<!DOCTYPE html>
<html dir="ltr" lang="en-gb">

<!-- Mirrored from www.dostips.com/forum/viewtopic.php?f=3&t=5543&start=15&view=print by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 19 Oct 2018 07:23:27 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- /Added by HTTrack -->
<head>
<meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="robots" content="noindex" />

<title>DosTips.com &bull; js/vbs/html/hta and more hybrids and chimeras in cmd/bat - Page 2</title>

<link href="styles/AllanStyle-SUBSILVER/theme/print.css" rel="stylesheet">
</head>
<body id="phpbb">
<div id="wrap" class="wrap">
	<a id="top" class="top-anchor" accesskey="t"></a>

	<div id="page-header">
		<h1>DosTips.com</h1>
		<p>A Forum all about DOS Batch<br /><a href="index-2.html">https://www.dostips.com/forum/</a></p>

		<h2>js/vbs/html/hta and more hybrids and chimeras in cmd/bat</h2>
		<p><a href="viewtopic9fb1.html?f=3&amp;t=5543">https://www.dostips.com/forum/viewtopic.php?f=3&amp;t=5543</a></p>
	</div>

	<div id="page-body" class="page-body">
		<div class="page-number">Page <strong>2</strong> of <strong>4</strong></div>
					<div class="post">
				<h3>Re: js/vbs/html/hta hybrids and chimeras in cmd/bat</h3>
				<div class="date">Posted: <strong>23 Apr 2014 04:23</strong></div>
				<div class="author">by <strong>penpen</strong></div>
				<div class="content">@Liviu: Just impressive.<br /><br />You may reduce the incompatabilities with xml by removing the &quot;^&quot;<br />character to use the &quot;:&quot; only (then used 2 times, then... merely an optical one; tested only on WinXp home 32 bit):<br /><div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>&lt;?xml : version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;<br />: ?&gt;<br />&lt;!------------------------- : cmd ----<br /></code></pre></div><br />penpen</div>
			</div>
			<hr />
					<div class="post">
				<h3>Re: js/vbs/html/hta hybrids and chimeras in cmd/bat</h3>
				<div class="date">Posted: <strong>24 Apr 2014 00:56</strong></div>
				<div class="author">by <strong>Liviu</strong></div>
				<div class="content"><blockquote><div><cite>siberia-man wrote:</cite><div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>&quot;%~f0?.wsf&quot;</code></pre></div>Very interesting trick allowing to run a batch file as wsf scenario. I tried to embed wsf into bat/cmd but all my attempts bumped to impossibility to run bat file as wsf (as it is possible for vbs or js scenarios). Is there source where I could learn more about it? Seems it uses some bug in cmd.exe (or wsh, or hidden feature of one of them).</div></blockquote>I don't know any more than what I posted. Train of thought was that I had just noticed in the previous post that WSH parses the command line in a very unorthodox way. Then I wondered, what are the chances that there might be other oddities in that ad-hoc parser.<br /><br />On a second look, the keys seem to be &quot;?&quot; as a delimiter, and &quot;.wsf&quot; as the extension, for example &quot;%~f0?xyz.wsf&quot; works as well. Probably an unintended (or possibly undocumented backdoor) related to parameter-passing URLs. In our paranoid times, could well be that someone someday sees it as a security risk and decides to &quot;fix&quot; it.<br /><br /><blockquote><div><cite>npocmaka_ wrote:</cite>I was wondered if it's possible to register the &quot;.bat&quot; extension to WSH as a dummy extension language and how eventually that could be used but didn't reach so far yet (it's still in my list with crazy ideas).</div></blockquote>Crazy or not, but I tried to register &quot;.cmd&quot; as a &quot;WSFFile&quot; type, and didn't work for me <img class="smilies" src="images/smilies/icon_wink.gif" alt=";-)" title="Wink" /><br /><br /><blockquote><div><cite>penpen wrote:</cite>You may reduce the incompatabilities with xml by removing the &quot;^&quot;<br />character to use the &quot;:&quot; only (then used 2 times, then... merely an optical one; tested only on WinXp home 32 bit):<br /><div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>&lt;?xml : version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;<br />: ?&gt;<br />&lt;!------------------------- : cmd ----<br /></code></pre></div></div></blockquote>You have a point, but the &quot;:&quot; colons in the declaration are technically an XML violation already.<br /><br />WSF files don't seem to be 100% compliant XML, for example the following prolog also works, even though it has free text between the &lt;?xml&gt; declaration and the root &lt;package&gt; node.<div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>&lt;?xml :: version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt; ---------------------------- cmd ---<br />@echo off<br />echo cmd<br />cscript //nologo &quot;%~f0?xyz.wsf&quot; //job:JS //job:VBS<br />exit /b<br />----------------------------------------------------------------------- wsf ---<br />&lt;package&gt;<br />&nbsp; &lt;job id=&quot;JS&quot;&gt; &lt;!------------------------------------------------------ js --&gt;</code></pre></div><br />Also, according to <a href="http://msdn.microsoft.com/en-us/library/dzfdccyf(v=vs.84).aspx" class="postlink">http://msdn.microsoft.com/en-us/library/dzfdccyf(v=vs.84).aspx</a> if there is no &lt;?xml&gt; declaration then the parser will ignore everything inside &lt;script&gt; blocks until the &lt;/script&gt; end tag. So the choice comes down to:<br />- &lt;?xml&gt; and CDATA, where the script code must avoid literal ']]&gt;', or<br />- no &lt;?xml&gt; and no CDATA, where the script code must avoid literal &lt;/script&gt;<br /><br />Neither alternative is 100% clean XML, both rely on special WSF parsing, so in the end it's a matter of style preference.<br /><br />Liviu</div>
			</div>
			<hr />
					<div class="post">
				<h3>Re: js/vbs/html/hta hybrids and chimeras in cmd/bat</h3>
				<div class="date">Posted: <strong>24 Apr 2014 03:24</strong></div>
				<div class="author">by <strong>penpen</strong></div>
				<div class="content">Maybe the xml authors add a &quot;default/global namespace access&quot; (to attributes, somewhere) in the future, so you can add colons without using a namespace prefix.<br />So this has the best chances to become valid xml:<br /><div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>&lt;?xml :version=&quot;1.0&quot;<br />&nbsp; &nbsp; &nbsp; :encoding=&quot;windows-1252&quot; ?&gt;&lt;!&#91;CDATA&#91; cmd<br />:: ...<br />&#93;&#93;&gt;<br /></code></pre></div>(Does anybody know someone in the W3C, or where one could present this proposal? ... Although i doubt they change it only of windows batch..., so whoever presents it to W3C should add more advantages of such feature. <img class="smilies" src="images/smilies/icon_wink.gif" alt=":wink:" title="Wink" /> )<br /><br />penpen</div>
			</div>
			<hr />
					<div class="post">
				<h3>Re: js/vbs/html/hta hybrids and chimeras in cmd/bat</h3>
				<div class="date">Posted: <strong>26 Apr 2014 09:30</strong></div>
				<div class="author">by <strong>dbenham</strong></div>
				<div class="content"><img class="smilies" src="images/smilies/icon_biggrin.gif" alt=":D" title="Very Happy" />  <img class="smilies" src="images/smilies/icon_biggrin.gif" alt=":D" title="Very Happy" />  <img class="smilies" src="images/smilies/icon_biggrin.gif" alt=":D" title="Very Happy" />  <img class="smilies" src="images/smilies/icon_biggrin.gif" alt=":D" title="Very Happy" />  <img class="smilies" src="images/smilies/icon_exclaim.gif" alt=":!:" title="Exclamation" /> <br />Really sweet discovery to be able to cleanly embed wsf within batch.<br /><blockquote><div><cite>Liviu wrote:</cite>So the choice comes down to:<br />- &lt;?xml&gt; and CDATA, where the script code must avoid literal ']]&gt;', or<br />- no &lt;?xml&gt; and no CDATA, where the script code must avoid literal &lt;/script&gt;<br /><br />Neither alternative is 100% clean XML, both rely on special WSF parsing, so in the end it's a matter of style preference.<br /></div></blockquote><br />I don't see either limitation as being a significant problem, and I find the latter option much simpler and less verbose.<br /><br /><br />Dave Benham</div>
			</div>
			<hr />
					<div class="post">
				<h3>Re: js/vbs/html/hta hybrids and chimeras in cmd/bat</h3>
				<div class="date">Posted: <strong>26 Apr 2014 16:47</strong></div>
				<div class="author">by <strong>Liviu</strong></div>
				<div class="content"><blockquote><div><cite>penpen wrote:</cite>Maybe the xml authors add a &quot;default/global namespace access&quot; (to attributes, somewhere) in the future</div></blockquote>It crossed my mind that &quot;:&quot; could be mis-parsed as a namespace:variable with both strings empty, then expanded to a null token and ignored. Or maybe the parser is so fixated on watching for &quot;version=&quot; that it ignores anything in between, I don't know. As far as getting XML to formalize &quot;:&quot; as valid syntax, I agree with your <img class="smilies" src="images/smilies/icon_wink.gif" alt=";-)" title="Wink" /> <img class="smilies" src="images/smilies/icon_wink.gif" alt=";-)" title="Wink" /><br /><br /><blockquote><div><cite>dbenham wrote:</cite>Really sweet discovery to be able to cleanly embed wsf within batch.</div></blockquote>Inasmuch as we call &quot;%~f0.wsf&quot; clean <img class="smilies" src="images/smilies/icon_wink.gif" alt=";-)" title="Wink" /> it's also a way to embed VBScript more &quot;cleanly&quot; than some of the alternatives.<br /><br />Liviu<br /><br />P.S. Just when I thought there isn't much left to learn about cmd/js hybrids, here is a neat one-liner from &quot;Peter Schwier&quot; in a comment at <a href="http://blogs.msdn.com/b/joshpoley/archive/2008/01/15/running-jscript-in-a-cmd-file.aspx" class="postlink">http://blogs.msdn.com/b/joshpoley/archive/2008/01/15/running-jscript-in-a-cmd-file.aspx</a> which &quot;daisy-chains&quot; JScript from batch.<div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>@if (false)==(false) @cscript //nologo //e:jscript &quot;%~f0&quot; %* &amp; goto :eof @end<br />WScript.Echo(&quot;JScript code, guaranteed to always run under CScript.&quot;);</code></pre></div></div>
			</div>
			<hr />
					<div class="post">
				<h3>Re: js/vbs/html/hta hybrids and chimeras in cmd/bat</h3>
				<div class="date">Posted: <strong>27 Apr 2014 13:24</strong></div>
				<div class="author">by <strong>dbenham</strong></div>
				<div class="content"><blockquote><div><cite>Liviu wrote:</cite><blockquote><div><cite>dbenham wrote:</cite>Really sweet discovery to be able to cleanly embed wsf within batch.</div></blockquote>Inasmuch as we call &quot;%~f0.wsf&quot; clean <img class="smilies" src="images/smilies/icon_wink.gif" alt=";-)" title="Wink" /> it's also a way to embed VBScript more &quot;cleanly&quot; than some of the alternatives.</div></blockquote><br />Precisely why I am so excited by the technique.<br /><br />I've updated my <a href="http://stackoverflow.com/q/9074476/1012053" class="postlink">StackOverflow hybrid batch/VBS Q&amp;A</a> with this superior method. I've included a link back to this thread, as well as a link to your specific post announcing the WSF discovery.<br /><br /><br />Dave Benham</div>
			</div>
			<hr />
					<div class="post">
				<h3>Re: js/vbs/html/hta hybrids and chimeras in cmd/bat</h3>
				<div class="date">Posted: <strong>28 Apr 2014 06:41</strong></div>
				<div class="author">by <strong>penpen</strong></div>
				<div class="content">I assume the wsf parser treats the &quot;&lt;?xml ... ?&gt;&quot; element similar as a processing instruction, where &quot;:&quot; characters are allowed.<br />Except using the name &quot;xml&quot;, &quot;xmL&quot;, ... &quot;XML&quot; these processing instructions are defined for XML, too:<br /><a href="http://www.w3.org/TR/2008/REC-xml-20081126/#sec-pi" class="postlink">http://www.w3.org/TR/2008/REC-xml-20081126/#sec-pi</a>.<br /><div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>&lt;?batch&nbsp; :: <br />@echo off<br />set /P &quot;All character combinations allowed without ?^&gt;, but this is easy to escape.&quot; &lt;nul<br />&gt;CON echo avoid a ?^&gt; at the end after a question mark: ?<br />exit /b<br />?&gt;<br />&lt;root/&gt;<br /></code></pre></div>So<br /><blockquote><div><cite>Liviu wrote:</cite>the parser is so fixated on watching for &quot;version=&quot; that it ignores anything in between<br /></div></blockquote> <img class="smilies" src="images/smilies/icon_smile.gif" alt=":)" title="Smile" /> .<br /><br />In the end: Double colon would be valid xml if the W3C could be convinced to treat the xml declaration (&lt;?xml ... ?&gt;) just as a reseved processing instruction,<br />instead of disallowing &quot;xml&quot;, &quot;xmL&quot;, ...&quot;XML&quot; as beeing a name for a processing instruction.<br />(I think one could find better arguments to implement this into the xml standard instead of what i've written in my above posting.)<br /><br />penpen</div>
			</div>
			<hr />
					<div class="post">
				<h3>Re: js/vbs/html/hta hybrids and chimeras in cmd/bat</h3>
				<div class="date">Posted: <strong>28 Apr 2014 20:37</strong></div>
				<div class="author">by <strong>Liviu</strong></div>
				<div class="content">@Dave, that's a nice well rounded writeup. And thanks for the credit, though accurate attributions are often times hard to come by in batch world. The arcane batch syntax - and the lengths we go to and pervert it further <img class="smilies" src="images/smilies/icon_wink.gif" alt=";-)" title="Wink" /> - makes searches difficult to try and locate the original sources. One can't google for &quot;::'&lt;SUB&gt;@&quot; where &lt;SUB&gt; is 0x1A, for example. Or for &quot;&lt;!-- :&quot; for that matter - actually this one has its own funny sub-story. When I posted my &quot;?.wsf&quot; trick I still had a nagging feeling that I had seen something like &quot;&lt;!-- :&quot; before, and it certainly wasn't on the Russian forum in siberia-man's link. Then, while writing this post today, I tried a random search for &quot;xml comment&quot; on dostips, and there it was &quot;&lt;!-- ::&quot; at <a href="viewtopicf97a.html?p=14694#p14694" class="postlink">http://www.dostips.com/forum/viewtopic.php?p=14694#p14694</a> in the first hit. Quite remarkable, isn't it, to have remembered it in the first place, and then find it a couple of years later. Except, then I looked more closely and ...oops, it was a post of my own <img class="smilies" src="images/smilies/icon_wink.gif" alt=";-)" title="Wink" /><br /><br />@penpen, right, but '&lt;?xml' is alot more restrictive than PIs in general. The W3C reference docs are not the friendliest to read <img class="smilies" src="images/smilies/icon_wink.gif" alt=";-)" title="Wink" /> but the case of the '&lt;?xml' declaration seems clearly cut. It's a pretty special PI and it must be at the very top of the file, if present at all. It can only contain the version/encoding/standalone tags - each with its own rigid format - and nothing else but whitespace before the closing '?&gt;'. I don't see any room (or backdoor <img class="smilies" src="images/smilies/icon_wink.gif" alt=";-)" title="Wink" />) where one could slip a ':' in that grammar (<a href="http://www.w3.org/TR/2008/REC-xml-20081126/#NT-EncodingDecl" class="postlink">http://www.w3.org/TR/2008/REC-xml-20081126/#NT-EncodingDecl</a>). It might be possible to insert an ':' in other PIs, but the point of the exercise here was to make the XML more compliant by adding the '&lt;?xml' declaration - allowing, for example, an explicit encoding to be specified. I don't see that working and, barring that, I tend to agree with Dave's assessment that no '&lt;?xml' (and therefore no 'CDATA' required, or supported) remains the simpler solution.<br /><br />Liviu</div>
			</div>
			<hr />
					<div class="post">
				<h3>Re: js/vbs/html/hta hybrids and chimeras in cmd/bat</h3>
				<div class="date">Posted: <strong>29 Apr 2014 04:41</strong></div>
				<div class="author">by <strong>penpen</strong></div>
				<div class="content"><blockquote class="uncited"><div>I don't see any room (or backdoor ) where one could slip a ':' in that grammar (<!-- m --><a class="postlink" href="http://www.w3.org/TR/2008/REC-xml-20081126/#NT-EncodingDecl">http://www.w3.org/TR/2008/REC-xml-20081 ... codingDecl</a><!-- m -->). It might be possible to insert an ':' in other PIs, but the point of the exercise here was to make the XML more compliant by adding the '&lt;?xml' declaration - allowing, for example, an explicit encoding to be specified.<br /></div></blockquote>My post above should only explain why the &quot;:&quot; characters are allowed in a wsf (at least from my point of view);<br />the above code should not be seen as an example to improve the XML conformity - but maybe someone sees a solution when reading it (so i posted the above).<br />(Don't get me wrong: I try to improve that aspect, as i really could need that actually - for my private use only i could organize my whole batch/vbs/... files using a xml database, so i am able to search for specific things better and faster.)<br /><br />So actually (state of the art) the only well formed xml file (unless I am mistaken) is your (Liviu's) version without the xml declaration with some comments:<br /><div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>&lt;!-- :: cmd&nbsp; &nbsp;<br />@echo off<br />echo cmd<br />cscript //nologo &quot;%~f0?.wsf&quot; //job:JS //job:VBS<br />exit /b<br />--&gt;<br />&lt;package&gt;<br />&nbsp; &nbsp;&lt;job id=&quot;JS&quot;&gt;<br />&nbsp; &nbsp;&nbsp; &nbsp;&lt;script language=&quot;VBScript&quot;&gt;<br />' avoid &#93;&#93; in this VBScript<br />' &lt;!&#91;CDATA&#91;<br />sub vbsEcho()<br />&nbsp; &nbsp;WScript.Echo &quot;cmd.js.vbs&quot;<br />end sub<br />' &#93;&#93;&gt;<br />&nbsp; &nbsp;&nbsp; &nbsp;&lt;/script&gt;<br />&nbsp; &nbsp;&nbsp; &nbsp;&lt;script language=&quot;JScript&quot;&gt;<br />// avoid &#93;&#93; in this JScript<br />// &lt;!&#91;CDATA&#91;<br />WScript.Echo(&quot;cmd.js&quot;);<br />vbsEcho();<br />// &#93;&#93;&gt;<br />&nbsp; &nbsp;&nbsp; &nbsp;&lt;/script&gt;<br />&nbsp; &nbsp;&lt;/job&gt;<br />&nbsp; &nbsp;&lt;job id=&quot;VBS&quot;&gt;<br />&nbsp; &nbsp;&nbsp; &nbsp;&lt;script language=&quot;JScript&quot;&gt;<br />// avoid -- in this JScript<br />// &lt;!--<br />function jsEcho() { WScript.Echo(&quot;cmd.vbs.js&quot;); }<br />// --&gt;<br />&nbsp; &nbsp;&nbsp; &nbsp;&lt;/script&gt;<br />&nbsp; &nbsp;&nbsp; &nbsp;&lt;script language=&quot;VBScript&quot;&gt;<br />' avoid -- in this VBScript<br />' &lt;!--<br />WScript.Echo &quot;cmd.vbs&quot;<br />call jsEcho<br />' --&gt;<br />&nbsp; &nbsp;&nbsp; &nbsp;&lt;/script&gt;<br />&nbsp; &lt;/job&gt;<br />&lt;/package&gt;<br /></code></pre></div>Automatic xml version 1.0 detection, as no xml declaration is used; automatic character encoding based on<br /><a href="http://www.w3.org/TR/xml11/#sec-guessing-no-ext-info" class="postlink">http://www.w3.org/TR/xml11/#sec-guessing-no-ext-info</a>,<br />but as batch scripts have to be executable, only ANSI files are possible recognised as UTF-8, so no characters in [0x80:0xFF].<br /><br />In my above post i forgotten to write that microsoft doesn't use a xml parser for that:<br />They are using a (very simple, not fully implemented) SGML parser, where all names for processing instructions are allowed;<br />this also explains all other &quot;special&quot;  syntax possible.<br />they've added some additional tests for the &lt;?xml ... ?&gt; element put haven't watched for the &quot;:&quot;.<br /><br />penpen<br /><br />Edit: Added the state of the art part.<br />Edit2: Clarified an ambiguous verbalization.</div>
			</div>
			<hr />
					<div class="post">
				<h3>Re: js/vbs/html/hta hybrids and chimeras in cmd/bat</h3>
				<div class="date">Posted: <strong>29 Apr 2014 08:06</strong></div>
				<div class="author">by <strong>penpen</strong></div>
				<div class="content">If you want to access the batch as cdata, too you might do something like that:<br /><div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>&lt;!-- :: cmd as the first JScript<br />:: --&gt;&lt;package&gt;&lt;job id=&quot;:batch&quot;&gt;&lt;script language=&quot;JScript&quot;&gt;<br />@if (true == false) @end /*&lt;!&#91;CDATA&#91;<br />@echo off<br />echo cmd<br />cscript //nologo &quot;%~f0?.wsf&quot; //job:JS<br />exit /b<br />&#93;&#93;&gt;<br />*/<br />&nbsp; &nbsp;&nbsp; &nbsp;&lt;/script&gt;<br />&nbsp; &nbsp;&lt;/job&gt;<br />&nbsp; &nbsp;&lt;job id=&quot;JS&quot;&gt;<br />&nbsp; &nbsp;&nbsp; &nbsp;&lt;script language=&quot;JScript&quot;&gt;<br />// &lt;!&#91;CDATA&#91;<br />WScript.Echo(&quot;cmd.js&quot;);<br />vbsEcho();<br />// &#93;&#93;&gt;<br />&nbsp; &nbsp;&nbsp; &nbsp;&lt;/script&gt;<br />&nbsp; &nbsp;&lt;/job&gt;<br />&lt;/package&gt;<br /></code></pre></div><br />penpen</div>
			</div>
			<hr />
					<div class="post">
				<h3>Re: js/vbs/html/hta hybrids and chimeras in cmd/bat</h3>
				<div class="date">Posted: <strong>29 Apr 2014 21:25</strong></div>
				<div class="author">by <strong>Liviu</strong></div>
				<div class="content">@penpen, sorry if something came off the wrong way about my &quot;funny story&quot;, surely dind't mean it. What I wanted to actually say is that proper attribution is often difficult in batch world and, while I always try to give credit where credit is due, misses or mistakes happen. After all, this was a case where I couldn't recognize my _own_ former little contribution until accidentally finding it on a search - and I am pretty sure it's not the only case. So, anybody who notices me forgetting to properly cite 'prior art' please just point me to the sources, and I'll be happy to correct and amend. As for sharing, seeing something I posted being used and/or built upon is its own reward of sorts, so everyone feel free to tweak/improve/hack to death any of it.<br /><br /><blockquote><div><cite>penpen wrote:</cite>In my above post i forgotten to write that microsoft doesn't use a xml parser for that:<br />They are using a (very simple, not fully implemented) SGML parser, where all names for processing instructions are allowed;<br />this also explains all other &quot;special&quot;  syntax possible.<br />they've added some additional tests for the &lt;?xml ... ?&gt; element put haven't watched for the &quot;:&quot;.</div></blockquote>I think that's the case, indeed. Microsoft's actual XML parser throws an error if you insert a stray &quot;:&quot; in the &lt;?xml .. ?&gt; declaration of, for example, an XSLT file, while WSH lets it pass for WSF files.<br /><br /><blockquote><div><cite>penpen wrote:</cite>If you want to access the batch as cdata, too you might do something like that:</div></blockquote>I don't think that works. It doesn't give errors in batch since since &quot;&lt;![CDATA[&quot; is inside a false conditional, and &quot;]]&gt;&quot; is after &quot;exit /b&quot;. It also doesn't give errors in JScript since it's all inside a /*&lt;![CDATA[ ... ]]&gt;*/ comment. But it doesn't work as a CDATA section proper. Try for example inserting a &quot;:: &lt;/script&gt;&quot; line right above &quot;@echo off&quot;. That raises an error &quot;<em class="text-italics">Windows Script Host: The end tag does not match the start tag : job</em>&quot; which shows that &lt;/script&gt; was actually parsed as an XML tag - which wouldn't happen inside a recognized CDATA section. As far as I can tell, proper CDATA parsing requires an &lt;?xml .. ?&gt; declaration at the top.<br /><br />Liviu</div>
			</div>
			<hr />
					<div class="post">
				<h3>Re: js/vbs/html/hta hybrids and chimeras in cmd/bat</h3>
				<div class="date">Posted: <strong>30 Apr 2014 01:01</strong></div>
				<div class="author">by <strong>penpen</strong></div>
				<div class="content"><blockquote><div><cite>Liviu wrote:</cite><blockquote><div><cite>penpen wrote:</cite>If you want to access the batch as cdata, too you might do something like that:<br /></div></blockquote>I don't think that works. [...]. But it doesn't work as a CDATA section proper. Try for example inserting a &quot;:: &lt;/script&gt;&quot; line right above &quot;@echo off&quot;. That raises an error &quot;Windows Script Host: The end tag does not match the start tag : job&quot; which shows that &lt;/script&gt; was actually parsed as an XML tag - which wouldn't happen inside a recognized CDATA section. As far as I can tell, proper CDATA parsing requires an &lt;?xml .. ?&gt; declaration at the top.<br /></div></blockquote>I've described too short recently: Sorry for that.<br />I didn't meant this from the &quot;.WSF&quot; parsers view.<br />I meant this from a XML parsers view, so you can transform it using XSLT (accessing the pure batch data inside the CDATA section).<br /><br />penpen</div>
			</div>
			<hr />
					<div class="post">
				<h3>Re: js/vbs/html/hta hybrids and chimeras in cmd/bat</h3>
				<div class="date">Posted: <strong>04 May 2014 00:31</strong></div>
				<div class="author">by <strong>Liviu</strong></div>
				<div class="content"><blockquote><div><cite>Liviu wrote:</cite>WSF files don't seem to be 100% compliant XML [...] if there is no &lt;?xml&gt; declaration then the parser will ignore everything inside &lt;script&gt; blocks until the &lt;/script&gt; end tag</div></blockquote><blockquote><div><cite>penpen wrote:</cite>In my above post i forgotten to write that microsoft doesn't use a xml parser for that: They are using a (very simple, not fully implemented) SGML parser, where all names for processing instructions are allowed</div></blockquote><blockquote><div><cite>Liviu wrote:</cite>As far as I can tell, proper CDATA parsing requires an &lt;?xml .. ?&gt; declaration at the top.</div></blockquote><blockquote><div><cite>penpen wrote:</cite>I didn't meant this from the &quot;.WSF&quot; parsers view. I meant this from a XML parsers view </div></blockquote><br />Good point, thanks for making it. WSH (cscript/wscript) seems to use its own internal XML parser for WSF files, other than and different from the MSXML or XMLLITE builtins. The WSF handling of CDATA is only one of its non-conforming oddities - technically, a missing &lt;?xml .. ?&gt; at the top should default to and behave the same as &lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;. But it also has issues with &lt;!DOCTYPE&gt; declarations, entitites and probably more.<br /><br />Yet, it's still possible to write XML that the WSF parser lets pass, and &quot;reparse&quot; it later in embedded code. Following post is an example of a hybrid cmd+wsf+xslt where the batch code calls into embedded JScript code, which in turn loads an XSLT stylesheet also embedded in the same file, and returns the result as text to the calling batch code.<br /><br />Liviu</div>
			</div>
			<hr />
					<div class="post">
				<h3>Re: js/vbs/html/hta hybrids and chimeras in cmd/bat</h3>
				<div class="date">Posted: <strong>04 May 2014 01:50</strong></div>
				<div class="author">by <strong>Liviu</strong></div>
				<div class="content">It has come up before that the &quot;&lt;!-- ::&quot; syntax (or &quot;&lt;!-- :&quot;) could be used to build hybrid cmd+xml files. There have been examples of it for cmd+html/mshta/wsf, but I don't recall a cmd+xslt one. This post seeks to cover that missing part. Anyone not interested in xml/xslt might as well stop here, and skip over the rest.<br /><br />The two techniques below provide for:<br />1. a hybrid cmd+xslt batch file with an embedded stylesheet, used to process an xml file of known format using an external command line XML processor of user's choice;<br />2. a hybrid cmd+wsf+xslt all-in-one batch file with an embedded stylesheet, and also the necessary jscript code to apply it to a given xml, using just Windows' builtin parser, without relying on external processors.<br /><br />Think it's easier to follow if I start with a - completely made up, still somewhat believable - use case. Suppose one had an XML file holding file information and respective hashes, such as...<div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>&lt;?xml version='1.0' encoding='UTF-8'?&gt;<br />&lt;dfxml xmloutputversion='1.0'&gt;<br />&nbsp; &lt;fileobject&gt;<br />&nbsp; &nbsp; &lt;filename&gt;file-0.txt&lt;/filename&gt;<br />&nbsp; &nbsp; &lt;hashdigest type='MD5'&gt;a3037a8c309f79fbccc1cfb0bce59634&lt;/hashdigest&gt;<br />&nbsp; &nbsp; &lt;hashdigest type='SHA1'&gt;c2f71e783ed2b5e78d30917a7363ed041de87d02&lt;/hashdigest&gt;<br />&nbsp; &lt;/fileobject&gt;<br />&nbsp; &lt;fileobject&gt;<br />&nbsp; &nbsp; &lt;filename&gt;dir-1\file-1-1.txt&lt;/filename&gt;<br />&nbsp; &nbsp; &lt;hashdigest type='MD5'&gt;2ae67a9bf2060a55033796e4ef0d023e&lt;/hashdigest&gt;<br />&nbsp; &nbsp; &lt;hashdigest type='SHA1'&gt;49eb490983196ca2b829b0885c8880afd9e52f5d&lt;/hashdigest&gt;<br />&nbsp; &lt;/fileobject&gt;<br />&nbsp; &lt;fileobject&gt;<br />&nbsp; &nbsp; &lt;filename&gt;dir-2\file-2-1.txt&lt;/filename&gt;<br />&nbsp; &nbsp; &lt;hashdigest type='MD5'&gt;c83a699edda408fec4340e3f7aa5acfd&lt;/hashdigest&gt;<br />&nbsp; &nbsp; &lt;hashdigest type='SHA1'&gt;a83b85c8cca34c484d31ec116247583453a29dab&lt;/hashdigest&gt;<br />&nbsp; &lt;/fileobject&gt;<br />&nbsp; &lt;fileobject&gt;<br />&nbsp; &nbsp; &lt;filename&gt;dir-2\file-2-2.txt&lt;/filename&gt;<br />&nbsp; &nbsp; &lt;hashdigest type='MD5'&gt;21bb58475e5a9b7146730e6eb8e74bb1&lt;/hashdigest&gt;<br />&nbsp; &nbsp; &lt;hashdigest type='SHA1'&gt;76418189163e89d9fc38fdf1acaa36e15046d86f&lt;/hashdigest&gt;<br />&nbsp; &lt;/fileobject&gt;<br />&lt;/dfxml&gt;<br /></code></pre></div>...and needed to convert it to a flat text format like...<div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>a3037a8c309f79fbccc1cfb0bce59634* file-0.txt<br />2ae67a9bf2060a55033796e4ef0d023e* dir-1\file-1-1.txt<br />c83a699edda408fec4340e3f7aa5acfd* dir-2\file-2-1.txt<br />21bb58475e5a9b7146730e6eb8e74bb1* dir-2\file-2-2.txt<br /></code></pre></div>...where incidentally the xml file is a trimmed down dfxml format such as generated by hashdeep/md5deep, and the text is in the de-facto standard accepted by most every md5sum clone.<br /><br />Such a conversion between formats would not be a trivial batch task - due to potential extra/irrelevant information in the input file, whitespace (spaces/tabs/newlines) tolerance in xml, the '&lt;&gt;' characters that are special to batch, etc. On the other hand, extracting the very specific information needed from the xml is just what XSLT was made for, and all it takes is a straightforward &quot;transformation&quot; (which is what &quot;T&quot; in XSLT stands for). Note that the XSLT as written does not include the '*' binary marker after MD5s, and puts quotes around the filename - both formatting issues will be taken care of in the batch code later down.<div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>&lt;?xml version='1.0' encoding='iso-8859-1'?&gt;<br />&lt;!DOCTYPE xsl:stylesheet &#91;&lt;!ENTITY eol &quot;&amp;#x26;#xA;&quot;&gt;&#93;&gt;<br />&lt;xsl:stylesheet version='1.0' xmlns:xsl='http://www.w3.org/1999/XSL/Transform'&gt;<br />&lt;xsl:output method='text' encoding='iso-8859-1'/&gt;<br />&lt;xsl:strip-space elements='*'/&gt;<br />&lt;xsl:template match='dfxml/fileobject'&gt;<br />&nbsp; &lt;xsl:value-of select=&quot;concat(hashdigest&#91;@type='MD5'&#93;,' &amp;quot;',filename,'&amp;quot;&amp;eol;')&quot;/&gt;<br />&lt;/xsl:template&gt;<br />&lt;/xsl:stylesheet&gt;<br /></code></pre></div><br />To run an XSLT on an XML file, one needs an XML parser/processor. An older, yet functioning one, is Microsoft's own MSXSL.EXE <a href="http://www.microsoft.com/en-us/download/details.aspx?id=21714" class="postlink">http://www.microsoft.com/en-us/download/details.aspx?id=21714</a>. With that in hand (i.e. somewhere in the PATH, or in the current directory), the following works - assuming the files above are saved as 'dfx.xml' and the XSLT 'dfx2md5.xslt' respectively.<div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>C:\tmp&gt;for /f &quot;tokens=1,*&quot; %X in ('msxsl &quot;dfx.xml&quot; &quot;dfx2md5.xslt&quot;') do @echo %~X* %~Y<br />a3037a8c309f79fbccc1cfb0bce59634* file-0.txt<br />2ae67a9bf2060a55033796e4ef0d023e* dir-1\file-1-1.txt<br />c83a699edda408fec4340e3f7aa5acfd* dir-2\file-2-1.txt<br />21bb58475e5a9b7146730e6eb8e74bb1* dir-2\file-2-2.txt</code></pre></div><br />This, however, requires having the external XSLT file available, and MSXSL.EXE available. The rest of this post is about removing those restrictions, one by one - and both codes return the same output as the one above.<br /><br />1. hybrid cmd+xslt batch file with an embedded stylesheet, used to process an xml file of known format using an external command line XML processor of user's choice<div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>&lt;!-- :: dfx2md5-msXsl.cmd :: converts dfxml file to md5sum format using msXsl.exe<br />@echo off<br />for /f &quot;tokens=1,*&quot; %%X in ('msxsl &quot;%~1&quot; &quot;%~f0&quot;') do echo %%~X* %%~Y<br />goto :eof &amp; rem --&gt;<br /><br />&lt;!-- embedded stylesheet identical to standalone one, except for<br />&nbsp; &nbsp; &nbsp;the &lt;?xml?&gt; declaration which cannot be inserted at the very top of the file --&gt;<br />&lt;!-- &lt;?xml version='1.0' encoding='iso-8859-1'?&gt; --&gt;<br />&lt;!DOCTYPE xsl:stylesheet &#91;&lt;!ENTITY eol &quot;&amp;#x26;#xA;&quot;&gt;&#93;&gt;<br />&lt;xsl:stylesheet version='1.0' xmlns:xsl='http://www.w3.org/1999/XSL/Transform'&gt;<br />&lt;xsl:output method='text' encoding='iso-8859-1'/&gt;<br />&lt;xsl:strip-space elements='*'/&gt;<br />&lt;xsl:template match='dfxml/fileobject'&gt;<br />&nbsp; &lt;xsl:value-of select=&quot;concat(hashdigest&#91;@type='MD5'&#93;,' &amp;quot;',filename,'&amp;quot;&amp;eol;')&quot;/&gt;<br />&lt;/xsl:template&gt;<br />&lt;/xsl:stylesheet&gt;<br /></code></pre></div><br />2. hybrid cmd+wsf+xslt all-in-one batch file with an embedded stylesheet, and also the necessary jscript code to apply it to a given xml, using just Windows' builtin parser, without relying on external processors<div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>&lt;!-- :: dfx2md5.cmd :: converts dfxml file to md5sum format - - - - - .cmd&nbsp; - -<br />@echo off<br />for /f &quot;tokens=1,*&quot; %%X in ('cscript //nologo &quot;%~f0?.wsf&quot; &quot;%~1&quot;') do (<br />&nbsp; echo %%~X* %%~Y<br />)<br />goto :eof &amp; rem --&gt;<br /><br />&lt;job&gt; &lt;!--&nbsp; - - - - - - - - - - - - - - - - - - - - - - - - - - - -&nbsp; &nbsp;.wsf&nbsp; --&gt;<br /><br />&lt;xslt id='default'&gt; &lt;!--&nbsp; - - - - - - - - - - - - - - - - - - - - -&nbsp; .xslt&nbsp; --&gt;<br />&lt;!-- embedded stylesheet identical to standalone one, except for<br />&nbsp; &nbsp; &nbsp;the &lt;?xml?&gt; declaration which cannot be inserted at the very top of the file<br />&nbsp; &nbsp; &nbsp;&amp;eol; entity replaced with $eol variable since !doctype breaks wsf parser --&gt;<br />&lt;!-- &lt;?xml version='1.0' encoding='iso-8859-1'?&gt; --&gt;<br />&lt;xsl:stylesheet version='1.0' xmlns:xsl='http://www.w3.org/1999/XSL/Transform'&gt;<br />&lt;xsl:output method='text' encoding='iso-8859-1'/&gt;<br />&lt;xsl:strip-space elements='*'/&gt;<br />&lt;xsl:variable name='eol' select='&quot;&amp;#xA;&quot;'/&gt;<br />&lt;xsl:template match='dfxml/fileobject'&gt;<br />&nbsp; &lt;xsl:value-of select=&quot;concat(hashdigest&#91;@type='MD5'&#93;,' &amp;quot;',filename,'&amp;quot;',$eol)&quot;/&gt;<br />&lt;/xsl:template&gt;<br />&lt;/xsl:stylesheet&gt;<br />&lt;/xslt&gt;<br /><br />&lt;script language=&quot;JScript&quot;&gt;//&lt;!&#91;CDATA&#91; &lt;!--&nbsp; - - - - - - - - - - - -&nbsp; &nbsp;.js&nbsp; --&gt;<br />function u32hex(arg)<br />{ return (arg &gt;&gt;&gt; 0).toString(16).toUpperCase(); }<br />function xmlErr(err)<br />{ return &quot;error 0x&quot; + u32hex(err.errorCode) + &quot; (&quot; + err.line + &quot;,&quot; + err.linepos + &quot;): &quot; + err.reason; }<br /><br />var vArgs = WScript.Arguments;<br />if(vArgs.length &lt; 1 || !vArgs(0).length)<br />{ WScript.Echo(&quot;syntax: dfx2md5.cmd &lt;xmlFile&gt;&quot;); WScript.Quit(1); }<br />var xmlFile = vArgs(0);<br />var wsfFile = WScript.ScriptFullName.slice(0, -5); // drop '?.wsf' tail<br /><br />// ms-recommended msXml6, in-band from xp.sp3 up, except server2k3 requires separate install<br />var xmlDOMDocProgID = &quot;MSXML2.DOMDocument.6.0&quot;;<br /><br />// load external xml file<br />var xmlDoc = new ActiveXObject(xmlDOMDocProgID);<br />xmlDoc.setProperty(&quot;NewParser&quot;, true);<br />xmlDoc.validateOnParse = false;<br />xmlDoc.async = false;<br />xmlDoc.load(xmlFile);<br />if(xmlDoc.parseError.errorCode)<br />{ WScript.Echo(&quot;XML &quot; + xmlErr(xmlDoc.parseError)); WScript.Quit(1); }<br /><br />// load self, then retrieve 'xslt' node at next step<br />var wsfDoc = new ActiveXObject(xmlDOMDocProgID);<br />wsfDoc.setProperty(&quot;NewParser&quot;, true);<br />wsfDoc.validateOnParse = false;<br />wsfDoc.async = false;<br />wsfDoc.load(wsfFile);<br />if(wsfDoc.parseError.errorCode)<br />{ WScript.Echo(&quot;XSL &quot; + xmlErr(wsfDoc.parseError)); WScript.Quit(1); }<br /><br />// msXml3 only, override legacy default 'xslPattern'<br />//wsfDoc.setProperty(&quot;SelectionLanguage&quot;, 'XPath');<br />// required in order for 'xpath' to recognize 'xsl' namespace<br />wsfDoc.setProperty(&quot;SelectionNamespaces&quot;, &quot;xmlns:xsl='http://www.w3.org/1999/XSL/Transform'&quot;);<br />// could store multiple 'xslt' stylesheets with different 'id' tags, and choose at runtime which one to apply<br />var xslNode = wsfDoc.documentElement.selectSingleNode(&quot;/job/xslt&#91;@id='default'&#93;/xsl:stylesheet&quot;);<br /><br />// 'xslDoc' only needed for 'xslPi' otherwise 'xslNode' could be passed to 'transformNode' directly<br />var xslDoc = new ActiveXObject(xmlDOMDocProgID);<br />// 'encoding' is parsed and observed, but left out of the 'xslDoc.xml' property<br />var xmlPi = xslDoc.createProcessingInstruction(&quot;xml&quot;, &quot;version='1.0' encoding='iso-8859-1' standalone='yes'&quot;);<br />xslDoc.appendChild(xmlPi);<br />xslDoc.appendChild(xslNode.parentNode.removeChild(xslNode));<br /><br />// apply transformation, output via stdout.write to avoid extra .echo newline<br />try<br />{ WScript.StdOut.Write(xmlDoc.transformNode(xslDoc)); }<br />catch(err)<br />{ WScript.Echo(&quot;XSLT error 0x&quot; + u32hex(err.number) + &quot;: &quot; + err.description); WScript.Quit(1); }<br />//&#93;&#93;&gt;&lt;/script&gt;<br />&lt;/job&gt; &lt;!--&nbsp; - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -&nbsp; --&gt;<br /></code></pre></div><br />To be noted that one would only need to customize the batch and xslt parts in the code above - the script/js block is completely generic.<br /><br />Liviu</div>
			</div>
			<hr />
					<div class="post">
				<h3>Re: js/vbs/html/hta hybrids and chimeras in cmd/bat</h3>
				<div class="date">Posted: <strong>04 May 2014 06:07</strong></div>
				<div class="author">by <strong>penpen</strong></div>
				<div class="content">Great idea, to store the xslt(s) into the wsf file, too: I even didn't thought it,<br />although, up to now, i stored all other (xml) data (== batch scripts/JScripts/VBScripts/... scripts) into it.<br /><br />penpen</div>
			</div>
			<hr />
			</div>

	<div id="page-footer" class="page-footer">
		<div class="page-number">All times are <span title="UTC-6">UTC-06:00</span><br />Page <strong>2</strong> of <strong>4</strong></div>
		<div class="copyright">Powered by phpBB&reg; Forum Software &copy; phpBB Limited<br />https://www.phpbb.com/</div>
	</div>
</div>

</body>

<!-- Mirrored from www.dostips.com/forum/viewtopic.php?f=3&t=5543&start=15&view=print by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 19 Oct 2018 07:23:27 GMT -->
</html>
