<!DOCTYPE html>
<html dir="ltr" lang="en-gb">

<!-- Mirrored from www.dostips.com/forum/viewtopic.php?f=3&t=2800&view=print by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 19 Oct 2018 08:31:30 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- /Added by HTTrack -->
<head>
<meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="robots" content="noindex" />

<title>DosTips.com &bull; Detect redirection and EOF in Standard Handles</title>

<link href="styles/AllanStyle-SUBSILVER/theme/print.css" rel="stylesheet">
</head>
<body id="phpbb">
<div id="wrap" class="wrap">
	<a id="top" class="top-anchor" accesskey="t"></a>

	<div id="page-header">
		<h1>DosTips.com</h1>
		<p>A Forum all about DOS Batch<br /><a href="index-2.html">https://www.dostips.com/forum/</a></p>

		<h2>Detect redirection and EOF in Standard Handles</h2>
		<p><a href="viewtopic577f.html?f=3&amp;t=2800">https://www.dostips.com/forum/viewtopic.php?f=3&amp;t=2800</a></p>
	</div>

	<div id="page-body" class="page-body">
		<div class="page-number">Page <strong>1</strong> of <strong>1</strong></div>
					<div class="post">
				<h3>Detect redirection and EOF in Standard Handles</h3>
				<div class="date">Posted: <strong>15 Jan 2012 23:02</strong></div>
				<div class="author">by <strong>Aacini</strong></div>
				<div class="content">At <a href="viewtopica6ef.php?f=3&amp;t=2128&amp;p=9720#p9720" class="postlink">this post</a> I saw this strange example posted by jeb:<br /><br /><blockquote><div><cite>jeb wrote:</cite><div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>@echo off<br />setlocal EnableDelayedExpansion<br />&lt; testfile.txt&nbsp; (<br />&nbsp; &nbsp;set /p line=<br />&nbsp; &nbsp;echo set/p-read: !line!<br /><br />&nbsp; &nbsp;echo --- FINDSTR ---<br />&nbsp; &nbsp;findstr /n ^^<br /><br />&nbsp; &nbsp;echo --- MORE ---<br />&nbsp; &nbsp;more<br /><br />&nbsp; &nbsp;echo --- FIND ---<br />&nbsp; &nbsp;find /n /v &quot;&quot;<br />)<br /></code></pre></div>...<br />None of the commands close the input stream, even if they are at the end the stream is still open.<br /><br />FIND and MORE first resets the file position variable and then read the complete file to the EOF, so both can be used to reread the same file multiple times.<br />jeb</div></blockquote><br />Previous code open my eyes to a so obvious concept I didn't realized before: in any Batch program, subroutine or parentheses-enclosed code block, the DOS standard file handles remains open until the program/subroutine/block ends. Remember that every DOS-Windows running program have 5 <em class="text-italics">Standard Handles</em> identified by an integer number this way: 0=STDIN (keyboard CON, redirected by &lt;), 1=STDOUT (screen CON, redirected by &gt;), 2=STDERR (screen CON, redirected by 2&gt;), 3=STDAUX (serial port AUX) and 4=STDPRN (printer PRN).<br /><br /><strong class="text-strong">EDIT:</strong> Windows documentation indicate that handles 3-9 are undefined (available), although it seems that CMD.EXE connect handle 3 to CON: device (keyboard for input, screen for output).<br /><br />I made a small test to confirm that the standard handles behaves as expected:<blockquote><div><cite>thefile.txt wrote:</cite>Line one<br />Line two<br />Line three<br />Line four<br />Line five<br /></div></blockquote>The program:<div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>@echo off<br />setlocal EnableDelayedExpansion<br />findstr /N ^^ thefile.txt | find /C &quot;:&quot; &gt; lines.tmp<br />set /P lines=&lt; lines.tmp<br />rem Copy twice the number of input lines:<br />set /A lines*=2<br />&lt; thefile.txt (<br />&nbsp; &nbsp;for /L %%i in (1,1,%lines%) do (<br />&nbsp; &nbsp; &nbsp; set /P line=<br />&nbsp; &nbsp; &nbsp; echo Copy of line %%i: !line!<br />&nbsp; &nbsp;)<br />) &gt;&gt; thefile.txt<br /></code></pre></div>And the result:<blockquote><div><cite>Result wrote:</cite>Line one<br />Line two<br />Line three<br />Line four<br />Line five<br />Copy of line 1: Line one<br />Copy of line 2: Line two<br />Copy of line 3: Line three<br />Copy of line 4: Line four<br />Copy of line 5: Line five<br />Copy of line 6: Copy of line 1: Line one<br />Copy of line 7: Copy of line 2: Line two<br />Copy of line 8: Copy of line 3: Line three<br />Copy of line 9: Copy of line 4: Line four<br />Copy of line 10: Copy of line 5: Line five<br /></div></blockquote>The new data appended to the end of the file via STDOUT handle is ready to be read when STDIN's File Pointer reaches it, although both handles refer to the same physical file.<br /><br />With this idea as base, I wrote a very small and simple .COM program that allows to detect if a standard handle has been redirected to a disk file.<div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>TYPEOFHANDLE handle</code></pre></div><br />Return the type of given handle via ERRORLEVEL this way:<br /><br />IF %ERRORLEVEL% LSS 128 (<br />   Handle connected to character device: 3=CON (4=NUL in original DOS)<br />) ELSE (<br />   Handle connected to disk file: +128=disk file, +64=EOF (low part=drive in original DOS)<br />)<br /><br /><strong class="text-strong">EDIT</strong>: If %errorlevel% is zero, the handle is not connected to any file (undefined handle, like handles 3-9 in Windows CMD.EXE).<br /><br />For example:<div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>TypeOfHandle 0<br />if %errorlevel% geq 128 (<br />&nbsp; &nbsp; rem STDIN redirected to disk file<br />&nbsp; &nbsp; echo This program must be executed in interactive (not predefined-input) way^!<br />&nbsp; &nbsp; goto :EOF<br />)<br />set /P input=Enter input please: <br />etc...</code></pre></div>Another one:<div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>TypeOfHandle 1<br />if %errorlevel% == 3 (<br />&nbsp; &nbsp; echo Summary of results to be displayed in the screen...<br />) else (<br />&nbsp; &nbsp; echo The complete results<br />&nbsp; &nbsp; echo that will be stored<br />&nbsp; &nbsp; echo in the redirected disk file...<br />)</code></pre></div>This program also provide (at least!) a method to detect EOF in redirected input file:<div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>:nextLine<br />&nbsp; &nbsp;set line=<br />&nbsp; &nbsp;set /P line=<br />&nbsp; &nbsp;echo(%line%<br />&nbsp; &nbsp;TypeOfHandle 0<br />&nbsp; &nbsp;set /A eof=%errorlevel% ^&amp; 64<br />if %eof% == 0 goto nextLine</code></pre></div>To get TYPEOFHANDLE.COM program, insert this line at beginning of the Batch file:<div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>if not exist TypeOfHandle.com call :CreateTypeOfHandle</code></pre></div>... and this subroutine at end:<div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>:CreateTypeOfHandle<br />setlocal DisableDelayedExpansion<br />set TypeOfHandle=ëWëOë82Ò2ÿ³‹û2íŠMÿã^&gt;° üó®t7Š&#93;ÿ€û0r/€û9w*€ë02À´DÍ!rÎöÂ€tË€âëÄ€Ê€€â¿°',!´DÍ!&quot;Àu²€Ê@ŠÂ´LÍ!ë«<br />setlocal EnableDelayedExpansion<br />echo !TypeOfHandle!&gt; TypeOfHandle.com<br />exit /B<br /></code></pre></div><br /><br />P.S. - When both STDIN and STDOUT handles are redirected to disk files, this command: <strong class="text-strong">SET /P VAR=%VAR%</strong> do a simultaneous output-input operation: the previous value of VAR is sent to STDOUT (with no CR+LF) and a new value of VAR is read from STDIN.</div>
			</div>
			<hr />
					<div class="post">
				<h3>Re: Detect redirection and EOF in Standard Handles</h3>
				<div class="date">Posted: <strong>08 Nov 2014 10:40</strong></div>
				<div class="author">by <strong>siberia-man</strong></div>
				<div class="content">Seems there is no internal way to detect if a handler is redirected to a file or another pipe. <br /><br /><blockquote class="uncited"><div>With this idea as base, I wrote a very small and simple .COM program that allows to detect if a standard handle has been redirected to a disk file</div></blockquote><br /><br /><strong class="text-strong">Aacini</strong>, what if you share the original assembler code of the program? Trivial copy-and-paste method doesn't allow to believe that the stored file if the same one as you have.</div>
			</div>
			<hr />
					<div class="post">
				<h3>Re: Detect redirection and EOF in Standard Handles</h3>
				<div class="date">Posted: <strong>08 Nov 2014 15:43</strong></div>
				<div class="author">by <strong>dbenham</strong></div>
				<div class="content">I think Aacini already knows this, but the following information is still not correct.<br /><blockquote><div><cite>Aacini wrote:</cite>Remember that every DOS-Windows running program have 5 <em class="text-italics">Standard Handles</em> identified by an integer number this way: 0=STDIN (keyboard CON, redirected by &lt;), 1=STDOUT (screen CON, redirected by &gt;), 2=STDERR (screen CON, redirected by 2&gt;), 3=STDAUX (serial port AUX) and 4=STDPRN (printer PRN).<br /><br /><strong class="text-strong">EDIT:</strong> Windows documentation indicate that handles 3-9 are undefined (available), although it seems that CMD.EXE connect handle 3 to CON: device (keyboard for input, screen for output).<br /></div></blockquote><br />The above edited statement was largely due to the following behavior:<br /><div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>C:\&gt;echo Hello 1&gt;&amp;3<br />Hello<br /></code></pre></div> The output is written to the console<br /><br />But there is newer information available at <!-- m --><a class="postlink" href="http://stackoverflow.com/q/9878007/1012053">http://stackoverflow.com/q/9878007/1012053</a><!-- m -->, and <!-- l --><a class="postlink-local" href="viewtopic0809-2.html?p=14612#p14612">viewtopic.php?p=14612#p14612</a><!-- l --><br /><br />The MicroSoft docs are correct. Only handles 0, 1 and 2 are predefined. Handles 3 and above are undefined.<br /><br />It is easy to show that 4 is undefined<br /><div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>C:\&gt;echo Hello 1&gt;&amp;4<br />The handle could not be duplicated<br />during redirection of handle 1.<br /></code></pre></div><br />Handle 3 seems to point to the console, but it only seems so because the redirection temporarily stores the original definition of 1 in the first available undefined handle, which normally is 3. So it is effectively redirecting 1 to itself!<br /><br />This behavior is further demonstrated below:<br /><div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>C:\&gt;echo Hello 3&gt;nul 1&gt;&amp;4<br />Hello<br /></code></pre></div>Earlier we saw that 4 was undefined, but now it is pointing to the console <img class="smilies" src="images/smilies/icon_exclaim.gif" alt=":!:" title="Exclamation" /> This is because 3 is already taken, so the first available undefined handle is 4, so that is where the original definition of 1 is temporarily stored. When the redirection of 1 is finished, it has effectively redirected to itself.<br /><br /><br />Dave Benham</div>
			</div>
			<hr />
					<div class="post">
				<h3>Re: Detect redirection and EOF in Standard Handles</h3>
				<div class="date">Posted: <strong>09 Nov 2014 15:56</strong></div>
				<div class="author">by <strong>Aacini</strong></div>
				<div class="content">Ok. Finally I updated this program to WIN-32 API, so it is now an .exe file that run in all Windows versions. I spent several hours looking for the corresponding documentation because it is bad named/located as a <em class="text-italics">File</em> Windows function, although it is really a <em class="text-italics">Handle</em> one! <img class="smilies" src="images/smilies/icon_eek.gif" alt=":shock:" title="Shocked" />  After <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/aa364960(v=vs.85).aspx" class="postlink">the documentation</a> was found, it took me less than 10 minutes to write the new program. <img class="smilies" src="images/smilies/icon_evil.gif" alt=":evil:" title="Evil or Very Mad" /> <br /><br />The Batch file below create the new GetFileType.exe auxiliary program and describe how to use it.<br /><br /><div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>@echo off<br />setlocal EnableDelayedExpansion<br /><br />rem GetFileTypeDoc.bat: Create GetFileType.exe auxiliary program and describe it<br />rem Antonio Perez Ayala<br /><br />if not exist GetFileType.exe (<br />&nbsp; &nbsp;echo Extracting GetFileType.exe<br />&nbsp; &nbsp;call :ExtractBinaryFile GetFileType.exe<br />&nbsp; &nbsp;echo GetFileType.exe file created<br />&nbsp; &nbsp;echo/<br />)<br /><br />echo Get the file type of the given handle<br />echo/<br />echo&nbsp; &nbsp; GetFileType.exe handle<br />echo/<br />echo The result is reported via ERRORLEVEL this way:<br />echo/<br />echo -2&nbsp; &nbsp; &nbsp; No handle given or bad handle number.<br />echo -1&nbsp; &nbsp; &nbsp; The handle number is not connected to any file.<br />echo&nbsp; 0&nbsp; &nbsp; &nbsp; The type of the specified file is unknown.<br />echo&nbsp; 1&nbsp; &nbsp; &nbsp; The specified file is a disk file.<br />echo&nbsp; 2&nbsp; &nbsp; &nbsp; The specified file is a character file, typically a device or console.<br />echo&nbsp; 3&nbsp; &nbsp; &nbsp; The specified file is a socket, a named pipe, or an anonymous pipe.<br />echo/<br />echo/<br />echo Some examples:<br />echo/<br />echo C:\^&gt; GetFileType.exe 0<br />echo C:\^&gt; echo %%errorlevel%%<br />echo 2<br />echo/<br />echo C:\^&gt; GetFileType.exe 0 ^&lt; file.txt<br />echo C:\^&gt; echo %%errorlevel%%<br />echo 1<br />echo/<br />echo C:\^&gt; type file.txt ^| GetFileType.exe 0<br />echo C:\^&gt; echo %%errorlevel%%<br />echo 3<br />echo/<br />echo C:\^&gt; GetFileType.exe 3<br />echo C:\^&gt; echo %%errorlevel%%<br />echo -1<br />echo/<br />goto :EOF<br /><br /><br />rem Extract Binary File from hexadecimal digits placed in a &quot;resource&quot; in this .bat file<br /><br />:ExtractBinaryFile filename.ext&#91;.cab&#93;<br />setlocal EnableDelayedExpansion<br />set &quot;start=&quot;<br />set &quot;end=&quot;<br />for /F &quot;tokens=1,3 delims=:=&gt;&quot; %%a in ('findstr /N /B &quot;&lt;/*resource&quot; &quot;%~F0&quot;') do (<br />&nbsp; &nbsp;if not defined start (<br />&nbsp; &nbsp; &nbsp; if &quot;%%~b&quot; equ &quot;%~1&quot; set start=%%a<br />&nbsp; &nbsp;) else if not defined end set end=%%a<br />)<br />(for /F &quot;skip=%start% tokens=1* delims=:&quot; %%a in ('findstr /N &quot;^&quot; &quot;%~F0&quot;') do (<br />&nbsp; &nbsp;if &quot;%%a&quot; == &quot;%end%&quot; goto decodeHexFile<br />&nbsp; &nbsp;echo %%b<br />)) &gt; &quot;%~1.hex&quot;<br />:decodeHexFile<br /><br />rem Modified code based on :genchr subroutine<br />type nul &gt; t.tmp<br />(for /F &quot;usebackq&quot; %%a in (&quot;%~1.hex&quot;) do (<br />&nbsp; &nbsp;set input=%%a<br />&nbsp; &nbsp;set i=0<br />&nbsp; &nbsp;for /L %%I in (0,2,120) do for %%i in (!i!) do if &quot;!input:~%%i,1!&quot; neq &quot;&quot; (<br />&nbsp; &nbsp; &nbsp; set hex=!input:~%%i,2!<br />&nbsp; &nbsp; &nbsp; set /A i+=2<br />&nbsp; &nbsp; &nbsp; if &quot;!hex:~0,1!&quot; neq &quot;&#91;&quot; (<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;set /A chr=0x!hex!<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if not exist !chr!.chr call :genchr !chr!<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;type !chr!.chr<br />&nbsp; &nbsp; &nbsp; ) else (<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;for /L %%J in (1,1,5) do for %%i in (!i!) do if &quot;!input:~%%i,1!&quot; neq &quot;&#93;&quot; (<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; set &quot;hex=!hex!!input:~%%i,1!&quot;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; set /A i+=1<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;)<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if not exist 0.chr call :genchr 0<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;for /L %%J in (1,1,!hex:~1!) do type 0.chr<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;set /A i+=1<br />&nbsp; &nbsp; &nbsp; )<br />&nbsp; &nbsp;)<br />)) &gt; &quot;%~1&quot;<br />del *.chr<br />del t.tmp temp.tmp<br />del &quot;%~1.hex&quot;<br /><br />rem Expand created file if extension is .cab<br />set &quot;filename=%~1&quot;<br />if /I &quot;%filename:~-4%&quot; equ &quot;.cab&quot; (<br />&nbsp; &nbsp;expand &quot;%filename%&quot; &quot;%filename:~0,-4%&quot; &gt; NUL<br />&nbsp; &nbsp;del &quot;%filename%&quot;<br />)<br /><br />exit /B<br /><br /><br />:genchr<br />REM This code creates one single byte. Parameter: int<br />REM Teamwork of carlos, penpen, aGerman, dbenham<br />REM Tested under Win2000, XP, Win7, Win8<br />set &quot;options=/d compress=off /d reserveperdatablocksize=26&quot;<br />if %~1 neq 26 (<br />&nbsp; &nbsp;makecab %options% /d reserveperfoldersize=%~1 t.tmp %~1.chr &gt; nul<br />&nbsp; &nbsp;type %~1.chr | ( (for /l %%N in (1,1,38) do pause)&gt;nul &amp; findstr &quot;^&quot; &gt; temp.tmp )<br />&nbsp; &nbsp;&gt;nul copy /y temp.tmp /a %~1.chr /b<br />) else (<br />&nbsp; &nbsp;copy /y nul + nul /a 26.chr /a &gt;nul<br />)<br />exit /B<br /><br /><br />&lt;resource id=&quot;GetFileType.exe&quot;&gt;<br />4d5a900003&#91;3&#93;04&#91;3&#93;ffff&#91;2&#93;b8&#91;7&#93;40&#91;35&#93;b0&#91;3&#93;0e1fba0e00b409cd21b8014ccd21546869732070726f6772616d2063616e6e6f74206265207275<br />6e20696e20444f53206d6f64652e0d0d0a24&#91;7&#93;551e49c1117f2792117f2792117f27929f603492167f2792ed5f3592137f279252696368117f2792<br />&#91;8&#93;5045&#91;2&#93;4c01020066de5f54&#91;8&#93;e0000f010b01050c0002&#91;3&#93;02&#91;7&#93;10&#91;3&#93;10&#91;3&#93;20&#91;4&#93;40&#91;2&#93;10&#91;3&#93;02&#91;2&#93;04&#91;7&#93;04&#91;8&#93;30&#91;3&#93;02&#91;6&#93;03&#91;5&#93;10&#91;2&#93;10<br />&#91;4&#93;10&#91;2&#93;10&#91;6&#93;10&#91;11&#93;1420&#91;2&#93;28&#91;84&#93;20&#91;2&#93;14&#91;27&#93;2e74657874&#91;3&#93;86&#91;4&#93;10&#91;3&#93;02&#91;3&#93;02&#91;14&#93;20&#91;2&#93;602e7264617461&#91;2&#93;9c&#91;4&#93;20&#91;3&#93;02&#91;3&#93;04&#91;14&#93;<br />40&#91;2&#93;40&#91;8&#93;e83b&#91;3&#93;e85a&#91;3&#93;33c048488a1e80fb30721f80fb39771a80e30fb8f6ffffff2ac350e850&#91;3&#93;0bc07c0650e840&#91;3&#93;50e834&#91;3&#93;cccccccccccc<br />e83b&#91;3&#93;8bf08a06463c2275098a06463c2275f9eb0c8a06463c20740484c075f54ec38a06463c2074f94ec3ccff250c204000ff2500204000ff250420<br />4000ff25082040&#91;379&#93;5e20&#91;2&#93;6c20&#91;2&#93;7c20&#91;2&#93;5020&#91;6&#93;3c20&#91;10&#93;8e20&#91;3&#93;20&#91;22&#93;5e20&#91;2&#93;6c20&#91;2&#93;7c20&#91;2&#93;5020&#91;6&#93;9b004578697450726f63657373<br />001f0147657446696c6554797065006a0147657453746448616e646c65&#91;2&#93;e600476574436f6d6d616e644c696e6541006b65726e656c33322e646c6c<br />&#91;358&#93;<br />&lt;/resource&gt;<br /></code></pre></div><br />Please, report any problem you may have with this program...<br /><br />Antonio</div>
			</div>
			<hr />
			</div>

	<div id="page-footer" class="page-footer">
		<div class="page-number">All times are <span title="UTC-6">UTC-06:00</span><br />Page <strong>1</strong> of <strong>1</strong></div>
		<div class="copyright">Powered by phpBB&reg; Forum Software &copy; phpBB Limited<br />https://www.phpbb.com/</div>
	</div>
</div>

</body>

<!-- Mirrored from www.dostips.com/forum/viewtopic.php?f=3&t=2800&view=print by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 19 Oct 2018 08:31:30 GMT -->
</html>
