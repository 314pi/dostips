<!DOCTYPE html>
<html dir="ltr" lang="en-gb">

<!-- Mirrored from www.dostips.com/forum/viewtopic.php?f=3&t=7990&start=45&view=print by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 19 Oct 2018 07:21:41 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- /Added by HTTrack -->
<head>
<meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="robots" content="noindex" />

<title>DosTips.com &bull; Best way to obfuscate a Batch File? - Page 4</title>

<link href="styles/AllanStyle-SUBSILVER/theme/print.css" rel="stylesheet">
</head>
<body id="phpbb">
<div id="wrap" class="wrap">
	<a id="top" class="top-anchor" accesskey="t"></a>

	<div id="page-header">
		<h1>DosTips.com</h1>
		<p>A Forum all about DOS Batch<br /><a href="index-2.html">https://www.dostips.com/forum/</a></p>

		<h2>Best way to obfuscate a Batch File?</h2>
		<p><a href="viewtopic3379.html?f=3&amp;t=7990">https://www.dostips.com/forum/viewtopic.php?f=3&amp;t=7990</a></p>
	</div>

	<div id="page-body" class="page-body">
		<div class="page-number">Page <strong>4</strong> of <strong>5</strong></div>
					<div class="post">
				<h3>Re: Best way to obfuscate a Batch File?</h3>
				<div class="date">Posted: <strong>01 Sep 2017 19:40</strong></div>
				<div class="author">by <strong>penpen</strong></div>
				<div class="content"><blockquote><div><cite>Kvc wrote:</cite>But, Are you sure - it is not the problem of having java installed in the PC? (just curious) </div></blockquote>Java and JavaScript are different languages at all:<br />So you don't need to install Java, and even if you would do so, it won't help:<br /><br />Beside this Daves javascript code is created to be run by the JScript Engine of the Windows Scripting Host (WSH).<br />I think this should state for most of the java script snipplets here on dostips.<br />Because of that the batch files execute such scripts using &quot;cscript.exe&quot; (or &quot;wscipt.exe&quot;).<br /><br />I don't know if any other JavaScript scripting engine is able to access the needed COM interfaces of the WSH, but i doubt it.<br /><br />If i remember right, then the WSH should be preinstalled on any system since Windows XP.<br />If i'm wrong, then you have to install the .NET-Framework under Windows XP, but it is preinstalled since Windows Vista.<br /><br />Sidenotes:<br />JScript is Microsoft's dialect of the ECMAScript.<br />ECMAScript is standardized JavaScript.<br /><br /><br />penpen</div>
			</div>
			<hr />
					<div class="post">
				<h3>Re: Best way to obfuscate a Batch File?</h3>
				<div class="date">Posted: <strong>02 Sep 2017 03:13</strong></div>
				<div class="author">by <strong>PaperTronics</strong></div>
				<div class="content">I'm sorry for my act of foolishness back at my previous reply. <br /><br />I thought that the whole JS and Batch code of the ObfuscateBat plugin would need to be changed, so that's why I asked Dave to do it himself, since he knows how the Batch File works better than me. <br /><br />But since Dave cleared my doubt now, that only 1 dot would solve the problem, I take back my request and I apologize for any of my mistake. <br /><br /><br /><br /><br />PaperTronics</div>
			</div>
			<hr />
					<div class="post">
				<h3>Re: Best way to obfuscate a Batch File?</h3>
				<div class="date">Posted: <strong>02 Sep 2017 11:25</strong></div>
				<div class="author">by <strong>Squashman</strong></div>
				<div class="content"><blockquote><div><cite>Kvc wrote:</cite>.But, Are you sure - it is not the problem of having java installed in the PC? (just curious) <br /><br /></div></blockquote><br />Why is this even remotely Dave's problem or even be of his concern?</div>
			</div>
			<hr />
					<div class="post">
				<h3>Re: Best way to obfuscate a Batch File?</h3>
				<div class="date">Posted: <strong>02 Sep 2017 21:08</strong></div>
				<div class="author">by <strong>Kvc</strong></div>
				<div class="content"><blockquote><div><cite>Squashman wrote:</cite>Why is this even remotely Dave's problem or even be of his concern?</div></blockquote><br /><br />Asking for help doesn't make my problem yours... You have the right to refuse to help. <br />If I'm trying to help others differently - from the different website... doesn't make me an alien from another planet. I'm also a regular guy as you all. And, as I've said earlier in the first message... <br /><br /><blockquote class="uncited"><div>Pardon me for Bothering you all...</div></blockquote><br /><br />Is there any problem with me asking questions? Or You it is just about I'm the new guy?  <img class="smilies" src="images/smilies/icon_rolleyes.gif" alt=":roll:" title="Rolling Eyes" /> <br /><br /><blockquote class="uncited"><div>We were born into this world with no sense of what we could or couldn't do. Then, bit by bit, life started to teach you how to fight our own battle. Learn to deal with the inner negative voice, flip a weakness into a strength, be our own motivational coach and develop our super powers. The last laugh is ours.</div></blockquote></div>
			</div>
			<hr />
					<div class="post">
				<h3>Re: Best way to obfuscate a Batch File?</h3>
				<div class="date">Posted: <strong>03 Sep 2017 05:01</strong></div>
				<div class="author">by <strong>Kvc</strong></div>
				<div class="content">@penpen<br />Woah.... I Didn't know that... Now I understand little about the things around... I really appreciate. Thanks for your time. <img class="smilies" src="images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>
			</div>
			<hr />
					<div class="post">
				<h3>Re: Best way to obfuscate a Batch File?</h3>
				<div class="date">Posted: <strong>02 Oct 2017 03:17</strong></div>
				<div class="author">by <strong>cya</strong></div>
				<div class="content">@aGerman<br />hi steffen, your method to prepend hex bytes to a batch file was really interesting.<br />1) is there any table to use Korean, French, Russian, Lithuanian, Danish, Swedish charset instead of Chinese?<br />2) is there any possibility to prepend this hex bytes to a file, straightly, without relying on certutil?(to avoid errors on different systems), even I have some program that can add some bytes to a file, I tried to add 'FF FE 26 63 6C 73 0D 0A' to a simple text file, but it didn't work. I think adding hex bytes is probably different.<br />Any way, if there is a way to add these bytes to a file, straightly and automatically from batch or a program please explain... .<br /><br />Thank you very much, for your interesting info</div>
			</div>
			<hr />
					<div class="post">
				<h3>Re: Best way to obfuscate a Batch File?</h3>
				<div class="date">Posted: <strong>02 Oct 2017 04:52</strong></div>
				<div class="author">by <strong>aGerman</strong></div>
				<div class="content"><blockquote><div><cite>cya wrote:</cite>1) is there any table to use Korean, French, Russian, Lithuanian, Danish, Swedish charset instead of Chinese?</div></blockquote><br />No. Prepending the Byte Order Mark to the text does <strong class="text-strong">not</strong> change the text itself. As I said it's still perfectly readable in a HEX editor. Only the text editor interprets now two bytes each as a character instead of only one. As you may have noticed not all resulting characters are Chinese characters. It always depends on the original text.<br /><br /><blockquote><div><cite>cya wrote:</cite>2) is there any possibility to prepend this hex bytes to a file, straightly, without relying on certutil?(to avoid errors on different systems)</div></blockquote><br />The reason why I used certutil is to avoid errors on different systems. More specific - to avoid errors on systems with different locale settings.<br />If (and only if) the codepage used by your text editor is Windows-1252 the following code may work to write the UTF-16 LE BOM to a file<br /><div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>set &quot;filename=test.txt&quot;<br />:: save the current OEM codepage<br />for /f &quot;tokens=2 delims=:&quot; %%i in ('chcp') do set /a oemcp = %%~ni<br />:: switch to Windows-1252<br />chcp 1252&gt;nul<br />:: create the Byte Order Mark (UTF-16 little endian)<br />&gt;&quot;%filename%&quot; set /p &quot;=ÿþ&quot;&lt;nul<br />:: switch back to OEM<br />chcp %oemcp%&gt;nul<br /></code></pre></div><br />Now you can append the content of another file to test.txt.<br /><br />Steffen</div>
			</div>
			<hr />
					<div class="post">
				<h3>Re: Best way to obfuscate a Batch File?</h3>
				<div class="date">Posted: <strong>05 Oct 2017 02:01</strong></div>
				<div class="author">by <strong>cya</strong></div>
				<div class="content">@aGerman Thank you for your precious information and also your time.  <br />is the following code, right? (without automatic saving and switching back to current code page)<br /><br /><br /><div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>@echo off<br />chcp 1252&gt;nul<br />echo &quot;ÿþ&quot;&gt;c:\file.txt&nbsp; &nbsp; ----(some thing simple like this needed, why should I &#91;set /p &quot;=ÿþ&quot;&lt;nul &gt;&quot;c:\test.txt&quot;&#93;)<br />chcp 437&gt;nul<br />echo hi&gt;&gt;c:\test.txt<br />exit</code></pre></div><br /><br />thanks</div>
			</div>
			<hr />
					<div class="post">
				<h3>Re: Best way to obfuscate a Batch File?</h3>
				<div class="date">Posted: <strong>05 Oct 2017 12:33</strong></div>
				<div class="author">by <strong>aGerman</strong></div>
				<div class="content"><blockquote><div><cite>cya wrote:</cite>why should I</div></blockquote><br />Because ECHO always creates a line break at the end while SET /P ... &lt;NUL does not.<br /><br />Steffen</div>
			</div>
			<hr />
					<div class="post">
				<h3>Re: Best way to obfuscate a Batch File?</h3>
				<div class="date">Posted: <strong>11 Oct 2017 10:49</strong></div>
				<div class="author">by <strong>dbenham</strong></div>
				<div class="content">I modified my obfuscateBatch.bat script to better obscure the character mapping at the top of the resultant obfuscated code.<br /><br />Version 1.2 is available at <!-- l --><a class="postlink-local" href="viewtopic944d.html?f=3&amp;t=7990&amp;p=53278#p53278">viewtopic.php?f=3&amp;t=7990&amp;p=53278#p53278</a><!-- l --><br /><br />Here are the original lines at the top of the obfuscated file that make it pretty easy (but very tedious) to translate the code<br /><div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>set &quot;@lo@= !#$&amp;'()*+,-./0123456789:;&lt;=&gt;?@ABCDEFGHIJKLMNOPQRSTUVWXYZ&#91;\&#93;^_`abcdefghijklmnopqrstuvwxyz{|}~&quot;&quot;<br />set &quot;@hi@=¡¢¤¥§¨©ª«¬­®¯°±²³´µ¶·¸¹º»¼½¾¿ÀÁÂÃÄÅÆÇÈÉÊËÌÍÎÏÐÑÒÓÔÕÖ×ØÙÚÛÜÝÞßàáâãäåæçèéêëìíîïðñòóôõö÷øùúûüýþÿ£&quot;<br /></code></pre></div><br /><br />And here is the modified form from version 1.2 that better obscures the mapping:<br /><div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>set &quot;@lo@= !#$&amp;'()*+,-./0123456789:;&lt;=&gt;?@ABCDEFGHIJKLMNOPQRSTUVWXYZ&#91;\&#93;^_`abcdefghijklmnopqrstuvwxyz{|}~&quot;&quot;<br />set &quot;@hi@=%=%¡%=%¢%=%¤%=%¥%=%§%=%¨%=%©%=%ª%=%«%=%¬%=%­%=%®%=%¯%=%°%=%±%=%²%=%³%=%´%=%µ%=%¶%=%·%=%¸%=%¹%=%º%=%»%=%¼%=%½%=%¾%=%¿%=%À%=%Á%=%Â%=%Ã%=%Ä%=%Å%=%Æ%=%Ç%=%È%=%É%=%Ê%=%Ë%=%Ì%=%Í%=%Î%=%Ï%=%Ð%=%Ñ%=%Ò%=%Ó%=%Ô%=%Õ%=%Ö%=%×%=%Ø%=%Ù%=%Ú%=%Û%=%Ü%=%Ý%=%Þ%=%ß%=%à%=%á%=%â%=%ã%=%ä%=%å%=%æ%=%ç%=%è%=%é%=%ê%=%ë%=%ì%=%í%=%î%=%ï%=%ð%=%ñ%=%ò%=%ó%=%ô%=%õ%=%ö%=%÷%=%ø%=%ù%=%ú%=%û%=%ü%=%ý%=%þ%=%ÿ%=%£%=%&quot;<br /></code></pre></div><br /><br />Dave Benham</div>
			</div>
			<hr />
					<div class="post">
				<h3>Re: Best way to obfuscate a Batch File?</h3>
				<div class="date">Posted: <strong>11 Oct 2017 11:46</strong></div>
				<div class="author">by <strong>Squashman</strong></div>
				<div class="content">Dave, I started working on creating the decoding of the obfuscated batch file into a second batch file and put a call to that batch file.<br /><br />Mybatobfuscated.bat<br /><div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>@echo off<br />if defined @lo@ goto ¡<br />CALL Unobfuscate.bat &quot;%0&quot; &quot;%~1&quot;<br />exit /b<br />:¡<br /><br />%Á%%æ%%ä%%é%%ð%%¡%%ð%%ç%%ç%<br />%ô%%æ%%õ%%í%%ð%%ä%%â%%í%%¡%%æ%%ï%%â%%ã%%í%%æ%%å%%æ%%í%%â%%ú%%æ%%å%%æ%%ù%%ñ%%â%%ï%%ô%%ê%%ð%%ï%<br /><br />%Ó%%Æ%%Î%%¡%%ô%%æ%%õ%%¡%%ç%%ê%%í%%æ%%¡%%ï%%â%%î%%æ%<br />%ô%%æ%%õ%%¡%%£%%ç%%ï%%¾%%~n1%£%<br />.............. truncated for brevity</code></pre></div><br />And then the Unobfuscate.bat<br /><div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>@echo off<br />chcp 708&gt;nul<br />set &quot;@lo@= !#$&amp;'()*+,-./0123456789:;&lt;=&gt;?@ABCDEFGHIJKLMNOPQRSTUVWXYZ&#91;\&#93;^_`abcdefghijklmnopqrstuvwxyz{|}~&quot;&quot;<br />set &quot;@hi@=¡¢¤¥§¨©ª«¬­®¯°±²³´µ¶·¸¹º»¼½¾¿ÀÁÂÃÄÅÆÇÈÉÊËÌÍÎÏÐÑÒÓÔÕÖ×ØÙÚÛÜÝÞßàáâãäåæçèéêëìíîïðñòóôõö÷øùúûüýþÿ£&quot;<br />setlocal enableDelayedExpansion<br />(for /l %%N in (0 1 93) do set &quot;!@hi@:~%%N,1!=!@lo@:~%%N,1!&quot;)&amp;cmd /c %*</code></pre></div><br /><br />It sort of works.  I can't get it to pass back any command line arguments.  Not sure what I am doing wrong with that.<br /><br />Just one more way to help obfuscate it in case someone does get a hold of the batch file. They won't have the code to decode it.</div>
			</div>
			<hr />
					<div class="post">
				<h3>Re: Best way to obfuscate a Batch File?</h3>
				<div class="date">Posted: <strong>11 Oct 2017 13:49</strong></div>
				<div class="author">by <strong>dbenham</strong></div>
				<div class="content">Here is how I would do that. My testing shows that it preserves quoted arguments just fine.<br /><br />Better to transfer control to Unobfuscate.bat, without CALL. This way there is no need for EXIT /B or GOTO :Label.<br />I went with the version 1.2 definition of @hi@ to better hide the mapping, just in case a user looks at that source code.<br /><br />Mybatobfuscated.bat<br /><div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>@if not defined @lo@ Unobfuscate.bat &quot;%~f0&quot; %*<br />%Á%%æ%%ä%%é%%ð%%¡%%ð%%ç%%ç%<br />%ô%%æ%%õ%%í%%ð%%ä%%â%%í%%¡%%æ%%ï%%â%%ã%%í%%æ%%å%%æ%%í%%â%%ú%%æ%%å%%æ%%ù%%ñ%%â%%ï%%ô%%ê%%ð%%ï%<br /><br />%Ó%%Æ%%Î%%¡%%ô%%æ%%õ%%¡%%ç%%ê%%í%%æ%%¡%%ï%%â%%î%%æ%<br />%ô%%æ%%õ%%¡%%£%%ç%%ï%%¾%%~n1%£%<br />.............. truncated for brevity<br /></code></pre></div><br />Unobfuscate.bat<br /><div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>@echo off<br />setlocal disableDelayedExpansion<br />for /f &quot;delims=:. tokens=2&quot; %%A in ('chcp') do set &quot;@chcp@=chcp %%A&gt;nul&quot;<br />chcp 708&gt;nul<br />set &quot;@lo@= !#$&amp;'()*+,-./0123456789:;&lt;=&gt;?@ABCDEFGHIJKLMNOPQRSTUVWXYZ&#91;\&#93;^_`abcdefghijklmnopqrstuvwxyz{|}~&quot;&quot;<br />set &quot;@hi@=%=%¡%=%¢%=%¤%=%¥%=%§%=%¨%=%©%=%ª%=%«%=%¬%=%­%=%®%=%¯%=%°%=%±%=%²%=%³%=%´%=%µ%=%¶%=%·%=%¸%=%¹%=%º%=%»%=%¼%=%½%=%¾%=%¿%=%À%=%Á%=%Â%=%Ã%=%Ä%=%Å%=%Æ%=%Ç%=%È%=%É%=%Ê%=%Ë%=%Ì%=%Í%=%Î%=%Ï%=%Ð%=%Ñ%=%Ò%=%Ó%=%Ô%=%Õ%=%Ö%=%×%=%Ø%=%Ù%=%Ú%=%Û%=%Ü%=%Ý%=%Þ%=%ß%=%à%=%á%=%â%=%ã%=%ä%=%å%=%æ%=%ç%=%è%=%é%=%ê%=%ë%=%ì%=%í%=%î%=%ï%=%ð%=%ñ%=%ò%=%ó%=%ô%=%õ%=%ö%=%÷%=%ø%=%ù%=%ú%=%û%=%ü%=%ý%=%þ%=%ÿ%=%£%=%&quot;<br />setlocal enableDelayedExpansion<br />for /l %%N in (0 1 93) do set &quot;!@hi@:~%%N,1!=!@lo@:~%%N,1!&quot;)<br />setlocal disableDelayedExpansion<br />cmd /c ^&quot;%*&quot;<br />%@chcp@%<br />exit /b<br /></code></pre></div><br /><br />Dave Benam</div>
			</div>
			<hr />
					<div class="post">
				<h3>Re: Best way to obfuscate a Batch File?</h3>
				<div class="date">Posted: <strong>11 Oct 2017 14:11</strong></div>
				<div class="author">by <strong>Squashman</strong></div>
				<div class="content"><blockquote><div><cite>dbenham wrote:</cite>Here is how I would do that. My testing shows that it preserves quoted arguments just fine.<br /><br />Better to transfer control to Unobfuscate.bat, without CALL. This way there is no need for EXIT /B or GOTO :Label.<br />I went with the version 1.2 definition of @hi@ to better hide the mapping, just in case a user looks at that source code.</div></blockquote><br />So this is going to be an option to create two batch files in version 1.3 <img class="smilies" src="images/smilies/icon_question.gif" alt=":?:" title="Question" />   <img class="smilies" src="images/smilies/icon_lol.gif" alt=":lol:" title="Laughing" /></div>
			</div>
			<hr />
					<div class="post">
				<h3>Re: Best way to obfuscate a Batch File?</h3>
				<div class="date">Posted: <strong>11 Oct 2017 20:11</strong></div>
				<div class="author">by <strong>dbenham</strong></div>
				<div class="content">I just realized that the obfuscated script without the map could be made even more cryptic by injecting random undefined variable expansion between each character of the first line.<br />So the obfuscated script could look like:<br /><div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>%#=%@%a=%i%o=%f%b=% %n=%n%t=%o%r=%t%a=% %c=%d%u=%e%i=%f%e=%i%f=%n%p=%e%n=%d%s=% %;=%@%O=%l%r=%o%e=%@%s=% %S=%U%E=%n%n=%o%s=%b%c=%f%g=%u%y=%s%z=%c%b=%a%r=%t%u=%e%s=%.%a=%b%c=%a%b=%t%c=% %d=%&quot;%&quot;=%%~f0%@=%&quot;%&quot;=% %&#91;=%%*%&#93;=%<br />%Á%%æ%%ä%%é%%ð%%¡%%ð%%ç%%ç%<br />%ô%%æ%%õ%%í%%ð%%ä%%â%%í%%¡%%æ%%ï%%â%%ã%%í%%æ%%å%%æ%%í%%â%%ú%%æ%%å%%æ%%ù%%ñ%%â%%ï%%ô%%ê%%ð%%ï%<br /><br />%Ó%%Æ%%Î%%¡%%ô%%æ%%õ%%¡%%ç%%ê%%í%%æ%%¡%%ï%%â%%î%%æ%<br />%ô%%æ%%õ%%¡%%£%%ç%%ï%%¾%%~n1%£%<br />.............. truncated for brevity<br /></code></pre></div><br /><br />But I don't think I want to promote the Unobfuscate solution. Sure, the map is not embedded within the obfuscated script, but it is too easy for a user to generate an unobfuscation map by running the following:<br /><div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>unobfuscate set &gt;unobfuscate_map.txt<br /></code></pre></div><br />I think it is better to have everything self-contained within each obfuscated script. I can still use the random undefined variable expansion trick to make the initialization difficult to read. A user could still get the map, but the user would have to figure out where to inject some code. Still not difficult for an experienced person, but probably intimidating for the average user.<br /><br /><br />Dave</div>
			</div>
			<hr />
					<div class="post">
				<h3>Re: Best way to obfuscate a Batch File?</h3>
				<div class="date">Posted: <strong>12 Oct 2017 06:41</strong></div>
				<div class="author">by <strong>PaperTronics</strong></div>
				<div class="content">@dbenham - It's great that even the beginning character mapping lines of the code can be encrypted too.<br /><br />I was a bit worried about that if the user reads and understands the character mapping lines, they could decode the code in just a few hours/days (depending on the length of the code). But I didn't say anything about it because I had discontinued the coding of the program that I needed to use your obfuscating script on.  <br /><br />I have no use for it still, but in the future I will (wow that rhymes!  <img class="smilies" src="images/smilies/icon_mrgreen.gif" alt=":mrgreen:" title="Mr. Green" />). So I still keep checking on this topic whenever there's a new post. <br /><br /><br /><br /><br />Cheers,<br />PaperTronics</div>
			</div>
			<hr />
			</div>

	<div id="page-footer" class="page-footer">
		<div class="page-number">All times are <span title="UTC-6">UTC-06:00</span><br />Page <strong>4</strong> of <strong>5</strong></div>
		<div class="copyright">Powered by phpBB&reg; Forum Software &copy; phpBB Limited<br />https://www.phpbb.com/</div>
	</div>
</div>

</body>

<!-- Mirrored from www.dostips.com/forum/viewtopic.php?f=3&t=7990&start=45&view=print by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 19 Oct 2018 07:21:41 GMT -->
</html>
