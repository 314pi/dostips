<!DOCTYPE html>
<html dir="ltr" lang="en-gb">

<!-- Mirrored from www.dostips.com/forum/viewtopic.php?p=32476 by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 19 Oct 2018 09:17:49 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- /Added by HTTrack -->
<head>
<meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1" />

<title>ReturnVar macro revisited - Page 2 - DosTips.com</title>


	<link rel="canonical" href="viewtopic1afe.html?t=5013&amp;start=15">

<!--
	phpBB style name: Allan Style - SUBSILVER
	Based on style:   prosilver (this is the default phpBB3 style)
	Based on style:   subsilver2 (this is the default phpBB3 style)
	Original author:  Tom Beddard ( http://www.subBlue.com/ )
	Modified by:  Allan ( http://x-tk.ru/ )
-->

<link href="assets/css/font-awesome.mind772.css?assets_version=34" rel="stylesheet">
<link href="styles/AllanStyle-SUBSILVER/theme/stylesheetd772.css?assets_version=34" rel="stylesheet">
<link href="styles/AllanStyle-SUBSILVER/theme/en/stylesheetd772.css?assets_version=34" rel="stylesheet">




<!--[if lte IE 9]>
	<link href="./styles/AllanStyle-SUBSILVER/theme/tweaks.css?assets_version=34" rel="stylesheet">
<![endif]-->




<script>
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','../../www.google-analytics.com/analytics.js','ga');

	ga('create', 'UA-280191-1', 'auto');
	ga('send', 'pageview');
</script>

</head>
<body id="phpbb" class="nojs notouch section-viewtopic ltr ">

<div id="header-subsilver">
	<a id="top" class="top-anchor" accesskey="t"></a>
		<div class="headerbar" role="banner">
					<div class="inner">

			<div id="site-description" class="site-description">
				<a id="logo" class="logo" href="../index.html" title="DosTips.com"><span class="site_logo"></span></a>
				<h1>DosTips.com</h1>
				<p>A Forum all about DOS Batch</p>
				<p class="skiplink"><a href="#start_here">Skip to content</a></p>
			</div>

									<div id="search-box" class="search-box search-header" role="search">
				<form action="https://www.dostips.com/forum/search.php" method="get" id="search">
				<fieldset>
					<input name="keywords" id="keywords" type="search" maxlength="128" title="Search for keywords" class="inputbox search tiny" size="20" value="" placeholder="Search…" />
					<button class="button button-search" type="submit" title="Search">
						<i class="icon fa-search fa-fw" aria-hidden="true"></i><span class="sr-only">Search</span>
					</button>
					<a href="search.html" class="button button-search-end" title="Advanced search">
						<i class="icon fa-cog fa-fw" aria-hidden="true"></i><span class="sr-only">Advanced search</span>
					</a>
					
				</fieldset>
				</form>
			</div>
						
			</div>
					</div>
</div>


<div id="wrap" class="wrap">
	<div id="page-header">
				<div class="navbar-top" role="navigation">
	<div class="inner">

	<ul id="nav-main" class="nav-main linklist" role="menubar">

		<li id="quick-links" class="quick-links dropdown-container responsive-menu" data-skip-responsive="true">
			<a href="#" class="dropdown-trigger">
				<i class="icon fa-bars fa-fw" aria-hidden="true"></i><span>Quick links</span>
			</a>
			<div class="dropdown">
				<div class="pointer"><div class="pointer-inner"></div></div>
				<ul class="dropdown-contents" role="menu">
					
											<li class="separator"></li>
																									<li>
								<a href="search33a7.html?search_id=unanswered" role="menuitem">
									<i class="icon fa-file-o fa-fw icon-gray" aria-hidden="true"></i><span>Unanswered topics</span>
								</a>
							</li>
							<li>
								<a href="search526f.html?search_id=active_topics" role="menuitem">
									<i class="icon fa-file-o fa-fw icon-blue" aria-hidden="true"></i><span>Active topics</span>
								</a>
							</li>
							<li class="separator"></li>
							<li>
								<a href="search.html" role="menuitem">
									<i class="icon fa-search fa-fw" aria-hidden="true"></i><span>Search</span>
								</a>
							</li>
					
											<li class="separator"></li>
																			<li>
								<a href="memberlist4bfd.html?mode=team" role="menuitem">
									<i class="icon fa-shield fa-fw" aria-hidden="true"></i><span>The team</span>
								</a>
							</li>
																<li class="separator"></li>

									</ul>
			</div>
		</li>

				<li data-skip-responsive="true">
			<a href="app.php/help/faq.html" rel="help" title="Frequently Asked Questions" role="menuitem">
				<i class="icon fa-question-circle fa-fw" aria-hidden="true"></i><span>FAQ</span>
			</a>
		</li>
						
			<li class="rightside"  data-skip-responsive="true">
			<a href="ucp26c3.html?mode=login" title="Login" accesskey="x" role="menuitem">
				<i class="icon fa-power-off fa-fw" aria-hidden="true"></i><span>Login</span>
			</a>
		</li>
					<li class="rightside" data-skip-responsive="true">
				<a href="ucp8319.html?mode=register" role="menuitem">
					<i class="icon fa-pencil-square-o  fa-fw" aria-hidden="true"></i><span>Register</span>
				</a>
			</li>
						</ul>

	</div>
</div>

<div class="navbar" role="navigation">
	<div class="inner">

	<ul id="nav-breadcrumbs" class="nav-breadcrumbs linklist navlinks" role="menubar">
						<li class="breadcrumbs">
							<span class="crumb"  itemtype="http://data-vocabulary.org/Breadcrumb" itemscope=""><a href="../index.html" itemprop="url" data-navbar-reference="home"><i class="icon fa-home fa-fw" aria-hidden="true"></i><span itemprop="title">DosTips.com</span></a></span>
										<span class="crumb"  itemtype="http://data-vocabulary.org/Breadcrumb" itemscope=""><a href="index.html" itemprop="url" accesskey="h" data-navbar-reference="index"><span itemprop="title">Board index</span></a></span>

											<span class="crumb"  itemtype="http://data-vocabulary.org/Breadcrumb" itemscope="" data-forum-id="4"><a href="viewforum31e6.html?f=4" itemprop="url"><span itemprop="title">DosTips - Dos Batch</span></a></span>
															<span class="crumb"  itemtype="http://data-vocabulary.org/Breadcrumb" itemscope="" data-forum-id="3"><a href="viewforum4d6b.html?f=3" itemprop="url"><span itemprop="title">DOS Batch Forum</span></a></span>
												</li>
		
					<li class="rightside responsive-search">
				<a href="search.html" title="View the advanced search options" role="menuitem">
					<i class="icon fa-search fa-fw" aria-hidden="true"></i><span class="sr-only">Search</span>
				</a>
			</li>
			</ul>

	</div>
</div>

<div class="navbar-top-link">
	<div class="inner">
		<ul>
			<li class="navbar-top-link-left"><a href="search33a7.html?search_id=unanswered">Unanswered topics</a></li>
			<li class="navbar-top-link-left"><a href="search526f.html?search_id=active_topics">Active topics</a></li>

											</ul>
	</div>
</div>
	</div>

	
	<a id="start_here" class="anchor"></a>
	<div id="page-body" class="page-body" role="main">
		
		
<h2 class="topic-title"><a href="viewtopic3d71.html?f=3&amp;t=5013&amp;start=15">ReturnVar macro revisited</a></h2>
<!-- NOTE: remove the style="display: none" when you want to have the forum description on the topic body -->
<div style="display: none !important;">Discussion forum for all Windows batch related topics.<br /></div>
<p>
	<strong>Moderator:</strong> <a href="memberlista6a8.html?mode=viewprofile&amp;u=5" class="username">DosItHelp</a>
</p>


<div class="action-bar bar-top">
	
			<a href="posting2fff.html?mode=reply&amp;f=3&amp;t=5013" class="button" title="Post a reply">
							<span>Post Reply</span> <i class="icon fa-reply fa-fw" aria-hidden="true"></i>
					</a>
	
			<div class="dropdown-container dropdown-button-control topic-tools">
		<span title="Topic tools" class="button button-secondary dropdown-trigger dropdown-select">
			<i class="icon fa-wrench fa-fw" aria-hidden="true"></i>
			<span class="caret"><i class="icon fa-sort-down fa-fw" aria-hidden="true"></i></span>
		</span>
		<div class="dropdown">
			<div class="pointer"><div class="pointer-inner"></div></div>
			<ul class="dropdown-contents">
																												<li>
					<a href="viewtopic22e5.html?f=3&amp;t=5013&amp;start=15&amp;view=print" title="Print view" accesskey="p">
						<i class="icon fa-print fa-fw" aria-hidden="true"></i><span>Print view</span>
					</a>
				</li>
											</ul>
		</div>
	</div>
	
			<div class="search-box" role="search">
			<form method="get" id="topic-search" action="https://www.dostips.com/forum/search.php">
			<fieldset>
				<input class="inputbox search tiny"  type="search" name="keywords" id="search_keywords" size="20" placeholder="Search this topic…" />
				<button class="button button-search" type="submit" title="Search">
					<i class="icon fa-search fa-fw" aria-hidden="true"></i><span class="sr-only">Search</span>
				</button>
				<a href="search.html" class="button button-search-end" title="Advanced search">
					<i class="icon fa-cog fa-fw" aria-hidden="true"></i><span class="sr-only">Advanced search</span>
				</a>
				<input type="hidden" name="t" value="5013" />
<input type="hidden" name="sf" value="msgonly" />

			</fieldset>
			</form>
		</div>
	
			<div class="pagination">
			31 posts
							<ul>
			<li class="arrow previous"><a class="button button-icon-only" href="viewtopiceac1-2.html?f=3&amp;t=5013" rel="prev" role="button"><i class="icon fa-chevron-left fa-fw" aria-hidden="true"></i><span class="sr-only">Previous</span></a></li>
				<li><a class="button" href="viewtopiceac1-2.html?f=3&amp;t=5013" role="button">1</a></li>
			<li class="active"><span>2</span></li>
				<li><a class="button" href="viewtopic434f.html?f=3&amp;t=5013&amp;start=30" role="button">3</a></li>
				<li class="arrow next"><a class="button button-icon-only" href="viewtopic434f.html?f=3&amp;t=5013&amp;start=30" rel="next" role="button"><i class="icon fa-chevron-right fa-fw" aria-hidden="true"></i><span class="sr-only">Next</span></a></li>
	</ul>
					</div>
		</div>




<div id="subsilver-nav-topic">
	<div class="inner"><div class="post has-profile">
		<div class="leftsided postbody subsilver-topic-title">Message</div>
		<div class="leftsided postprofile subsilver-topic-author">Author</div>
	</div></div>
</div>

			<div id="p29669" class="post has-profile bg2">
		<div class="inner">

		<dl class="postprofile" id="profile29669">
			<dt class="has-profile-rank no-avatar">
				<div class="avatar-container">
																			</div>
								<a href="memberlist7125.html?mode=viewprofile&amp;u=417" class="username">jeb</a>							</dt>

						<dd class="profile-rank">Expert</dd>			
		<dd class="profile-posts"><strong>Posts:</strong> <a href="search73f1.html?author_id=417&amp;sr=posts">880</a></dd>		<dd class="profile-joined"><strong>Joined:</strong> 30 Aug 2007 08:05</dd>		
		
											<dd class="profile-custom-field profile-phpbb_location"><strong>Location:</strong> Germany, Bochum</dd>
							
						
		</dl>

		<div class="postbody">
						<div id="post_content29669">

						<h3 class="first"><a href="#p29669">Re: ReturnVar macro revisited</a></h3>

													<ul class="post-buttons">
																																									<li>
							<a href="postingcfc8.html?mode=quote&amp;f=3&amp;p=29669" title="Reply with quote" class="button button-icon-only">
								<i class="icon fa-quote-left fa-fw" aria-hidden="true"></i><span class="sr-only">Quote</span>
							</a>
						</li>
														</ul>
							
						<p class="author"><span class="posti"><a href="viewtopic171a-2.html?p=29669#p29669" onclick="prompt('Message #16',this.href); return false;">#16</a></span> 
									<a class="unread" href="viewtopic171a-2.html?p=29669#p29669" title="Post">
						<i class="icon fa-file fa-fw icon-lightgray icon-md" aria-hidden="true"></i><span class="sr-only">Post</span>
					</a>
								<span class="responsive-hide">by <strong><a href="memberlist7125.html?mode=viewprofile&amp;u=417" class="username">jeb</a></strong> &raquo; </span>04 Nov 2013 06:15
			</p>
			
			
			
			<div class="content">Hi carlsomo,<br /><br />I was very supressed, that you solved my main problem, to return linefeed AND Carriage return to a disabled context without a helper function  <img class="smilies" src="images/smilies/icon_biggrin.gif" alt=":D" title="Very Happy" /> <br /><br />But after examing the code I didn't understand why it should work<br /><div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>if defined _#_$_dis for /f &quot;delims=&quot; %%A in (!%%N!) do @endlocal ^&amp; @set &quot;%%~N=%%A&quot;%\n%</code></pre></div><br />This main line seems to work for you, but my expectations said that this is impossible, as a FOR/F can't tranfser a line feed.<br /><br />After searching a bit, I found the bug. The macro never returns to a disbaled context <img class="smilies" src="images/smilies/icon_sad.gif" alt=":(" title="Sad" /><br />You used the clever idea to add the **_#_$_dis** variable, but the for loop never executes anything, as **!%%N!** is always empty <img class="smilies" src="images/smilies/icon_exclaim.gif" alt=":!:" title="Exclamation" /> <br /><br />%%N contains in the tests &quot;result&quot; with the quotes, so <br />!%%N! -&gt;&gt; !&quot;result&quot;! -&gt;&gt; &lt;empty&gt;<br /><br />I change the test banch a bit, so this types of bugs will be found sooner.<br /><br /><div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>:TestReturnVar.bat<br />@echo off<br />cls<br />setlocal DisableDelayedExpansion<br />if not defined ReturnVar call :ReturnVar<br />set /a test_cnt=0<br />set &quot;test1=^a!&quot;^^b&quot;<br />set &quot;test2=caret^&quot;<br />set &quot;test3=&quot;<br />set &quot;test4====Equals&quot;<br />@rem&nbsp; &nbsp; &nbsp; &nbsp; &amp;&quot;&amp;^&amp;!!!^^%^!<br />set&nbsp; test5=^&amp;&quot;&amp;^&amp;!!!^^%%^!<br />setlocal enabledelayedexpansion<br />set &quot;test6=Hello &amp;^^ &quot;^^^^&nbsp; ^&amp;&quot; world^!!CR!*!LF!X&quot;<br />@echo off&amp;echo(<br /><br />for /L %%n in (1 1 6) do (<br />&nbsp; &nbsp;call :Test_Both test%%n<br />)<br />exit /b<br /><br />:Test_Both<br />setlocal EnableDelayedExpansion<br />echo Test now&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; %1='!%1!'<br />endlocal<br />call :Test_context Disable Disable %1<br />call :Test_context Disable Enable&nbsp; %1<br />call :Test_context Enable&nbsp; Disable %1<br />call :Test_context Enable&nbsp; Enable&nbsp; %1<br />echo(<br />exit /b<br /><br />:Test_context<br />set /a test_cnt+=1<br />setlocal %1DelayedExpansion<br />set &quot;result=not set by macro&quot;<br />call :startTest %1 %2 %3<br /><br />REM Output the result<br />setlocal enabledelayedexpansion<br />if &quot;!result!&quot;==&quot;!%~3!&quot; (<br />&nbsp; &nbsp;set &quot;postfix=OK&quot;<br />) ELSE (<br />&nbsp; &nbsp; set postfix=FAIL<br />)<br />set &quot;format1=&nbsp; Test #!test_cnt! &quot;<br />set &quot;format2=%1/%2&nbsp; &quot;<br />echo !format1:~0,10! !format2:~0,15! result='!result!'&nbsp; &nbsp; - !postfix! !level!<br />endlocal<br /><br />endlocal<br />exit /b<br /><br />:startTest<br />setlocal %2DelayedExpansion<br />%ReturnVar% result %3 1<br />exit /b<br /></code></pre></div><br /><br />Now the output looks like<br /><blockquote><div><cite>output wrote:</cite>Test now                    test1='^a!&quot;^b'<br />  Test #1  Disable/Disable result='not set by macro'    - FAIL<br />  Test #2  Disable/Enable  result='not set by macro'    - FAIL<br />  Test #3  Enable/Disable  result='^a!&quot;^b'    - OK<br />  Test #4  Enable/Enable   result='^a!&quot;^b'    - OK<br /><br />Test now                    test2='caret^'<br />  Test #5  Disable/Disable result='not set by macro'    - FAIL<br />  Test #6  Disable/Enable  result='not set by macro'    - FAIL<br />  Test #7  Enable/Disable  result='caret^'    - OK<br />  Test #8  Enable/Enable   result='caret^'    - OK<br /><br />Test now                    test3=''<br />  Test #9  Disable/Disable result='not set by macro'    - FAIL<br />  Test #10 Disable/Enable  result='not set by macro'    - FAIL<br />  Test #11 Enable/Disable  result=''    - OK<br />  Test #12 Enable/Enable   result=''    - OK<br /><br />Test now                    test4='===Equals'<br />  Test #13 Disable/Disable result='not set by macro'    - FAIL<br />  Test #14 Disable/Enable  result='not set by macro'    - FAIL<br />  Test #15 Enable/Disable  result='===Equals'    - OK<br />  Test #16 Enable/Enable   result='===Equals'    - OK<br /><br />Test now                    test5='&amp;&quot;&amp;^&amp;!!!^^%^!'<br />  Test #17 Disable/Disable result='not set by macro'    - FAIL<br />  Test #18 Disable/Enable  result='not set by macro'    - FAIL<br />  Test #19 Enable/Disable  result='&amp;&quot;&amp;^&amp;!!!^^%^!'    - OK<br />  Test #20 Enable/Enable   result='&amp;&quot;&amp;^&amp;!!!^^%^!'    - OK<br /><br />*est now                    test6='Hello &amp;^ &quot;^  &amp;&quot; world!<br />X'<br />  Test #21 Disable/Disable result='not set by macro'    - FAIL<br />  Test #22 Disable/Enable  result='not set by macro'    - FAIL<br />* Test #23 Enable/Disable  result='Hello &amp;^ &quot;^  &amp;&quot; world!<br />X'    - OK<br />* Test #24 Enable/Enable   result='Hello &amp;^ &quot;^  &amp;&quot; world!<br />X'    - OK</div></blockquote><br /><br />Currently I suppose to found a solution, that can return to a disabled context each character, even linefeed and carriage return.<br />But not both at the same time <img class="smilies" src="images/smilies/icon_wink.gif" alt=":wink:" title="Wink" /> <br />Either linefeeds or carriage returns are allowed in a string.<br /><br />I will post it when it works.<br /><br />But perhaps you will find a better solution for the problem <img class="smilies" src="images/smilies/icon_idea.gif" alt=":idea:" title="Idea" /></div>

			
									
									
						</div>

		</div>

				<div class="back2top">
						<a href="#top" class="top" title="Top">
				<i class="icon fa-chevron-circle-up fa-fw icon-gray" aria-hidden="true"></i>
				<span class="sr-only">Top</span>
			</a>
					</div>
		
		</div>
	</div>

	<hr class="divider" />
				<div id="p29695" class="post has-profile bg1">
		<div class="inner">

		<dl class="postprofile" id="profile29695">
			<dt class="no-profile-rank no-avatar">
				<div class="avatar-container">
																			</div>
								<a href="memberlist7557.html?mode=viewprofile&amp;u=4243" class="username">carlsomo</a>							</dt>

									
		<dd class="profile-posts"><strong>Posts:</strong> <a href="search15dd.html?author_id=4243&amp;sr=posts">91</a></dd>		<dd class="profile-joined"><strong>Joined:</strong> 02 Oct 2012 17:21</dd>		
		
						
						
		</dl>

		<div class="postbody">
						<div id="post_content29695">

						<h3 ><a href="#p29695">Re: ReturnVar macro revisited</a></h3>

													<ul class="post-buttons">
																																									<li>
							<a href="posting5890-2.html?mode=quote&amp;f=3&amp;p=29695" title="Reply with quote" class="button button-icon-only">
								<i class="icon fa-quote-left fa-fw" aria-hidden="true"></i><span class="sr-only">Quote</span>
							</a>
						</li>
														</ul>
							
						<p class="author"><span class="posti"><a href="viewtopic2c83.html?p=29695#p29695" onclick="prompt('Message #17',this.href); return false;">#17</a></span> 
									<a class="unread" href="viewtopic2c83.html?p=29695#p29695" title="Post">
						<i class="icon fa-file fa-fw icon-lightgray icon-md" aria-hidden="true"></i><span class="sr-only">Post</span>
					</a>
								<span class="responsive-hide">by <strong><a href="memberlist7557.html?mode=viewprofile&amp;u=4243" class="username">carlsomo</a></strong> &raquo; </span>05 Nov 2013 02:14
			</p>
			
			
			
			<div class="content">This version handles everything correctly with the exception of the linefeed in the disabled context - Only 2 FAILS  <img class="smilies" src="images/smilies/icon_redface.gif" alt=":oops:" title="Embarassed" /> <br /><br />This segment:<br /><div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>&nbsp; &nbsp; &nbsp; &nbsp; if defined _#_$_dis (%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; for /f delims^^=^^ eol^^=&nbsp; %%A in (&quot;&quot;!%%~N!&quot;&quot;) do @(%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if defined _#_$_dis (endlocal ^&amp; set &quot;%%~N=%%~A&quot; ^&amp; set &quot;_#_$_dis=&quot;) else (%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; echo %%~A is missing in this string%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; )%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; )%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; )%\n%<br /></code></pre></div><br />processes the first iteration of %%~A before the first linefeed and handles the !CR!<br />endlocal is only called once. The for /f 're-loops' for each linefeed contained in &quot;!%%~N!&quot;, resetting %%~A<br />I wonder if there is a way to re-insert linefeeds between the %%~A's, then endlocal reassign %%N ??<br /><br /><blockquote class="uncited"><div>Output:<br /><br />Test now                    test1='^a!&quot;^b'<br />  Test #1  Disable/Disable result='^a!&quot;^b'    - OK<br />  Test #2  Disable/Enable  result='^a!&quot;^b'    - OK<br />  Test #3  Enable/Disable  result='^a!&quot;^b'    - OK<br />  Test #4  Enable/Enable   result='^a!&quot;^b'    - OK<br /><br />Test now                    test2='caret^'<br />  Test #5  Disable/Disable result='caret^'    - OK<br />  Test #6  Disable/Enable  result='caret^'    - OK<br />  Test #7  Enable/Disable  result='caret^'    - OK<br />  Test #8  Enable/Enable   result='caret^'    - OK<br /><br />Test now                    test3=''<br />  Test #9  Disable/Disable result=''    - OK<br />  Test #10 Disable/Enable  result=''    - OK<br />  Test #11 Enable/Disable  result=''    - OK<br />  Test #12 Enable/Enable   result=''    - OK<br /><br />Test now                    test4='===Equals'<br />  Test #13 Disable/Disable result='===Equals'    - OK<br />  Test #14 Disable/Enable  result='===Equals'    - OK<br />  Test #15 Enable/Disable  result='===Equals'    - OK<br />  Test #16 Enable/Enable   result='===Equals'    - OK<br /><br />Test now                    test5='&amp;&quot;&amp;^&amp;!!!^^%^!'<br />  Test #17 Disable/Disable result='&amp;&quot;&amp;^&amp;!!!^^%^!'    - OK<br />  Test #18 Disable/Enable  result='&amp;&quot;&amp;^&amp;!!!^^%^!'    - OK<br />  Test #19 Enable/Disable  result='&amp;&quot;&amp;^&amp;!!!^^%^!'    - OK<br />  Test #20 Enable/Enable   result='&amp;&quot;&amp;^&amp;!!!^^%^!'    - OK<br /><br />*est now                    test6='Hello &amp;^ &quot;^  &amp;&quot; world!<br />X'<br />X&quot; is missing in this string<br />*'    - FAIL sable/Disable result='Hello &amp;^ &quot;^  &amp;&quot; world!<br />X&quot; is missing in this string<br />*'    - FAIL sable/Enable  result='Hello &amp;^ &quot;^  &amp;&quot; world!<br />* Test #23 Enable/Disable  result='Hello &amp;^ &quot;^  &amp;&quot; world!<br />X'    - OK<br />* Test #24 Enable/Enable   result='Hello &amp;^ &quot;^  &amp;&quot; world!<br />X'    - OK<br /></div></blockquote><br /><div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>:TestReturnVar.bat<br />@echo off<br />cls<br />setlocal DisableDelayedExpansion<br />if not defined ReturnVar call :ReturnVar<br />set /a test_cnt=0<br />set &quot;test1=^a!&quot;^^b&quot;<br />set &quot;test2=caret^&quot;<br />set &quot;test3=&quot;<br />set &quot;test4====Equals&quot;<br />@rem&nbsp; &nbsp; &nbsp; &nbsp; &amp;&quot;&amp;^&amp;!!!^^%^!<br />set&nbsp; test5=^&amp;&quot;&amp;^&amp;!!!^^%%^!<br />setlocal enabledelayedexpansion<br />set &quot;test6=Hello &amp;^^ &quot;^^^^&nbsp; ^&amp;&quot; world^!!CR!*!LF!X&quot;<br />@echo off&amp;echo(<br /><br />for /L %%n in (1 1 6) do (<br />&nbsp; &nbsp;call :Test_Both test%%n<br />)<br />exit /b<br /><br />:Test_Both<br />setlocal EnableDelayedExpansion<br />echo Test now&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; %1='!%1!'<br />endlocal<br />call :Test_context Disable Disable %1<br />call :Test_context Disable Enable&nbsp; %1<br />call :Test_context Enable&nbsp; Disable %1<br />call :Test_context Enable&nbsp; Enable&nbsp; %1<br />echo(<br />exit /b<br /><br />:Test_context<br />set /a test_cnt+=1<br />setlocal %1DelayedExpansion<br />set &quot;result=not set by macro&quot;<br />call :startTest %1 %2 %3<br /><br />REM Output the result<br />setlocal enabledelayedexpansion<br />if &quot;!result!&quot;==&quot;!%~3!&quot; (<br />&nbsp; &nbsp;set &quot;postfix=OK&quot;<br />) ELSE (<br />&nbsp; &nbsp; set postfix=FAIL<br />)<br />set &quot;format1=&nbsp; Test #!test_cnt! &quot;<br />set &quot;format2=%1/%2&nbsp; &quot;<br />echo !format1:~0,10! !format2:~0,15! result='!result!'&nbsp; &nbsp; - !postfix! !level!<br />endlocal<br /><br />endlocal<br />exit /b<br /><br />:startTest<br />setlocal %2DelayedExpansion<br />%ReturnVar% result %3 1<br />exit /b<br /><br />:ReturnVar Macro<br />@if defined ReturnVar @exit /b -1<br /><br />:initReturnVar<br />@if &quot;!&quot; equ &quot;&quot; (<br />&nbsp; &gt;&amp;2 @echo ERROR: ReturnVar must be initialized with delayed expansion disabled<br />&nbsp; @exit /b 1<br />)<br /><br />@set LF=^<br /><br /><br />::&nbsp; Above 2 blank lines are critical - Do not remove&nbsp; ::<br />@set ^&quot;\n=^^^%LF%%LF%^%LF%%LF%^^&quot;<br /><br />@for /f &quot;usebackq delims= &quot; %%C in (`copy /z &quot;%~f0&quot; nul`) do @set &quot;CR=%%C&quot;<br /><br />@REM ** ReturnVar &lt;resultVariable&gt; &lt;TransferVariable&gt; &#91;endlocalCount&#93; by jeb and carl<br />@REM ** return a &lt;TransferVariable&gt; over one or more endlocal barriers to a resultVariable<br />@REM ** endlocalCount default=1, is the number of endlocals that should be executed<br />@REM ** All special characters can be transferd from TranferVariable to the result variable,<br />@REM ** even &quot;&lt;&gt;&amp;|!^&quot;<br />@REM ** The result is correct, independent of the delayed expansion mode after the endlocals<br />@set ^&quot;ReturnVar=@for %%# in (1 2) do @if %%#==2 @(%\n%<br />&nbsp; setlocal EnableDelayedExpansion%\n%<br />&nbsp; set/a safeReturn_count=0%\n%<br />&nbsp; for %%C in (!args!) do @(%\n%<br />&nbsp; &nbsp; set &quot;safeReturn&#91;!safeReturn_count!&#93;=%%~C&quot; ^&amp; set /a safeReturn_count+=1%\n%<br />&nbsp; )%\n%<br />&nbsp; if not defined safeReturn&#91;2&#93; set &quot;safeReturn&#91;2&#93;=1&quot;%\n%<br />&nbsp; set /a safeReturn&#91;2&#93;+=2%\n%<br />&nbsp; for /f &quot;delims=&quot; %%T in (&quot;!safeReturn&#91;1&#93;!&quot;) do @set &quot;_#_$_safeReturn=a!%%T!&quot;%\n%<br />&nbsp; set ^&quot;_#_$_safeReturn=!_#_$_safeReturn:&quot;=&quot;&quot;q!&quot;%\n%<br />&nbsp; FOR /F %%R in (&quot;!CR! #&quot;) DO @set &quot;_#_$_safeReturn=!_#_$_safeReturn:%%~R=&quot;&quot;r!&quot;%\n%<br />&nbsp; FOR %%L in (&quot;!LF!&quot;) DO @set &quot;_#_$_safeReturn=!_#_$_safeReturn:%%~L=&quot;&quot;n!&quot;%\n%<br />&nbsp; set &quot;_#_$_safeReturn=!_#_$_safeReturn:^=^^!&quot;%\n%<br />&nbsp; call set &quot;_#_$_safeReturn=%%_#_$_safeReturn:^!=&quot;&quot;c^!%%&quot;%\n%<br />&nbsp; set &quot;_#_$_safeReturn=!_#_$_safeReturn:&quot;&quot;c=^!&quot;%\n%<br />&nbsp; set ^&quot;_#_$_safeReturn=!_#_$_safeReturn:&quot;&quot;q=&quot;!&quot;%\n%<br />&nbsp; for %%L in (&quot;!LF!&quot;) do @(%\n%<br />&nbsp; &nbsp; for /f &quot;delims=&quot; %%N in (&quot;&quot;!safeReturn&#91;0&#93;!&quot;&quot;) do @(%\n%<br />&nbsp; &nbsp; &nbsp; for /f &quot;delims=&quot; %%E in (&quot;&quot;!_#_$_safeReturn!&quot;&quot;) do @(%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; for /l %%n in (1 1 !safeReturn&#91;2&#93;!) do @endlocal%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; if &quot;!&quot; neq &quot;&quot; setlocal enabledelayedexpansion ^&amp; set &quot;_#_$_dis=1&quot;%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; set &quot;%%~N=%%~E&quot; !%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; set &quot;%%~N=!%%~N:&quot;&quot;n=%%~L!&quot;%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; FOR /F %%R in (&quot;!CR! #&quot;) DO @set &quot;%%~N=!%%~N:&quot;&quot;r=%%R!&quot;%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; set &quot;%%~N=!%%~N:~1!&quot;%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; if defined _#_$_dis (%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; for /f delims^^=^^ eol^^=&nbsp; %%A in (&quot;&quot;!%%~N!&quot;&quot;) do @(%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if defined _#_$_dis (endlocal ^&amp; set &quot;%%~N=%%~A&quot;) else (%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; echo %%~A is missing in this string%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; )%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; )%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; )%\n%<br />&nbsp; &nbsp; &nbsp; )%\n%<br />&nbsp; &nbsp; )%\n%<br />&nbsp; )%\n%<br />) else @setlocal ^&amp; @set args=&quot;<br />@exit /b 0<br /></code></pre></div></div>

			
									
									
						</div>

		</div>

				<div class="back2top">
						<a href="#top" class="top" title="Top">
				<i class="icon fa-chevron-circle-up fa-fw icon-gray" aria-hidden="true"></i>
				<span class="sr-only">Top</span>
			</a>
					</div>
		
		</div>
	</div>

	<hr class="divider" />
				<div id="p29756" class="post has-profile bg2">
		<div class="inner">

		<dl class="postprofile" id="profile29756">
			<dt class="no-profile-rank no-avatar">
				<div class="avatar-container">
																			</div>
								<a href="memberlist7557.html?mode=viewprofile&amp;u=4243" class="username">carlsomo</a>							</dt>

									
		<dd class="profile-posts"><strong>Posts:</strong> <a href="search15dd.html?author_id=4243&amp;sr=posts">91</a></dd>		<dd class="profile-joined"><strong>Joined:</strong> 02 Oct 2012 17:21</dd>		
		
						
						
		</dl>

		<div class="postbody">
						<div id="post_content29756">

						<h3 ><a href="#p29756">Re: ReturnVar macro revisited</a></h3>

													<ul class="post-buttons">
																																									<li>
							<a href="posting3c57.html?mode=quote&amp;f=3&amp;p=29756" title="Reply with quote" class="button button-icon-only">
								<i class="icon fa-quote-left fa-fw" aria-hidden="true"></i><span class="sr-only">Quote</span>
							</a>
						</li>
														</ul>
							
						<p class="author"><span class="posti"><a href="viewtopic23b9-2.html?p=29756#p29756" onclick="prompt('Message #18',this.href); return false;">#18</a></span> 
									<a class="unread" href="viewtopic23b9-2.html?p=29756#p29756" title="Post">
						<i class="icon fa-file fa-fw icon-lightgray icon-md" aria-hidden="true"></i><span class="sr-only">Post</span>
					</a>
								<span class="responsive-hide">by <strong><a href="memberlist7557.html?mode=viewprofile&amp;u=4243" class="username">carlsomo</a></strong> &raquo; </span>08 Nov 2013 02:11
			</p>
			
			
			
			<div class="content">Dear jeb,<br />I tried very hard not to use a temp file but this version had to resort to that only when called from a disabled environment with linefeeds in the transfer variable. I am not happy with it but it passes the jeb test. It would be much more satisfying to avoid writing to file under any circumstance but I cry 'UNCLE' <br />At least the goal of avoiding calls to an outside function is met<br />carl<br /><br /><blockquote class="uncited"><div><br />Test now                    test1='^a!&quot;^b'<br />  Test #1  Disable/Disable result='^a!&quot;^b'    - OK<br />  Test #2  Disable/Enable  result='^a!&quot;^b'    - OK<br />  Test #3  Enable/Disable  result='^a!&quot;^b'    - OK<br />  Test #4  Enable/Enable   result='^a!&quot;^b'    - OK<br /><br />Test now                    test2='caret^'<br />  Test #5  Disable/Disable result='caret^'    - OK<br />  Test #6  Disable/Enable  result='caret^'    - OK<br />  Test #7  Enable/Disable  result='caret^'    - OK<br />  Test #8  Enable/Enable   result='caret^'    - OK<br /><br />Test now                    test3=''<br />  Test #9  Disable/Disable result=''    - OK<br />  Test #10 Disable/Enable  result=''    - OK<br />  Test #11 Enable/Disable  result=''    - OK<br />  Test #12 Enable/Enable   result=''    - OK<br /><br />Test now                    test4='===Equals'<br />  Test #13 Disable/Disable result='===Equals'    - OK<br />  Test #14 Disable/Enable  result='===Equals'    - OK<br />  Test #15 Enable/Disable  result='===Equals'    - OK<br />  Test #16 Enable/Enable   result='===Equals'    - OK<br /><br />Test now                    test5='&amp;&quot;&amp;^&amp;!!!^^%^!'<br />  Test #17 Disable/Disable result='&amp;&quot;&amp;^&amp;!!!^^%^!'    - OK<br />  Test #18 Disable/Enable  result='&amp;&quot;&amp;^&amp;!!!^^%^!'    - OK<br />  Test #19 Enable/Disable  result='&amp;&quot;&amp;^&amp;!!!^^%^!'    - OK<br />  Test #20 Enable/Enable   result='&amp;&quot;&amp;^&amp;!!!^^%^!'    - OK<br /><br />*est now                    test6='Hello &amp;^ &quot;^  &amp;&quot; world!<br />X'<br />* Test #21 Disable/Disable result='Hello &amp;^ &quot;^  &amp;&quot; world!<br />X'    - OK<br />* Test #22 Disable/Enable  result='Hello &amp;^ &quot;^  &amp;&quot; world!<br />X'    - OK<br />* Test #23 Enable/Disable  result='Hello &amp;^ &quot;^  &amp;&quot; world!<br />X'    - OK<br />* Test #24 Enable/Enable   result='Hello &amp;^ &quot;^  &amp;&quot; world!<br />X'    - OK<br /></div></blockquote><br /><br /><br /><div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>:TestReturnVar.bat<br />@echo off<br />cls<br />setlocal DisableDelayedExpansion<br />call :ReturnVar<br />set /a test_cnt=0<br />rem echo on<br />set &quot;test1=^a!&quot;^^b&quot;<br />set &quot;test2=caret^&quot;<br />set &quot;test3=&quot;<br />set &quot;test4====Equals&quot;<br />@rem&nbsp; &nbsp; &nbsp; &nbsp; &amp;&quot;&amp;^&amp;!!!^^%^!<br />set&nbsp; test5=^&amp;&quot;&amp;^&amp;!!!^^%%^!<br />@setlocal enabledelayedexpansion<br />set &quot;test6=Hello &amp;^^ &quot;^^^^&nbsp; ^&amp;&quot; world^!!CR!*!LF!X&quot;<br />@echo off&amp;echo(<br />rem set ret<br /><br />for /L %%n in (1 1 6) do (<br />&nbsp; &nbsp;call :Test_Both test%%n<br />)<br />exit /b<br /><br />:Test_Both<br />setlocal EnableDelayedExpansion<br />echo Test now&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; %1='!%1!'<br />endlocal<br />call :Test_context Disable Disable %1<br />call :Test_context Disable Enable&nbsp; %1<br />call :Test_context Enable&nbsp; Disable %1<br />call :Test_context Enable&nbsp; Enable&nbsp; %1<br />echo(<br />exit /b<br /><br />:Test_context<br />set /a test_cnt+=1<br />setlocal %1DelayedExpansion<br />set &quot;result=not set by macro&quot;<br />call :startTest %1 %2 %3<br /><br />REM Output the result<br />setlocal enabledelayedexpansion<br />if &quot;!result!&quot;==&quot;!%~3!&quot; (<br />&nbsp; &nbsp;set &quot;postfix=OK&quot;<br />) ELSE (<br />&nbsp; &nbsp; set postfix=FAIL<br />)<br />set &quot;format1=&nbsp; Test #!test_cnt! &quot;<br />set &quot;format2=%1/%2&nbsp; &quot;<br />echo !format1:~0,10! !format2:~0,15! result='!result!'&nbsp; &nbsp; - !postfix! !level!<br />endlocal<br /><br />endlocal<br />exit /b<br /><br />:startTest<br />setlocal %2DelayedExpansion<br />%ReturnVar% result %3 1<br />exit /b<br /><br />:ReturnVar Macro<br />@if defined ReturnVar @exit /b -1<br /><br />:initReturnVar<br />@if &quot;!&quot; equ &quot;&quot; (<br />&nbsp; &gt;&amp;2 @echo ERROR: ReturnVar must be initialized with delayed expansion disabled<br />&nbsp; @exit /b 1<br />)<br /><br />@set LF=^<br /><br /><br />::&nbsp; Above 2 blank lines are critical - Do not remove&nbsp; ::<br />@set ^&quot;\n=^^^%LF%%LF%^%LF%%LF%^^&quot;<br /><br />@for /f &quot;usebackq delims= &quot; %%C in (`copy /z &quot;%~f0&quot; nul`) do @set &quot;CR=%%C&quot;<br /><br />@REM ** ReturnVar &lt;resultVariable&gt; &lt;TransferVariable&gt; &#91;endlocalCount&#93; by jeb and carl<br />@REM ** return a &lt;TransferVariable&gt; over one or more endlocal barriers to a resultVariable<br />@REM ** endlocalCount default=1, is the number of endlocals that should be executed<br />@REM ** All special characters can be transferd from TranferVariable to the result variable,<br />@REM ** even &quot;&lt;&gt;&amp;|!^&quot;<br />@REM ** The result is correct, independent of the delayed expansion mode after the endlocals<br /><br />@set ^&quot;ReturnVar=@for %%# in (1 2) do @if %%#==2 @(%\n%<br />&nbsp; setlocal EnableDelayedExpansion%\n%<br />&nbsp; set/a safeReturn_count=0%\n%<br />&nbsp; for %%C in (!args!) do @(%\n%<br />&nbsp; &nbsp; set &quot;safeReturn&#91;!safeReturn_count!&#93;=%%~C&quot; ^&amp; set /a safeReturn_count+=1%\n%<br />&nbsp; )%\n%<br />&nbsp; if not defined safeReturn&#91;2&#93; set &quot;safeReturn&#91;2&#93;=1&quot;%\n%<br />&nbsp; set /a safeReturn&#91;2&#93;+=2%\n%<br />&nbsp; for /f &quot;delims=&quot; %%T in (&quot;!safeReturn&#91;1&#93;!&quot;) do @set &quot;_#_$_safeReturn=a!%%T!&quot;%\n%<br />&nbsp; set ^&quot;_#_$_safeReturn=!_#_$_safeReturn:&quot;=&quot;&quot;q!&quot;%\n%<br />&nbsp; FOR /F %%R in (&quot;!CR! #&quot;) DO @set &quot;_#_$_safeReturn=!_#_$_safeReturn:%%~R=&quot;&quot;r!&quot;%\n%<br />&nbsp; FOR %%L in (&quot;!LF!&quot;) DO @set &quot;_#_$_safeReturn=!_#_$_safeReturn:%%~L=&quot;&quot;n!&quot;%\n%<br />&nbsp; set &quot;_#_$_safeReturn=!_#_$_safeReturn:^=^^!&quot;%\n%<br />&nbsp; call set &quot;_#_$_safeReturn=%%_#_$_safeReturn:^!=&quot;&quot;c^!%%&quot;%\n%<br />&nbsp; set &quot;_#_$_safeReturn=!_#_$_safeReturn:&quot;&quot;c=^!&quot;%\n%<br />&nbsp; set ^&quot;_#_$_safeReturn=!_#_$_safeReturn:&quot;&quot;q=&quot;!&quot;%\n%<br />&nbsp; for %%L in (&quot;!LF!&quot;) do @(%\n%<br />&nbsp; &nbsp; for /f &quot;delims=&quot; %%N in (&quot;&quot;!safeReturn&#91;0&#93;!&quot;&quot;) do @(%\n%<br />&nbsp; &nbsp; &nbsp; for /f &quot;delims=&quot; %%E in (&quot;&quot;!_#_$_safeReturn!&quot;&quot;) do @(%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; for /l %%n in (1 1 !safeReturn&#91;2&#93;!) do @endlocal%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; if &quot;!&quot; neq &quot;&quot; setlocal enabledelayedexpansion ^&amp; set &quot;_#_$_dis=1&quot;%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; set &quot;%%~N=%%~E&quot; !%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; set &quot;%%~N=!%%~N:&quot;&quot;n=%%~L!&quot;%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; FOR /F %%R in (&quot;!CR! #&quot;) DO @set &quot;%%~N=!%%~N:&quot;&quot;r=%%R!&quot;%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; set &quot;%%~N=!%%~N:~1!&quot;%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; if defined _#_$_dis (%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; for /f delims^^=^^ eol^^=&nbsp; %%A in (&quot;&quot;!%%~N!&quot;&quot;) do @(%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if defined _#_$_dis (%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if &quot;!%%~N!&quot; neq &quot;%%~A&quot; echo !%%~N!^&gt;!temp!\_#_$_dis.txt%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; endlocal ^&amp; set &quot;%%~N=%%~A&quot;%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ) else (%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ^&lt;%temp%\_#_$_dis.txt set/p %%~N=&quot;&quot;%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; )%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; )%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if exist %temp%\_#_$_dis.txt del %temp%\_#_$_dis.txt 2^&gt;nul%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; )%\n%<br />&nbsp; &nbsp; &nbsp; )%\n%<br />&nbsp; &nbsp; )%\n%<br />&nbsp; )%\n%<br />) else @setlocal ^&amp; @set args=&quot;<br />@exit /b 0<br /></code></pre></div></div>

			
									
									
						</div>

		</div>

				<div class="back2top">
						<a href="#top" class="top" title="Top">
				<i class="icon fa-chevron-circle-up fa-fw icon-gray" aria-hidden="true"></i>
				<span class="sr-only">Top</span>
			</a>
					</div>
		
		</div>
	</div>

	<hr class="divider" />
				<div id="p29761" class="post has-profile bg1">
		<div class="inner">

		<dl class="postprofile" id="profile29761">
			<dt class="has-profile-rank no-avatar">
				<div class="avatar-container">
																			</div>
								<a href="memberlist7125.html?mode=viewprofile&amp;u=417" class="username">jeb</a>							</dt>

						<dd class="profile-rank">Expert</dd>			
		<dd class="profile-posts"><strong>Posts:</strong> <a href="search73f1.html?author_id=417&amp;sr=posts">880</a></dd>		<dd class="profile-joined"><strong>Joined:</strong> 30 Aug 2007 08:05</dd>		
		
											<dd class="profile-custom-field profile-phpbb_location"><strong>Location:</strong> Germany, Bochum</dd>
							
						
		</dl>

		<div class="postbody">
						<div id="post_content29761">

						<h3 ><a href="#p29761">Re: ReturnVar macro revisited</a></h3>

													<ul class="post-buttons">
																																									<li>
							<a href="posting70d0.html?mode=quote&amp;f=3&amp;p=29761" title="Reply with quote" class="button button-icon-only">
								<i class="icon fa-quote-left fa-fw" aria-hidden="true"></i><span class="sr-only">Quote</span>
							</a>
						</li>
														</ul>
							
						<p class="author"><span class="posti"><a href="viewtopicfa3d.html?p=29761#p29761" onclick="prompt('Message #19',this.href); return false;">#19</a></span> 
									<a class="unread" href="viewtopicfa3d.html?p=29761#p29761" title="Post">
						<i class="icon fa-file fa-fw icon-lightgray icon-md" aria-hidden="true"></i><span class="sr-only">Post</span>
					</a>
								<span class="responsive-hide">by <strong><a href="memberlist7125.html?mode=viewprofile&amp;u=417" class="username">jeb</a></strong> &raquo; </span>08 Nov 2013 02:49
			</p>
			
			
			
			<div class="content">Hmm, <br /><br />I have two new tests for you.<br /><div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>set &quot;test7=Line1!LF!Line2!LF!&quot;<br />set &quot;test8=Line1!CR!!LF!Line2&quot;<br /></code></pre></div><br /><br />Both fails with your temporary file technic.<br /><br />IMO the set /p technic is a dead end.<br /><br />My own solution for this part looks like this (It requires one more global variable <strong class="text-strong">set &quot;sfr.caret=^&quot;</strong>)<br /><div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>for %%L IN (&quot;!\n!&quot;) DO (%\n%<br />&nbsp; &nbsp;if &quot;!var!&quot; == &quot;!var:%%~L=!&quot; ( %= REM ** No linefeeds found, so use normal FOR/F return =%&nbsp; %\n%<br />&nbsp; &nbsp;) ELSE if &quot;!var!&quot; NEQ &quot;!var:%%~C=!&quot; ( %= REM ** LF and CR founds, return by calling a helper function is required =%&nbsp; %\n%<br />&nbsp; &nbsp;&nbsp; &nbsp;for /F &quot;delims=&quot; %%P in (&quot;&quot;!var!&quot;&quot;) DO (%\n%<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;for /L %%n in (1 1 !endlocal_cnt!) do endlocal%\n%<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;call :safeReturn_Helper%\n%<br />&nbsp; &nbsp;&nbsp; &nbsp;)%\n%<br />&nbsp; &nbsp;) ELSE ( %= REM ** Linefeed creation with a CALL SET expansion =%&nbsp; %\n%<br />&nbsp; &nbsp;for /F &quot;delims=: tokens=1,*&quot; %%C IN (&quot;!cr!:&quot;!path!&quot;&quot;) DO (%\n%<br />&nbsp; &nbsp;&nbsp; &nbsp;%= REM ** Make all special chars safe against one percent expansion =%&nbsp; %\n%<br />&nbsp; &nbsp;&nbsp; &nbsp;set &quot;var=!var:^=^^!&quot;%\n%<br />&nbsp; &nbsp;&nbsp; &nbsp;set &quot;var=!var:&amp;=^&amp;!&quot;%\n%<br />&nbsp; &nbsp;&nbsp; &nbsp;set &quot;var=!var:|=^|!&quot;%\n%<br />&nbsp; &nbsp;&nbsp; &nbsp;set &quot;var=!var:&lt;=^&lt;!&quot;%\n%<br />&nbsp; &nbsp;&nbsp; &nbsp;set &quot;var=!var:&gt;=^&gt;!&quot;%\n%<br />&nbsp; &nbsp;&nbsp; &nbsp;set &quot;var=!var:&quot;=^^&quot;!&quot; %= REM ** Quotes must be escaped so all other =%&nbsp; %\n%<br />&nbsp; &nbsp;&nbsp; &nbsp;set ^&quot;var=!var:%%~L=^^%%~C!&quot; %= REM ** Replace LF with CR, as CR can survive a FOR/F and it can't be in the string =%&nbsp; %\n%<br />&nbsp; &nbsp;&nbsp; &nbsp;%= REM ** The extra caret in front of the CR is required when the CR is reverted to a linefeed =%&nbsp; %\n%<br />&nbsp; &nbsp;&nbsp; &nbsp;for /F &quot;delims=&quot; %%a in (&quot;&quot;!var!&quot;&quot;) DO (%\n%<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;endlocal%\n%<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;endlocal%\n%<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;set &quot;path=&quot; %= REM ** Path must be removed, to speed up =%%\n%<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;set &quot;pathext=:&quot; %= REM ** PathExt must be removed, to avoid external search for a set.bat,set.exe,... =%%\n%<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;set &quot;result=%%~a&quot;%\n%<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;%= REM ** The first quote must be escaped twice, first for the %NLM% and then for the escaped content of the result =%%\n%<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;call set %%sfr.caret%%^&quot;result=%%result:%%~C=%NLM%%NLM%%%&quot;%\n%<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;set &quot;path=%%~D&quot; %= REM ** Restore path and PathExt =%%\n%<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;set &quot;pathext=%%~Q&quot;%\n%<br />&nbsp; &nbsp;&nbsp; &nbsp;)%\n%<br />&nbsp; &nbsp;)%\n%<br />)%\n%</code></pre></div><br /><br />I changed the test suite a bit for a bit better overview.<br /><br /><div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>:TestReturnVar.bat<br />@echo off<br />cls<br />setlocal DisableDelayedExpansion<br />if not defined ReturnVar call :ReturnVar<br />set /a test_cnt=0<br />For /F &quot;delims=;&quot; %%# in ('&quot;Prompt;$H;&amp;For %%_ in (1) Do Rem&quot;') Do Set &quot;BS=%%#&quot;<br />set &quot;test1=^a!&quot;^^b&quot;<br />set &quot;test2=caret^&quot;<br />set &quot;test3=&quot;<br />set &quot;test4====Equals&quot;<br />@rem&nbsp; &nbsp; &nbsp; &nbsp; &amp;&quot;&amp;^&amp;!!!^^%^!<br />set&nbsp; test5=^&amp;&quot;&amp;^&amp;!!!^^%%^!<br />setlocal enabledelayedexpansion<br />set &quot;test6=Hello &amp;^^ &quot;^^^^&nbsp; ^&amp;&quot; world^!!CR!*!LF!X&quot;<br />set &quot;test7=Line1!LF!Line2!LF!&quot;<br />set &quot;test8=Line1!CR!!LF!Line2&quot;<br />@echo off&amp;echo(<br /><br />for /L %%n in (1 1 8) do (<br />&nbsp; &nbsp;call :Test_Both test%%n<br />)<br />exit /b<br /><br />:Test_Both<br />setlocal EnableDelayedExpansion<br />echo --- %1 ---&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;text='!%1!'<br />endlocal<br />call :Test_context Disable Disable %1<br />call :Test_context Disable Enable&nbsp; %1<br />call :Test_context Enable&nbsp; Disable %1<br />call :Test_context Enable&nbsp; Enable&nbsp; %1<br />echo(<br />exit /b<br /><br />:Test_context<br />set /a test_cnt+=1<br />setlocal %1DelayedExpansion<br />set &quot;result=not set by macro&quot;<br />call :startTest %1 %2 %3<br /><br />REM Output the result<br />setlocal enabledelayedexpansion<br />set &quot;format1=&nbsp; Test #!test_cnt! &quot;<br />set &quot;format2=%1/%2&nbsp; &quot;<br />if &quot;!result!&quot;==&quot;!%~3!&quot; (<br />&nbsp; &nbsp;set &quot;postfix=&nbsp; &nbsp;OK &quot;<br />&nbsp; &nbsp;echo !format1:~0,10! !postfix! !format2:~0,15!<br />) ELSE (<br />&nbsp; &nbsp; set &quot;postfix=&lt;FAIL&gt;&quot;<br />&nbsp; &nbsp;echo !format1:~0,10! !postfix! !format2:~0,15! result='!result!'<br />)<br />endlocal<br /><br />endlocal<br />exit /b<br /></code></pre></div><br /><br />For your last code it outputs<br /><blockquote><div><cite>output wrote:</cite>--- test1 ---                       text='^a!&quot;^b'<br />  Test #1     OK  Disable/Disable<br />  Test #2     OK  Disable/Enable<br />  Test #3     OK  Enable/Disable<br />  Test #4     OK  Enable/Enable<br /><br />--- test2 ---                       text='caret^'<br />  Test #5     OK  Disable/Disable<br />  Test #6     OK  Disable/Enable<br />  Test #7     OK  Enable/Disable<br />  Test #8     OK  Enable/Enable<br /><br />--- test3 ---                       text=''<br />  Test #9     OK  Disable/Disable<br />  Test #10    OK  Disable/Enable<br />  Test #11    OK  Enable/Disable<br />  Test #12    OK  Enable/Enable<br /><br />--- test4 ---                       text='===Equals'<br />  Test #13    OK  Disable/Disable<br />  Test #14    OK  Disable/Enable<br />  Test #15    OK  Enable/Disable<br />  Test #16    OK  Enable/Enable<br /><br />--- test5 ---                       text='&amp;&quot;&amp;^&amp;!!!^^%^!'<br />  Test #17    OK  Disable/Disable<br />  Test #18    OK  Disable/Enable<br />  Test #19    OK  Enable/Disable<br />  Test #20    OK  Enable/Enable<br /><br />*-- test6 ---                       text='Hello &amp;^ &quot;^  &amp;&quot; world!<br />X'<br />  Test #21    OK  Disable/Disable<br />  Test #22    OK  Disable/Enable<br />  Test #23    OK  Enable/Disable<br />  Test #24    OK  Enable/Enable<br /><br />--- test7 ---                       text='Line1<br />Line2<br />'<br />  Test #25 &lt;FAIL&gt; Disable/Disable result='Line1<br />Line2'<br />  Test #26 &lt;FAIL&gt; Disable/Enable  result='Line1<br />Line2'<br />  Test #27    OK  Enable/Disable<br />  Test #28    OK  Enable/Enable<br /><br />--- test8 ---                       text='Line1<br />Line2'<br />  Test #29 &lt;FAIL&gt; Disable/Disable result='Line1'<br />  Test #30 &lt;FAIL&gt; Disable/Enable  result='Line1'<br />  Test #31    OK  Enable/Disable<br />  Test #32    OK  Enable/Enable</div></blockquote></div>

			
									
									
						</div>

		</div>

				<div class="back2top">
						<a href="#top" class="top" title="Top">
				<i class="icon fa-chevron-circle-up fa-fw icon-gray" aria-hidden="true"></i>
				<span class="sr-only">Top</span>
			</a>
					</div>
		
		</div>
	</div>

	<hr class="divider" />
				<div id="p29794" class="post has-profile bg2">
		<div class="inner">

		<dl class="postprofile" id="profile29794">
			<dt class="no-profile-rank no-avatar">
				<div class="avatar-container">
																			</div>
								<a href="memberlist7557.html?mode=viewprofile&amp;u=4243" class="username">carlsomo</a>							</dt>

									
		<dd class="profile-posts"><strong>Posts:</strong> <a href="search15dd.html?author_id=4243&amp;sr=posts">91</a></dd>		<dd class="profile-joined"><strong>Joined:</strong> 02 Oct 2012 17:21</dd>		
		
						
						
		</dl>

		<div class="postbody">
						<div id="post_content29794">

						<h3 ><a href="#p29794">Re: ReturnVar macro revisited</a></h3>

													<ul class="post-buttons">
																																									<li>
							<a href="postinga4d2-2.html?mode=quote&amp;f=3&amp;p=29794" title="Reply with quote" class="button button-icon-only">
								<i class="icon fa-quote-left fa-fw" aria-hidden="true"></i><span class="sr-only">Quote</span>
							</a>
						</li>
														</ul>
							
						<p class="author"><span class="posti"><a href="viewtopic5aad.html?p=29794#p29794" onclick="prompt('Message #20',this.href); return false;">#20</a></span> 
									<a class="unread" href="viewtopic5aad.html?p=29794#p29794" title="Post">
						<i class="icon fa-file fa-fw icon-lightgray icon-md" aria-hidden="true"></i><span class="sr-only">Post</span>
					</a>
								<span class="responsive-hide">by <strong><a href="memberlist7557.html?mode=viewprofile&amp;u=4243" class="username">carlsomo</a></strong> &raquo; </span>08 Nov 2013 23:38
			</p>
			
			
			
			<div class="content">Ah, very interesting...<br /><br />My macro fails if there is not a character after a CR or LF other than CR or LF else it works <img class="smilies" src="images/smilies/icon_rolleyes.gif" alt=":roll:" title="Rolling Eyes" /><br /><br />so take your latest test 6 (works) and 7 and 8, does not work and try this:<br /><br />change 7 and 8 to this:<br /><br />set &quot;test7=Line1!LF!Line2!LF!.&quot;<br />set &quot;test8=Line1!CR!.!LF!Line2&quot;<br /><br />and you get this:<br /><blockquote class="uncited"><div>Test now                    test1='^a!&quot;^b'<br />  Test #1  Disable/Disable result='^a!&quot;^b'    - OK<br />  Test #2  Disable/Enable  result='^a!&quot;^b'    - OK<br />  Test #3  Enable/Disable  result='^a!&quot;^b'    - OK<br />  Test #4  Enable/Enable   result='^a!&quot;^b'    - OK<br /><br />Test now                    test2='caret^'<br />  Test #5  Disable/Disable result='caret^'    - OK<br />  Test #6  Disable/Enable  result='caret^'    - OK<br />  Test #7  Enable/Disable  result='caret^'    - OK<br />  Test #8  Enable/Enable   result='caret^'    - OK<br /><br />Test now                    test3=''<br />  Test #9  Disable/Disable result=''    - OK<br />  Test #10 Disable/Enable  result=''    - OK<br />  Test #11 Enable/Disable  result=''    - OK<br />  Test #12 Enable/Enable   result=''    - OK<br /><br />Test now                    test4='===Equals'<br />  Test #13 Disable/Disable result='===Equals'    - OK<br />  Test #14 Disable/Enable  result='===Equals'    - OK<br />  Test #15 Enable/Disable  result='===Equals'    - OK<br />  Test #16 Enable/Enable   result='===Equals'    - OK<br /><br />Test now                    test5='&amp;&quot;&amp;^&amp;!!!^^%^!'<br />  Test #17 Disable/Disable result='&amp;&quot;&amp;^&amp;!!!^^%^!'    - OK<br />  Test #18 Disable/Enable  result='&amp;&quot;&amp;^&amp;!!!^^%^!'    - OK<br />  Test #19 Enable/Disable  result='&amp;&quot;&amp;^&amp;!!!^^%^!'    - OK<br />  Test #20 Enable/Enable   result='&amp;&quot;&amp;^&amp;!!!^^%^!'    - OK<br /><br />*est now                    test6='Hello &amp;^ &quot;^  &amp;&quot; world!<br />X'<br />* Test #21 Disable/Disable result='Hello &amp;^ &quot;^  &amp;&quot; world!<br />X'    - OK<br />* Test #22 Disable/Enable  result='Hello &amp;^ &quot;^  &amp;&quot; world!<br />X'    - OK<br />* Test #23 Enable/Disable  result='Hello &amp;^ &quot;^  &amp;&quot; world!<br />X'    - OK<br />* Test #24 Enable/Enable   result='Hello &amp;^ &quot;^  &amp;&quot; world!<br />X'    - OK<br /><br />Test now                    test7='Line1<br />Line2<br />.'<br />  Test #25 Disable/Disable result='Line1<br />Line2<br />.'    - OK<br />  Test #26 Disable/Enable  result='Line1<br />Line2<br />.'    - OK<br />  Test #27 Enable/Disable  result='Line1<br />Line2<br />.'    - OK<br />  Test #28 Enable/Enable   result='Line1<br />Line2<br />.'    - OK<br /><br />.est now                    test8='Line1<br />Line2'<br />. Test #29 Disable/Disable result='Line1<br />Line2'    - OK<br />. Test #30 Disable/Enable  result='Line1<br />Line2'    - OK<br />. Test #31 Enable/Disable  result='Line1<br />Line2'    - OK<br />. Test #32 Enable/Enable   result='Line1<br />Line2'    - OK<br /></div></blockquote><br /><br />Hmmm... there could be a workable solution here?</div>

			
									
									
						</div>

		</div>

				<div class="back2top">
						<a href="#top" class="top" title="Top">
				<i class="icon fa-chevron-circle-up fa-fw icon-gray" aria-hidden="true"></i>
				<span class="sr-only">Top</span>
			</a>
					</div>
		
		</div>
	</div>

	<hr class="divider" />
				<div id="p29803" class="post has-profile bg1">
		<div class="inner">

		<dl class="postprofile" id="profile29803">
			<dt class="has-profile-rank no-avatar">
				<div class="avatar-container">
																			</div>
								<a href="memberlist7125.html?mode=viewprofile&amp;u=417" class="username">jeb</a>							</dt>

						<dd class="profile-rank">Expert</dd>			
		<dd class="profile-posts"><strong>Posts:</strong> <a href="search73f1.html?author_id=417&amp;sr=posts">880</a></dd>		<dd class="profile-joined"><strong>Joined:</strong> 30 Aug 2007 08:05</dd>		
		
											<dd class="profile-custom-field profile-phpbb_location"><strong>Location:</strong> Germany, Bochum</dd>
							
						
		</dl>

		<div class="postbody">
						<div id="post_content29803">

						<h3 ><a href="#p29803">Re: ReturnVar macro revisited</a></h3>

													<ul class="post-buttons">
																																									<li>
							<a href="postingb2a4.html?mode=quote&amp;f=3&amp;p=29803" title="Reply with quote" class="button button-icon-only">
								<i class="icon fa-quote-left fa-fw" aria-hidden="true"></i><span class="sr-only">Quote</span>
							</a>
						</li>
														</ul>
							
						<p class="author"><span class="posti"><a href="viewtopic7656.html?p=29803#p29803" onclick="prompt('Message #21',this.href); return false;">#21</a></span> 
									<a class="unread" href="viewtopic7656.html?p=29803#p29803" title="Post">
						<i class="icon fa-file fa-fw icon-lightgray icon-md" aria-hidden="true"></i><span class="sr-only">Post</span>
					</a>
								<span class="responsive-hide">by <strong><a href="memberlist7125.html?mode=viewprofile&amp;u=417" class="username">jeb</a></strong> &raquo; </span>10 Nov 2013 05:18
			</p>
			
			
			
			<div class="content"><blockquote><div><cite>carlsomo wrote:</cite>My macro fails if there is not a character after a CR or LF other than CR or LF else it works <img class="smilies" src="images/smilies/icon_rolleyes.gif" alt=":roll:" title="Rolling Eyes" /><br />so take your latest test 6 (works) and 7 and 8, does not work and try this:</div></blockquote><br /><br />There was a cause, why I build the test this way  <img class="smilies" src="images/smilies/icon_smile.gif" alt=":)" title="Smile" /> <br /><br />The problem of set /p is that it removes all control characters at the end and it can only handle up to ~1021 characters.<br />The other problem (test8) is that it reads only till ~1021 characters or the first CR/LF.<br /><br />That's why I said that this technic seems to be a dead end  <img class="smilies" src="images/smilies/icon_wink.gif" alt=":wink:" title="Wink" /> <br /><br />Test7 can be solved with the linefeed part of my macro,<br />it adds the linefeeds just after the FOR/F parameter assignment with a CALL.<br /><br /><blockquote><div><cite>jeb wrote:</cite>set &quot;var=!var:^=^^!&quot;%\n%<br />      set &quot;var=!var:&amp;=^&amp;!&quot;%\n%<br />      set &quot;var=!var:|=^|!&quot;%\n%<br />      set &quot;var=!var:&lt;=^&lt;!&quot;%\n%<br />      set &quot;var=!var:&gt;=^&gt;!&quot;%\n%<br />      set &quot;var=!var:&quot;=^^&quot;!&quot; %= REM ** Quotes must be escaped so all other =%  %\n%<br />      set ^&quot;var=!var:%%~L=^^%%~C!&quot; %= REM ** Replace LF with CR, as CR can survive a FOR/F and it can't be in the string =%  %\n%<br />      %= REM ** The extra caret in front of the CR is required when the CR is reverted to a linefeed =%  %\n%<br />      for /F &quot;delims=&quot; %%a in (&quot;&quot;!var!&quot;&quot;) DO (%\n%<br />         endlocal%\n%<br />         endlocal%\n%<br />         set &quot;path=&quot; %= REM ** Path must be removed, to speed up =%%\n%<br />         set &quot;pathext=:&quot; %= REM ** PathExt must be removed, to avoid external search for a set.bat,set.exe,... =%%\n%<br />         set &quot;result=%%~a&quot;%\n%<br />         %= REM ** The first quote must be escaped twice, first for the %NLM% and then for the escaped content of the result =%%\n%<br />         call set %%sfr.caret%%^&quot;result=%%result:%%~C=%NLM%%NLM%%%&quot;%\n%<br />         set &quot;path=%%~D&quot; %= REM ** Restore path and PathExt =%%\n%<br />         set &quot;pathext=%%~Q&quot;%\n%</div></blockquote></div>

			
									
									
						</div>

		</div>

				<div class="back2top">
						<a href="#top" class="top" title="Top">
				<i class="icon fa-chevron-circle-up fa-fw icon-gray" aria-hidden="true"></i>
				<span class="sr-only">Top</span>
			</a>
					</div>
		
		</div>
	</div>

	<hr class="divider" />
				<div id="p30306" class="post has-profile bg2">
		<div class="inner">

		<dl class="postprofile" id="profile30306">
			<dt class="has-profile-rank no-avatar">
				<div class="avatar-container">
																			</div>
								<a href="memberlist3d77.html?mode=viewprofile&amp;u=2258" style="color: #00AA00;" class="username-coloured">dbenham</a>							</dt>

						<dd class="profile-rank">Expert</dd>			
		<dd class="profile-posts"><strong>Posts:</strong> <a href="searcha86d.html?author_id=2258&amp;sr=posts">2152</a></dd>		<dd class="profile-joined"><strong>Joined:</strong> 12 Feb 2011 21:02</dd>		
		
											<dd class="profile-custom-field profile-phpbb_location"><strong>Location:</strong> United States (east coast)</dd>
							
						
		</dl>

		<div class="postbody">
						<div id="post_content30306">

						<h3 ><a href="#p30306">Re: ReturnVar macro revisited</a></h3>

													<ul class="post-buttons">
																																									<li>
							<a href="postinge6c6.html?mode=quote&amp;f=3&amp;p=30306" title="Reply with quote" class="button button-icon-only">
								<i class="icon fa-quote-left fa-fw" aria-hidden="true"></i><span class="sr-only">Quote</span>
							</a>
						</li>
														</ul>
							
						<p class="author"><span class="posti"><a href="viewtopica61a.html?p=30306#p30306" onclick="prompt('Message #22',this.href); return false;">#22</a></span> 
									<a class="unread" href="viewtopica61a.html?p=30306#p30306" title="Post">
						<i class="icon fa-file fa-fw icon-lightgray icon-md" aria-hidden="true"></i><span class="sr-only">Post</span>
					</a>
								<span class="responsive-hide">by <strong><a href="memberlist3d77.html?mode=viewprofile&amp;u=2258" style="color: #00AA00;" class="username-coloured">dbenham</a></strong> &raquo; </span>01 Dec 2013 14:09
			</p>
			
			
			
			<div class="content">Going back to <a href="viewtopicf034-3.html?p=27972" class="postlink">jeb's original post</a>, I find it interesting that the worst performing return is when the return environment has delayed expansion disabled. Yet the absolute simplest solution exists for disabled delayed expansion if the return value does not contain the newline character - a FOR /F can easily return the value without worrying about any escaping.<br /><br />I decided to develop different techniques for handling delayed expansion enabled vs disabled, and return value containing or not containing newline. The enabled delayed expansion code is based on jeb's code. I then experimented with ways of dynamically applying the most efficient method possible, depending on the circumstance.<br /><br />I also added another option to specify the returned ERRORLEVEL. Values of 0 and 1 can be generated very efficiently. But values greater than 1 are more problematic. I started by using <strong class="text-strong">cmd /c exit N</strong>, but that was unacceptably slow on my home machine. I switched to using a CALLed subroutine with <strong class="text-strong">exit /b N</strong>.<br /><br />I now have two optional arguments - the number of active SETLOCAL, and the returned ERRORLEVEL. I opted to make those optional arguments named arguments of the form <strong class="text-strong">local=N</strong> and <strong class="text-strong">err=M</strong>. I adapted jeb's original code to my style with the new optional arguments.<br /><br />I also put all the required macro code in a stand-alone library script. The ugly CALLed functions are embedded within the script. It is very convenient to load the macro from any script as needed.<br /><br />I wrote 3 new versions: macro.rtnDave1.bat, macro.rtnDave2.bat, and macro.rtnDave3.bat, along with my version of jeb's original code - macro.rtnJeb.bat.<br /><br />I also wrote a modified test script that provides timing data. The test script expects a single argument value of dave1, dave2, dave3, or jeb. The argument controls which version of the macro gets loaded into memory.<br /><br /><br /><strong class="text-strong">testReturn.bat</strong><br /><div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>@echo off<br />cls<br />setlocal DisableDelayedExpansion<br />call macro.rtn%1<br />set /a test_cnt=0<br />set &quot;value1=%%1^a!&quot;^^b&quot;<br />set &quot;value2=caret^&quot;<br />set &quot;value3=&quot;<br />set &quot;value4====Equals&quot;<br />rem&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&amp;&quot;&amp;^&amp;!!!^^%^!<br />set ^&quot;value5=^&amp;&quot;&amp;^&amp;!!!^^%%^!&quot;<br />setlocal enabledelayedexpansion<br />set &quot;value6=Hello &amp;^^ &quot;^^^^&nbsp; ^&amp;&quot; world^!!CR!*!LF!X&quot;<br />set &quot;value7=Line1!LF!Line2!LF!&quot;<br />set &quot;value8=Line1!CR!!LF!Line2&quot;<br />set &quot;value9=CR!CR!&quot;<br />echo(<br /><br />for /L %%n in (1 1 9) do call :Test_Both value%%n<br /><br />set &quot;input=&quot;<br />set &quot;singleLine=!value1!&quot;<br />set &quot;multiLine =!value6!&quot;<br />for %%a in (&quot;SingleLine&quot; &quot;MultiLine &quot;) do for %%b in (&quot;Disable&quot; &quot; Enable&quot;) do for %%c in (0 1 2) do (<br />&nbsp; set &quot;beg=!time!&quot;<br />&nbsp; setlocal %%~bDelayedExpansion<br />&nbsp; for /l %%N in (1 1 5000) do (<br />&nbsp; &nbsp; setlocal enableDelayedExpansion<br />&nbsp; &nbsp; set &quot;input=!%%~a!&quot;<br />&nbsp; &nbsp; %returnVar% result input local=1 err=%%c<br />&nbsp; )<br />&nbsp; endlocal<br />&nbsp; set &quot;end=!time!&quot;<br />&nbsp; set /a &quot;t1=t2=0&quot;<br />&nbsp; for /f &quot;tokens=1-4 delims=:.&quot; %%a in (&quot;!beg: =0!&quot;) do set /a &quot;t1=(((1%%a*60)+1%%b)*60+1%%c)*100+1%%d-36610100&quot;<br />&nbsp; for /f &quot;tokens=1-4 delims=:.&quot; %%a in (&quot;!end: =0!&quot;) do set /a &quot;t2=(((1%%a*60)+1%%b)*60+1%%c)*100+1%%d-36610100&quot;<br />&nbsp; set /a &quot;diff=t2-t1&quot;<br />&nbsp; if !diff! lss 0 set /a &quot;diff+=24*60*60*100&quot;<br />&nbsp; echo %%~a %%~b err=%%c : !diff!<br />)<br />exit /b<br /><br />:Test_Both<br />setlocal EnableDelayedExpansion<br />echo ------- %1 -------------------- text='!%1!'<br />for %%x in (0 1 2) do (<br />&nbsp; call :Test_context Disable Disable %1 %%x<br />&nbsp; call :Test_context Disable Enable&nbsp; %1 %%x<br />&nbsp; call :Test_context Enable&nbsp; Disable %1 %%x<br />&nbsp; call :Test_context Enable&nbsp; Enable&nbsp; %1 %%x<br />)<br />echo(<br />exit /b<br /><br />:Test_context<br />set /a test_cnt+=1<br />setlocal %1DelayedExpansion<br />set &quot;result=not set by macro&quot;<br />call :startTest %2 %3 %4<br /><br />REM Output the result<br />set &quot;error=%errorlevel%&quot;<br />setlocal enabledelayedexpansion<br />set &quot;input=inputNotSet&quot;<br />set &quot;format1=&nbsp; Test #!test_cnt! &quot;<br />set &quot;format2=%1/%2&nbsp; &quot;<br />set &quot;postfix=&lt;FAIL&gt;&quot;<br />if &quot;!result!&quot;==&quot;!%~3!&quot; if %error% equ %4 set &quot;postfix=&nbsp; &nbsp;OK &quot;<br />echo !format1:~0,10! err=%4 !postfix! !format2:~0,15! err=!error! result='!result!'<br />exit /b<br /><br /><br />:startTest<br />setlocal enableDelayedExpansion<br />set &quot;input=!%2!&quot;<br />setlocal %1DelayedExpansion<br />%ReturnVar% result input local=2 err=%3<br />exit /b<br /></code></pre></div><br /><br /><strong class="text-strong">macro.rtnJeb.bat</strong><br /><div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>@echo off<br />if not defined returnVar call :loadMacro&amp;exit /b<br />if &quot;%~1&quot; neq &quot;:returnDisabled&quot; exit /b %2<br />setlocal enableDelayedExpansion<br />set &quot;rtn=!%2!&quot;<br />set &quot;rtn=!rtn:%%=%%3!&quot;<br />set &quot;rtn=!rtn:&quot;&quot;n=%%~L!&quot;<br />set &quot;rtn=!rtn:&quot;&quot;r=%%4!&quot;<br />set &quot;rtn=!rtn:&quot;&quot;q=%%~5!&quot;<br />for /f &quot;tokens=1-4&quot; %%3 in (^&quot;%% !CR! &quot;&quot;&quot;&quot;) do (<br />&nbsp; endlocal<br />&nbsp; set &quot;%2=%rtn:~1%&quot;<br />&nbsp; exit /b %%X<br />)<br /><br /><br />:loadMacro<br />if &quot;!&quot; equ &quot;&quot; (<br />&nbsp; &gt;2 echo ERROR: Delayed expansion must be off when loading the returnVar macro.<br />&nbsp; exit /b 1<br />)<br />set LF=^<br /><br /><br />set ^&quot;\n=^^^%LF%%LF%^%LF%%LF%^^&quot;<br />for /F &quot;usebackq delims= &quot; %%C in (`copy /z &quot;%~f0&quot; nul`) do set &quot;CR=%%C&quot;<br /><br />set ^&quot;returnVar=for %%# in (1 2) do if %%#==2 (setlocal enableDelayedExpansion%\n%<br />for /f &quot;tokens=1-4&quot; %%1 in (&quot;!returnVar.args!&quot;) do (%\n%<br />&nbsp; set &quot;rtn=x!%%2!&quot;%\n%<br />&nbsp; set /a &quot;err=!errorlevel!, local=1&quot;%\n%<br />&nbsp; for %%A in (&quot;%%~3&quot; &quot;%%~4&quot;) do if %%A neq &quot;&quot; set /a &quot;%%~A&quot;%\n%<br />&nbsp; set /a &quot;local+=1&quot;%\n%<br />&nbsp; for /f %%R in (&quot;!CR!!CR!&quot;) do for %%L in (&quot;!LF!&quot;) do for %%X in (!err!) do (%\n%<br />&nbsp; &nbsp; set ^&quot;rtn=!rtn:&quot;=&quot;&quot;q!&quot;%\n%<br />&nbsp; &nbsp; set &quot;rtn=!rtn:%%R=&quot;&quot;r!&quot;%\n%<br />&nbsp; &nbsp; set &quot;rtn=!rtn:%%~L=&quot;&quot;n!&quot;%\n%<br />&nbsp; &nbsp; set &quot;rtnDis=!rtn!&quot;%\n%<br />&nbsp; &nbsp; set &quot;rtn=!rtn:^=^^!&quot;%\n%<br />&nbsp; &nbsp; set &quot;path=&quot;%\n%<br />&nbsp; &nbsp; set &quot;pathExt=;&quot;%\n%<br />&nbsp; &nbsp; call set &quot;rtn=%%rtn:^!=&quot;&quot;c^!%%&quot;%\n%<br />&nbsp; &nbsp; set &quot;rtn=!rtn:&quot;&quot;c=^!&quot;%\n%<br />&nbsp; &nbsp; for /f &quot;delims=&quot; %%D in (&quot;&quot;!rtnDis!&quot;&quot;) do for /f &quot;delims=&quot; %%E in (&quot;&quot;!rtn!&quot;&quot;) do (%\n%<br />&nbsp; &nbsp; &nbsp; for /l %%n in (1 1 !local!) do endlocal%\n%<br />&nbsp; &nbsp; &nbsp; if &quot;!&quot;==&quot;&quot; (%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; set &quot;%%1=%%~E&quot; !%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; set &quot;%%1=!%%1:&quot;&quot;n=%%~L!&quot;%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; set &quot;%%1=!%%1:&quot;&quot;r=%%R!&quot;%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; set ^&quot;%%1=!%%1:&quot;&quot;q=&quot;!&quot;%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; set &quot;%%1=!%%1:~1!&quot;%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; if &quot;%%X&quot; equ &quot;0&quot; (call ) else if &quot;%%X&quot; equ &quot;1&quot; (call) else call &quot;%~f0&quot; :exitErr %%X%\n%<br />&nbsp; &nbsp; &nbsp; ) else (%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; set &quot;%%1=%%~D&quot;%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; call &quot;%~f0&quot; :returnDisabled %%1%\n%<br />&nbsp; &nbsp; &nbsp; )%\n%<br />&nbsp; &nbsp; )%\n%<br />&nbsp; )%\n%<br />)) else set returnVar.args=&quot;<br /><br />exit /b 0<br /></code></pre></div><br /><br /><strong class="text-strong">macro.rtnDave1.bat</strong> - new code if value does not contain newline (delayed expansion enabled or disabled)<br /><div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>@echo off<br />if not defined returnVar call :loadMacro&amp;exit /b<br />if &quot;%~1&quot; neq &quot;:returnDisabled&quot; exit /b %2<br />setlocal enableDelayedExpansion<br />set &quot;rtn=!%2!&quot;<br />set &quot;rtn=!rtn:%%=%%3!&quot;<br />set &quot;rtn=!rtn:&quot;&quot;n=%%~L!&quot;<br />set &quot;rtn=!rtn:&quot;&quot;r=%%4!&quot;<br />set &quot;rtn=!rtn:&quot;&quot;q=%%~5!&quot;<br />for /f &quot;tokens=1-4&quot; %%3 in (^&quot;%% !CR! &quot;&quot;&quot;&quot;) do (<br />&nbsp; endlocal<br />&nbsp; set &quot;%2=%rtn%&quot;<br />&nbsp; exit /b %%X<br />)<br /><br /><br />:loadMacro<br />if &quot;!&quot; equ &quot;&quot; (<br />&nbsp; &gt;2 echo ERROR: Delayed expansion must be off when loading the returnVar macro.<br />&nbsp; exit /b 1<br />)<br />set LF=^<br /><br /><br />set ^&quot;\n=^^^%LF%%LF%^%LF%%LF%^^&quot;<br />for /F &quot;usebackq delims= &quot; %%C in (`copy /z &quot;%~f0&quot; nul`) do set &quot;CR=%%C&quot;<br /><br />::returnVar&nbsp; OutVar&nbsp; InVar&nbsp; &#91;Local=N&#93;&nbsp; &#91;Err=N&#93;<br />set ^&quot;ReturnVar=for %%# in (1 2) do if %%#==2 (setlocal enableDelayedExpansion%\n%<br />for /f &quot;tokens=1-4&quot; %%1 in (&quot;!returnVar.args!&quot;) do (%\n%<br />&nbsp; set &quot;rtn=&quot;!%%2!&quot;&quot;%\n%<br />&nbsp; set /a &quot;err=!errorlevel!, local=1&quot;%\n%<br />&nbsp; for %%A in (&quot;%%~3&quot; &quot;%%~4&quot;) do if %%A neq &quot;&quot; set /a &quot;%%~A&quot;%\n%<br />&nbsp; set /a &quot;local+=1&quot;%\n%<br />&nbsp; for %%L in (&quot;!LF!&quot;) do for /f %%R in (&quot;!CR!!CR!&quot;) do for %%X in (!err!) do (%\n%<br />&nbsp; &nbsp; if &quot;!rtn:%%~L=!&quot; equ &quot;!rtn!&quot; (%\n%<br />&nbsp; &nbsp; &nbsp; for /f &quot;delims=&quot; %%V in (&quot;!rtn!&quot;) do (%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; for /l %%N in (1 1 !local!) do endlocal%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; if &quot;!!&quot; neq &quot;&quot; (%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; set &quot;%%1=%%~V&quot;%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; ) else (%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; setlocal disableDelayedExpansion%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; set &quot;rtn=%%V&quot;%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; setlocal enableDelayedExpansion%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; for /f %%R in (&quot;!CR!!CR!&quot;) do (%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; set &quot;rtn=!rtn:@=@A!&quot;%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; set &quot;rtn=!rtn:&quot;=@Q!^&quot;%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; set &quot;rtn=!rtn:%%R=@R!&quot;%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; set &quot;rtn=!rtn:^=@C@C!&quot;%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; setlocal disableDelayedExpansion%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; set &quot;path=&quot;%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; set &quot;pathext=;&quot;%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; call set &quot;rtn=%%rtn:!=@C!%%&quot;%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; setlocal enableDelayedExpansion%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; set &quot;rtn=!rtn:@C=^!&quot;%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; set &quot;rtn=!rtn:@R=%%R!&quot;%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; set &quot;rtn=!rtn:@Q=&quot;!^&quot;%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; set &quot;rtn=!rtn:@A=@!&quot;%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; for /f &quot;delims=&quot; %%V in (&quot;!rtn!&quot;) do (%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; endlocal^&amp;endlocal^&amp;endlocal^&amp;endlocal%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; set &quot;%%1=%%~V&quot;!%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; )%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; )%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; )%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; if &quot;%%X&quot; equ &quot;0&quot; (call ) else if &quot;%%X&quot; equ &quot;1&quot; (call) else call &quot;%~f0&quot; :exitErr %%X%\n%<br />&nbsp; &nbsp; &nbsp; )%\n%<br />&nbsp; &nbsp; ) else (%\n%<br />&nbsp; &nbsp; &nbsp; set &quot;rtn=!rtn:~1,-1!&quot;%\n%<br />&nbsp; &nbsp; &nbsp; set ^&quot;rtn=!rtn:&quot;=&quot;&quot;q!&quot;%\n%<br />&nbsp; &nbsp; &nbsp; set &quot;rtn=!rtn:%%R=&quot;&quot;r!&quot;%\n%<br />&nbsp; &nbsp; &nbsp; set &quot;rtn=!rtn:%%~L=&quot;&quot;n!&quot;%\n%<br />&nbsp; &nbsp; &nbsp; set &quot;rtnDis=!rtn!&quot;%\n%<br />&nbsp; &nbsp; &nbsp; set &quot;rtn=!rtn:^=^^!&quot;%\n%<br />&nbsp; &nbsp; &nbsp; set &quot;path=&quot;%\n%<br />&nbsp; &nbsp; &nbsp; set &quot;pathExt=;&quot;%\n%<br />&nbsp; &nbsp; &nbsp; call set &quot;rtn=%%rtn:^!=&quot;&quot;c^!%%&quot;%\n%<br />&nbsp; &nbsp; &nbsp; set &quot;rtn=!rtn:&quot;&quot;c=^!&quot;%\n%<br />&nbsp; &nbsp; &nbsp; for /f &quot;delims=&quot; %%D in (&quot;!rtnDis!&quot;) do for /f &quot;delims=&quot; %%E in (&quot;!rtn!&quot;) do (%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; for /l %%n in (1 1 !local!) do endlocal%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; if &quot;!&quot;==&quot;&quot; (%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; set &quot;%%1=%%~E&quot; !%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; set &quot;%%1=!%%1:&quot;&quot;n=%%~L!&quot;%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; set &quot;%%1=!%%1:&quot;&quot;r=%%R!&quot;%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; set ^&quot;%%1=!%%1:&quot;&quot;q=&quot;!&quot;%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if &quot;%%X&quot; equ &quot;0&quot; (call ) else if &quot;%%X&quot; equ &quot;1&quot; (call) else call &quot;%~f0&quot; :exitErr %%X%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; ) else (%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; set &quot;%%1=%%~D&quot;%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; call &quot;%~f0&quot; :returnDisabled %%1%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; )%\n%<br />&nbsp; &nbsp; &nbsp; )%\n%<br />&nbsp; &nbsp; )%\n%<br />&nbsp; )%\n%<br />)) else set returnVar.args=^&quot;<br /><br />exit /b<br /></code></pre></div><br /><br /><strong class="text-strong">macro.rtnDave2.bat</strong> - new code only if value does not contain newline and delayed expansion is disabled<br /><div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>@echo off<br />if not defined returnVar call :loadMacro&amp;exit /b<br />if &quot;%~1&quot; neq &quot;:returnDisabled&quot; exit /b %2<br />setlocal enableDelayedExpansion<br />set &quot;rtn=!%2!&quot;<br />set &quot;rtn=!rtn:%%=%%3!&quot;<br />set &quot;rtn=!rtn:&quot;&quot;n=%%~L!&quot;<br />set &quot;rtn=!rtn:&quot;&quot;r=%%4!&quot;<br />set &quot;rtn=!rtn:&quot;&quot;q=%%~5!&quot;<br />for /f &quot;tokens=1-4&quot; %%3 in (^&quot;%% !CR! &quot;&quot;&quot;&quot;) do (<br />&nbsp; endlocal<br />&nbsp; set &quot;%2=%rtn%&quot;<br />&nbsp; exit /b %%X<br />)<br /><br /><br />:loadMacro<br />if &quot;!&quot; equ &quot;&quot; (<br />&nbsp; &gt;2 echo ERROR: Delayed expansion must be off when loading the returnVar macro.<br />&nbsp; exit /b 1<br />)<br />set LF=^<br /><br /><br />set ^&quot;\n=^^^%LF%%LF%^%LF%%LF%^^&quot;<br />for /F &quot;usebackq delims= &quot; %%C in (`copy /z &quot;%~f0&quot; nul`) do set &quot;CR=%%C&quot;<br /><br />::returnVar&nbsp; OutVar&nbsp; InVar&nbsp; &#91;Local=N&#93;&nbsp; &#91;Err=N&#93;<br />set ^&quot;ReturnVar=for %%# in (1 2) do if %%#==2 (setlocal enableDelayedExpansion%\n%<br />for /f &quot;tokens=1-4&quot; %%1 in (&quot;!returnVar.args!&quot;) do (%\n%<br />&nbsp; set &quot;rtn=&quot;!%%2!&quot;&quot;%\n%<br />&nbsp; set /a &quot;err=!errorlevel!, local=1&quot;%\n%<br />&nbsp; for %%A in (&quot;%%~3&quot; &quot;%%~4&quot;) do if %%A neq &quot;&quot; set /a &quot;%%~A&quot;%\n%<br />&nbsp; set /a &quot;local+=1&quot;%\n%<br />&nbsp; for %%L in (&quot;!LF!&quot;) do for /f %%R in (&quot;!CR!!CR!&quot;) do for %%X in (!err!) do (%\n%<br />&nbsp; &nbsp; if &quot;!rtn:%%~L=!&quot; neq &quot;!rtn!&quot; (set returnVar.part2=1) else set &quot;returnVar.part2=&quot;%\n%<br />&nbsp; &nbsp; if not defined returnVar.part2 for /f &quot;delims=&quot; %%V in (&quot;!rtn!&quot;) do (%\n%<br />&nbsp; &nbsp; &nbsp; for /l %%N in (1 1 !local!) do endlocal%\n%<br />&nbsp; &nbsp; &nbsp; if %%V equ &quot;&quot; (%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; set &quot;%%1=%%~V&quot;%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; set &quot;returnVar.part2=&quot;%\n%<br />&nbsp; &nbsp; &nbsp; ) else if &quot;!&quot; neq &quot;&quot; (%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; set &quot;%%1=%%~V&quot;%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; set &quot;returnVar.part2=&quot;%\n%<br />&nbsp; &nbsp; &nbsp; ) else (%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; setlocal disableDelayedExpansion%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; set &quot;rtn=%%V&quot;%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; setlocal enableDelayedExpansion%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; set &quot;returnVar.part2=1&quot;%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; set local=2%\n%<br />&nbsp; &nbsp; &nbsp; )%\n%<br />&nbsp; &nbsp; &nbsp; if not defined returnVar.part2 if &quot;%%X&quot; equ &quot;0&quot; (call ) else if &quot;%%X&quot; equ &quot;1&quot; (call) else call &quot;%~f0&quot; :exitErr %%X%\n%<br />&nbsp; &nbsp; )%\n%<br />&nbsp; &nbsp; if defined returnVar.part2 (%\n%<br />&nbsp; &nbsp; &nbsp; set &quot;returnVar.part2=&quot;%\n%<br />&nbsp; &nbsp; &nbsp; set &quot;rtn=!rtn:~1,-1!&quot;%\n%<br />&nbsp; &nbsp; &nbsp; set ^&quot;rtn=!rtn:&quot;=&quot;&quot;q!&quot;%\n%<br />&nbsp; &nbsp; &nbsp; set &quot;rtn=!rtn:%%R=&quot;&quot;r!&quot;%\n%<br />&nbsp; &nbsp; &nbsp; set &quot;rtn=!rtn:%%~L=&quot;&quot;n!&quot;%\n%<br />&nbsp; &nbsp; &nbsp; set &quot;rtnDis=!rtn!&quot;%\n%<br />&nbsp; &nbsp; &nbsp; set &quot;rtn=!rtn:^=^^!&quot;%\n%<br />&nbsp; &nbsp; &nbsp; set &quot;path=&quot;%\n%<br />&nbsp; &nbsp; &nbsp; set &quot;pathExt=;&quot;%\n%<br />&nbsp; &nbsp; &nbsp; call set &quot;rtn=%%rtn:^!=&quot;&quot;c^!%%&quot;%\n%<br />&nbsp; &nbsp; &nbsp; set &quot;rtn=!rtn:&quot;&quot;c=^!&quot;%\n%<br />&nbsp; &nbsp; &nbsp; for /f &quot;delims=&quot; %%D in (&quot;!rtnDis!&quot;) do for /f &quot;delims=&quot; %%E in (&quot;!rtn!&quot;) do (%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; for /l %%n in (1 1 !local!) do endlocal%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; if &quot;!&quot;==&quot;&quot; (%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; set &quot;%%1=%%~E&quot; !%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; set &quot;%%1=!%%1:&quot;&quot;n=%%~L!&quot;%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; set &quot;%%1=!%%1:&quot;&quot;r=%%R!&quot;%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; set ^&quot;%%1=!%%1:&quot;&quot;q=&quot;!&quot;%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if &quot;%%X&quot; equ &quot;0&quot; (call ) else if &quot;%%X&quot; equ &quot;1&quot; (call) else call &quot;%~f0&quot; :exitErr %%X%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; ) else (%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; set &quot;%%1=%%~D&quot;%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; call &quot;%~f0&quot; :returnDisabled %%1%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; )%\n%<br />&nbsp; &nbsp; &nbsp; )%\n%<br />&nbsp; &nbsp; )%\n%<br />&nbsp; )%\n%<br />)) else set returnVar.args=^&quot;<br /><br />exit /b<br /></code></pre></div><br /><br /><strong class="text-strong">macro.rtnDave3.bat</strong> - new code only if value does not contain newline (or is empty) and delayed expansion is disabled. More escaping done up front before deciding on which technique to use.<br /><div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>@echo off<br />if not defined returnVar call :loadMacro&amp;exit /b<br />if &quot;%~1&quot; neq &quot;:returnDisabled&quot; exit /b %2<br />setlocal enableDelayedExpansion<br />set &quot;rtn=!%2!&quot;<br />set &quot;rtn=!rtn:%%=%%3!&quot;<br />set &quot;rtn=!rtn:&quot;&quot;n=%%~L!&quot;<br />set &quot;rtn=!rtn:&quot;&quot;r=%%4!&quot;<br />set &quot;rtn=!rtn:&quot;&quot;q=%%~5!&quot;<br />for /f &quot;tokens=1-4&quot; %%3 in (^&quot;%% !CR! &quot;&quot;&quot;&quot;) do (<br />&nbsp; endlocal<br />&nbsp; set &quot;%2=%rtn:~1%&quot;<br />&nbsp; exit /b %%X<br />)<br /><br /><br />:loadMacro<br />if &quot;!&quot; equ &quot;&quot; (<br />&nbsp; &gt;2 echo ERROR: Delayed expansion must be off when loading the returnVar macro.<br />&nbsp; exit /b 1<br />)<br />set LF=^<br /><br /><br />set ^&quot;\n=^^^%LF%%LF%^%LF%%LF%^^&quot;<br />for /F &quot;usebackq delims= &quot; %%C in (`copy /z &quot;%~f0&quot; nul`) do set &quot;CR=%%C&quot;<br /><br />::returnVar&nbsp; OutVar&nbsp; InVar&nbsp; &#91;Local=N&#93;&nbsp; &#91;Err=N&#93;<br />set ^&quot;ReturnVar=for %%# in (1 2) do if %%#==2 (setlocal enableDelayedExpansion%\n%<br />for /f &quot;tokens=1-4&quot; %%1 in (&quot;!returnVar.args!&quot;) do (%\n%<br />&nbsp; set &quot;rtn=.!%%2!&quot;%\n%<br />&nbsp; set /a &quot;err=!errorlevel!, local=1&quot;%\n%<br />&nbsp; for %%A in (&quot;%%~3&quot; &quot;%%~4&quot;) do if %%A neq &quot;&quot; set /a &quot;%%~A&quot;%\n%<br />&nbsp; set /a &quot;local+=1&quot;%\n%<br />&nbsp; for %%L in (&quot;!LF!&quot;) do for /f %%R in (&quot;!CR!!CR!&quot;) do for %%X in (!err!) do (%\n%<br />&nbsp; &nbsp; set ^&quot;rtnE=!rtn:&quot;=&quot;&quot;q!&quot;%\n%<br />&nbsp; &nbsp; set &quot;rtnE=!rtnE:%%R=&quot;&quot;r!&quot;%\n%<br />&nbsp; &nbsp; set &quot;rtnD=!rtnE:%%~L=&quot;&quot;n!&quot;%\n%<br />&nbsp; &nbsp; if !rtnD! neq !rtnE! (%\n%<br />&nbsp; &nbsp; &nbsp; set multiLn=1%\n%<br />&nbsp; &nbsp; &nbsp; set &quot;rtnE=!rtnD!&quot;%\n%<br />&nbsp; &nbsp; ) else set &quot;multiLn=0&quot;%\n%<br />&nbsp; &nbsp; set &quot;rtnE=!rtnE:^=^^!&quot;%\n%<br />&nbsp; &nbsp; set &quot;path=&quot;%\n%<br />&nbsp; &nbsp; set &quot;pathExt=;&quot;%\n%<br />&nbsp; &nbsp; call set &quot;rtnE=%%rtnE:^!=&quot;&quot;c^!%%&quot;%\n%<br />&nbsp; &nbsp; set &quot;rtnE=!rtnE:&quot;&quot;c=^!&quot;%\n%<br />&nbsp; &nbsp; set &quot;returnVar.continue=1&quot;%\n%<br />&nbsp; &nbsp; for /f &quot;delims=&quot; %%D in (&quot;!rtnD!&quot;) do for /f &quot;delims=&quot; %%E in (&quot;!rtnE!&quot;) do for %%M in (!multiLn!) do for /f &quot;delims=&quot; %%V in (&quot;&quot;!rtn:~1!&quot;&quot;) do if defined returnVar.continue (%\n%<br />&nbsp; &nbsp; &nbsp; for /l %%n in (1 1 !local!) do endlocal%\n%<br />&nbsp; &nbsp; &nbsp; if &quot;!&quot;==&quot;&quot; (%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; set &quot;%%1=%%~E&quot; !%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; set &quot;%%1=!%%1:&quot;&quot;n=%%~L!&quot;%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; set &quot;%%1=!%%1:&quot;&quot;r=%%R!&quot;%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; set ^&quot;%%1=!%%1:&quot;&quot;q=&quot;!&quot;%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; set &quot;%%1=!%%1:~1!&quot;%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; if &quot;%%X&quot; equ &quot;0&quot; (call ) else if &quot;%%X&quot; equ &quot;1&quot; (call) else call &quot;%~f0&quot; :exitErr %%X%\n%<br />&nbsp; &nbsp; &nbsp; ) else if %%M equ 0 (%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; set &quot;%%1=%%~V&quot;%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; if &quot;%%X&quot; equ &quot;0&quot; (call ) else if &quot;%%X&quot; equ &quot;1&quot; (call) else call &quot;%~f0&quot; :exitErr %%X%\n%<br />&nbsp; &nbsp; &nbsp; ) else (%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; set &quot;%%1=%%~D&quot;%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; call &quot;%~f0&quot; :returnDisabled %%1%\n%<br />&nbsp; &nbsp; &nbsp; )%\n%<br />&nbsp; &nbsp; )%\n%<br />&nbsp; )%\n%<br />)) else set returnVar.args=^&quot;<br /><br />exit /b<br /></code></pre></div><br /><br /><strong class="text-strong">Here are the timing results, two runs for each test. I think I prefer the Dave2 version.</strong><br /><div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Timing for 5000 Iterations (centiseconds)<br /><br />&nbsp; TEST&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp; &nbsp;JEB&nbsp; &nbsp; &nbsp;|&nbsp; &nbsp;DAVE1&nbsp; &nbsp;|&nbsp; &nbsp;DAVE2&nbsp; &nbsp;|&nbsp; &nbsp;DAVE3<br />-------------------------+-----------+-----------+-----------+----------<br />SingleLine Disable err=0 | 3778 3772 | 1392 1483 | 1194 1196 | 1778 1781<br />SingleLine Disable err=1 | 3772 3767 | 1366 1370 | 1194 1196 | 1791 1794<br />SingleLine Disable err=2 | 3777 3755 | 2344 2725 | 2014 2381 | 3105 3120<br />-------------------------+-----------+-----------+-----------+----------<br />SingleLine&nbsp; Enable err=0 | 1236 1226 | 2504 2508 | 2015 2020 | 1873 1876<br />SingleLine&nbsp; Enable err=1 | 1246 1237 | 2503 2508 | 1931 1930 | 1876 1882<br />SingleLine&nbsp; Enable err=2 | 2381 2376 | 3503 3887 | 2732 3099 | 3257 3267<br />-------------------------+-----------+-----------+-----------+----------<br />MultiLine&nbsp; Disable err=0 | 3819 3800 | 4550 5365 | 3524 4291 | 5246 5270<br />MultiLine&nbsp; Disable err=1 | 3822 3814 | 4556 5377 | 3520 4278 | 5260 5298<br />MultiLine&nbsp; Disable err=2 | 3806 3804 | 4543 5364 | 3497 4286 | 5263 5300<br />-------------------------+-----------+-----------+-----------+----------<br />MultiLine&nbsp; &nbsp;Enable err=0 | 1274 1273 | 2014 2020 | 1643 1640 | 1989 1990<br />MultiLine&nbsp; &nbsp;Enable err=1 | 1283 1283 | 2019 2016 | 1646 1645 | 1990 1994<br />MultiLine&nbsp; &nbsp;Enable err=2 | 2433 2426 | 3027 3408 | 2442 2808 | 3368 3366<br /></code></pre></div><br /><br />Dave Benham</div>

			
									
									
						</div>

		</div>

				<div class="back2top">
						<a href="#top" class="top" title="Top">
				<i class="icon fa-chevron-circle-up fa-fw icon-gray" aria-hidden="true"></i>
				<span class="sr-only">Top</span>
			</a>
					</div>
		
		</div>
	</div>

	<hr class="divider" />
				<div id="p30315" class="post has-profile bg1">
		<div class="inner">

		<dl class="postprofile" id="profile30315">
			<dt class="has-profile-rank no-avatar">
				<div class="avatar-container">
																			</div>
								<a href="memberliste2cd.html?mode=viewprofile&amp;u=2453" class="username">Ed Dyreen</a>							</dt>

						<dd class="profile-rank">Expert</dd>			
		<dd class="profile-posts"><strong>Posts:</strong> <a href="search0d5e.html?author_id=2453&amp;sr=posts">1497</a></dd>		<dd class="profile-joined"><strong>Joined:</strong> 16 May 2011 08:21</dd>		
		
																<dd class="profile-custom-field profile-phpbb_location"><strong>Location:</strong> Flanders(Belgium)</dd>
							
							<dd class="profile-contact">
				<strong>Contact:</strong>
				<div class="dropdown-container dropdown-left">
					<a href="#" class="dropdown-trigger" title="Contact Ed Dyreen">
						<i class="icon fa-commenting-o fa-fw icon-lg" aria-hidden="true"></i><span class="sr-only">Contact Ed Dyreen</span>
					</a>
					<div class="dropdown">
						<div class="pointer"><div class="pointer-inner"></div></div>
						<div class="dropdown-contents contact-icons">
																																								<div>
																	<a href="http://ed-dyreen.ddns.net/" title="Website" class="last-cell">
										<span class="contact-icon phpbb_website-icon">Website</span>
									</a>
																	</div>
																					</div>
					</div>
				</div>
			</dd>
				
		</dl>

		<div class="postbody">
						<div id="post_content30315">

						<h3 ><a href="#p30315">Re: ReturnVar macro revisited</a></h3>

													<ul class="post-buttons">
																																									<li>
							<a href="posting685a-2.html?mode=quote&amp;f=3&amp;p=30315" title="Reply with quote" class="button button-icon-only">
								<i class="icon fa-quote-left fa-fw" aria-hidden="true"></i><span class="sr-only">Quote</span>
							</a>
						</li>
														</ul>
							
						<p class="author"><span class="posti"><a href="viewtopiccb12.html?p=30315#p30315" onclick="prompt('Message #23',this.href); return false;">#23</a></span> 
									<a class="unread" href="viewtopiccb12.html?p=30315#p30315" title="Post">
						<i class="icon fa-file fa-fw icon-lightgray icon-md" aria-hidden="true"></i><span class="sr-only">Post</span>
					</a>
								<span class="responsive-hide">by <strong><a href="memberliste2cd.html?mode=viewprofile&amp;u=2453" class="username">Ed Dyreen</a></strong> &raquo; </span>02 Dec 2013 03:00
			</p>
			
			
			
			<div class="content">Well of all code I see, mine must be the ugliest duck <img class="smilies" src="images/smilies/icon_razz.gif" alt=":P" title="Razz" /> <br /><br />Funny, I recently tried to get $cr, $lf over endlocal in a single expansion too.<br />But after haven't coded a single line of DOS in an entire year I forgot this is currently impossible.<br />So I gave up where jeb stated that even though it can't be done in disDelayed it still is possible for enaDelayed.<br /><br />I recently had problems with my %replace_% macro replacing linefeeds due to the fact it implements my %endlocal_% macro<br />that doesn't support $lf, $cr.<br /><br />I nest the %endlocal_% macro inside other macro's and the outer macro can't exceed 8k.<br />Though some variables are missing, I'm sure expert can follow.<br /><br />I've updated my endlocal_ macro from this;<br /><div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>::--------------------------------------------------------------------------------------------------------------------------<br />set &quot;$defines=endlocal_&quot;<br />::--------------------------------------------------------------------------------------------------------------------------<br />:: last updated&nbsp; &nbsp; &nbsp; &nbsp;: 2012^11^19<br />:: support&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; : naDelayed, no ( $cr, $lf )<br />::<br />::&nbsp; &nbsp;-the number of optional endlocals is the first parameter.<br />::&nbsp; &nbsp;-multiple variables can be returned at once.<br />::&nbsp; &nbsp;-the maximum return size which is 8k is the maximum of the sum of all sizes of all variables to return.<br />::<br />set ^&quot;$usage.%$defines%=^<br />%=&nbsp; &nbsp;=% use: ( %%endlocal_%% #eCount, #var, #etc.. )%$n1c%<br />%=&nbsp; &nbsp;=% err: Unaffected, panic otherwise&quot;<br />::<br />2&gt;nul ( %macroStart_% enableDelayedExpansion )<br />:: (<br />%=&nbsp; &nbsp;=%set ^&quot;!$defines!=!forQ_! (1,2) do if %%?==2 (^<br />!==^^^!^<br />%=&nbsp; &nbsp; &nbsp; =%set ¤=^&amp;!forQ_! (^^^!º^^^!) do if ^^^!¤^^^!.==. set/a¤=0%%~? 2^&gt;nul^&amp;^&amp;(%=&nbsp; &nbsp;endlocal count&nbsp; &nbsp; =%^<br />%=&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;=%call set º=%%º:*^^^!¤^^^!=%%^&amp;set/a¤+=1^<br />%=&nbsp; &nbsp; &nbsp; =%)^|^|set/a¤=2%$n1c%<br />%=&nbsp; &nbsp; &nbsp; =%set _=^&amp;!forQ_! (^^^!º^^^!) do (^<br />%=&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;=%set ?=^^^!%%~?^^^!^&amp;if defined ? set ?=^^^!?:§=§§^^^!%=&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;coded mark set&nbsp; &nbsp; =%%$n1c%<br />%=&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;=%set _=^^^!_^^^!l§f%%~?=^^^!?^^^!%=&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; coded add $lf&nbsp; &nbsp; &nbsp;=%%$n1c%<br />%=&nbsp; &nbsp; &nbsp; =%)%$n1c%<br />%=&nbsp; &nbsp; &nbsp; =%set _=^^^!_:^^^&quot;=&quot;&quot;^^^!%=&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; code pre 94, 33&nbsp; &nbsp;=%%$n1c%<br />%=&nbsp; &nbsp; &nbsp; =%set &quot;_=^!_:^^^=9§4^!&quot;^&amp;call set &quot;_=%%^^^_:^^^!=3§3%%&quot;%=&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; enco&nbsp; &nbsp; &nbsp;94, 33&nbsp; &nbsp;=%%$n1c%<br />%=&nbsp; &nbsp; &nbsp; =%for /f &quot;delims=&quot; %%r in (&quot;^!_:~3^!&quot;) do (^<br />%=&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;=%!forC_! (1,1,^^^!¤^^^!) do endlocal%$n1c%<br />%=&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;=%set ?=^^^!^&amp;setlocal enableDelayedExpansion%=&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;outer delay&nbsp; &nbsp; &nbsp; &nbsp;=%%$n1c%<br />%=&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;=%set _=%%r%$n1c%<br />%=&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;=%call set &quot;_=%%^^^_:3§3=3§3^^^!%%&quot;^&amp;if defined ? (%=&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;deco&nbsp; &nbsp; &nbsp;94, 33&nbsp; &nbsp;=%^<br />%=&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; =%set &quot;_=^!_:9§4=^^^!&quot;^&amp;set _=^^^!_:3§3=^^^!^<br />%=&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;=%)else set &quot;_=^!_:9§4=^^^^^!&quot;^&amp;set &quot;_=^!_:3§3=^^^!&quot;%$n1c%<br />%=&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;=%set _=^^^!_:&quot;&quot;=^^^&quot;^^^!%=&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;code pst 94, 33&nbsp; &nbsp;=%%$n1c%<br />%=&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;=%!forQ_! (&quot;^!$lf^!&quot;) do set _=^^^!_:l§f=%%~?^^^!%=&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;deco $lf&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; =%%$n1c%<br />%=&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;=%set _=^^^!_:§§=§^^^!%=&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; coded mark unset&nbsp; =%%$n1c%<br />%=&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;=%!forLineR_! (&quot;^!_^!&quot;) do endlocal^&amp;set &quot;%%r&quot;^^^!^&amp;setlocal enableDelayedExpansion%$n1c%<br />%=&nbsp; &nbsp; &nbsp; =%endlocal)^<br />!==^^^!^<br />%=&nbsp; &nbsp;=%)else setlocal enableDelayedExpansion^&amp;set º=&quot;<br />:: )<br />2&gt;nul %macroEnd%<br />%endlocalR_% (<br />%$%<br />)<br /></code></pre></div>to this;<div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>::--------------------------------------------------------------------------------------------------------------------------<br />set &quot;$defines=endlocal_&quot;<br />::--------------------------------------------------------------------------------------------------------------------------<br />:: last updated&nbsp; &nbsp; &nbsp; &nbsp;: 2013^12^01<br />:: support&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; : naDelayed, disDelayed gives encoded ( $cr, $lf ), enaDelayed supports ( $cr, $lf )<br />::<br />::&nbsp; &nbsp;-the number of optional endlocals is the first parameter.<br />::&nbsp; &nbsp;-multiple variables can be returned at once.<br />::&nbsp; &nbsp;-the maximum return size which is 8k is the maximum of the sum of all sizes of all variables to return.<br />::<br />set ^&quot;$usage.%$defines%=^<br />%=&nbsp; &nbsp;=% use: ( %%endlocal_%% #eCount, #var, #etc.. )%$n1c%<br />%=&nbsp; &nbsp;=% err: Unaffected, panic otherwise&quot;<br />::<br />2&gt;nul ( %macroStart_% enableDelayedExpansion )<br />:: (<br />%=&nbsp; &nbsp;=%set ^&quot;!$defines!=!forQ_! (1,2) do if %%?==2 (^<br />!==^^^!^<br />%=&nbsp; &nbsp; &nbsp; =%set ¤=^&amp;!forQ_! (^^^!º^^^!) do if ^^^!¤^^^!.==. set/a¤=0%%~? 2^&gt;nul^&amp;^&amp;(%=&nbsp; &nbsp;endlocal count&nbsp; &nbsp; =%^<br />%=&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;=%call set º=%%º:*^^^!¤^^^!=%%^&amp;set/a¤+=1^<br />%=&nbsp; &nbsp; &nbsp; =%)^|^|set/a¤=2%$n1c%<br />%=&nbsp; &nbsp; &nbsp; =%set _=^&amp;!forQ_! (^^^!º^^^!) do (^<br />%=&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;=%set ?=^^^!%%~?^^^!^&amp;if defined ? (^<br />%=&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; =%set ?=^^^!?:§=§0^^^!%=&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;coded mark set&nbsp; &nbsp; =%%$n1c%<br />%=&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; =%set ?=^^^!?:^^^^!$lf!!$lf!=§0l^^^!%=&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;enco $lf&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; =%%$n1c%<br />%=&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; =%for /f %%1 in (&quot;^!$cr^! &quot;) do set ?=^^^!?:%%1=§0c^^^!%=&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; enco $cr&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; =%^<br />%=&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;=%)%$n1c%<br />%=&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;=%set _=^^^!_^^^!§l%%~?=^^^!?^^^!%=&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;coded add $lf&nbsp; &nbsp; &nbsp;=%^<br />%=&nbsp; &nbsp; &nbsp; =%)%$n1c%<br />%=&nbsp; &nbsp; &nbsp; =%set _=^^^!_:^^^&quot;=&quot;&quot;^^^!%=&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; code pre 94, 33&nbsp; &nbsp;=%%$n1c%<br />%=&nbsp; &nbsp; &nbsp; =%set &quot;_=^!_:^^^=§9^!&quot;^&amp;call set &quot;_=%%^^^_:^^^!=§3%%&quot;%=&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; enco&nbsp; &nbsp; &nbsp;94, 33&nbsp; &nbsp;=%%$n1c%<br />%=&nbsp; &nbsp; &nbsp; =%for /f delims^^^^= %%r in (&quot;^!_:~2^!&quot;) do (^<br />%=&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;=%!forC_! (1,1,^^^!¤^^^!) do endlocal%$n1c%<br />%=&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;=%set ?=^^^!^&amp;setlocal enableDelayedExpansion%=&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;outer delay&nbsp; &nbsp; &nbsp; &nbsp;=%%$n1c%<br />%=&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;=%set _=%%r%$n1c%<br />%=&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;=%call set &quot;_=%%^^^_:§3=§3^^^!%%&quot;^&amp;if ^^^!?^^^!.==. (%=&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;deco&nbsp; &nbsp; &nbsp;94, 33&nbsp; &nbsp;=%^<br />%=&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; =%set &quot;_=^!_:§9=^^^^^!&quot;^&amp;set &quot;_=^!_:§3=^^^!&quot;%$n1c%<br />%=&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;=%)else set &quot;_=^!_:§9=^^^!&quot;^&amp;set _=^^^!_:§3=^^^!%$n1c%<br />%=&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;=%set _=^^^!_:&quot;&quot;=^^^&quot;^^^!%=&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;code pst 94, 33&nbsp; &nbsp;=%%$n1c%<br />%=&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;=%!forQ_! (&quot;^!$lf^!&quot;) do set _=^^^!_:§l=%%~?^^^!%=&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; deco $lf&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; =%%$n1c%<br />%=&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;=%set _=^^^!_:§0=§^^^!%=&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; coded mark unset&nbsp; =%%$n1c%<br />%=&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;=%!forLineR_! (&quot;^!_^!&quot;) do (^<br />%=&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; =%endlocal%$n1c%<br />%=&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; =%if ^^^!.==. (^<br />%=&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;=%set _=%%r^^^!%$n1c%<br />%=&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;=%set _=^^^!_:§l=^^^^!$lf!!$lf!^^^!%=&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;deco $lf&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; =%%$n1c%<br />%=&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;=%for /f %%1 in (&quot;^!$cr^! &quot;) do set _=^^^!_:§c=%%1^^^!%=&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; deco $cr&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; =%%$n1c%<br />%=&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;=%set &quot;^!_^!&quot;^^^!^<br />%=&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; =%)else set &quot;%%r&quot;%$n1c%<br />%=&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; =%setlocal enableDelayedExpansion^<br />%=&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;=%)%$n1c%<br />%=&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;=%endlocal^<br />%=&nbsp; &nbsp; &nbsp; =%)^<br />!==^^^!^<br />%=&nbsp; &nbsp;=%)else setlocal enableDelayedExpansion^&amp;set º=&quot;<br />:: )<br />2&gt;nul %macroEnd%<br />%endlocalR_% (<br />%$%<br />)<br /></code></pre></div>I changed;<br /><br />-FOR /F %%R in (&quot;!CR! #&quot;) DO set &quot;%%~N=!%%~N:&quot;&quot;r=%%~R!&quot;%\n%<br /> to FOR /F %%R in (&quot;!CR! &quot;) DO set &quot;%%~N=!%%~N:&quot;&quot;r=%%~R!&quot;%\n%<br /><br />-the encoding mark §0 which is sometimes shorter than §§ due to better encrypt, §l instead of l§f etc<br /><br />-deco 94, 33<br /><br />A quick verify seems to be bugfree<br /><div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>set $var0=<br />setlocal disableDelayedExpansion<br />setlocal enableDelayedExpansion<br />setlocal enableDelayedExpansion<br />:: (<br />&nbsp; &nbsp;set &quot;$var0=&quot;sim!$lf!sam!$cr!^^^^&quot;ple^^&quot; !<br />&nbsp; &nbsp;set &quot;$var1=;:()*&lt;=&gt;^^?^!&quot; !<br />&nbsp; &nbsp;%nechon_%<br />&nbsp; &nbsp;set $var0<br />&nbsp; &nbsp;set $var1<br />:: )<br />( %endlocal_% 1, $var0, $var1 )<br />%echon_%<br />set $var0<br />set $var1<br />endlocal<br />%echon_%<br />set $var0<br />set $var1<br />endlocal</code></pre></div>--- output ---<div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>$var0=&quot;sim<br />^&quot;ple^<br />$var1=;:()*&lt;=&gt;^?!<br /><br />$var0=&quot;sim<br />^&quot;ple^<br />$var1=;:()*&lt;=&gt;^?!<br /><br />Omgevingsvariabele $var0 is niet gedefinieerd<br />Omgevingsvariabele $var1 is niet gedefinieerd</code></pre></div>I haven't measured the number of bytes it occupies yet, hope it don't waste memory, having things fit within 8k is such a pain <img class="smilies" src="images/smilies/icon_sad.gif" alt=":(" title="Sad" /></div>

			
									
									
						</div>

		</div>

				<div class="back2top">
						<a href="#top" class="top" title="Top">
				<i class="icon fa-chevron-circle-up fa-fw icon-gray" aria-hidden="true"></i>
				<span class="sr-only">Top</span>
			</a>
					</div>
		
		</div>
	</div>

	<hr class="divider" />
				<div id="p32476" class="post has-profile bg2">
		<div class="inner">

		<dl class="postprofile" id="profile32476">
			<dt class="has-profile-rank no-avatar">
				<div class="avatar-container">
																			</div>
								<a href="memberlist2970.html?mode=viewprofile&amp;u=3077" class="username">Liviu</a>							</dt>

						<dd class="profile-rank">Expert</dd>			
		<dd class="profile-posts"><strong>Posts:</strong> <a href="searche861.html?author_id=3077&amp;sr=posts">470</a></dd>		<dd class="profile-joined"><strong>Joined:</strong> 13 Jan 2012 21:24</dd>		
		
						
						
		</dl>

		<div class="postbody">
						<div id="post_content32476">

						<h3 ><a href="#p32476">Re: ReturnVar macro revisited</a></h3>

													<ul class="post-buttons">
																																									<li>
							<a href="postingca13.html?mode=quote&amp;f=3&amp;p=32476" title="Reply with quote" class="button button-icon-only">
								<i class="icon fa-quote-left fa-fw" aria-hidden="true"></i><span class="sr-only">Quote</span>
							</a>
						</li>
														</ul>
							
						<p class="author"><span class="posti"><a href="viewtopic8e0b.html?p=32476#p32476" onclick="prompt('Message #24',this.href); return false;">#24</a></span> 
									<a class="unread" href="viewtopic8e0b.html?p=32476#p32476" title="Post">
						<i class="icon fa-file fa-fw icon-lightgray icon-md" aria-hidden="true"></i><span class="sr-only">Post</span>
					</a>
								<span class="responsive-hide">by <strong><a href="memberlist2970.html?mode=viewprofile&amp;u=3077" class="username">Liviu</a></strong> &raquo; </span>12 Feb 2014 22:56
			</p>
			
			
			
			<div class="content"><blockquote><div><cite>dbenham wrote:</cite>I adapted jeb's original code to my style with the new optional arguments.<br /></div></blockquote><br />Below is a variation on your adaption of Jeb's returnVar macro. No offense to others <img class="smilies" src="images/smilies/icon_wink.gif" alt=";-)" title="Wink" /> but this was the shortest macro to practice on. The macro has only minor changes, and it may be a few bytes shorter, but otherwise it's functionally and speed-wise (hopefully) equivalent to the original. It appears to pass your testReturn.bat OK. Details are in the fully commented code posted next to the abbreviated version.<br /><div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>@echo off<br />if not defined returnVar call :loadMacro&amp;exit /b<br />if &quot;%~1&quot; neq &quot;:returnDisabled&quot; exit /b %2<br />setlocal enableDelayedExpansion<br />set &quot;rtn=!%2!&quot;<br />set &quot;rtn=!rtn:%%=%%3!&quot;<br />set &quot;rtn=!rtn:&quot;&quot;n=%%~L!&quot;<br />set &quot;rtn=!rtn:&quot;&quot;r=%%~R!&quot;<br />set &quot;rtn=!rtn:&quot;&quot;q=%%4!&quot;<br />for /f &quot;usebackq tokens=1,2&quot; %%3 in (' %% ^&quot; ') do (<br />&nbsp; endlocal<br />&nbsp; set &quot;%2=%rtn:~1%&quot;<br />&nbsp; exit /b %%X<br />)<br /><br />:loadMacro<br />if &quot;!&quot; equ &quot;&quot; (<br />&nbsp; &gt;&amp;2 echo ERROR: Delayed expansion must be off when loading the returnVar macro.<br />&nbsp; exit /b 1<br />)<br />set LF=^<br /><br /><br />set ^&quot;\n=^^^%LF%%LF%^%LF%%LF%^^&quot;<br />for /F &quot;usebackq delims= &quot; %%C in (`copy /z &quot;%~f0&quot; nul`) do set &quot;CR=%%C&quot;<br /><br />set ^&quot;returnVar=for %%# in (1 2) do if %%#==2 (setlocal enableDelayedExpansion%\n%<br />for /f &quot;tokens=1-4&quot; %%1 in (&quot;!returnVar.args!&quot;) do (%\n%<br />&nbsp; set &quot;rtn=x!%%2!&quot;%\n%<br />&nbsp; set /a err=!errorlevel!, local=1%\n%<br />&nbsp; for %%A in (&quot;%%~3&quot; &quot;%%~4&quot;) do if %%A neq &quot;&quot; set /a &quot;%%~A&quot;%\n%<br />&nbsp; for %%R in (&quot;!CR!&quot;) do for %%L in (&quot;!LF!&quot;) do for %%X in (!err!) do (%\n%<br />&nbsp; &nbsp; set rtn=!rtn:^&quot;=&quot;&quot;q!%\n%<br />&nbsp; &nbsp; set rtn=!rtn:%%~R=&quot;&quot;r!%\n%<br />&nbsp; &nbsp; set rtn=!rtn:%%~L=&quot;&quot;n!%\n%<br />&nbsp; &nbsp; set rtnDis=!rtn!%\n%<br />&nbsp; &nbsp; set &quot;rtn=!rtn:^=^^!&quot;%\n%<br />&nbsp; &nbsp; set path=%\n%<br />&nbsp; &nbsp; set pathExt=;%\n%<br />&nbsp; &nbsp; call set &quot;rtn=%%rtn:^!=&quot;&quot;c^!%%&quot;%\n%<br />&nbsp; &nbsp; set &quot;rtn=!rtn:&quot;&quot;c=^!&quot;%\n%<br />&nbsp; &nbsp; for /f &quot;delims=&quot; %%D in (&quot;!rtnDis!&quot;) do for /f &quot;delims=&quot; %%E in (&quot;!rtn!&quot;) do (%\n%<br />&nbsp; &nbsp; &nbsp; for /l %%n in (0 1 !local!) do endlocal%\n%<br />&nbsp; &nbsp; &nbsp; if &quot;!&quot;==&quot;&quot; (%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; set &quot;%%1=%%E&quot; !%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; set %%1=!%%1:&quot;&quot;n=%%~L!%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; set %%1=!%%1:&quot;&quot;r=%%~R!%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; set %%1=!%%1:^&quot;&quot;q=&quot;!%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; set %%1=!%%1:~1!%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; if &quot;%%X&quot; equ &quot;0&quot; (call ) else if &quot;%%X&quot; equ &quot;1&quot; (call) else call &quot;%~f0&quot; :exitErr %%X%\n%<br />&nbsp; &nbsp; &nbsp; ) else (%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; set %%1=%%D%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; call &quot;%~f0&quot; :returnDisabled %%1%\n%<br />&nbsp; &nbsp; &nbsp; )%\n%<br />&nbsp; &nbsp; )%\n%<br />&nbsp; )%\n%<br />)) else set returnVar.args=&quot;<br /><br />exit /b 0<br /></code></pre></div><br />Same code as above, now with full comments... It's not the first time I &quot;parse&quot; this macro, but it's all those less-than-obvious details that never seem to make it into my long term memory. Maybe this will help me remember faster next time, or perhaps will help someone else follow the mechanics more readily.<br /><div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>@echo off<br />if not defined returnVar call :loadMacro&amp;exit /b<br />if &quot;%~1&quot; neq &quot;:returnDisabled&quot; exit /b %2<br />setlocal enableDelayedExpansion<br />set &quot;rtn=!%2!&quot;<br />set &quot;rtn=!rtn:%%=%%3!&quot;<br />@rem &#91;12&#93;<br />set &quot;rtn=!rtn:&quot;&quot;n=%%~L!&quot;<br />@rem &#91;13&#93; :: set &quot;rtn=!rtn:&quot;&quot;r=%%4!&quot;<br />set &quot;rtn=!rtn:&quot;&quot;r=%%~R!&quot;<br />@rem &#91;13&#93; :: set &quot;rtn=!rtn:&quot;&quot;q=%%~5!&quot;<br />set &quot;rtn=!rtn:&quot;&quot;q=%%4!&quot;<br />@rem &#91;e&#93; &#91;13&#93; &#91;14&#93; :: for /f &quot;tokens=1-4&quot; %%3 in (^&quot;%% !CR! &quot;&quot;&quot;&quot;) do (<br />for /f &quot;usebackq tokens=1,2&quot; %%3 in (' %% ^&quot; ') do (<br />&nbsp; endlocal<br />@rem &#91;f&#93; &#91;1&#93; why :~1<br />&nbsp; set &quot;%2=%rtn:~1%&quot;<br />&nbsp; exit /b %%X<br />)<br /><br />:loadMacro<br />if &quot;!&quot; equ &quot;&quot; (<br />@rem &#91;0&#93; :: &gt;2 echo ...<br />&nbsp; &gt;&amp;2 echo ERROR: Delayed expansion must be off when loading the returnVar macro.<br />&nbsp; exit /b 1<br />)<br />set LF=^<br /><br /><br />set ^&quot;\n=^^^%LF%%LF%^%LF%%LF%^^&quot;<br />for /F &quot;usebackq delims= &quot; %%C in (`copy /z &quot;%~f0&quot; nul`) do set &quot;CR=%%C&quot;<br /><br />set ^&quot;returnVar=for %%# in (1 2) do if %%#==2 (setlocal enableDelayedExpansion%\n%<br />for /f &quot;tokens=1-4&quot; %%1 in (&quot;!returnVar.args!&quot;) do (%\n%<br />@rem &#91;a&#93; &#91;1&#93; why 'x' %\n%<br />&nbsp; set &quot;rtn=x!%%2!&quot;%\n%<br />@rem &#91;2&#93; &#91;3&#93; :: set /a &quot;err=!errorlevel!, local=1&quot;%\n%<br />&nbsp; set /a err=!errorlevel!, local=1%\n%<br />&nbsp; for %%A in (&quot;%%~3&quot; &quot;%%~4&quot;) do if %%A neq &quot;&quot; set /a &quot;%%~A&quot;%\n%<br />@rem &#91;4&#93; :: set /a &quot;local+=1&quot;%\n%<br />@rem &#91;5&#93;%\n% :: for /f %%R in (&quot;!CR!!CR!&quot;) do for %%L in (&quot;!LF!&quot;) do for %%X in (!err!) do (%\n%<br />&nbsp; for %%R in (&quot;!CR!&quot;) do for %%L in (&quot;!LF!&quot;) do for %%X in (!err!) do (%\n%<br />@rem &#91;6&#93; &#91;7&#93; :: set ^&quot;rtn=!rtn:&quot;=&quot;&quot;q!&quot;%\n%<br />&nbsp; &nbsp; set rtn=!rtn:^&quot;=&quot;&quot;q!%\n%<br />@rem &#91;5&#93; &#91;3&#93; :: set &quot;rtn=!rtn:%%R=&quot;&quot;r!&quot;%\n%<br />&nbsp; &nbsp; set rtn=!rtn:%%~R=&quot;&quot;r!%\n%<br />@rem &#91;3&#93; :: set &quot;rtn=!rtn:%%~L=&quot;&quot;n!&quot;%\n%<br />@rem&nbsp; &nbsp; &nbsp;:: set &quot;rtnDis=!rtn!&quot;%\n%<br />&nbsp; &nbsp; set rtn=!rtn:%%~L=&quot;&quot;n!%\n%<br />&nbsp; &nbsp; set rtnDis=!rtn!%\n%<br />@rem &#91;b&#93; &#91;8&#93;%\n%<br />&nbsp; &nbsp; set &quot;rtn=!rtn:^=^^!&quot;%\n%<br />&nbsp; &nbsp; set path=%\n%<br />&nbsp; &nbsp; set pathExt=;%\n%<br />@rem &#91;9&#93;%\n%<br />&nbsp; &nbsp; call set &quot;rtn=%%rtn:^!=&quot;&quot;c^!%%&quot;%\n%<br />&nbsp; &nbsp; set &quot;rtn=!rtn:&quot;&quot;c=^!&quot;%\n%<br />@rem &#91;c&#93; &#91;10&#93; :: for /f &quot;delims=&quot; %%D in (&quot;&quot;!rtnDis!&quot;&quot;) do for /f &quot;delims=&quot; %%E in (&quot;&quot;!rtn!&quot;&quot;) do (%\n%<br />&nbsp; &nbsp; for /f &quot;delims=&quot; %%D in (&quot;!rtnDis!&quot;) do for /f &quot;delims=&quot; %%E in (&quot;!rtn!&quot;) do (%\n%<br />@rem &#91;4&#93; :: for /l %%n in (1 1 !local!) do endlocal%\n%<br />&nbsp; &nbsp; &nbsp; for /l %%n in (0 1 !local!) do endlocal%\n%<br />&nbsp; &nbsp; &nbsp; if &quot;!&quot;==&quot;&quot; (%\n%<br />@rem &#91;10&#93; &#91;11&#93; :: set &quot;%%1=%%~E&quot; !%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; set &quot;%%1=%%E&quot; !%\n%<br />@rem &#91;3&#93; :: set &quot;%%1=!%%1:&quot;&quot;n=%%~L!&quot;%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; set %%1=!%%1:&quot;&quot;n=%%~L!%\n%<br />@rem &#91;5&#93; &#91;3&#93; :: set &quot;%%1=!%%1:&quot;&quot;r=%%R!&quot;%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; set %%1=!%%1:&quot;&quot;r=%%~R!%\n%<br />@rem &#91;7&#93; :: set ^&quot;%%1=!%%1:&quot;&quot;q=&quot;!&quot;%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; set %%1=!%%1:^&quot;&quot;q=&quot;!%\n%<br />@rem &#91;d&#93; &#91;1&#93; &#91;3&#93; :: set &quot;%%1=!%%1:~1!&quot;%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; set %%1=!%%1:~1!%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; if &quot;%%X&quot; equ &quot;0&quot; (call ) else if &quot;%%X&quot; equ &quot;1&quot; (call) else call &quot;%~f0&quot; :exitErr %%X%\n%<br />&nbsp; &nbsp; &nbsp; ) else (%\n%<br />@rem &#91;10&#93; &#91;3&#93; :: set &quot;%%1=%%~D&quot;%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; set %%1=%%D%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; call &quot;%~f0&quot; :returnDisabled %%1%\n%<br />&nbsp; &nbsp; &nbsp; )%\n%<br />&nbsp; &nbsp; )%\n%<br />&nbsp; )%\n%<br />)) else set returnVar.args=&quot;<br />exit /b 0<br /><br />:: :loadMacro defines CR, LF, \n, returnVar variables in caller's context<br />::<br />:: %returnVar%&nbsp; outVar&nbsp; inVar&nbsp; &#91;local=#&#93;&nbsp; &#91;err=#&#93;<br />:: - 'outVar' is the variable being returned/set in the outer context<br />:: - 'inVar' is the local/inner context variable whose value is returned<br />::&nbsp; &nbsp;(must not be 'returnVar.args' since that name is used by %returnVar%)<br />:: - optional 'local=#' is the nesting level, default 1<br />::&nbsp; &nbsp;%returnVar% will execute endlocal # times<br />:: - optional 'err=#' is the errorlevel to be returned, default 0<br />:: - order of optional arguments is irrelevant, names must be 'local'/'err'<br />:: - %returnVar% does not modify the outer environment except for 'outVar'<br />::<br />:: - sample input of 'a &quot; &lt;cr&gt; b &lt;lf&gt; ^ c ! d % e' traced at @rem &#91;a&#93;-&#91;f&#93;<br />:: &#91;a&#93; !%2!&nbsp; &nbsp; &nbsp;a &quot; &lt;cr&gt; b &lt;lf&gt; ^ c ! d % e&nbsp; &nbsp; &nbsp; &gt; input<br />::&nbsp; &nbsp; &nbsp;!rtn!&nbsp; &nbsp; xa &quot; &lt;cr&gt; b &lt;lf&gt; ^ c ! d % e&nbsp; &nbsp; &nbsp; &nbsp;prepend char<br />:: &#91;b&#93; !rtnDis! xa &quot;&quot;q &quot;&quot;r b &quot;&quot;n ^ c ! d % e&nbsp; &nbsp; &nbsp; &nbsp;encode &quot; &lt;cr&gt; &lt;lf&gt;<br />:: &#91;c&#93; !rtn!&nbsp; &nbsp; xa &quot;&quot;q &quot;&quot;r b &quot;&quot;n ^^ c ^! d % e&nbsp; &nbsp; &nbsp;edx: escape ^ !<br />:: &#91;d&#93; !%1!&nbsp; &nbsp; &nbsp;xa &quot; &lt;cr&gt; b &lt;lf&gt; ^ c ! d % e&nbsp; &nbsp; &nbsp;&lt;&nbsp; &nbsp; &nbsp; return :~1<br />:: &#91;e&#93; !rtn!&nbsp; &nbsp; xa %4 %~R b %~L ^ c ! d %3 e&nbsp; &nbsp; &nbsp; &nbsp;ddx: recode &quot; &lt;cr&gt; &lt;lf&gt; %<br />:: &#91;f&#93; %rtn%&nbsp; &nbsp; xa &quot; &lt;cr&gt; b &lt;lf&gt; ^ c ! d % e&nbsp; &nbsp; &nbsp;&lt;&nbsp; &nbsp; &nbsp; return :~1<br />:: ____________________________________________________________________________<br />::<br />:: &#91;0&#93; &gt;2 typo, fixed to &gt;&amp;2 <br />::<br />:: &#91;1&#93; the 'x' is prepended just as a guard against empty strings<br />::&nbsp; &nbsp; &nbsp;removing the 'x' and the two :~1 works for all non-empty strings<br />::<br />:: &#91;2&#93; local err/local override any namesake variables in caller context<br />::&nbsp; &nbsp; &nbsp;even if defaulted/not passed as an argument<br />::<br />:: &#91;3&#93; these assignments don't technically require quotes<br />::&nbsp; &nbsp; &nbsp;and the %\n% guards against accidental whitespace at the end<br />::<br />:: &#91;4&#93; can modify the endlocal loop, instead of incrementing 'local'<br />::<br />:: &#91;5&#93; CR in a for/f loop needs be doubled, LF requires a plain non-/f loop<br />::&nbsp; &nbsp; &nbsp;http://www.dostips.com/forum/viewtopic.php?p=6930#p6930 !?<br />::<br />:: &#91;6&#93; the &quot; -&gt; &quot;&quot;q substitution is losslessly reversible<br />::&nbsp; &nbsp;- the double &quot;&quot; makes the entire string parse as unquoted as far as<br />::&nbsp; &nbsp; &nbsp;embedded special chars (^&amp;&lt;|&gt;) go<br />::&nbsp; &nbsp; &nbsp;(hint: &quot;&quot;&quot;&quot;q would work as well, while &quot;q, &quot;&quot;&quot;q, or $$q would not)<br />::&nbsp; &nbsp;- &quot;&quot;q also guarantees that no other &quot;&quot;? patterns remain in the string<br />::<br />:: &#91;7&#93; can remove outer quotes, but then need to escape first inner quote<br />::&nbsp; &nbsp; &nbsp;to preserve the quote balance<br />::<br />:: &#91;8&#93; this also works, but is longer and less readable<br />::&nbsp; &nbsp; &nbsp;set rtn=!rtn:^^^^=^^^^^^^^!%\n%<br />::<br />:: &#91;9&#93; this relies on 'call' doubling the ^ carets inside quoted strings<br />::&nbsp; &nbsp; &nbsp;to compensate for '!' halving them under enableDelayedExpansion<br />::&nbsp; &nbsp; &nbsp;so the outer quotes are required<br />::&nbsp; &nbsp;- and because of that it doesn't seem to be possible to substitute<br />::&nbsp; &nbsp; &nbsp;! -&gt; ^! in one single step, since escaping ^! needs a single caret<br />::&nbsp; &nbsp;- also, the two step substitution relies on an unused substring like<br />::&nbsp; &nbsp; &nbsp;&quot;&quot;c to be guaranteed available<br />::<br />::&#91;10&#93; no need to double the outer double quotes 'in (&quot;&quot;!rtn*!&quot;&quot;)'<br />::&nbsp; &nbsp; &nbsp;since the extra 'x' character &#91;1&#93; is prepended not appended<br />::&nbsp; -&nbsp; prepending the 'x' and trimming with ':~1' works with<br />::&nbsp; &nbsp; &nbsp;just 'in (&quot;!rtn*!&quot;)', and using %%D inside the loop<br />::&nbsp; -&nbsp; appending the 'x' and removing it with ':~0,-1', instead,<br />::&nbsp; &nbsp; &nbsp;would require the double double-quotes 'in (&quot;&quot;!rtn*!&quot;&quot;)',<br />::&nbsp; &nbsp; &nbsp;and using %%~D inside the loop,<br />::&nbsp; &nbsp; &nbsp;otherwise lines starting with a &quot; quote or ; semicolon got trashed<br />::<br />::&#91;11&#93; the trailing ! ensures that carets are always halved even if<br />::&nbsp; &nbsp; &nbsp;the string itself contains no ! so the outer quotes are required<br />::<br />::&#91;12&#93; %%~L inherited from caller, becomes available inside the for loop<br />::&nbsp; &nbsp; &nbsp;for/? - for variables are single-letter, case sensitive, *global*<br />::<br />::&#91;13&#93; can use inherited %%~R instead of local loop variable<br />::&nbsp; &nbsp; &nbsp;which reduces the necessary for/f tokens to 1-2<br />::<br />::&#91;14&#93; original 'for /f &quot;tokens=1-4&quot; %%3 in (^&quot;%% !CR! &quot;&quot;&quot;&quot;) do'<br />::&nbsp; &nbsp; &nbsp;only used tokens=1-3 though 4 were actually declared<br />::&nbsp; &nbsp;- both following alternatives work as well<br />::&nbsp; &nbsp; &nbsp;'for /f &quot;tokens=1-3&quot; %%3 in (&quot; %% !CR! &quot;^&quot;&quot; &quot;) do'<br />::&nbsp; &nbsp; &nbsp;'for /f &quot;usebackq tokens=1-3&quot; %%3 in (' %% !CR! ^&quot; ') do'<br />::&nbsp; &nbsp; &nbsp;with the latter returning a single (unquoted) quote in %%5<br /></code></pre></div><br />Any critique much appreciated, about the suggested (cosmetic) code changes, the additional comments, or anything else I missed or may have misunderstood.<br /><br />Liviu<br /><br />P.S.  <strong class="text-strong"><span style="color: #FF0000">[ EDIT ]</span></strong>  Corrected comment line &quot;<em class="text-italics">:: - optional 'err=#' is the errorlevel to be returned, default <span style="color: #FF0000">!errorlevel!</span></em>&quot; to &quot;<em class="text-italics">default <span style="color: #FF0000">0</span></em>&quot; since the errorlevel would have been reset to 0 by 'setlocal' at that point.<br /><br /><strong class="text-strong"><span style="color: #FF0000">[ 2nd EDIT ]</span></strong>  Updated comment line &quot;<em class="text-italics">::[10] no need to double the outer double quotes 'in (&quot;&quot;!rtn*!&quot;&quot;)' <span style="color: #FF0000">!?</span></em>&quot; with a guess as to where the double double-quoting came from.</div>

			
													<div class="notice">
					Last edited by <a href="memberlist2970.html?mode=viewprofile&amp;u=3077" class="username">Liviu</a> on 17 May 2014 23:12, edited 2 times in total.
									</div>
			
									
						</div>

		</div>

				<div class="back2top">
						<a href="#top" class="top" title="Top">
				<i class="icon fa-chevron-circle-up fa-fw icon-gray" aria-hidden="true"></i>
				<span class="sr-only">Top</span>
			</a>
					</div>
		
		</div>
	</div>

	<hr class="divider" />
				<div id="p32479" class="post has-profile bg1">
		<div class="inner">

		<dl class="postprofile" id="profile32479">
			<dt class="has-profile-rank no-avatar">
				<div class="avatar-container">
																			</div>
								<a href="memberlist7125.html?mode=viewprofile&amp;u=417" class="username">jeb</a>							</dt>

						<dd class="profile-rank">Expert</dd>			
		<dd class="profile-posts"><strong>Posts:</strong> <a href="search73f1.html?author_id=417&amp;sr=posts">880</a></dd>		<dd class="profile-joined"><strong>Joined:</strong> 30 Aug 2007 08:05</dd>		
		
											<dd class="profile-custom-field profile-phpbb_location"><strong>Location:</strong> Germany, Bochum</dd>
							
						
		</dl>

		<div class="postbody">
						<div id="post_content32479">

						<h3 ><a href="#p32479">Re: ReturnVar macro revisited</a></h3>

													<ul class="post-buttons">
																																									<li>
							<a href="posting167b-2.html?mode=quote&amp;f=3&amp;p=32479" title="Reply with quote" class="button button-icon-only">
								<i class="icon fa-quote-left fa-fw" aria-hidden="true"></i><span class="sr-only">Quote</span>
							</a>
						</li>
														</ul>
							
						<p class="author"><span class="posti"><a href="viewtopic5c28.html?p=32479#p32479" onclick="prompt('Message #25',this.href); return false;">#25</a></span> 
									<a class="unread" href="viewtopic5c28.html?p=32479#p32479" title="Post">
						<i class="icon fa-file fa-fw icon-lightgray icon-md" aria-hidden="true"></i><span class="sr-only">Post</span>
					</a>
								<span class="responsive-hide">by <strong><a href="memberlist7125.html?mode=viewprofile&amp;u=417" class="username">jeb</a></strong> &raquo; </span>13 Feb 2014 03:23
			</p>
			
			
			
			<div class="content">Hi Liviu,<br /><br /><blockquote><div><cite>Liviu wrote:</cite>Any critique much appreciated, about the suggested (cosmetic) code changes, the additional comments, or anything else I missed or may have misunderstood.<br /></div></blockquote><br />You used two versions of the macro, one commented one and one uncommented.<br /><br />I start a new thread to show a way how to use macros with comments without increasing the macro size.<br /><a href="viewtopicb022.html?f=3&amp;t=5374" class="postlink">Comments without increasing macro size</a><br /><br />jeb</div>

			
									
									
						</div>

		</div>

				<div class="back2top">
						<a href="#top" class="top" title="Top">
				<i class="icon fa-chevron-circle-up fa-fw icon-gray" aria-hidden="true"></i>
				<span class="sr-only">Top</span>
			</a>
					</div>
		
		</div>
	</div>

	<hr class="divider" />
				<div id="p32635" class="post has-profile bg2">
		<div class="inner">

		<dl class="postprofile" id="profile32635">
			<dt class="has-profile-rank no-avatar">
				<div class="avatar-container">
																			</div>
								<a href="memberlist2970.html?mode=viewprofile&amp;u=3077" class="username">Liviu</a>							</dt>

						<dd class="profile-rank">Expert</dd>			
		<dd class="profile-posts"><strong>Posts:</strong> <a href="searche861.html?author_id=3077&amp;sr=posts">470</a></dd>		<dd class="profile-joined"><strong>Joined:</strong> 13 Jan 2012 21:24</dd>		
		
						
						
		</dl>

		<div class="postbody">
						<div id="post_content32635">

						<h3 ><a href="#p32635">Re: ReturnVar macro revisited</a></h3>

													<ul class="post-buttons">
																																									<li>
							<a href="posting2282.html?mode=quote&amp;f=3&amp;p=32635" title="Reply with quote" class="button button-icon-only">
								<i class="icon fa-quote-left fa-fw" aria-hidden="true"></i><span class="sr-only">Quote</span>
							</a>
						</li>
														</ul>
							
						<p class="author"><span class="posti"><a href="viewtopic6f59.html?p=32635#p32635" onclick="prompt('Message #26',this.href); return false;">#26</a></span> 
									<a class="unread" href="viewtopic6f59.html?p=32635#p32635" title="Post">
						<i class="icon fa-file fa-fw icon-lightgray icon-md" aria-hidden="true"></i><span class="sr-only">Post</span>
					</a>
								<span class="responsive-hide">by <strong><a href="memberlist2970.html?mode=viewprofile&amp;u=3077" class="username">Liviu</a></strong> &raquo; </span>21 Feb 2014 00:43
			</p>
			
			
			
			<div class="content"><blockquote><div><cite>jeb wrote:</cite>Currently I suppose to found a solution, that can return to a disabled context each character, even linefeed and carriage return.<br />But not both at the same time <img class="smilies" src="images/smilies/icon_wink.gif" alt=":wink:" title="Wink" /> <br />Either linefeeds or carriage returns are allowed in a string.<br /><br />I will post it when it works.<br /></div></blockquote>I am very much looking forward to that.<br /><br />For a baseline, below is a macro (heavily based on the generic ones) that doesn't allow either CR or LF - but is otherwise simpler, and is self-contained without external &quot;%~f0&quot; calls.<br /><div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>@echo off &amp; if defined retLocal goto :eof<br /><br />if &quot;!&quot; equ &quot;&quot; (<br />&nbsp; &gt;&amp;2 echo ERROR: Delayed expansion must be off when loading the retLocal macro.<br />&nbsp; exit /b 1<br />)<br /><br />set LF=^<br /><br /><br />set ^&quot;\n=^^^%LF%%LF%^%LF%%LF%^^&quot;<br /><br />:: macro to return CR/LF-free variable across endlocal barriers<br />::<br />:: syntax:&nbsp; %retLocal%&#91;*cnt&#93; outVar&#91;=inVar&#93;<br />:: - 'outVar' is the variable being returned/set in the outer context<br />:: - 'inVar' is the local/inner context variable whose value is returned<br />:: - optional '=inVar' defaults to 'outVar=outVar'<br />:: - optional '*cnt' is the nesting level, default 1 (times 'endlocal' called)<br />::<br />:: e.g.&nbsp; %retLocal% var&nbsp; &nbsp; &nbsp; &nbsp; copies inner 'var' across 1 endlocal barrier<br />::&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;to namesake 'var' in the outer context<br />::<br />::&nbsp; &nbsp; &nbsp; &nbsp;%retLocal%*2 out=in&nbsp; &nbsp;copies inner 'in' across 2 endlocal barriers<br />::&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;to 'out' in the outer context<br />::<br />::&nbsp; &nbsp; &nbsp; &nbsp;%retLocal%*0 out=in&nbsp; &nbsp;copies 'in' to 'out' within the same context<br />::&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;like 'set out=%in%' but safe against embedded<br />::&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;quotes, and problem characters except CR/LF<br />::<br />:: ! names of variables 'outVar', 'inVar' are expected to be plain quote-less<br />::&nbsp; &nbsp;well behaved strings, with no funny (&lt;|&gt;^%!) characters<br />:: ! 'inVar' name must not be 'cd' since that's used by %retLocal% internally<br />:: ! outer environment is not modified, except for '%retLocal%*0' with '*0'<br />::&nbsp; &nbsp;de-nesting, which clears any 'cd' explicitly set within the same context<br />:: ! inner errorlevel is not preserved - but the caller can save it on its own<br />::&nbsp; &nbsp;if needed via '(%retLocal% outVar=inVar) &amp; set outErr=%errorlevel%'<br /><br />set ^&quot;retLocal=for %%# in (1 2) do if %%#==2 (%\n%<br />&nbsp; setlocal enableDelayedExpansion%\n%<br />&nbsp; for /f &quot;tokens=1-2&quot; %%U in (&quot;!cd!&quot;) do (%\n%<br />&nbsp; for /f &quot;tokens=2 delims=*&quot; %%0 in (&quot;%%U*%%U&quot;) do (%\n%<br />&nbsp; &nbsp; for /f &quot;tokens=1-2 delims==&quot; %%1 in (&quot;%%V=%%V&quot;) do (%\n%<br />&nbsp; &nbsp; &nbsp; if not defined %%2 (%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; for /l %%N in (0 1 %%0) do endlocal%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; set &quot;%%1=&quot;%\n%<br />&nbsp; &nbsp; &nbsp; ) else for /f &quot;delims=&quot; %%D in (&quot;!%%2!&quot;) do (%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; set &quot;e=!%%2!&quot;%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; set ^&quot;e=!e:&quot;=&quot;&quot;q!&quot;%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; set &quot;e=!e:^=^^!&quot;%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; set &quot;path=&quot;%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; set &quot;pathExt=;&quot;%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; call set &quot;e=%%e:^!=&quot;&quot;c^!%%&quot;%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; set &quot;e=!e:&quot;&quot;c=^!!&quot;%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; for /f &quot;delims=&quot; %%E in (&quot;!e!&quot;) do (%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; for /l %%N in (0 1 %%0) do endlocal%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if &quot;!&quot;==&quot;&quot; (%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; set &quot;%%1=%%E&quot;!%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; set ^&quot;%%1=!%%1:&quot;&quot;q=&quot;!&quot;%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ) else (%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; set &quot;%%1=%%D&quot;%\n%<br />&nbsp; &nbsp; ))))%\n%<br />&nbsp; &nbsp; if &quot;%%~0&quot; equ &quot;0&quot; set &quot;cd=&quot;%\n%<br />))) else set cd=*1^&quot;<br /><br />exit /b 0<br /></code></pre></div><br />Quick notes:<br />- macro is named 'retLocal' as to not be confused with the 'returnVar' used here for arbitrary unrestricted strings;<br />- '*cnt' syntax looks friendlier to me than appending the count at the end;<br />- 'outVar[=invar]' syntax leaves the door open for future 'outVar1[=invar1] outVar2[=invar2] ...' once someone figures out how to make _that_ work <img class="smilies" src="images/smilies/icon_wink.gif" alt=";-)" title="Wink" /><br />- the sticking point in this approach is escaping ! when returning to enableDelayedExpansion - that's what requires the 'call set' line, and in turn that percent expansion requires the previous substitutions of quotes; if some trick were found to make the equivalent of  '!var:^!=^^!!' work without percent expansion and without an intermediate &quot;&quot;c variable, the code could be a few good lines shorter.<br /><br />Liviu<br /><br /><strong class="text-strong"><span style="color: #FF0000">[ EDIT ]</span></strong>  P.S. Posted code had a flaw in certain failure cases. For example an input of just CR caused it to not just fail to return the correct value, but actually fail to run the endlocal loop, thus leaving the caller inside an unexpected nested context. While the macro does not support CRs, nor claimed to, it could still fail more graciously in such cases. The variation below does that i.e. always unrolls the given endlocal levels (even if it returns an empty string for CRs).<div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>@echo off &amp; if defined retLocal goto :eof<br /><br />if &quot;!&quot; equ &quot;&quot; (<br />&nbsp; &gt;&amp;2 echo ERROR: Delayed expansion must be off when loading the retLocal macro.<br />&nbsp; exit /b 1<br />)<br /><br />set LF=^<br /><br /><br />set ^&quot;\n=^^^%LF%%LF%^%LF%%LF%^^&quot;<br />for /F &quot;usebackq delims= &quot; %%C in (`copy /z &quot;%~f0&quot; nul`) do set &quot;CR=%%C&quot;<br /><br />set ^&quot;retLocal=for %%# in (1 2) do if %%#==2 (%\n%<br />&nbsp; setlocal enableDelayedExpansion%\n%<br />&nbsp; for /f &quot;tokens=1-2&quot; %%U in (&quot;!cd!&quot;) do ^<br />&nbsp; for /f &quot;tokens=2 delims=*&quot; %%0 in (&quot;%%U*%%U&quot;) do (%\n%<br />&nbsp; &nbsp; for /f &quot;tokens=1-2 delims==&quot; %%1 in (&quot;%%V=%%V&quot;) do ^<br />&nbsp; &nbsp; for /f &quot;usebackq delims=&quot; %%D in ('&quot;!%%2!&quot;') do (%\n%<br />&nbsp; &nbsp; &nbsp; set &quot;e=!%%2!&quot;%\n%<br />&nbsp; &nbsp; &nbsp; if defined e (%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; set ^&quot;e=!e:&quot;=&quot;&quot;!&quot;%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; set &quot;e=!e:^=^^^^!&quot;%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; set &quot;path=&quot;%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; set &quot;pathExt=;&quot;%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; call set &quot;e=%%e:^!=^^^!%%&quot;%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; set &quot;e=!e:^^=^!&quot;%\n%<br />&nbsp; &nbsp; &nbsp; )%\n%<br />&nbsp; &nbsp; &nbsp; for /f &quot;usebackq delims=&quot; %%E in ('&quot;!e!&quot;') do (%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; for /l %%N in (0 1 %%0) do endlocal%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; if &quot;!&quot;==&quot;&quot; (%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; set &quot;%%1=%%~E&quot;!%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if defined %%1 set ^&quot;%%1=!%%1:&quot;&quot;=&quot;!&quot;%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; ) else (%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; set &quot;%%1=%%~D&quot;%\n%<br />&nbsp; )))%\n%<br />&nbsp; if &quot;%%~0&quot; equ &quot;0&quot; set &quot;cd=&quot;%\n%<br />)) else set cd=*1^&quot;<br /><br />exit /b 0</code></pre></div><br />And for a slightly different approach in the CR/LF-free case, here is another alternative - mostly of technical interest (unquoted 'call set'), since practically it runs more substitutions than the above.<div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>@echo off &amp; if defined retLocal goto :eof<br /><br />if &quot;!&quot; equ &quot;&quot; (<br />&nbsp; &gt;&amp;2 echo ERROR: Delayed expansion must be off when loading the retLocal macro.<br />&nbsp; exit /b 1<br />)<br /><br />@rem single linefeed char 0x0A (two blank lines required below)<br />set LF=^<br /><br /><br />@rem linefeed macros<br />set ^&quot;/n=^^^%LF%%LF%^%LF%%LF%&quot;<br />set ^&quot;//n=^^^^^^%/n%%/n%^^%/n%%/n%&quot;<br />set ^&quot;///n=^^^^^^^^^^^^%//n%%//n%^^^^%//n%%//n%&quot;<br /><br />@rem newline macros (linefeed + line continuation)<br />set ^&quot;\n=%//n%^^&quot;<br />set ^&quot;\\n=%///n%^^&quot;<br /><br />set ^&quot;retLocal=for %%# in (1 2) do if %%#==2 (%\n%<br />&nbsp; setlocal enableDelayedExpansion%\n%<br />&nbsp; for /f &quot;tokens=1-2&quot; %%U in (&quot;!cd!&quot;) do ^<br />&nbsp; for /f &quot;tokens=2 delims=*&quot; %%0 in (&quot;%%U*%%U&quot;) do (%\n%<br />&nbsp; &nbsp; for /f &quot;tokens=1-2 delims==&quot; %%1 in (&quot;%%V=%%V&quot;) do ^<br />&nbsp; &nbsp; for /f &quot;usebackq delims=&quot; %%D in ('&quot;!%%2!&quot;') do (%\n%<br />&nbsp; &nbsp; &nbsp; set &quot;e=!%%2!&quot;%\n%<br />&nbsp; &nbsp; &nbsp; if defined e (%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; for /f usebackq %%Q in ('%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ^^^^^^=^^^^^^^^^^^^^^^^ %\\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ^^^&quot;^^=^^^^^^^&quot; %\\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ^^^&lt;^^=^^^^^^^&lt; %\\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ^^^&gt;^^=^^^^^^^&gt; %\\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ^^^|^^=^^^^^^^| %\\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ^^^&amp;^^=^^^^^^^&amp; %\\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; ') do set &quot;e=!e:%%Q!&quot;%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; set &quot;path=&quot; ^&amp; set &quot;pathExt=;&quot;%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; call set e=%%e:^^^^!=^^^^^^^^^^^^!%%%\n%<br />&nbsp; &nbsp; &nbsp; )%\n%<br />&nbsp; &nbsp; &nbsp; for /f &quot;usebackq delims=&quot; %%E in ('&quot;!e!&quot;') do (%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; for /l %%N in (0 1 %%0) do endlocal%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; if &quot;!&quot;==&quot;&quot; (set &quot;%%1=%%~E&quot;!) else (set &quot;%%1=%%~D&quot;)%\n%<br />&nbsp; ))%\n%<br />&nbsp; if &quot;%%~0&quot; equ &quot;0&quot; set &quot;cd=&quot;%\n%<br />)) else set cd=*1^&quot;<br /><br />exit /b 0</code></pre></div></div>

			
													<div class="notice">
					Last edited by <a href="memberlist2970.html?mode=viewprofile&amp;u=3077" class="username">Liviu</a> on 27 Feb 2014 01:54, edited 1 time in total.
									</div>
			
									
						</div>

		</div>

				<div class="back2top">
						<a href="#top" class="top" title="Top">
				<i class="icon fa-chevron-circle-up fa-fw icon-gray" aria-hidden="true"></i>
				<span class="sr-only">Top</span>
			</a>
					</div>
		
		</div>
	</div>

	<hr class="divider" />
				<div id="p32743" class="post has-profile bg1">
		<div class="inner">

		<dl class="postprofile" id="profile32743">
			<dt class="has-profile-rank no-avatar">
				<div class="avatar-container">
																			</div>
								<a href="memberlist2970.html?mode=viewprofile&amp;u=3077" class="username">Liviu</a>							</dt>

						<dd class="profile-rank">Expert</dd>			
		<dd class="profile-posts"><strong>Posts:</strong> <a href="searche861.html?author_id=3077&amp;sr=posts">470</a></dd>		<dd class="profile-joined"><strong>Joined:</strong> 13 Jan 2012 21:24</dd>		
		
						
						
		</dl>

		<div class="postbody">
						<div id="post_content32743">

						<h3 ><a href="#p32743">Re: ReturnVar macro revisited</a></h3>

													<ul class="post-buttons">
																																									<li>
							<a href="posting36cf.html?mode=quote&amp;f=3&amp;p=32743" title="Reply with quote" class="button button-icon-only">
								<i class="icon fa-quote-left fa-fw" aria-hidden="true"></i><span class="sr-only">Quote</span>
							</a>
						</li>
														</ul>
							
						<p class="author"><span class="posti"><a href="viewtopic1934.html?p=32743#p32743" onclick="prompt('Message #27',this.href); return false;">#27</a></span> 
									<a class="unread" href="viewtopic1934.html?p=32743#p32743" title="Post">
						<i class="icon fa-file fa-fw icon-lightgray icon-md" aria-hidden="true"></i><span class="sr-only">Post</span>
					</a>
								<span class="responsive-hide">by <strong><a href="memberlist2970.html?mode=viewprofile&amp;u=3077" class="username">Liviu</a></strong> &raquo; </span>27 Feb 2014 01:13
			</p>
			
			
			
			<div class="content">Along the same line as previous post, below is a 'retLocal' macro with CR support (but no LF), also self-contained and without external &quot;%~f0&quot; calls. Comments welcome, since I am still interested in &quot;special case&quot; shortcuts for the &quot;most general case&quot; macro. To make this very clear, I find the generic 'returnVar' to be an admirable tour de force. But there are situations where the input is known to not contain certain characters like LF, and a macro could take advantage of that knowledge.<br /><div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>@echo off &amp; if defined retLocal goto :eof<br /><br />if &quot;!&quot; equ &quot;&quot; (<br />&nbsp; &gt;&amp;2 echo ERROR: Delayed expansion must be off when loading the retLocal macro.<br />&nbsp; exit /b 1<br />)<br /><br />@rem single linefeed char 0x0A (two blank lines required below)<br />set LF=^<br /><br /><br />@rem linefeed macros<br />set ^&quot;/n=^^^%LF%%LF%^%LF%%LF%&quot;<br />set ^&quot;//n=^^^^^^%/n%%/n%^^%/n%%/n%&quot;<br />set ^&quot;///n=^^^^^^^^^^^^%//n%%//n%^^^^%//n%%//n%&quot;<br /><br />@rem newline macros (linefeed + line continuation)<br />set ^&quot;\n=%//n%^^&quot;<br />set ^&quot;\\n=%///n%^^&quot;<br />set ^&quot;\\\n=%////n%^^&quot;<br /><br />@rem single carriage-return char 0x0D<br />for /F &quot;usebackq delims= &quot; %%C in (`copy /z &quot;%~f0&quot; nul`) do set &quot;CR=%%C&quot;<br /><br />set ^&quot;retLocal=for %%# in (1 2) do if %%#==2 (%\n%<br />&nbsp; setlocal enableDelayedExpansion%\n%<br />&nbsp; for /f &quot;tokens=1-2&quot; %%U in (&quot;!cd!&quot;) do ^<br />&nbsp; for /f &quot;tokens=2 delims=*&quot; %%0 in (&quot;%%U*%%U&quot;) do (%\n%<br />&nbsp; &nbsp; for /f &quot;tokens=1-2 delims==&quot; %%1 in (&quot;%%V=%%V&quot;) do ^<br />&nbsp; &nbsp; for /f &quot;usebackq delims=&quot; %%D in ('&quot;!%%2!&quot;') do ^<br />&nbsp; &nbsp; for %%R in (&quot;!CR!&quot;) do (%\n%<br />&nbsp; &nbsp; &nbsp; set &quot;e=!%%2!&quot;%\n%<br />&nbsp; &nbsp; &nbsp; if defined e (%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; for /f usebackq %%Q in ('%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ^^^&quot;^^=^^^&quot;^^^&quot;q %\\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; %%~R^^=^^^&quot;^^^&quot;r %\\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; ') do set &quot;e=!e:%%Q!&quot;%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; set &quot;path=&quot; ^&amp; set &quot;pathExt=;&quot;%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; set &quot;e=!e:^=^^^^!&quot;%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; call set &quot;e=%%e:^!=^^^!%%&quot;%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; set &quot;e=!e:^^=^!&quot;%\n%<br />&nbsp; &nbsp; &nbsp; )%\n%<br />&nbsp; &nbsp; &nbsp; for /f &quot;usebackq delims=&quot; %%E in ('&quot;!e!&quot;') do (%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; for /l %%N in (0 1 %%0) do endlocal%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; if &quot;!&quot;==&quot;&quot; (%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; set &quot;%%1=%%~E&quot;!%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if defined %%1 for /f usebackq %%Q in ('%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ^^^&quot;^^^&quot;r^^=%%~R %\\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ^^^&quot;^^^&quot;q^^=^^^&quot; %\\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ') do set ^&quot;%%1=!%%1:%%Q!^&quot;%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; ) else (%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; set &quot;%%1=%%~D&quot;%\n%<br />&nbsp; )))%\n%<br />&nbsp; if &quot;%%~0&quot; equ &quot;0&quot; set &quot;cd=&quot;%\n%<br />)) else set cd=*1^&quot;<br /><br />exit /b 0<br /></code></pre></div><br />Liviu</div>

			
									
									
						</div>

		</div>

				<div class="back2top">
						<a href="#top" class="top" title="Top">
				<i class="icon fa-chevron-circle-up fa-fw icon-gray" aria-hidden="true"></i>
				<span class="sr-only">Top</span>
			</a>
					</div>
		
		</div>
	</div>

	<hr class="divider" />
				<div id="p32747" class="post has-profile bg2">
		<div class="inner">

		<dl class="postprofile" id="profile32747">
			<dt class="has-profile-rank no-avatar">
				<div class="avatar-container">
																			</div>
								<a href="memberlist7125.html?mode=viewprofile&amp;u=417" class="username">jeb</a>							</dt>

						<dd class="profile-rank">Expert</dd>			
		<dd class="profile-posts"><strong>Posts:</strong> <a href="search73f1.html?author_id=417&amp;sr=posts">880</a></dd>		<dd class="profile-joined"><strong>Joined:</strong> 30 Aug 2007 08:05</dd>		
		
											<dd class="profile-custom-field profile-phpbb_location"><strong>Location:</strong> Germany, Bochum</dd>
							
						
		</dl>

		<div class="postbody">
						<div id="post_content32747">

						<h3 ><a href="#p32747">Re: ReturnVar macro revisited</a></h3>

													<ul class="post-buttons">
																																									<li>
							<a href="posting86d7.html?mode=quote&amp;f=3&amp;p=32747" title="Reply with quote" class="button button-icon-only">
								<i class="icon fa-quote-left fa-fw" aria-hidden="true"></i><span class="sr-only">Quote</span>
							</a>
						</li>
														</ul>
							
						<p class="author"><span class="posti"><a href="viewtopicdaa9-2.html?p=32747#p32747" onclick="prompt('Message #28',this.href); return false;">#28</a></span> 
									<a class="unread" href="viewtopicdaa9-2.html?p=32747#p32747" title="Post">
						<i class="icon fa-file fa-fw icon-lightgray icon-md" aria-hidden="true"></i><span class="sr-only">Post</span>
					</a>
								<span class="responsive-hide">by <strong><a href="memberlist7125.html?mode=viewprofile&amp;u=417" class="username">jeb</a></strong> &raquo; </span>27 Feb 2014 02:49
			</p>
			
			
			
			<div class="content"><blockquote><div><cite>Liviu wrote:</cite>Along the same line as previous post, below is a 'retLocal' macro with CR support (but no LF), also self-contained and without external &quot;%~f0&quot; calls. </div></blockquote><br />Dave's and my macro contain the &quot;call %~f0&quot; but it will only be used when a CR AND also a Linefeed was detected, else one of the <em class="text-italics">shortcuts</em> will be used.<br /><br />So I can't see any relevant drawbacks of the &quot;general case macros&quot;<br /><br />Btw.<br /><blockquote><div><cite>Liviu wrote:</cite>if &quot;!&quot; equ &quot;&quot; (<br />  &gt;&amp;2 echo ERROR: Delayed expansion must be off when loading the retLocal macro.<br />  exit /b 1<br />)<br /></div></blockquote><br />You build here a macro that can return content over an endlocal barrier <img class="smilies" src="images/smilies/icon_exclaim.gif" alt=":!:" title="Exclamation" /> <br />Why you don't use it?  <img class="smilies" src="images/smilies/icon_biggrin.gif" alt=":D" title="Very Happy" /> <br /><br /><div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>setlocal DisableDelayedExpansion<br />set myReturnMacro=....my macro definition ....<br /><br />%myReturnMacro% myReturnMacro myReturnMacro</code></pre></div><br /><br />jeb</div>

			
									
									
						</div>

		</div>

				<div class="back2top">
						<a href="#top" class="top" title="Top">
				<i class="icon fa-chevron-circle-up fa-fw icon-gray" aria-hidden="true"></i>
				<span class="sr-only">Top</span>
			</a>
					</div>
		
		</div>
	</div>

	<hr class="divider" />
				<div id="p32761" class="post has-profile bg1">
		<div class="inner">

		<dl class="postprofile" id="profile32761">
			<dt class="has-profile-rank no-avatar">
				<div class="avatar-container">
																			</div>
								<a href="memberlist2970.html?mode=viewprofile&amp;u=3077" class="username">Liviu</a>							</dt>

						<dd class="profile-rank">Expert</dd>			
		<dd class="profile-posts"><strong>Posts:</strong> <a href="searche861.html?author_id=3077&amp;sr=posts">470</a></dd>		<dd class="profile-joined"><strong>Joined:</strong> 13 Jan 2012 21:24</dd>		
		
						
						
		</dl>

		<div class="postbody">
						<div id="post_content32761">

						<h3 ><a href="#p32761">Re: ReturnVar macro revisited</a></h3>

													<ul class="post-buttons">
																																									<li>
							<a href="postingc5e7.html?mode=quote&amp;f=3&amp;p=32761" title="Reply with quote" class="button button-icon-only">
								<i class="icon fa-quote-left fa-fw" aria-hidden="true"></i><span class="sr-only">Quote</span>
							</a>
						</li>
														</ul>
							
						<p class="author"><span class="posti"><a href="viewtopicccf7.html?p=32761#p32761" onclick="prompt('Message #29',this.href); return false;">#29</a></span> 
									<a class="unread" href="viewtopicccf7.html?p=32761#p32761" title="Post">
						<i class="icon fa-file fa-fw icon-lightgray icon-md" aria-hidden="true"></i><span class="sr-only">Post</span>
					</a>
								<span class="responsive-hide">by <strong><a href="memberlist2970.html?mode=viewprofile&amp;u=3077" class="username">Liviu</a></strong> &raquo; </span>28 Feb 2014 00:08
			</p>
			
			
			
			<div class="content"><blockquote><div><cite>jeb wrote:</cite>Dave's and my macro contain the &quot;call %~f0&quot; but it will only be used when a CR AND also a Linefeed was detected, else one of the <em class="text-italics">shortcuts</em> will be used.<br /><br />So I can't see any relevant drawbacks of the &quot;general case macros&quot;</div></blockquote><br />Don't get me wrong. I certainly appreciate the mastery of the general case macros. But there still are use cases where the full generality is not needed, and those cases could still take advantage of whatever limitations are known to exist in the input data. It may be just one less substitution, or some other code shortcut, and it may not even make any obvious difference performance-wise. Still, from a minimalistic standpoint, why pay for something you know in advance doesn't get used.<br /><br />As an extreme example in the opposite direction, my default mode is 'disableDelayedExpansion'. That's the first thing needed in order to retrieve command line parameters with some degree of sanity against ^!, and also run well behaved 'for' loops later. Of course, I may switch to 'enableDelayedExpansion' as necessary, but that's usually just for local manipulations. So, to me at least, the following very restricted macro is useful in certain cases - and does not carry any of the unneeded baggage that the completely generic macros do.<div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>:: macro to return LF-free variable to 'disableDelayedExpansion' context<br />::<br />:: syntax:&nbsp; %retLocal.ddx%&#91;*cnt&#93; outVar&#91;=inVar&#93;<br />:: - 'outVar' is the variable being returned/set in the outer context<br />:: - 'inVar' is the local/inner context variable whose value is returned<br />:: - optional '=inVar' defaults to 'outVar=outVar'<br />:: - optional '*cnt' is the nesting level, default 1 (times 'endlocal' called)<br /><br />set ^&quot;retLocal.ddx=for %%# in (1 2) do if %%#==2 (%\n%<br />&nbsp; setlocal enableDelayedExpansion%\n%<br />&nbsp; for /f &quot;tokens=1-2&quot; %%U in (&quot;!cd!&quot;) do ^<br />&nbsp; for /f &quot;tokens=2 delims=*&quot; %%0 in (&quot;%%U*%%U&quot;) do (%\n%<br />&nbsp; &nbsp; for /f &quot;tokens=1-2 delims==&quot; %%1 in (&quot;%%V=%%V&quot;) do ^<br />&nbsp; &nbsp; for /f &quot;usebackq delims=&quot; %%D in ('&quot;!%%2!&quot;') do (%\n%<br />&nbsp; &nbsp; &nbsp; for /l %%N in (0 1 %%0) do endlocal%\n%<br />&nbsp; &nbsp; &nbsp; set &quot;%%1=%%~D&quot;%\n%<br />&nbsp; &nbsp; )%\n%<br />&nbsp; &nbsp; if &quot;%%~0&quot; equ &quot;0&quot; set &quot;cd=&quot;%\n%<br />)) else set cd=*1^&quot;</code></pre></div><br /><br /><blockquote><div><cite>jeb wrote:</cite>You build here a macro that can return content over an endlocal barrier <img class="smilies" src="images/smilies/icon_exclaim.gif" alt=":!:" title="Exclamation" /> <br />Why you don't use it?  <img class="smilies" src="images/smilies/icon_biggrin.gif" alt=":D" title="Very Happy" /><br /></div></blockquote>Nice. Too bad the macros I've posted don't do LFs <img class="smilies" src="images/smilies/icon_wink.gif" alt=";-)" title="Wink" /> but it's still a great point to make for the generic ones.<br /><br />Liviu</div>

			
									
									
						</div>

		</div>

				<div class="back2top">
						<a href="#top" class="top" title="Top">
				<i class="icon fa-chevron-circle-up fa-fw icon-gray" aria-hidden="true"></i>
				<span class="sr-only">Top</span>
			</a>
					</div>
		
		</div>
	</div>

	<hr class="divider" />
				<div id="p52551" class="post has-profile bg2">
		<div class="inner">

		<dl class="postprofile" id="profile52551">
			<dt class="no-profile-rank no-avatar">
				<div class="avatar-container">
																			</div>
								<a href="memberlist8c20.html?mode=viewprofile&amp;u=8766" class="username">spoutnik</a>							</dt>

									
		<dd class="profile-posts"><strong>Posts:</strong> <a href="search4af9-2.html?author_id=8766&amp;sr=posts">1</a></dd>		<dd class="profile-joined"><strong>Joined:</strong> 03 Jun 2017 03:58</dd>		
		
						
						
		</dl>

		<div class="postbody">
						<div id="post_content52551">

						<h3 ><a href="#p52551">Re: ReturnVar macro revisited</a></h3>

													<ul class="post-buttons">
																																									<li>
							<a href="posting912a-2.html?mode=quote&amp;f=3&amp;p=52551" title="Reply with quote" class="button button-icon-only">
								<i class="icon fa-quote-left fa-fw" aria-hidden="true"></i><span class="sr-only">Quote</span>
							</a>
						</li>
														</ul>
							
						<p class="author"><span class="posti"><a href="viewtopicc479.html?p=52551#p52551" onclick="prompt('Message #30',this.href); return false;">#30</a></span> 
									<a class="unread" href="viewtopicc479.html?p=52551#p52551" title="Post">
						<i class="icon fa-file fa-fw icon-lightgray icon-md" aria-hidden="true"></i><span class="sr-only">Post</span>
					</a>
								<span class="responsive-hide">by <strong><a href="memberlist8c20.html?mode=viewprofile&amp;u=8766" class="username">spoutnik</a></strong> &raquo; </span>03 Jun 2017 04:20
			</p>
			
			
			
			<div class="content"><blockquote><div><cite>dbenham wrote:</cite><br />[...]<br /><br /><strong class="text-strong">macro.rtnJeb.bat</strong><br /><div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>@echo off<br />if not defined returnVar call :loadMacro&amp;exit /b<br />if &quot;%~1&quot; neq &quot;:returnDisabled&quot; exit /b %2<br />setlocal enableDelayedExpansion<br />set &quot;rtn=!%2!&quot;<br />set &quot;rtn=!rtn:%%=%%3!&quot;<br />set &quot;rtn=!rtn:&quot;&quot;n=%%~L!&quot;<br />set &quot;rtn=!rtn:&quot;&quot;r=%%4!&quot;<br />set &quot;rtn=!rtn:&quot;&quot;q=%%~5!&quot;<br />for /f &quot;tokens=1-4&quot; %%3 in (^&quot;%% !CR! &quot;&quot;&quot;&quot;) do (<br />&nbsp; endlocal<br />&nbsp; set &quot;%2=%rtn:~1%&quot;<br />&nbsp; exit /b %%X<br />)<br /><br /><br />:loadMacro<br />if &quot;!&quot; equ &quot;&quot; (<br />&nbsp; &gt;2 echo ERROR: Delayed expansion must be off when loading the returnVar macro.<br />&nbsp; exit /b 1<br />)<br />set LF=^<br /><br /><br />set ^&quot;\n=^^^%LF%%LF%^%LF%%LF%^^&quot;<br />for /F &quot;usebackq delims= &quot; %%C in (`copy /z &quot;%~f0&quot; nul`) do set &quot;CR=%%C&quot;<br /><br />set ^&quot;returnVar=for %%# in (1 2) do if %%#==2 (setlocal enableDelayedExpansion%\n%<br />for /f &quot;tokens=1-4&quot; %%1 in (&quot;!returnVar.args!&quot;) do (%\n%<br />&nbsp; set &quot;rtn=x!%%2!&quot;%\n%<br />&nbsp; set /a &quot;err=!errorlevel!, local=1&quot;%\n%<br />&nbsp; for %%A in (&quot;%%~3&quot; &quot;%%~4&quot;) do if %%A neq &quot;&quot; set /a &quot;%%~A&quot;%\n%<br />&nbsp; set /a &quot;local+=1&quot;%\n%<br />&nbsp; for /f %%R in (&quot;!CR!!CR!&quot;) do for %%L in (&quot;!LF!&quot;) do for %%X in (!err!) do (%\n%<br />&nbsp; &nbsp; set ^&quot;rtn=!rtn:&quot;=&quot;&quot;q!&quot;%\n%<br />&nbsp; &nbsp; set &quot;rtn=!rtn:%%R=&quot;&quot;r!&quot;%\n%<br />&nbsp; &nbsp; set &quot;rtn=!rtn:%%~L=&quot;&quot;n!&quot;%\n%<br />&nbsp; &nbsp; set &quot;rtnDis=!rtn!&quot;%\n%<br />&nbsp; &nbsp; set &quot;rtn=!rtn:^=^^!&quot;%\n%<br />&nbsp; &nbsp; set &quot;path=&quot;%\n%<br />&nbsp; &nbsp; set &quot;pathExt=;&quot;%\n%<br />&nbsp; &nbsp; call set &quot;rtn=%%rtn:^!=&quot;&quot;c^!%%&quot;%\n%<br />&nbsp; &nbsp; set &quot;rtn=!rtn:&quot;&quot;c=^!&quot;%\n%<br />&nbsp; &nbsp; for /f &quot;delims=&quot; %%D in (&quot;&quot;!rtnDis!&quot;&quot;) do for /f &quot;delims=&quot; %%E in (&quot;&quot;!rtn!&quot;&quot;) do (%\n%<br />&nbsp; &nbsp; &nbsp; for /l %%n in (1 1 !local!) do endlocal%\n%<br />&nbsp; &nbsp; &nbsp; if &quot;!&quot;==&quot;&quot; (%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; set &quot;%%1=%%~E&quot; !%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; set &quot;%%1=!%%1:&quot;&quot;n=%%~L!&quot;%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; set &quot;%%1=!%%1:&quot;&quot;r=%%R!&quot;%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; set ^&quot;%%1=!%%1:&quot;&quot;q=&quot;!&quot;%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; set &quot;%%1=!%%1:~1!&quot;%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; if &quot;%%X&quot; equ &quot;0&quot; (call ) else if &quot;%%X&quot; equ &quot;1&quot; (call) else call &quot;%~f0&quot; :exitErr %%X%\n%<br />&nbsp; &nbsp; &nbsp; ) else (%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; set &quot;%%1=%%~D&quot;%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; call &quot;%~f0&quot; :returnDisabled %%1%\n%<br />&nbsp; &nbsp; &nbsp; )%\n%<br />&nbsp; &nbsp; )%\n%<br />&nbsp; )%\n%<br />)) else set returnVar.args=&quot;<br /><br />exit /b 0<br /></code></pre></div><br /><br />[...]<br /><br />Dave Benham</div></blockquote><br /><br />Hi,<br /><br />I like the 'macro.rtnJeb.bat' quite much.<br />It works quite well at having ONE variable come across the ENDLOCAL barrier, and even for variable containing LF.<br /><br />However one drawback is that it %returnVar% only ONE variable.<br /><br />Would there be an extended version of the 'macro.rtnJeb.bat' that would allow to make SEVERAL variables come accross the barrier?<br /><br />Currently I use:<br />%returnVar% varInOutsideContext varInInsideContext<br /><br />And I would like to have something like:<br />%returnVar% var01InOutsideContext=var01InInsideContext var02InOutsideContext=var02InInsideContext (and so on)<br />or even force identical name such as:<br />%returnVar% var01 var02 (and so on)<br />where var01, var02 and so on are variables declared with same name in the Inside and the Outside context<br /><br />Thank you very much in advance.<br /><br />spoutnik</div>

			
									
									
						</div>

		</div>

				<div class="back2top">
						<a href="#top" class="top" title="Top">
				<i class="icon fa-chevron-circle-up fa-fw icon-gray" aria-hidden="true"></i>
				<span class="sr-only">Top</span>
			</a>
					</div>
		
		</div>
	</div>

	<hr class="divider" />
	

	<div class="action-bar bar-bottom">
	
			<a href="posting2fff.html?mode=reply&amp;f=3&amp;t=5013" class="button" title="Post a reply">
							<span>Post Reply</span> <i class="icon fa-reply fa-fw" aria-hidden="true"></i>
					</a>
		
		<div class="dropdown-container dropdown-button-control topic-tools">
		<span title="Topic tools" class="button button-secondary dropdown-trigger dropdown-select">
			<i class="icon fa-wrench fa-fw" aria-hidden="true"></i>
			<span class="caret"><i class="icon fa-sort-down fa-fw" aria-hidden="true"></i></span>
		</span>
		<div class="dropdown">
			<div class="pointer"><div class="pointer-inner"></div></div>
			<ul class="dropdown-contents">
																												<li>
					<a href="viewtopic22e5.html?f=3&amp;t=5013&amp;start=15&amp;view=print" title="Print view" accesskey="p">
						<i class="icon fa-print fa-fw" aria-hidden="true"></i><span>Print view</span>
					</a>
				</li>
											</ul>
		</div>
	</div>

			<form method="post" action="https://www.dostips.com/forum/viewtopic.php?f=3&amp;t=5013&amp;start=15">
		<div class="dropdown-container dropdown-container-left dropdown-button-control sort-tools">
	<span title="Display and sorting options" class="button button-secondary dropdown-trigger dropdown-select">
		<i class="icon fa-sort-amount-asc fa-fw" aria-hidden="true"></i>
		<span class="caret"><i class="icon fa-sort-down fa-fw" aria-hidden="true"></i></span>
	</span>
	<div class="dropdown hidden">
		<div class="pointer"><div class="pointer-inner"></div></div>
		<div class="dropdown-contents">
			<fieldset class="display-options">
							<label>Display: <select name="st" id="st"><option value="0" selected="selected">All posts</option><option value="1">1 day</option><option value="7">7 days</option><option value="14">2 weeks</option><option value="30">1 month</option><option value="90">3 months</option><option value="180">6 months</option><option value="365">1 year</option></select></label>
								<label>Sort by: <select name="sk" id="sk"><option value="a">Author</option><option value="t" selected="selected">Post time</option><option value="s">Subject</option></select></label>
				<label>Direction: <select name="sd" id="sd"><option value="a" selected="selected">Ascending</option><option value="d">Descending</option></select></label>
								<hr class="dashed" />
				<input type="submit" class="button2" name="sort" value="Go" />
						</fieldset>
		</div>
	</div>
</div>
		</form>
	
	
	
			<div class="pagination">
			31 posts
							<ul>
			<li class="arrow previous"><a class="button button-icon-only" href="viewtopiceac1-2.html?f=3&amp;t=5013" rel="prev" role="button"><i class="icon fa-chevron-left fa-fw" aria-hidden="true"></i><span class="sr-only">Previous</span></a></li>
				<li><a class="button" href="viewtopiceac1-2.html?f=3&amp;t=5013" role="button">1</a></li>
			<li class="active"><span>2</span></li>
				<li><a class="button" href="viewtopic434f.html?f=3&amp;t=5013&amp;start=30" role="button">3</a></li>
				<li class="arrow next"><a class="button button-icon-only" href="viewtopic434f.html?f=3&amp;t=5013&amp;start=30" rel="next" role="button"><i class="icon fa-chevron-right fa-fw" aria-hidden="true"></i><span class="sr-only">Next</span></a></li>
	</ul>
					</div>
	</div>


<div class="action-bar actions-jump">
		<p class="jumpbox-return">
		<a href="viewforum4d6b.html?f=3" class="left-box arrow-left" accesskey="r">
			<i class="icon fa-angle-left fa-fw icon-black" aria-hidden="true"></i><span>Return to “DOS Batch Forum”</span>
		</a>
	</p>
	
		<div class="jumpbox dropdown-container dropdown-container-right dropdown-up dropdown-left dropdown-button-control" id="jumpbox">
			<span title="Jump to" class="button button-secondary dropdown-trigger dropdown-select">
				<span>Jump to</span>
				<span class="caret"><i class="icon fa-sort-down fa-fw" aria-hidden="true"></i></span>
			</span>
		<div class="dropdown">
			<div class="pointer"><div class="pointer-inner"></div></div>
			<ul class="dropdown-contents">
																				<li><a href="viewforum31e6.html?f=4" class="jumpbox-cat-link"> <span> DosTips - Dos Batch</span></a></li>
																<li><a href="viewforum4d6b.html?f=3" class="jumpbox-sub-link"><span class="spacer"></span> <span>&#8627; &nbsp; DOS Batch Forum</span></a></li>
											</ul>
		</div>
	</div>

	</div>


			</div>


<div id="page-footer" class="page-footer" role="contentinfo">
	<div class="navbar" role="navigation">
	<div class="inner">

	<ul id="nav-footer" class="nav-footer linklist" role="menubar">
		<li class="breadcrumbs">
							<span class="crumb"><a href="../index.html" data-navbar-reference="home"><i class="icon fa-home fa-fw" aria-hidden="true"></i><span>DosTips.com</span></a></span>									<span class="crumb"><a href="index.html" data-navbar-reference="index"><span>Board index</span></a></span>					</li>
		
				<li class="rightside">All times are <span title="UTC-6">UTC-06:00</span></li>
							<li class="rightside">
				<a href="ucp033a.html?mode=delete_cookies" data-ajax="true" data-refresh="true" role="menuitem">
					<i class="icon fa-trash fa-fw" aria-hidden="true"></i><span>Delete all board cookies</span>
				</a>
			</li>
												<li class="rightside" data-last-responsive="true">
				<a href="memberlist4bfd.html?mode=team" role="menuitem">
					<i class="icon fa-shield fa-fw" aria-hidden="true"></i><span>The team</span>
				</a>
			</li>
									<li class="rightside" data-last-responsive="true">
				<a href="memberlist8733.html?mode=contactadmin" role="menuitem">
					<i class="icon fa-envelope fa-fw" aria-hidden="true"></i><span>Contact us</span>
				</a>
			</li>
			</ul>

	</div>
</div>

	<div class="copyright">
				<!-- WARNING NO DELETE -->Style developer by <a href="http://tricolor.x-tk.ru/">support forum tricolor</a>, <!-- END WARNING NO DELETE -->Powered by <a href="https://www.phpbb.com/">phpBB</a>&reg; Forum Software &copy; phpBB Limited
									</div>

	<div id="darkenwrapper" class="darkenwrapper" data-ajax-error-title="AJAX error" data-ajax-error-text="Something went wrong when processing your request." data-ajax-error-text-abort="User aborted request." data-ajax-error-text-timeout="Your request timed out; please try again." data-ajax-error-text-parsererror="Something went wrong with the request and the server returned an invalid reply.">
		<div id="darken" class="darken">&nbsp;</div>
	</div>

	<div id="phpbb_alert" class="phpbb_alert" data-l-err="Error" data-l-timeout-processing-req="Request timed out.">
		<a href="#" class="alert_close">
			<i class="icon fa-times-circle fa-fw" aria-hidden="true"></i>
		</a>
		<h3 class="alert_title">&nbsp;</h3><p class="alert_text"></p>
	</div>
	<div id="phpbb_confirm" class="phpbb_alert">
		<a href="#" class="alert_close">
			<i class="icon fa-times-circle fa-fw" aria-hidden="true"></i>
		</a>
		<div class="alert_text"></div>
	</div>
</div>

</div>

<div>
	<a id="bottom" class="anchor" accesskey="z"></a>
	<img src="cron5897.gif?cron_type=cron.task.text_reparser.poll_option" width="1" height="1" alt="cron" /></div>

<script type="text/javascript" src="assets/javascript/jquery.mind772.js?assets_version=34"></script>
<script type="text/javascript" src="assets/javascript/cored772.js?assets_version=34"></script>



<script type="text/javascript" src="styles/prosilver/template/forum_fnd772.js?assets_version=34"></script>
<script type="text/javascript" src="styles/prosilver/template/ajaxd772.js?assets_version=34"></script>
<script type="text/javascript" src="styles/AllanStyle-SUBSILVER/template/jquery-uid772.js?assets_version=34"></script>
<script type="text/javascript" src="styles/AllanStyle-SUBSILVER/template/collapsed772.js?assets_version=34"></script>



</body>

<!-- Mirrored from www.dostips.com/forum/viewtopic.php?p=32476 by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 19 Oct 2018 09:18:11 GMT -->
</html>
