<!DOCTYPE html>
<html dir="ltr" lang="en-gb">

<!-- Mirrored from www.dostips.com/forum/viewtopic.php?f=3&t=8355&start=30&view=print by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 19 Oct 2018 07:17:29 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- /Added by HTTrack -->
<head>
<meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="robots" content="noindex" />

<title>DosTips.com &bull; Discussion about jeb's batch parsing rules on StackOverflow - Page 3</title>

<link href="styles/AllanStyle-SUBSILVER/theme/print.css" rel="stylesheet">
</head>
<body id="phpbb">
<div id="wrap" class="wrap">
	<a id="top" class="top-anchor" accesskey="t"></a>

	<div id="page-header">
		<h1>DosTips.com</h1>
		<p>A Forum all about DOS Batch<br /><a href="index-2.html">https://www.dostips.com/forum/</a></p>

		<h2>Discussion about jeb's batch parsing rules on StackOverflow</h2>
		<p><a href="viewtopicdf43.html?f=3&amp;t=8355">https://www.dostips.com/forum/viewtopic.php?f=3&amp;t=8355</a></p>
	</div>

	<div id="page-body" class="page-body">
		<div class="page-number">Page <strong>3</strong> of <strong>3</strong></div>
					<div class="post">
				<h3>Re: Discussion about jeb's batch parsing rules on StackOverflow</h3>
				<div class="date">Posted: <strong>02 Feb 2018 15:06</strong></div>
				<div class="author">by <strong>dbenham</strong></div>
				<div class="content"><blockquote><div><cite><a href="memberlist7125.html?mode=viewprofile&amp;u=417">jeb</a> wrote: <a href="viewtopicbbe6.html?p=55609#p55609" data-post-id="55609" onclick="if(document.getElementById(hash.substr(1)))href=hash">↑</a><div class="responsive-hide">02 Feb 2018 01:55</div></cite>
 <img class="smilies" src="images/smilies/icon_biggrin.gif" width="15" height="15" alt=":D" title="Very Happy"> I suppose we are too old to remember all the things we already know.<br>
Do you can remember the batch macros? They are using exactly this effect, when the macro is defined, the LF is injected in an escaped form, but when executing a macro  it uses an unescaped LF.
</div></blockquote>
 <img class="smilies" src="images/smilies/icon_lol.gif" width="15" height="15" alt=":lol:" title="Laughing"> Once I "discovered" the "new" LF behavior, I immediately wondered if I could use it to simplify creation of macros.<br>
I quickly abandoned the thought, and never traced it through enough to realize the macro technique was already using it <img class="smilies" src="images/smilies/icon_exclaim.gif" width="15" height="15" alt=":!:" title="Exclamation">  <img class="smilies" src="images/smilies/icon_rolleyes.gif" width="15" height="15" alt=":roll:" title="Rolling Eyes"><br>
<br>
I updated the SO post with the new &lt;LF&gt; rules. It wasn't easy - the answer is bumping against the 30,000 character limit.<br>
<br>
Dave Benham</div>
			</div>
			<hr />
					<div class="post">
				<h3>Re: Discussion about jeb's batch parsing rules on StackOverflow</h3>
				<div class="date">Posted: <strong>04 Feb 2018 09:24</strong></div>
				<div class="author">by <strong>dbenham</strong></div>
				<div class="content"><blockquote><div><cite><a href="memberlist7125.html?mode=viewprofile&amp;u=417">jeb</a> wrote: <a href="viewtopicbbe6.html?p=55609#p55609" data-post-id="55609" onclick="if(document.getElementById(hash.substr(1)))href=hash">↑</a><div class="responsive-hide">02 Feb 2018 01:55</div></cite>
<blockquote><div><cite><a href="memberlist3d77.html?mode=viewprofile&amp;u=2258">dbenham</a> wrote: <a href="viewtopic766f.html?p=55601#p55601" data-post-id="55601" onclick="if(document.getElementById(hash.substr(1)))href=hash">↑</a><div class="responsive-hide">01 Feb 2018 07:28</div></cite>
Your !var:~,7! expansion is broken because you forgot to escape the comma, so the expression is split between the command token and the arguments token in phase 2.
</div></blockquote> Exactly that was my intention, to simply detect, if the character between ECHO and !var is a phase 2 delimiter.</div></blockquote>
Very nice <img class="smilies" src="images/smilies/icon_smile.gif" width="15" height="15" alt=":)" title="Smile"> <br>
<br>
I've got two variants of an improved form that somewhat self documents, and it is safe to use additional delayed expansion afterwards.
<div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>@echo off
setlocal enableDelayedExpansion
set "###CMD= "

echo].Variant.1.!###CMD: =ARG^^!......!###CMD: =ARG^^!
echo(.Variant.1.!###CMD: =ARG^^!......!###CMD: =ARG^^!
echo].Variant.2.!###CMD: =ARG!^^!......!###CMD: =ARG!^^!
echo(.Variant.2.!###CMD: =ARG!^^!......!###CMD: =ARG!^^!
</code></pre></div>
--OUTPUT--
<div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>.Variant.1.###CMD: =ARG!......ARG^
.Variant.1.ARG^......ARG^
.Variant.2.###CMD: =ARG......ARG!
.Variant.2.ARG!......ARG!
</code></pre></div>
If the expression is split between the command and argument tokens, then "<strong class="text-strong"><span style="color: #0000FF">###CMD:</span></strong>" is the end of the phase 2 command token, and "<strong class="text-strong"><span style="color: #0000FF"> =ARG!</span></strong>" (or "<strong class="text-strong"><span style="color: #0000FF"> =ARG</span></strong>") is the beginning of the phase 2 argument token<br>
If entirely within the phase 2 argument token, then it simply expands to "<strong class="text-strong"><span style="color: #0000FF">ARG^</span></strong>" (or "<strong class="text-strong"><span style="color: #0000FF">ARG!</span></strong>")<br>
<br>
<br>
Dave Benham</div>
			</div>
			<hr />
					<div class="post">
				<h3>Re: Discussion about jeb's batch parsing rules on StackOverflow</h3>
				<div class="date">Posted: <strong>05 Feb 2018 14:17</strong></div>
				<div class="author">by <strong>dbenham</strong></div>
				<div class="content">Back to jeb's phase 7 token delimiter tests. I wondered if &lt;LF&gt; and &lt;CR&gt; might have any effect on any other ECHO white space characters besides &lt;space&gt; and &lt;tab&gt;. I also wanted to cleanup the rules a little bit.<br>
<br>
So I did some more tests - What a can of worms this turned out to be  <img class="smilies" src="images/smilies/icon_evil.gif" width="15" height="15" alt=":evil:" title="Evil or Very Mad">  <br>
<br>
First I will state my new discoveries / rules. Later on I will provide the evidence in the form of scripts and output.<br>
<br>
<strong class="text-strong">1) I discovered two additional phase 2 token delimiters</strong> <img class="smilies" src="images/smilies/icon_exclaim.gif" width="15" height="15" alt=":!:" title="Exclamation">  <img class="smilies" src="images/smilies/icon_eek.gif" width="15" height="15" alt=":shock:" title="Shocked"> 
<ul>
<li> &lt;VT&gt; 0x0B Vertical tab</li>
<li> &lt;FF&gt; 0x0C Form Feed</li>
</ul>
So the complete list of standard phase 2 token delimiters is <strong class="text-strong"><span style="color: #0000FF">&lt;space&gt; &lt;tab&gt; , ; = &lt;VT&gt; &lt;FF&gt; &lt;NBSP&gt;</span></strong> (Non-Breaking Space 0xFF)<br>
In addition, there is the special command token delimiter <strong class="text-strong"><span style="color: #0000FF">(</span></strong> that only serves as the stop character for a command token.<br>
After discovering these, I decided to test all control characters from 0x01 - 0x1F (test not shown), and I did not find any additional ones.<br>
<br>
<strong class="text-strong">2) I refined the list of phase 7 command token delimiters</strong>
<ul>
<li> Class 1 (rarely fails): <strong class="text-strong"><span style="color: #0000FF">&lt;space&gt; &lt;tab&gt; , ; = + / [ ]</span></strong></li>
<li> Class 2 (sometimes fails): <strong class="text-strong"><span style="color: #0000FF">\ . :</span></strong></li>
</ul>
Note that the following phase 2 token delimiters are <strong class="text-strong"><em class="text-italics">not</em></strong> included: <strong class="text-strong"><span style="color: #BF0000">( &lt;VT&gt; &lt;FF&gt; &lt;LF&gt; &lt;CR&gt; &lt;NBSP&gt;</span></strong><br>
The command token delimiter is always included in the arguments list for the internal command. How it is interpreted is up to the individual command.<br>
<br>
<strong class="text-strong">3) The odd phase 7 ECHO behavior that jeb discovered regarding <strong class="text-strong"><span style="color: #0000FF">&lt;LF&gt; &lt;CR&gt;</span></strong> and <strong class="text-strong"><span style="color: #0000FF">&lt;NBSP&gt;</span></strong> does not work on all machines</strong>  <img class="smilies" src="images/smilies/icon_eek.gif" width="15" height="15" alt=":shock:" title="Shocked">  <img class="smilies" src="images/smilies/icon_evil.gif" width="15" height="15" alt=":evil:" title="Evil or Very Mad"> <br>
For this discussion, I will call the odd behavior <strong class="text-strong"><em class="text-italics">"Extended ECHO"</em></strong><br>
I tested jeb's script on 3 machines, and I was only able to reproduce his Extended ECHO results on one of them.<br>
I cannot figure out any predictor as to when Extended ECHO works <img class="smilies" src="images/smilies/icon_exclaim.gif" width="15" height="15" alt=":!:" title="Exclamation">  <img class="smilies" src="images/smilies/icon_evil.gif" width="15" height="15" alt=":evil:" title="Evil or Very Mad"><br>
<br>
Windows 7 Desktop: Extended ECHO works
<div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code> INFO.BAT version 1.4
--------------------------------------------------------------------------------
Windows version        :  Microsoft Windows [Version 6.1.7601]
Product name           :  Windows 7 Enterprise, 32 bit
Performance indicators :  Processor Cores: 4      Visible RAM: 3659760 kilobytes

Date/Time format       :  (mm/dd/yy)  02/05/2018  12:46:47.06
__APPDIR__             :  C:\Windows\System32\
ComSpec                :  C:\Windows\system32\cmd.exe
PathExt                :  .COM;.EXE;.BAT;.CMD;.VBS;.VBE;.JS;.JSE;.WSF;.WSH;.MSC;.sh;.ksh;.csh;.sed;.awk;.pl
Extensions             :  system: Enabled   user: Enabled 
Delayed expansion      :  system: Disabled  user: Disabled
Locale name            :  en-US       Code Pages: OEM  437    ANSI 1252
DIR  format            :  02/02/2018  09:44 PM     3,747,594,240 pagefile.sys
Permissions            :  Elevated Admin=No, Admin group=No
</code></pre></div>
Windows 7 Laptop: Extended ECHO fails
<div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code> INFO.BAT version 1.4
--------------------------------------------------------------------------------
Windows version        :  Microsoft Windows [Version 6.1.7601]
Product name           :  Windows 7 Enterprise, 32 bit
Performance indicators :  Processor Cores: 8      Visible RAM: 3058776 kilobytes

Date/Time format       :  (mm/dd/yy)  Mon 02/05/2018  12:48:42.19
__APPDIR__             :  C:\windows\system32\
ComSpec                :  C:\windows\system32\cmd.exe
PathExt                :  .COM;.EXE;.BAT;.CMD;.VBS;.VBE;.JS;.JSE;.WSF;.WSH;.MSC
Extensions             :  system: Enabled   user: Enabled 
Delayed expansion      :  system: Disabled  user: Disabled
Locale name            :  en-US       Code Pages: OEM  437    ANSI 1252
DIR  format            :  02/05/2018  07:17 AM     3,132,186,624 pagefile.sys
Permissions            :  Elevated Admin=No, Admin group=No
</code></pre></div>
Windows 10 Desktop: Extended ECHO fails
<div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code> INFO.BAT version 1.4
--------------------------------------------------------------------------------
Windows version        :  Microsoft Windows [Version 10.0.16299.125]
Product name           :  Windows 10 Pro, 64 bit
Performance indicators :  Processor Cores: 4      Visible RAM: 4192432 kilobytes

Date/Time format       :  (mm/dd/yy)  Mon 02/05/2018  23:47:16.85
__APPDIR__             :  C:\WINDOWS\system32\
ComSpec                :  C:\WINDOWS\system32\cmd.exe
PathExt                :  .COM;.EXE;.BAT;.CMD;.VBS;.VBE;.JS;.JSE;.WSF;.WSH;.MSC
Extensions             :  system: Enabled   user: Enabled 
Delayed expansion      :  system: Disabled  user: Disabled
Locale name            :  en-US       Code Pages: OEM  437    ANSI 1252
DIR  format            :  02/04/2018  07:20 PM     4,445,007,872 pagefile.sys
Permissions            :  Elevated Admin=No, Admin group=Yes

                          Missing from the tool collection:  debug
</code></pre></div>

<br>
<strong class="text-strong">4) I refined the phase 7 rules for Extended ECHO behavior</strong>
<ul>
<li> The list of phase 7 Extended ECHO delimiters is <strong class="text-strong"><span style="color: #0000FF">&lt;LF&gt; &lt;CR&gt; &lt;VT&gt; &lt;FF&gt; &lt;NBSP&gt;</span></strong></li>
<li> The Extended ECHO delimiters work only for the ECHO command, and only in phase 7 <img class="smilies" src="images/smilies/icon_exclaim.gif" width="15" height="15" alt=":!:" title="Exclamation"></li> 
<li> If the ECHO command is delimited by an Extended ECHO delimiter in phase 7, then:
  <ul>
  <li> The Extended ECHO delimiter is output normally - it is not stripped like most command delimiters</li>
  <li> Each contiguous string of <strong class="text-strong"><span style="color: #0000FF">&lt;space&gt; </span></strong>and/or <strong class="text-strong"><span style="color: #0000FF">&lt;tab&gt;</span></strong> is collapsed into a single <strong class="text-strong"><span style="color: #0000FF">&lt;space&gt;</span></strong></li>
  </ul></li>
</ul>

<span style="font-size: 150%; line-height: normal">And below are my "proofs" for the above:</span><br>
<br>
<strong class="text-strong">TEST1.bat</strong>
<div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>@echo off
setlocal disableDelayedExpansion
cls
for /f "tokens=1-6 delims= " %%A in (
  'forfiles /p "%~dp0." /m "%~nx0" /c "cmd /c echo(0x08 0x09 0x0B 0x0C 0x1A 0xFF"'
) do (
  set "BS=%%A
  set "TAB=%%B"
  set "VT=%%C"
  set "FF=%%D"
  set "SUB=%%E"
  set "NBSP=%%F"
  set "SP= "
  set "SC=;"
  set "COM=,"
  set "EQ=="
  set "LP=("
)
(set LF=^
%= empty line creates &lt;LF&gt; character =%
)
for /F %%# in ('copy /Z "%~dpf0" NUL') do set "CR=%%#"
set "###CMD= "

call :test "%%%%NBSP%%%% = 0xFF" "%NBSP%"
call :test "!NBSP! = 0xFF" !NBSP!
call :test !LF! !LF!
call :test !CR! !CR!
call :test ( (
call :test "!LP! = (" !LP!
call :test "%%%%BS%%%% = 0x08" "%BS%"
call :test "%%%%VT%%%% = 0x0B" "%VT%"
call :test "%%%%FF%%%% = 0x0C" "%FF%"
call :test "%%%%SUB%%%% = 0x1A" "%SUB%"
call :test "!BS! = 0x08" !BS!
call :test "!VT! = 0x0B" !VT!
call :test "!FF! = 0x0C" !FF!
call :test "!SUB! = 0x1A" !SUB!
call :test !SP! !SP!
call :test !TAB! !TAB!
call :test "!SC! = ;" !SC!
call :test "!COM! = ," !COM!
call :test "!EQ! = =" !EQ!
call :test [ [
call :test ] ]
call :test + +
call :test / /
call :test . .
call :test \ \
call :test : :

exit /b
:test
echo(&amp;echo(Test %~1  %~2
setlocal enableDelayedExpansion
&lt;nul set/p"=---"
echo%~2#^ ^ #!TAB!!TAB!!VT!!VT!!FF!!FF!!NBSP!!NBSP!^,^,^;^;^=^=!LF!---!CR!!###CMD: =ARG^^!^
 ^ #!TAB!!TAB!!VT!!VT!!FF!!FF!!NBSP!!NBSP!^,^,^;^;^=^=!LF!---!CR!!###CMD: =ARG^^!
exit /b
</code></pre></div>
test1 output on machine <strong class="text-strong">with</strong> Extended ECHO support:
<div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>
Test %NBSP% = 0xFF   
---#  #         ♂♂♀♀  ,,;;==
ARG^  #         ♂♂♀♀  ,,;;==
ARG^

Test !NBSP! = 0xFF  !NBSP!
--- # # ♂♂♀♀  ,,;;==
###CMD: =ARG! # ♂♂♀♀  ,,;;==
ARG^

Test !LF!  !LF!
---
# # ♂♂♀♀  ,,;;==
###CMD: =ARG! # ♂♂♀♀  ,,;;==
ARG^

Test !CR!  !CR!
# # ♂♂♀♀  ,,;;==
###CMD: =ARG! # ♂♂♀♀  ,,;;==
ARG^

Test (  (
---#  #         ♂♂♀♀  ,,;;==
ARG^  #         ♂♂♀♀  ,,;;==
ARG^

Test !LP! = (  !LP!
---'echo(#' is not recognized as an internal or external command,
operable program or batch file.

Test %BS% = 0x08
---'ech#' is not recognized as an internal or external command,
operable program or batch file.

Test %VT% = 0x0B  ♂
---#  #         ♂♂♀♀  ,,;;==
ARG^  #         ♂♂♀♀  ,,;;==
ARG^

Test %FF% = 0x0C  ♀
---#  #         ♂♂♀♀  ,,;;==
ARG^  #         ♂♂♀♀  ,,;;==
ARG^

Test %SUB% = 0x1A  →
---'echo→#' is not recognized as an internal or external command,
operable program or batch file.

Test !BS! = 0x08  !BS!
---'ech#' is not recognized as an internal or external command,
operable program or batch file.

Test !VT! = 0x0B  !VT!
---♂# # ♂♂♀♀  ,,;;==
###CMD: =ARG! # ♂♂♀♀  ,,;;==
ARG^

Test !FF! = 0x0C  !FF!
---♀# # ♂♂♀♀  ,,;;==
###CMD: =ARG! # ♂♂♀♀  ,,;;==
ARG^

Test !SUB! = 0x1A  !SUB!
---'echo→#' is not recognized as an internal or external command,
operable program or batch file.

Test !SP!  !SP!
---#  #         ♂♂♀♀  ,,;;==
###CMD: =ARG!  #                ♂♂♀♀  ,,;;==
ARG^

Test !TAB!  !TAB!
---#  #         ♂♂♀♀  ,,;;==
###CMD: =ARG!  #                ♂♂♀♀  ,,;;==
ARG^

Test !SC! = ;  !SC!
---#  #         ♂♂♀♀  ,,;;==
###CMD: =ARG!  #                ♂♂♀♀  ,,;;==
ARG^

Test !COM! = ,  !COM!
---#  #         ♂♂♀♀  ,,;;==
###CMD: =ARG!  #                ♂♂♀♀  ,,;;==
ARG^

Test !EQ! = =  !EQ!
---#  #         ♂♂♀♀  ,,;;==
###CMD: =ARG!  #                ♂♂♀♀  ,,;;==
ARG^

Test [  [
---#  #         ♂♂♀♀  ,,;;==
###CMD: =ARG!  #                ♂♂♀♀  ,,;;==
ARG^

Test ]  ]
---#  #         ♂♂♀♀  ,,;;==
###CMD: =ARG!  #                ♂♂♀♀  ,,;;==
ARG^

Test +  +
---#  #         ♂♂♀♀  ,,;;==
###CMD: =ARG!  #                ♂♂♀♀  ,,;;==
ARG^

Test /  /
---#  #         ♂♂♀♀  ,,;;==
###CMD: =ARG!  #                ♂♂♀♀  ,,;;==
ARG^

Test .  .
---#  #         ♂♂♀♀  ,,;;==
###CMD: =ARG!  #                ♂♂♀♀  ,,;;==
ARG^

Test \  \
---#  #         ♂♂♀♀  ,,;;==
###CMD: =ARG!  #                ♂♂♀♀  ,,;;==
ARG^

Test :  :
---#  #         ♂♂♀♀  ,,;;==
###CMD: =ARG!  #                ♂♂♀♀  ,,;;==
ARG^</code></pre></div>
test1.bat output on a machine <strong class="text-strong">without</strong> Extended ECHO support:
<div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>
Test %NBSP% = 0xFF   
---#  #         ♂♂♀♀  ,,;;==
ARG^  #         ♂♂♀♀  ,,;;==
ARG^

Test !NBSP! = 0xFF  !NBSP!
---'echo' is not recognized as an internal or external command,
operable program or batch file.

Test !LF!  !LF!
---'echo' is not recognized as an internal or external command,
operable program or batch file.

Test !CR!  !CR!
---'echo' is not recognized as an internal or external command,
operable program or batch file.

Test (  (
---#  #         ♂♂♀♀  ,,;;==
ARG^  #         ♂♂♀♀  ,,;;==
ARG^

Test !LP! = (  !LP!
---'echo(#' is not recognized as an internal or external command,
operable program or batch file.

Test %BS% = 0x08
---'ech#' is not recognized as an internal or external command,
operable program or batch file.

Test %VT% = 0x0B  ♂
---#  #         ♂♂♀♀  ,,;;==
ARG^  #         ♂♂♀♀  ,,;;==
ARG^

Test %FF% = 0x0C  ♀
---#  #         ♂♂♀♀  ,,;;==
ARG^  #         ♂♂♀♀  ,,;;==
ARG^

Test %SUB% = 0x1A  →
---'echo→#' is not recognized as an internal or external command,
operable program or batch file.

Test !BS! = 0x08  !BS!
---'ech#' is not recognized as an internal or external command,
operable program or batch file.

Test !VT! = 0x0B  !VT!
---'echo' is not recognized as an internal or external command,
operable program or batch file.

Test !FF! = 0x0C  !FF!
---'echo' is not recognized as an internal or external command,
operable program or batch file.

Test !SUB! = 0x1A  !SUB!
---'echo→#' is not recognized as an internal or external command,
operable program or batch file.

Test !SP!  !SP!
---#  #         ♂♂♀♀  ,,;;==
###CMD: =ARG!  #                ♂♂♀♀  ,,;;==
ARG^

Test !TAB!  !TAB!
---#  #         ♂♂♀♀  ,,;;==
###CMD: =ARG!  #                ♂♂♀♀  ,,;;==
ARG^

Test !SC! = ;  !SC!
---#  #         ♂♂♀♀  ,,;;==
###CMD: =ARG!  #                ♂♂♀♀  ,,;;==
ARG^

Test !COM! = ,  !COM!
---#  #         ♂♂♀♀  ,,;;==
###CMD: =ARG!  #                ♂♂♀♀  ,,;;==
ARG^

Test !EQ! = =  !EQ!
---#  #         ♂♂♀♀  ,,;;==
###CMD: =ARG!  #                ♂♂♀♀  ,,;;==
ARG^

Test [  [
---#  #         ♂♂♀♀  ,,;;==
###CMD: =ARG!  #                ♂♂♀♀  ,,;;==
ARG^

Test ]  ]
---#  #         ♂♂♀♀  ,,;;==
###CMD: =ARG!  #                ♂♂♀♀  ,,;;==
ARG^

Test +  +
---#  #         ♂♂♀♀  ,,;;==
###CMD: =ARG!  #                ♂♂♀♀  ,,;;==
ARG^

Test /  /
---#  #         ♂♂♀♀  ,,;;==
###CMD: =ARG!  #                ♂♂♀♀  ,,;;==
ARG^

Test .  .
---#  #         ♂♂♀♀  ,,;;==
###CMD: =ARG!  #                ♂♂♀♀  ,,;;==
ARG^

Test \  \
---#  #         ♂♂♀♀  ,,;;==
###CMD: =ARG!  #                ♂♂♀♀  ,,;;==
ARG^

Test :  :
---#  #         ♂♂♀♀  ,,;;==
###CMD: =ARG!  #                ♂♂♀♀  ,,;;==
ARG^
</code></pre></div>

<br>
<strong class="text-strong">TEST2.BAT</strong>
<div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>@echo off
setlocal disableDelayedExpansion
cls
for /f "tokens=1-6 delims= " %%A in (
  'forfiles /p "%~dp0." /m "%~nx0" /c "cmd /c echo(0x08 0x09 0x0B 0x0C 0x1A 0xFF"'
) do (
  set "BS=%%A
  set "TAB=%%B"
  set "VT=%%C"
  set "FF=%%D"
  set "SUB=%%E"
  set "NBSP=%%F"
  set "SP= "
  set "SC=;"
  set "COM=,"
  set "EQ=="
  set "LP=("
)
(set LF=^
%= empty line creates &lt;LF&gt; character =%
)
for /F %%# in ('copy /Z "%~dpf0" NUL') do set "CR=%%#"
set "###CMD= "

call :test [
call :test ]
call :test +
call :test !SP!
call :test !TAB!
call :test !EQ!
call :test !COM!
call :test !SC!
call :test !EQ!
call :test !LF!
call :test !CR!
call :test !VT!
call :test !FF!
call :test !NBSP!
exit /b

:test
setlocal enableDelayedExpansion
echo(
echo on
echo%~1 ECHO works
type%~1
set%~1xxx
@echo off
exit /b
</code></pre></div>
test2.bat output on machine with Extended ECHO support
<div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>

P:\test&gt;echo[ ECHO works
 ECHO works

P:\test&gt;type[
The system cannot find the file specified.

P:\test&gt;set[xxx
Environment variable [xxx not defined


P:\test&gt;echo] ECHO works
 ECHO works

P:\test&gt;type]
The system cannot find the file specified.

P:\test&gt;set]xxx
Environment variable ]xxx not defined


P:\test&gt;echo+ ECHO works
 ECHO works

P:\test&gt;type+
The system cannot find the file specified.

P:\test&gt;set+xxx
Environment variable +xxx not defined


P:\test&gt;echo!SP! ECHO works
 ECHO works

P:\test&gt;type!SP!
The syntax of the command is incorrect.

P:\test&gt;set!SP!xxx
Environment variable xxx not defined


P:\test&gt;echo!TAB! ECHO works
 ECHO works

P:\test&gt;type!TAB!
The syntax of the command is incorrect.

P:\test&gt;set!TAB!xxx
Environment variable xxx not defined


P:\test&gt;echo!EQ! ECHO works
 ECHO works

P:\test&gt;type!EQ!
The syntax of the command is incorrect.

P:\test&gt;set!EQ!xxx
The syntax of the command is incorrect.


P:\test&gt;echo!COM! ECHO works
 ECHO works

P:\test&gt;type!COM!
The syntax of the command is incorrect.

P:\test&gt;set!COM!xxx
Environment variable ,xxx not defined


P:\test&gt;echo!SC! ECHO works
 ECHO works

P:\test&gt;type!SC!
The syntax of the command is incorrect.

P:\test&gt;set!SC!xxx
Environment variable ;xxx not defined


P:\test&gt;echo!EQ! ECHO works
 ECHO works

P:\test&gt;type!EQ!
The syntax of the command is incorrect.

P:\test&gt;set!EQ!xxx
The syntax of the command is incorrect.


P:\test&gt;echo!LF! ECHO works

 ECHO works

P:\test&gt;type!LF!
'type' is not recognized as an internal or external command,
operable program or batch file.

P:\test&gt;set!LF!xxx
'set' is not recognized as an internal or external command,
operable program or batch file.


P:\test&gt;echo!CR! ECHO works
 ECHO works

P:\test&gt;type!CR!
'type' is not recognized as an internal or external command,
operable program or batch file.

P:\test&gt;set!CR!xxx
'set' is not recognized as an internal or external command,
operable program or batch file.


P:\test&gt;echo!VT! ECHO works
♂ ECHO works

P:\test&gt;type!VT!
'type' is not recognized as an internal or external command,
operable program or batch file.

P:\test&gt;set!VT!xxx
'set' is not recognized as an internal or external command,
operable program or batch file.


P:\test&gt;echo!FF! ECHO works
♀ ECHO works

P:\test&gt;type!FF!
'type' is not recognized as an internal or external command,
operable program or batch file.

P:\test&gt;set!FF!xxx
'set' is not recognized as an internal or external command,
operable program or batch file.


P:\test&gt;echo!NBSP! ECHO works
  ECHO works

P:\test&gt;type!NBSP!
'type' is not recognized as an internal or external command,
operable program or batch file.

P:\test&gt;set!NBSP!xxx
'set' is not recognized as an internal or external command,
operable program or batch file.
</code></pre></div>

<br>
<strong class="text-strong">TEST3.BAT</strong>
<div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>@echo off
setlocal disableDelayedExpansion
cls
for /f "tokens=1-2 delims= " %%A in (
  'forfiles /p "%~dp0." /m "%~nx0" /c "cmd /c echo(0x0B 0x0C"'
) do (
  set "VT=%%A"
  set "FF=%%B"
)
echo on

cmd /c for %%. in (.) do if a%VT%b==a%VT%b echo VT OK
cmd /c for %%. in (.) do if a%FF%b==a%FF%b echo FF OK
cmd /v:on /c for %%. in (.) do if a!VT!b==a!VT!b echo VT OK
cmd /v:on /c for %%. in (.) do if a!FF!b==a!FF!b echo FF OK
</code></pre></div>
test3.bat output
<div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>P:\test&gt;cmd /c for %. in (.) do if a♂b==a♂b echo VT OK
b==a was unexpected at this time.

P:\test&gt;cmd /c for %. in (.) do if a♀b==a♀b echo FF OK
b==a was unexpected at this time.

P:\test&gt;cmd /v:on /c for %. in (.) do if a!VT!b==a!VT!b echo VT OK

P:\test&gt;if a!VT!b == a!VT!b echo VT OK
VT OK

P:\test&gt;cmd /v:on /c for %. in (.) do if a!FF!b==a!FF!b echo FF OK

P:\test&gt;if a!FF!b == a!FF!b echo FF OK
FF OK
</code></pre></div>

<br>
Dave Benham</div>
			</div>
			<hr />
					<div class="post">
				<h3>Re: Discussion about jeb's batch parsing rules on StackOverflow</h3>
				<div class="date">Posted: <strong>06 Feb 2018 04:09</strong></div>
				<div class="author">by <strong>jeb</strong></div>
				<div class="content"><blockquote><div><cite><a href="memberlist3d77.html?mode=viewprofile&amp;u=2258">dbenham</a> wrote: <a href="viewtopic49d8.html?p=55642#p55642" data-post-id="55642" onclick="if(document.getElementById(hash.substr(1)))href=hash">↑</a><div class="responsive-hide">05 Feb 2018 14:17</div></cite>
3) The odd phase 7 ECHO behavior that jeb discovered regarding &lt;LF&gt; &lt;CR&gt; and &lt;NBSP&gt; does not work on all machines <img class="smilies" src="images/smilies/icon_eek.gif" width="15" height="15" alt=":shock:" title="Shocked"> <img class="smilies" src="images/smilies/icon_evil.gif" width="15" height="15" alt=":evil:" title="Evil or Very Mad"><br>
For this discussion, I will call the odd behavior "Extended ECHO"<br>
I tested jeb's script on 3 machines, and I was only able to reproduce his Extended ECHO results on one of them.<br>
I cannot figure out any predictor as to when Extended ECHO works <img class="smilies" src="images/smilies/icon_exclaim.gif" width="15" height="15" alt=":!:" title="Exclamation"> <img class="smilies" src="images/smilies/icon_evil.gif" width="15" height="15" alt=":evil:" title="Evil or Very Mad">
</div></blockquote>
Sorry for that  <img class="smilies" src="images/smilies/icon_rolleyes.gif" width="15" height="15" alt=":roll:" title="Rolling Eyes"> <br>
First I checked it on another machine and it fails there.<br>
Then I created an empty echo.bat and it starts that batch file, then I got the enlightenment  <img class="smilies" src="images/smilies/icon_idea.gif" width="15" height="15" alt=":idea:" title="Idea"> <br>
<br>
Check your "working" machine with 
<div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>where echo</code></pre></div>
I got<br>
C:\MinGW\msys\1.0\bin\echo.exe   <img class="smilies" src="images/smilies/icon_idea.gif" width="15" height="15" alt=":idea:" title="Idea">  <img class="smilies" src="images/smilies/icon_exclaim.gif" width="15" height="15" alt=":!:" title="Exclamation"> <br>
That explains the "odd" effects <img class="smilies" src="images/smilies/icon_biggrin.gif" width="15" height="15" alt=":D" title="Very Happy"> <br>
Therefore the new rules are obsolete
<blockquote class="uncited"><div>4) I refined the phase 7 rules for Extended ECHO behavior</div></blockquote></div>
			</div>
			<hr />
					<div class="post">
				<h3>Re: Discussion about jeb's batch parsing rules on StackOverflow</h3>
				<div class="date">Posted: <strong>06 Feb 2018 04:41</strong></div>
				<div class="author">by <strong>dbenham</strong></div>
				<div class="content">That is a relief  <img class="smilies" src="images/smilies/icon_biggrin.gif" width="15" height="15" alt=":D" title="Very Happy"> <br>
I think I ran into C:\MinGW\msys\1.0\bin\echo.exe  before on that same machine when I was doing some unrelated tests years ago. No chance in hell that I would have remembered it and applied it to this situation.<br>
<span style="color: #0000FF">EDIT - On my machine it is "D:\Program Files\Integrity\Toolkit\mksnt\echo.exe" from our code management installation (formerly MKS)</span><br>
<br>
I didn't plan on including "Extended ECHO" rules on StackOverflow anyway, especially with the inconsistencies.<br>
<br>
Thanks for figuring this out.<br>
<br>
The whole episode does point out something interesting though - The command delimiters for phase 7 internal commands must be different than the command delimiters for phase 7 external command searches <img class="smilies" src="images/smilies/icon_exclaim.gif" width="15" height="15" alt=":!:" title="Exclamation">  <img class="smilies" src="images/smilies/icon_rolleyes.gif" width="15" height="15" alt=":roll:" title="Rolling Eyes"> <br>
I kind of had a clue to this when I looked at the error messages, but I foolishly thought it was some special behavior of the error message formatter.<br>
<br>
How about those new phase 2 delimiters <img class="smilies" src="images/smilies/icon_exclaim.gif" width="15" height="15" alt=":!:" title="Exclamation"> <br>
I had hoped they would be safe with ECHO, but alas, ECHO%VT%/? and ECHO%FF%/? both print ECHO help <img class="smilies" src="images/smilies/icon_sad.gif" width="15" height="15" alt=":(" title="Sad"> <br>
<br>
<br>
Dave Benham</div>
			</div>
			<hr />
					<div class="post">
				<h3>Re: Discussion about jeb's batch parsing rules on StackOverflow</h3>
				<div class="date">Posted: <strong>10 Feb 2018 14:08</strong></div>
				<div class="author">by <strong>Sponge Belly</strong></div>
				<div class="content">Hi Dave and Jeb! <img class="smilies" src="images/smilies/icon_smile.gif" width="15" height="15" alt=":)" title="Smile"><br>
<br>
How about this for strange behaviour?<br>
<br>
multiLine.cmd:<br>

<div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>@echo off &amp; setLocal enableExtensions disableDelayedExpansion

prompt @
for /f "delims=" %%A in ('
    for /f %%B in ("1"^) do rem # %1 #
') do @echo(%%A

echo on
@(
    @for /f "delims=" %%A in ("1") do rem: # %1 #
) | @findStr "^"
@echo off

endLocal &amp; goto :EOF
</code></pre></div>

Input:<br>

<div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>Prompt&gt; multiLine ^"hello^
More?
More? world!"
</code></pre></div>

Output:<br>

<div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>@rem # "hello world!" #

@rem: # "hello &amp; world!" #
</code></pre></div>

Please note that the colon after the second REM is required. Just don’t ask me why! <img class="smilies" src="images/smilies/icon_wink.gif" width="15" height="15" alt=";)" title="Wink"><br>
<br>
<em class="text-italics">- SB</em></div>
			</div>
			<hr />
					<div class="post">
				<h3>Re: Discussion about jeb's batch parsing rules on StackOverflow</h3>
				<div class="date">Posted: <strong>10 Feb 2018 22:00</strong></div>
				<div class="author">by <strong>dbenham</strong></div>
				<div class="content">Nothing mysterious about any of that <img class="smilies" src="images/smilies/icon_wink.gif" width="15" height="15" alt=":wink:" title="Wink"> <br>
The <a href="https://stackoverflow.com/a/4095133/1012053" class="postlink">existing phase rules</a> already predict all the observed behavior. <img class="smilies" src="images/smilies/icon_exclaim.gif" width="15" height="15" alt=":!:" title="Exclamation">  <img class="smilies" src="images/smilies/icon_biggrin.gif" width="15" height="15" alt=":D" title="Very Happy"> <br>
<br>
I've modified the script so that it is completely self-contained - no need to pass any odd line continuation arguments to the script.<br>
I also added an example that uses ECHO instead of REM
<div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>@echo off &amp; setlocal enableExtensions disableDelayedExpansion &amp; prompt @
(set LF=^
%= Empty line creates linefeed 0x0A character =%
)
for /f "delims=" %%A in ('
  for /f %%B in ("1"^) do rem #1 "Hello%LF%world!" #
') do echo(%%A
(
  for %%A in (.) do rem: #2 "Hello%LF%world!" #
) | findStr "^"
(
  echo #3 "Hello%LF%world!" #
) | findstr "^"
</code></pre></div>
--OUTPUT--
<div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>@rem #1 "Hello world!" #

@rem: #2 "Hello &amp; world!" #
#3 "Hello &amp; world!" #
</code></pre></div>

Explanation:<br>
<br>
<strong class="text-strong">#1 - This one is quite simple.</strong>
<blockquote><div><cite>StackOverflow Phase 2, &lt;LF&gt; Section wrote:</cite>
<ul>
<li>Unescaped <strong class="text-strong"><span style="color: #0000FF">&lt;LF&gt;</span></strong> within a FOR IN parenthesized block
  <ul>
  <li><strong class="text-strong"><span style="color: #0000FF">&lt;LF&gt;</span></strong> is converted into a <strong class="text-strong"><span style="color: #0000FF">&lt;space&gt;</span></strong></li>
  <li>If at the end of the line buffer, then the next line is read and appended to the current one.</li>
  </ul></li>
</ul>
</div></blockquote>

<strong class="text-strong">#2 - This one is a bit trickier, as it involves multiple phases.</strong>
<blockquote><div><cite>StackOverflow Phase 2, &lt;LF&gt; Section wrote:</cite>
<ul>
<li>Unescaped <strong class="text-strong"><span style="color: #0000FF">&lt;LF&gt;</span></strong> within a parenthesized command block
  <ul>
  <li><strong class="text-strong"><span style="color: #0000FF">&lt;LF&gt;</span></strong> is converted into <strong class="text-strong"><span style="color: #0000FF">&lt;LF&gt;&lt;space&gt;</span></strong>, and the <strong class="text-strong"><span style="color: #0000FF">&lt;space&gt;</span></strong> is treated as part of the next line of the command block.</li>
  <li>If at the end of line buffer, then the next line is read and appended to the space.</li>
  </ul></li>
</ul>
</div></blockquote>
At this point, the code block looks like<div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>(&lt;LF&gt; for %%A in (.) do rem: #2 "Hello&lt;LF&gt; world!" #&lt;LF&gt; )
</code></pre></div>
<blockquote><div><cite>StackOverflow Phase 5.5 wrote:</cite>
<strong class="text-strong">Phase 5.3) Pipe processing:</strong> Only if commands are on either side of a pipe<br>
Each side of the pipe is processed independently.
<ul>
<li>If dealing with a parenthesized command block, then all <strong class="text-strong"><span style="color: #0000FF">&lt;LF&gt;</span></strong> with a command before and after are converted to <strong class="text-strong"><span style="color: #0000FF">&lt;space&gt;&amp;</span></strong>. Other <strong class="text-strong"><span style="color: #0000FF">&lt;LF&gt;</span></strong> are stripped.</li>
<li>The command (or command block) is executed asynchronously in a new cmd.exe thread via <strong class="text-strong"><span style="color: #0000FF">%comspec% /S /D /c" commandBlock"</span></strong>.<br>
This means the command block gets a phase restart, but this time in command line mode.</li>
</ul>
</div></blockquote>
The parser sees <strong class="text-strong"><span style="color: #0000FF">rem: #2 "Hello</span></strong> as one command, and on the next line it sees <strong class="text-strong"><span style="color: #0000FF">&lt;space&gt;world!" #</span></strong> as another command. So the intervening <strong class="text-strong"><span style="color: #0000FF">&lt;LF&gt;</span></strong> is converted into <strong class="text-strong"><span style="color: #0000FF">&lt;space&gt;&lt;LF&gt;</span></strong><br>
<br>
The linefeeds after the opening parenthesis and before the closing parenthesis are not between commands, so they each get stripped.<br>
<br>
The command then becomes:
<div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>C:\WINDOWS\system32\cmd.exe /S /D /c" ( for %%A in (.) do rem: #2 "Hello &amp; world!" # )"
</code></pre></div>
The REM: command is not recognized as REM in phase 2, so the entire line gets parsed normally during Phase 2 of the command line parsing.<br>
But if you remove the colon, then REM is recognized in phase 2, and the closing parenthesis is treated as part of the remark. So the parenthesized block is never closed, and the block never executes.<br>
<br>
You don't have to use REM:<br>
According to the rules in Phase 7.1, you could use any of the following to delay recognition of the internal REM command until phase 7
<div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>rem:
rem.
rem\
rem+
rem/
rem[
rem]
</code></pre></div>

The explanation for #3 is basically the same as #2, except you don't have to worry about ECHO hiding the closing parenthesis<br>
<br>
<br>
Dave Benham</div>
			</div>
			<hr />
					<div class="post">
				<h3>Re: Discussion about jeb's batch parsing rules on StackOverflow</h3>
				<div class="date">Posted: <strong>11 Feb 2018 14:49</strong></div>
				<div class="author">by <strong>Sponge Belly</strong></div>
				<div class="content">Hi Dave,<br>
<br>
Thanks for the detailed explanation.<br>
<br>
I noticed consecutive LFs were being converted into a single space when I was trying to capture an input parameter inside the in (…) clause of a FOR /F loop using the REM tecchnique.<br>
<br>
I tried all kinds of crazy things, including piping the output from the REM command through FindStr, which is when I noticed LFs were being replaced with “ &amp; ”.<br>
<br>
My efforts were unsuccessful because I couldn’t find a way to deal with unbalanced quotes.<br>
<br>
<em class="text-italics">- SB</em></div>
			</div>
			<hr />
					<div class="post">
				<h3>Re: Discussion about jeb's batch parsing rules on StackOverflow</h3>
				<div class="date">Posted: <strong>11 Feb 2018 15:11</strong></div>
				<div class="author">by <strong>dbenham</strong></div>
				<div class="content"><blockquote><div><cite><a href="memberlistba6b.html?mode=viewprofile&amp;u=4238">Sponge Belly</a> wrote: <a href="viewtopiceac0.html?p=55693#p55693" data-post-id="55693" onclick="if(document.getElementById(hash.substr(1)))href=hash">↑</a><div class="responsive-hide">11 Feb 2018 14:49</div></cite>
My efforts were unsuccessful because I couldn’t find a way to deal with unbalanced quotes.
</div></blockquote>
One point from Phase 2 that is critical to understanding the behavior is the following:
<blockquote><div><cite>StackOverflow Phase 2 wrote:</cite>
&lt;LF&gt; always turns off the quote flag.
</div></blockquote>
It is possible to put each block on a single line if you escape the last quote in #2 and #3.
<div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>@echo off &amp; setlocal enableExtensions disableDelayedExpansion &amp; prompt @
(set LF=^
%= Empty line creates linefeed 0x0A character =%
)
(for %%A in (.) do rem: #2 "Hello%LF%world!^" #) | findStr "^"
(echo #3 "Hello%LF%world!^" #) | findstr "^"
</code></pre></div>
The &lt;LF&gt; closes the first quote, so if you don't escape the 2nd quote, then the right parenthesis is quoted and the block never closes.
<div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>@echo off &amp; setlocal enableExtensions disableDelayedExpansion &amp; prompt @
(set LF=^
%= Empty line creates linefeed 0x0A character =%
)
(for %%A in (.) do rem: #2 "This %LF% FAILS" #) | findStr "^"
(echo #3 "This %LF% FAILS" #) | findstr "^"
</code></pre></div>

Dave Benham</div>
			</div>
			<hr />
					<div class="post">
				<h3>Re: Discussion about jeb's batch parsing rules on StackOverflow</h3>
				<div class="date">Posted: <strong>19 Apr 2018 14:00</strong></div>
				<div class="author">by <strong>pieh-ejdsch</strong></div>
				<div class="content">I had the function <a href="viewtopic759e.html?f=3&amp;t=6496&amp;p=56356#p56356" class="postlink">viewtopic.php?f=3&amp;t=6496&amp;p=56356#p56356</a>return in the do. I first tried to replace an exclamation point with percent signs. which is NOT possible anyway:
<div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>set "return.var=%return.var:!=%%5%"</code></pre></div>

then with delayedexpansion I replaced the variable at the time of execution.
<div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>set "delayed=%%5"
...
set "return.var=%return.var:!=!delayed!%"</code></pre></div>
That worked well.<br>
<br>
Now I wanted to do the whole in a row with call.<br>
the countless attempts with escape characters in several variants have always failed.
<div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code> ...
 call set ^"return.var=%%%%return.var:^!=!delayed!%%%%" ^!
...
call set ^^^"return.var=%%return.var:^^!^=^!delayed^!=%%" ^!
</code></pre></div>
and so on ...<br>
in all variants, which I have tried with call (also nested), the percent sign from the Delayed Variable has been expanded BEFORE executing the command line.<br>
this has led to - that the replacement has NOT taken place.<br>
<br>
changing the variable in advance did not change anything:
<div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code> rem set "A=B"
  rem set "X=^!A^!"
  rem call echo !X!
  rem X =&gt; B
set "delayedA=%%5"
set "delayed=^!delayedA^!"
...</code></pre></div>

If delayedExpansion only takes effect shortly before the command is executed - it still resolves after the call but before the variable is resolved in double percent signs???</div>
			</div>
			<hr />
					<div class="post">
				<h3>Re: Discussion about jeb's batch parsing rules on StackOverflow</h3>
				<div class="date">Posted: <strong>19 Apr 2018 15:36</strong></div>
				<div class="author">by <strong>dbenham</strong></div>
				<div class="content"><blockquote><div><cite><a href="memberlistc1e4.html?mode=viewprofile&amp;u=5414">pieh-ejdsch</a> wrote: <a href="viewtopicd367.html?p=56450#p56450" data-post-id="56450" onclick="if(document.getElementById(hash.substr(1)))href=hash">↑</a><div class="responsive-hide">19 Apr 2018 14:00</div></cite>If delayedExpansion only takes effect shortly before the command is executed - it still resolves after the call but before the variable is resolved in double percent signs???
</div></blockquote>
I'm not sure of the source of your confusion.<br>
<br>
Delayed expansion occurs in phase 5. Then the CALL is processed in phase 6, which kicks of another round of phase 1 percent expansion. Finally in phase 7 the SET command is executed.<br>
<br>
So yes, the CALL percent expansion will always occurs after the delayed expansion.<br>
<br>
Carets are never used to escape or modify percent expansion. The only way to escape a percent is to double it. But it is impossible to include a percent within the replace string when doing percent expansion find/replace.<br>
<br>
You can use % within the find string when doing percent expansion find/replace, but unfortunately the percent cannot be the first character of the find string. The capabilities for delayed expansion are symmetric. You can use ! within the find string when doing delayed expansion find/replace, but the first character of the find string cannot be !. Also, the ! cannot be used in the replace string.<br>
<br>
You want to replace ! with %5, and you believe you need to use CALL percent expansion, presumably because you want to do percent expansion within a parenthesized block. But there is no way to add an additional replace after the CALL percent expansion.<br>
<br>
The only way forward that I see is to do your replacement in two steps by using some escape sequence that does not involve % or !. I'll arbitrarily use @. But @ could already be a character within your string, so you need a way to escape the @. So now it will require 4 steps. I will use @A for @ and @P for percent.<br>

<div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>set "return.var=!return.var:@=@A!"
call set "return.var=%%return.var:!=@P5%%"
set "return.var=!return.var:@P=%%!"
set "return.var=!return.var:@A=@!"
</code></pre></div>

Dave Benham</div>
			</div>
			<hr />
					<div class="post">
				<h3>Re: Discussion about jeb's batch parsing rules on StackOverflow</h3>
				<div class="date">Posted: <strong>18 May 2018 02:24</strong></div>
				<div class="author">by <strong>jeb</strong></div>
				<div class="content">Related to a comment from aschipf at stackoverflow:
<blockquote><div><cite>aschipfl wrote:</cite>Phase 7.1: I think it would be worth mentioning that for the special set semantics set "name=content" ignored the command extensions need to be enabled, otherwise a syntax error arises: what do you think, @dbenham or @jeb?</div></blockquote>

In my opinion, the SET-syntax it's not related to the batch parser phases, more to a special parser of the SET-command.<br>
<br>
But while playing with Extensions I was suprised of the following difference<br>

<div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>setlocal DisableExtensions
set "varC"=ccc
setlocal EnableExtensions
set varC
echo The next one fails
set "varD"=ddd
</code></pre></div>

But that set "varD"=ddd fails is an effect of the extended SET syntax, when the assign starts with a quote, then all characters after the last quote are removed.<br>
Therefore the line is equivalent to set "varD"  only.<br>
set "varD"=ddd"  works again.<br>
<br>
With Enabled Extensions it's possible to embedd quotes into the variable name, without extensions this seems not to be possible,<br>
but it's still possible to expand them<br>

<div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>@echo off
setlocal
set "varA="
set "varB="
set "varC="
set "var"D=ddd"

setlocal DisableExtensions
set varA=aaa
for %%V in ("varB""") DO (
	echo %%V
	set %%V=bbb
)
set varC=ccc
echo It's possible to access var^&lt;quote^&gt;D: %var"D%
setlocal EnableExtensions
set var
</code></pre></div></div>
			</div>
			<hr />
					<div class="post">
				<h3>Re: Discussion about jeb's batch parsing rules on StackOverflow</h3>
				<div class="date">Posted: <strong>18 May 2018 10:00</strong></div>
				<div class="author">by <strong>penpen</strong></div>
				<div class="content"><blockquote><div><cite><a href="memberlist7125.html?mode=viewprofile&amp;u=417">jeb</a> wrote: <a href="viewtopiccc71.html?p=56790#p56790" data-post-id="56790" onclick="if(document.getElementById(hash.substr(1)))href=hash">↑</a><div class="responsive-hide">18 May 2018 02:24</div></cite>In my opinion, the SET-syntax it's not related to the batch parser phases, more to a special parser of the SET-command.</div></blockquote>I'm unsure, because the SET-statement is an internal command", which in my opinion makes it unlikely that it has an own parser.<br>
Because of that i prefer to view "SET" as a keyword recognized by the batch parser.<br>
<br>
<br>
penpen</div>
			</div>
			<hr />
			</div>

	<div id="page-footer" class="page-footer">
		<div class="page-number">All times are <span title="UTC-6">UTC-06:00</span><br />Page <strong>3</strong> of <strong>3</strong></div>
		<div class="copyright">Powered by phpBB&reg; Forum Software &copy; phpBB Limited<br />https://www.phpbb.com/</div>
	</div>
</div>

</body>

<!-- Mirrored from www.dostips.com/forum/viewtopic.php?f=3&t=8355&start=30&view=print by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 19 Oct 2018 07:17:29 GMT -->
</html>
