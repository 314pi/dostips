<!DOCTYPE html>
<html dir="ltr" lang="en-gb">

<!-- Mirrored from www.dostips.com/forum/viewtopic.php?f=3&t=2836&start=30&view=print by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 19 Oct 2018 06:21:25 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- /Added by HTTrack -->
<head>
<meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="robots" content="noindex" />

<title>DosTips.com &bull; foolproof counting of arguments - Page 3</title>

<link href="styles/AllanStyle-SUBSILVER/theme/print.css" rel="stylesheet">
</head>
<body id="phpbb">
<div id="wrap" class="wrap">
	<a id="top" class="top-anchor" accesskey="t"></a>

	<div id="page-header">
		<h1>DosTips.com</h1>
		<p>A Forum all about DOS Batch<br /><a href="index-2.html">https://www.dostips.com/forum/</a></p>

		<h2>foolproof counting of arguments</h2>
		<p><a href="viewtopic9303.html?f=3&amp;t=2836">https://www.dostips.com/forum/viewtopic.php?f=3&amp;t=2836</a></p>
	</div>

	<div id="page-body" class="page-body">
		<div class="page-number">Page <strong>3</strong> of <strong>4</strong></div>
					<div class="post">
				<h3>Re: foolproof counting of arguments</h3>
				<div class="date">Posted: <strong>15 Feb 2012 11:36</strong></div>
				<div class="author">by <strong>dbenham</strong></div>
				<div class="content"><blockquote><div><cite>Liviu wrote:</cite><blockquote><div><cite>jeb wrote:</cite>But piping do the same as the exit, as the pipe itself creates two seperate sub-tasks for each side.<br />The prompt disappears in the child task which is never visible.</div></blockquote>Haven't followed this in any depth, but it doesn't look quite the same. The pipe closes both ends without any obvious 'exit' being typed in and/or piped through.<br /><blockquote><div><cite>jeb wrote:</cite>So the pipe doesn't solve the problem this way.</div></blockquote>Streams 3/4 redirection is foggy enough to me that I can't even spell out what the &quot;problem&quot; might be, let alone solve it <img class="smilies" src="images/smilies/icon_wink.gif" alt=";-)" title="Wink" /><br /></div></blockquote><br />I think I understand what jeb is saying. The pipe is not restoring the streams. It forces the stream manipulation to occur in a child CMD.EXE process that leaves the parent CME.EXE streams alone.<br /><br />--------------------<br /><br />Redirection is one wacky world  <img class="smilies" src="images/smilies/icon_lol.gif" alt=":lol:" title="Laughing" /> <br /><br />I haven't fully analyzed the results to arrive at a pattern yet. But here are some interesting test cases with results.<br /><br /><div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>@echo off<br />if &quot;%~1&quot; neq &quot;&quot; goto :test<br />prompt $g<br />cls<br />for /l %%n in (1 1 21) do (<br />&nbsp; del file?.stream 2&gt;nul<br />&nbsp; echo(<br />&nbsp; echo =====================================================<br />&nbsp; cmd /c &quot;test %%n&quot;<br />&nbsp; echo(<br />&nbsp; for %%f in (file*) do (<br />&nbsp; &nbsp; echo(<br />&nbsp; &nbsp; echo %%f contents<br />&nbsp; &nbsp; echo -----------------------------<br />&nbsp; &nbsp; type %%f<br />&nbsp; )<br />)<br />del file?.stream 2&gt;nul<br />prompt<br />exit /b<br /><br /><br />:test<br />echo on &amp; call :test%1<br />echo echo to stream1<br />&gt;&amp;2 echo echo to stream2<br />&gt;&amp;3 echo echo to stream3<br />&gt;&amp;4 echo echo to stream4<br />exit /b<br /><br />:test1<br />echo off<br />exit /b<br /><br />:test2<br />echo off 1&gt;file1.stream<br />exit /b<br /><br />:test3<br />echo off 2&gt;file2.stream<br />exit /b<br /><br />:test4<br />echo off 3&gt;file3.stream<br />exit /b<br /><br />:test5<br />echo off 4&gt;file4.stream<br />exit /b<br /><br />:test6<br />echo off 1&gt;file1.stream 2&gt;file2.stream 3&gt;file3.stream 4&gt;file4.stream<br />exit /b<br /><br />:test7<br />echo off 1&gt;file1.stream 2&gt;file2.stream 3&gt;file3.stream<br />exit /b<br /><br />:test8<br />echo off 2&gt;file2.stream 3&gt;file3.stream 4&gt;file4.stream<br />exit /b<br /><br />:test9<br />echo off 1&gt;file1.stream 3&gt;file3.stream 4&gt;file4.stream<br />exit /b<br /><br />:test10<br />echo off 1&gt;file1.stream 2&gt;file2.stream 4&gt;file4.stream<br />exit /b<br /><br />:test11<br />echo off 1&gt;file1.stream 2&gt;file2.stream<br />exit /b<br /><br />:test12<br />echo off 1&gt;file1.stream 3&gt;file3.stream<br />exit /b<br /><br />:test13<br />echo off 1&gt;file1.stream 4&gt;file4.stream<br />exit /b<br /><br />:test14<br />echo off 2&gt;file2.stream 3&gt;file3.stream<br />exit /b<br /><br />:test15<br />echo off 2&gt;file2.stream 4&gt;file4.stream<br />exit /b<br /><br />:test16<br />echo off 3&gt;file3.stream 4&gt;file4.stream<br />exit /b<br /><br />:test17<br />echo off 1&gt;nul 2&gt;nul 3&gt;file3.stream 4&gt;file4.stream<br />exit /b<br /><br />:test18<br />echo off 1&gt;nul 2&gt;nul 3&gt;file3.stream<br />exit /b<br /><br />:test19<br />echo off 1&gt;nul 2&gt;nul 4&gt;file4.stream<br />exit /b<br /><br />:test20<br />echo off 1&gt;nul 3&gt;file3.stream<br />exit /b<br /><br />:test21<br />echo off 2&gt;nul 4&gt;file4.stream<br />exit /b<br /></code></pre></div><br /><br /><strong class="text-strong">Results:</strong><br /><div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>=====================================================<br /><br />&gt;echo off<br />echo to stream1<br />echo to stream2<br />echo to stream3<br />The handle could not be duplicated<br />during redirection of handle 1.<br /><br /><br />=====================================================<br /><br />&gt;echo off&nbsp; 1&gt;file1.stream<br />echo to stream1<br />echo to stream2<br />echo to stream3<br />The handle could not be duplicated<br />during redirection of handle 1.<br /><br /><br />file1.stream contents<br />-----------------------------<br /><br />=====================================================<br /><br />&gt;echo off&nbsp; 2&gt;file2.stream<br />echo to stream1<br />echo to stream2<br />echo to stream3<br />The handle could not be duplicated<br />during redirection of handle 1.<br /><br /><br />file2.stream contents<br />-----------------------------<br /><br />=====================================================<br /><br />&gt;echo off&nbsp; 3&gt;file3.stream<br />echo to stream1<br />echo to stream2<br />echo to stream3<br />The handle could not be duplicated<br />during redirection of handle 1.<br /><br /><br />file3.stream contents<br />-----------------------------<br /><br />=====================================================<br /><br />&gt;echo off&nbsp; 4&gt;file4.stream<br />echo to stream1<br />echo to stream2<br />echo to stream3<br />The handle could not be duplicated<br />during redirection of handle 1.<br /><br /><br />file4.stream contents<br />-----------------------------<br /><br />=====================================================<br /><br />&gt;echo off&nbsp; 1&gt;file1.stream 2&gt;file2.stream 3&gt;file3.strea<br />echo to stream3<br />echo to stream4<br /><br /><br />file1.stream contents<br />-----------------------------<br /><br />file2.stream contents<br />-----------------------------<br /><br />file3.stream contents<br />-----------------------------<br />echo to stream1<br /><br />file4.stream contents<br />-----------------------------<br />echo to stream2<br /><br />=====================================================<br /><br />&gt;echo off&nbsp; 1&gt;file1.stream 2&gt;file2.stream 3&gt;file3.strea<br />echo to stream2<br />echo to stream3<br /><br /><br />file1.stream contents<br />-----------------------------<br /><br />file2.stream contents<br />-----------------------------<br /><br />file3.stream contents<br />-----------------------------<br />echo to stream1<br />echo to stream4<br /><br />=====================================================<br /><br />&gt;echo off&nbsp; 2&gt;file2.stream 3&gt;file3.stream 4&gt;file4.strea<br />echo to stream1<br />echo to stream4<br /><br /><br />file2.stream contents<br />-----------------------------<br /><br />file3.stream contents<br />-----------------------------<br />echo to stream2<br /><br />file4.stream contents<br />-----------------------------<br />echo to stream3<br /><br />=====================================================<br /><br />&gt;echo off&nbsp; 1&gt;file1.stream 3&gt;file3.stream 4&gt;file4.strea<br />echo to stream2<br />echo to stream4<br /><br /><br />file1.stream contents<br />-----------------------------<br /><br />file3.stream contents<br />-----------------------------<br />echo to stream1<br /><br />file4.stream contents<br />-----------------------------<br />echo to stream3<br /><br />=====================================================<br /><br />&gt;echo off&nbsp; 1&gt;file1.stream 2&gt;file2.stream 4&gt;file4.strea<br />echo to stream1<br />echo to stream3<br />echo to stream4<br /><br /><br />file1.stream contents<br />-----------------------------<br /><br />file2.stream contents<br />-----------------------------<br /><br />file4.stream contents<br />-----------------------------<br />echo to stream2<br /><br />=====================================================<br /><br />&gt;echo off&nbsp; 1&gt;file1.stream 2&gt;file2.stream<br />echo to stream1<br />echo to stream2<br />echo to stream3<br />The handle could not be duplicated<br />during redirection of handle 1.<br /><br /><br />file1.stream contents<br />-----------------------------<br /><br />file2.stream contents<br />-----------------------------<br /><br />=====================================================<br /><br />&gt;echo off&nbsp; 1&gt;file1.stream 3&gt;file3.stream<br />echo to stream2<br />echo to stream3<br /><br /><br />file1.stream contents<br />-----------------------------<br /><br />file3.stream contents<br />-----------------------------<br />echo to stream1<br />echo to stream4<br /><br />=====================================================<br /><br />&gt;echo off&nbsp; 1&gt;file1.stream 4&gt;file4.stream<br />echo to stream1<br />echo to stream2<br />echo to stream3<br />The handle could not be duplicated<br />during redirection of handle 1.<br /><br /><br />file1.stream contents<br />-----------------------------<br /><br />file4.stream contents<br />-----------------------------<br /><br />=====================================================<br /><br />&gt;echo off&nbsp; 2&gt;file2.stream 3&gt;file3.stream<br />echo to stream1<br />echo to stream3<br />echo to stream4<br /><br /><br />file2.stream contents<br />-----------------------------<br /><br />file3.stream contents<br />-----------------------------<br />echo to stream2<br /><br />=====================================================<br /><br />&gt;echo off&nbsp; 2&gt;file2.stream 4&gt;file4.stream<br />echo to stream1<br />echo to stream2<br />echo to stream3<br />The handle could not be duplicated<br />during redirection of handle 1.<br /><br /><br />file2.stream contents<br />-----------------------------<br /><br />file4.stream contents<br />-----------------------------<br /><br />=====================================================<br /><br />&gt;echo off&nbsp; 3&gt;file3.stream 4&gt;file4.stream<br />echo to stream1<br />echo to stream2<br />echo to stream3<br />The handle could not be duplicated<br />during redirection of handle 1.<br /><br /><br />file3.stream contents<br />-----------------------------<br /><br />file4.stream contents<br />-----------------------------<br /><br />=====================================================<br /><br />&gt;echo off&nbsp; 1&gt;nul 2&gt;nul 3&gt;file3.stream 4&gt;file4.stream<br />echo to stream3<br />echo to stream4<br /><br /><br />file3.stream contents<br />-----------------------------<br />echo to stream1<br /><br />file4.stream contents<br />-----------------------------<br />echo to stream2<br /><br />=====================================================<br /><br />&gt;echo off&nbsp; 1&gt;nul 2&gt;nul 3&gt;file3.stream<br />echo to stream2<br />echo to stream3<br /><br /><br />file3.stream contents<br />-----------------------------<br />echo to stream1<br />echo to stream4<br /><br />=====================================================<br /><br />&gt;echo off&nbsp; 1&gt;nul 2&gt;nul 4&gt;file4.stream<br />echo to stream1<br />echo to stream3<br />echo to stream4<br /><br /><br />file4.stream contents<br />-----------------------------<br />echo to stream2<br /><br />=====================================================<br /><br />&gt;echo off&nbsp; 1&gt;nul 3&gt;file3.stream<br />echo to stream2<br />echo to stream3<br /><br /><br />file3.stream contents<br />-----------------------------<br />echo to stream1<br />echo to stream4<br /><br />=====================================================<br /><br />&gt;echo off&nbsp; 2&gt;nul 4&gt;file4.stream<br />echo to stream1<br />echo to stream2<br />echo to stream3<br />The handle could not be duplicated<br />during redirection of handle 1.<br /><br /><br />file4.stream contents<br />-----------------------------<br /></code></pre></div><br /><br />Dave Benham</div>
			</div>
			<hr />
					<div class="post">
				<h3>Re: foolproof counting of arguments</h3>
				<div class="date">Posted: <strong>15 Feb 2012 19:27</strong></div>
				<div class="author">by <strong>Liviu</strong></div>
				<div class="content"><blockquote><div><cite>dbenham wrote:</cite>Redirection is one wacky world  <img class="smilies" src="images/smilies/icon_lol.gif" alt=":lol:" title="Laughing" /> <br /><br />I haven't fully analyzed the results to arrive at a pattern yet. But here are some interesting test cases with results.</div></blockquote><br />Interesting... Though I'd say first pattern which jumps to the eye is random chaos <img class="smilies" src="images/smilies/icon_wink.gif" alt=";-)" title="Wink" /><br /><br />Not directly related, but another &gt;&amp;3 odd behavior noted in my Feb 6th post at <a href="http://groups.google.com/group/alt.msdos.batch.nt/browse_thread/thread/b5d5f5e3e17f024b/c24bcb7982c42ab2?lnk=raot" class="postlink">http://groups.google.com/group/alt.msdos.batch.nt/browse_thread/thread/b5d5f5e3e17f024b/c24bcb7982c42ab2?lnk=raot</a>.<br /><br />Liviu</div>
			</div>
			<hr />
					<div class="post">
				<h3>Re: foolproof counting of arguments</h3>
				<div class="date">Posted: <strong>19 Feb 2012 18:28</strong></div>
				<div class="author">by <strong>dbenham</strong></div>
				<div class="content"><blockquote><div><cite>jeb wrote:</cite>I create a completly other way of capturing the parameters into a file<br /><div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>@echo on<br />@echo Hello1 1&gt;stream1.txt 2&gt;stream2.txt 3&gt;stream3.txt 4&gt;stream4.txt<br />rem # %* #<br />@echo off<br />type stream3.txt &gt; con<br />exit /b<br /></code></pre></div><br /><br />This is adapted from the code of walid2me <a href="http://stackoverflow.com/a/8533464/463115" class="postlink">SO: Commenting multiple lines in DOS batch file</a><br /><br />The only problem is to restore the standard handles <img class="smilies" src="images/smilies/icon_exclaim.gif" alt=":!:" title="Exclamation" /> <br />As after the code even the prompt isn't visible anymore<br /></div></blockquote><br />I can get close <img class="smilies" src="images/smilies/icon_exclaim.gif" alt=":!:" title="Exclamation" /><br />By some weird chaining effect I can redirect the output back to con. Stream 1 (stdout) is not quite normal when finished because CLS does not work, and the stream3.txt is still left open until the CMD.EXE session terminates. I imagine there are additional oddities lurking somewhere.<br /><br /><strong class="text-strong">test.bat</strong><br /><div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>@echo on 1&gt;nul 3&gt;stream3.txt<br />rem # %* #<br />@echo off 1&gt;nul 3&gt;nul 4&gt;con<br />type stream3.txt<br /></code></pre></div><br /><strong class="text-strong">command line session</strong><br /><div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>&gt;cmd<br />Microsoft Windows &#91;Version 6.0.6002&#93;<br />Copyright (c) 2006 Microsoft Corporation.&nbsp; All rights reserved.<br /><br />&gt;test Hello world<br /><br />&gt;rem # Hello world #<br /><br />&gt;cls<br />♀<br />&gt;del stream3.txt<br />C:\Users\public\utils\stream3.txt<br />The process cannot access the file because it is being used by another process.<br /><br />&gt;exit<br /><br />&gt;del stream3.txt<br /><br />&gt;</code></pre></div><br /><br />I can work with both stdout and stderr if I want. From the command line:<br /><div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>&gt;cmd<br />Microsoft Windows &#91;Version 6.0.6002&#93;<br />Copyright (c) 2006 Microsoft Corporation.&nbsp; All rights reserved.<br /><br />&gt;echo on 1&gt;nul 2&gt;nul 3&gt;stream3.txt 4&gt;stream4.txt<br />echo stdout message<br />echo stderr message &gt;&amp;2<br />echo on 1&gt;nul 2&gt;nul 3&gt;nul 4&gt;nul 5&gt;con 6&gt;con<br /><br />&gt;type stream3.txt<br /><br />&gt;stdout message<br /><br />&gt;<br />&gt;<br />&gt;type stream4.txt<br />stderr message<br /><br />&gt;dir doesNotExist<br />&nbsp;Volume in drive C is OS<br />&nbsp;Volume Serial Number is EE2C-5A11<br /><br />&nbsp;Directory of C:\Users\public\utils<br /><br />File Not Found<br /><br />&gt;dir doesNotExist 1&gt;nul<br />File Not Found<br /><br />&gt;dir doesNotExist 2&gt;nul<br />&nbsp;Volume in drive C is OS<br />&nbsp;Volume Serial Number is EE2C-5A11<br /><br />&nbsp;Directory of C:\Users\public\utils<br /><br /><br />&gt;del stream3.txt<br />C:\Users\public\utils\stream3.txt<br />The process cannot access the file because it is being used by another process.<br /><br />&gt;del stream4.txt<br />C:\Users\public\utils\stream4.txt<br />The process cannot access the file because it is being used by another process.<br /><br />&gt;exit<br /><br />&gt;del stream3.txt<br /><br />&gt;del stream4.txt<br /><br />&gt;<br /></code></pre></div><br /><br />While experimenting I learned that CLS sends a form feed character &lt;FF&gt; (0x0C) to the screen. If you redirect CLS to con, then you get a graphical representation of the &lt;FF&gt; character on the screen. I can use CLS behavior to get &lt;FF&gt; in a variable:<br /><div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>@echo off<br />setlocal<br />for /f %%A in ('cls') do set FF=%%A<br />set FF<br /></code></pre></div><br /><br />Dave Benham</div>
			</div>
			<hr />
					<div class="post">
				<h3>Re: foolproof counting of arguments</h3>
				<div class="date">Posted: <strong>19 Feb 2012 18:55</strong></div>
				<div class="author">by <strong>Squashman</strong></div>
				<div class="content"><blockquote><div><cite>dbenham wrote:</cite><blockquote><div><cite>jeb wrote:</cite>While experimenting I learned that CLS sends a form feed character &lt;FF&gt; (0x0C) to the screen. If you redirect CLS to con, then you get a graphical representation of the &lt;FF&gt; character on the screen. I can use CLS behavior to get &lt;FF&gt; in a variable:<br /><div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>@echo off<br />setlocal<br />for /f %%A in ('cls') do set FF=%%A<br />set FF<br /></code></pre></div><br /><br />Dave Benham</div></blockquote></div></blockquote><br />Sweet. Now we have all 3 covered. CR LF and FF</div>
			</div>
			<hr />
					<div class="post">
				<h3>Re: foolproof counting of arguments</h3>
				<div class="date">Posted: <strong>26 Mar 2012 16:29</strong></div>
				<div class="author">by <strong>dbenham</strong></div>
				<div class="content">StackOverflow user Erbert has discovered that reversing the order of the redirection, (high numbered file handles before low numbers), prevents the &quot;permanent&quot; redirection: <!-- m --><a class="postlink" href="http://stackoverflow.com/a/9880156/1012053">http://stackoverflow.com/a/9880156/1012053</a><!-- m --><br /><br /><br />Dave Benham</div>
			</div>
			<hr />
					<div class="post">
				<h3>Re: foolproof counting of arguments</h3>
				<div class="date">Posted: <strong>28 Mar 2012 22:38</strong></div>
				<div class="author">by <strong>Liviu</strong></div>
				<div class="content"><blockquote><div><cite>dbenham wrote:</cite>StackOverflow user Erbert has discovered that reversing the order of the redirection, (high numbered file handles before low numbers), prevents the &quot;permanent&quot; redirection: <!-- m --><a class="postlink" href="http://stackoverflow.com/a/9880156/1012053">http://stackoverflow.com/a/9880156/1012053</a><!-- m --></div></blockquote><br />Interesting, thanks for the pointer. That said, I don't think the case is closed. For one thing, replacing &quot;3&quot; with some other handle number e.g. &quot;4&quot; or &quot;5&quot; gives different output/behavior. What's observed there may well be the result of some crosstalk with cmd's own internal usage of handle 3.<br /><br />Liviu</div>
			</div>
			<hr />
					<div class="post">
				<h3>Re: foolproof counting of arguments</h3>
				<div class="date">Posted: <strong>29 Mar 2012 00:20</strong></div>
				<div class="author">by <strong>jeb</strong></div>
				<div class="content">In my opinion, stream3 and stream4 are the destinations of stdout and stderr, they will be used when stream1 or stream2 are not redirected.<br /><br />So if you write <br /><div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>echo test1<br />echo test1r 1&gt; stream1.txt</code></pre></div><br /><br />In the first case the text will be &quot;redirected&quot; to stream3, and as the destination of stream3 is CON, the text will be displayed<br />And in the second case stream3 will not be used, as there is an explicit redirection<br /><br />(Only a guess)  <img class="smilies" src="images/smilies/icon_smile.gif" alt=":)" title="Smile" /> <br />jeb</div>
			</div>
			<hr />
					<div class="post">
				<h3>Re: foolproof counting of arguments</h3>
				<div class="date">Posted: <strong>29 Mar 2012 13:26</strong></div>
				<div class="author">by <strong>dbenham</strong></div>
				<div class="content">I believe I have figured it out <img class="smilies" src="images/smilies/icon_exclaim.gif" alt=":!:" title="Exclamation" />  <img class="smilies" src="images/smilies/icon_biggrin.gif" alt=":D" title="Very Happy" /> <br /><br />When a stream is redirected, the current definition is held in (transfered to) the 1st available (undefined) stream. When the redirection ends, the held definition is restored back to the original stream, and the holding stream is undefined again.<br /><br />For example<br /><div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>1&gt;out.txt echo Hello world!<br /></code></pre></div>While the redirection is in effect, 1 is directed to the file, and 3 holds the original definition of 1 (stdout). Stream 2 couldn't be used to hold the stdout definition because it is already being used by stderr. Once redirection is over, 1 is restored to the definition held in <span style="color: #BF0000">3</span> (stdout), and <span style="color: #BF0000">3</span> is undefined again. <em class="text-italics"><span style="color: #BF0000">(Edit - typos fixed on 2012-04-03)</span></em><br /><br />The weirdness starts when a chain of redirections occurs. The redirection chaining works fine on the way in. But on the way out, restoration is only performed 1 level deep.<br /><div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>1&gt;out1.txt 3&gt;out2.txt echo Hello world!<br /></code></pre></div>First 1 is directed to file out1.txt and 3 holds the definition of stdout, but then 3 is directed to out2.txt and 4 holds the definition of stdout. But once redirection is over, 1 is restored to the definition of 3(out2.txt), 3 is restored to the definition of 4(stdout), and 4 is undefined.<br /><br />Here is a script I used to &quot;prove&quot; my theory<br /><div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>@echo off<br />2&gt;nul 3&gt;nul 1&gt;nul 5&gt;nul 6&gt;nul (<br />&nbsp; REM while redirection is in effect<br />&nbsp; REM 2=nul, 3=nul, 4=stderr<br />&nbsp; REM 1=nul, 5=nul, 6=nul, 7=stdout<br />&nbsp; 1&gt;&amp;7 echo stdout via stream7<br />&nbsp; 2&gt;&amp;4 1&gt;&amp;2 echo stderr via stream4<br />&nbsp; 1&gt;&amp;7 echo -------------------------<br />)<br />REM Prior redirection is now over,<br />REM but handles are only restored one level deep<br />REM 2=nul, 3=stderr, 4=undefined<br />REM 1=nul, 5=nul, 6=stdout, 7=undefined<br />1&gt;&amp;6 echo stdout via stream6<br />2&gt;&amp;3 1&gt;&amp;2 echo stderr via stream3<br />1&gt;&amp;6 echo -------------------------<br /><br />1&gt;nul 4&gt;&amp;6 2&gt;nul 8&gt;&amp;3 (<br />&nbsp; REM while redirection is in effect<br />&nbsp; REM 5=nul(unchanged)<br />&nbsp; REM 1=nul, 4=6=stdout, 7=nul(from 4 from 1 before redirection)<br />&nbsp; REM 2=nul, 8=3=stdout, 9=nul(from 8 from 2 before redirection)<br />&nbsp; 1&gt;&amp;6 echo stdout via stream6<br />&nbsp; 1&gt;&amp;4 echo stdout via stream4 (via stream6^)<br />&nbsp; 2&gt;&amp;3 1&gt;&amp;2 echo stderr via stream3<br />&nbsp; 2&gt;&amp;8 1&gt;&amp;2 echo stderr via stream8 (via stream3^)<br />&nbsp; 1&gt;&amp;6 echo -------------------------<br />)<br />REM 1=6=stdout, 4=nul, 7=undefined<br />REM 2=3=stderr, 8=nul, 9=undefined<br />echo restored stdout (via stream6)<br />1&gt;&amp;6 echo stdout via stream6<br />1&gt;&amp;2 echo restored stderr (via stream3)<br />1&gt;&amp;3 echo stderr via stream3<br />1&gt;&amp;6 echo -------------------------<br /></code></pre></div><br />And here are the results<br /><div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>stdout via stream7<br />stderr via stream4<br />-------------------------<br />stdout via stream6<br />stderr via stream3<br />-------------------------<br />stdout via stream6<br />stdout via stream4 (via stream6)<br />stderr via stream3<br />stderr via stream8 (via stream3)<br />-------------------------<br />restored stdout (via stream6)<br />stdout via stream6<br />restored stderr (via stream3)<br />stderr via stream3<br />-------------------------<br /></code></pre></div><br />-----------------------------------------------------------<br /><br />Now we can use jeb's idea to safely capture the arguments, and have stdout restored to almost normal when done. (remember the original topic of this thread <img class="smilies" src="images/smilies/icon_smile.gif" alt=":)" title="Smile" />  <img class="smilies" src="images/smilies/icon_exclaim.gif" alt=":!:" title="Exclamation" />)<br /><div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>@echo on 1&gt;args.txt 3&gt;&amp;1<br />rem # %* #<br />@echo off 1&gt;nul 4&gt;&amp;3<br />type args.txt<br />echo -------------<br />1&gt;&amp;3 echo stream1 and stream3 both point to stdout<br />echo -------------<br />del args.txt<br />1&gt;&amp;4 echo stream4 is left open pointing to args.txt<br />type args.txt<br />exit /b<br /></code></pre></div><br />stdout is normal except that both stream1 and stream3 point to stdout, whereas normally stream 3 is undefined. This might not be so bad.<br /><br />More problematic is the fact that stream4 is left open pointing to args.txt, and it will remain open until the CMD shell is terminated. <img class="smilies" src="images/smilies/icon_sad.gif" alt=":(" title="Sad" /><br /><br /><br />Dave Benham</div>
			</div>
			<hr />
					<div class="post">
				<h3>Re: foolproof counting of arguments</h3>
				<div class="date">Posted: <strong>29 Mar 2012 21:44</strong></div>
				<div class="author">by <strong>dbenham</strong></div>
				<div class="content">My prior post had a test case that enabled me to derive the rules, but it wasn't very definitive proof.<br /><br />Here is a new test case that better proves the theory.<br /><div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>@echo off<br />2&gt;file2.txt 3&gt;file3.txt 1&gt;file1.txt 5&gt;file5.txt 6&gt;file6.txt (<br />&nbsp; REM while redirection is in effect<br />&nbsp; REM 2=file2.txt, 3=file3.txt, 4=stderr<br />&nbsp; REM 1=file1.txt, 5=file5.txt, 6=file6.txt, 7=stdout<br />&nbsp; dir /b nonExistentFile<br />&nbsp; &nbsp; &nbsp; &nbsp;echo Inside 1st redirection: stream1<br />&nbsp; 1&gt;&amp;2 echo Inside 1st redirection: stream2<br />&nbsp; 1&gt;&amp;3 echo Inside 1st redirection: stream3<br />&nbsp; 1&gt;&amp;4 echo Inside 1st redirection: stream4<br />&nbsp; 1&gt;&amp;5 echo Inside 1st redirection: stream5<br />&nbsp; 1&gt;&amp;6 echo Inside 1st redirection: stream6<br />&nbsp; 1&gt;&amp;7 echo Inside 1st redirection: stream7<br />&nbsp; 1&gt;&amp;7 (<br />&nbsp; &nbsp; echo -----------------------<br />&nbsp; &nbsp; echo file1:<br />&nbsp; &nbsp; type file1.txt<br />&nbsp; &nbsp; echo -----------------------<br />&nbsp; &nbsp; echo file2:<br />&nbsp; &nbsp; type file2.txt<br />&nbsp; &nbsp; echo -----------------------<br />&nbsp; &nbsp; echo file3:<br />&nbsp; &nbsp; type file3.txt<br />&nbsp; &nbsp; echo -----------------------<br />&nbsp; &nbsp; echo file5:<br />&nbsp; &nbsp; type file5.txt<br />&nbsp; &nbsp; echo -----------------------<br />&nbsp; &nbsp; echo file6:<br />&nbsp; &nbsp; type file6.txt<br />&nbsp; &nbsp; echo =============================<br />&nbsp; )<br />)<br />REM Prior redirection is now over,<br />REM but handles are only restored one level deep<br />REM 2=file3.txt, 3=stderr, 4=undefined<br />REM 1=file5.txt, 5=file6.txt, 6=stdout, 7=undefined<br />dir /b nonExistentFile<br />&nbsp; &nbsp; &nbsp;echo After 1st redirection: stream1<br />1&gt;&amp;2 echo After 1st redirection: stream2<br />1&gt;&amp;3 echo After 1st redirection: stream3<br />1&gt;&amp;4 echo After 1st redirection: stream4<br />1&gt;&amp;5 echo After 1st redirection: stream5<br />1&gt;&amp;6 echo After 1st redirection: stream6<br />1&gt;&amp;7 echo After 1st redirection: stream7<br />1&gt;&amp;6 (<br />&nbsp; echo -----------------------<br />&nbsp; echo file1:<br />&nbsp; type file1.txt<br />&nbsp; echo -----------------------<br />&nbsp; echo file2:<br />&nbsp; type file2.txt<br />&nbsp; echo -----------------------<br />&nbsp; echo file3:<br />&nbsp; type file3.txt<br />&nbsp; echo -----------------------<br />&nbsp; echo file5:<br />&nbsp; type file5.txt<br />&nbsp; echo -----------------------<br />&nbsp; echo file6:<br />&nbsp; type file6.txt<br />&nbsp; echo =============================<br />)<br /><br />1&gt;&amp;6 4&gt;&amp;6 2&gt;&amp;3 8&gt;&amp;3 (<br />&nbsp; REM while redirection is in effect<br />&nbsp; REM 3=stderr(unchanged), 5=file6.txt(unchanged), 6=stdout(unchanged),<br />&nbsp; REM 1=6=stdout, 4=6=stdout, 7=file5.txt(from 4 from 1 before redirection)<br />&nbsp; REM 2=3=stderr, 8=3=stderr, 9=file3.txt(from 8 from 2 before redirection)<br />&nbsp; dir /b nonExistentFile<br />&nbsp; &nbsp; &nbsp; &nbsp;echo Inside 2nd redirection: stream1<br />&nbsp; 1&gt;&amp;2 echo Inside 2nd redirection: stream2<br />&nbsp; 1&gt;&amp;3 echo Inside 2nd redirection: stream3<br />&nbsp; 1&gt;&amp;4 echo Inside 2nd redirection: stream4<br />&nbsp; 1&gt;&amp;5 echo Inside 2nd redirection: stream5<br />&nbsp; 1&gt;&amp;6 echo Inside 2nd redirection: stream6<br />&nbsp; 1&gt;&amp;7 echo Inside 2nd redirection: stream7<br />&nbsp; 1&gt;&amp;8 echo Inside 2nd redirection: stream8<br />&nbsp; 1&gt;&amp;9 echo Inside 2nd redirection: stream9<br />&nbsp; 1&gt;&amp;6 (<br />&nbsp; &nbsp; echo -----------------------<br />&nbsp; &nbsp; echo file1:<br />&nbsp; &nbsp; type file1.txt<br />&nbsp; &nbsp; echo -----------------------<br />&nbsp; &nbsp; echo file2:<br />&nbsp; &nbsp; type file2.txt<br />&nbsp; &nbsp; echo -----------------------<br />&nbsp; &nbsp; echo file3:<br />&nbsp; &nbsp; type file3.txt<br />&nbsp; &nbsp; echo -----------------------<br />&nbsp; &nbsp; echo file5:<br />&nbsp; &nbsp; type file5.txt<br />&nbsp; &nbsp; echo -----------------------<br />&nbsp; &nbsp; echo file6:<br />&nbsp; &nbsp; type file6.txt<br />&nbsp; &nbsp; echo =============================<br />&nbsp; )<br />)<br />REM Prior redirection is now over,<br />REM 3=stderr(unchanged), 5=file6.txt(unchanged), 6=stdout(unchanged),<br />REM 1=6=stdout, 4=file5.txt, 7=undefined<br />REM 2=3=stderr, 8=file3.txt, 9=undefined<br />dir /b nonExistentFile<br />&nbsp; &nbsp; &nbsp;echo After 2nd redirection: stream1<br />1&gt;&amp;2 echo After 2nd redirection: stream2<br />1&gt;&amp;3 echo After 2nd redirection: stream3<br />1&gt;&amp;4 echo After 2nd redirection: stream4<br />1&gt;&amp;5 echo After 2nd redirection: stream5<br />1&gt;&amp;6 echo After 2nd redirection: stream6<br />1&gt;&amp;7 echo After 2nd redirection: stream7<br />1&gt;&amp;8 echo After 2nd redirection: stream8<br />1&gt;&amp;9 echo After 2nd redirection: stream9<br />echo -----------------------<br />echo file1:<br />type file1.txt<br />echo -----------------------<br />echo file2:<br />type file2.txt<br />echo -----------------------<br />echo file3:<br />type file3.txt<br />echo -----------------------<br />echo file5:<br />type file5.txt<br />echo -----------------------<br />echo file6:<br />type file6.txt<br />echo =============================<br /></code></pre></div><br />And here are the results<br /><div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>&gt;test<br />Inside 1st redirection: stream4<br />Inside 1st redirection: stream7<br />-----------------------<br />file1:<br />Inside 1st redirection: stream1<br />-----------------------<br />file2:<br />File Not Found<br />Inside 1st redirection: stream2<br />-----------------------<br />file3:<br />Inside 1st redirection: stream3<br />-----------------------<br />file5:<br />Inside 1st redirection: stream5<br />-----------------------<br />file6:<br />Inside 1st redirection: stream6<br />=============================<br />After 1st redirection: stream3<br />After 1st redirection: stream6<br />-----------------------<br />file1:<br />Inside 1st redirection: stream1<br />-----------------------<br />file2:<br />File Not Found<br />Inside 1st redirection: stream2<br />-----------------------<br />file3:<br />Inside 1st redirection: stream3<br />File Not Found<br />After 1st redirection: stream2<br />The handle could not be duplicated<br />during redirection of handle 1.<br />-----------------------<br />file5:<br />Inside 1st redirection: stream5<br />After 1st redirection: stream1<br />After 1st redirection: stream4<br />-----------------------<br />file6:<br />Inside 1st redirection: stream6<br />After 1st redirection: stream5<br />=============================<br />File Not Found<br />Inside 2nd redirection: stream1<br />Inside 2nd redirection: stream2<br />Inside 2nd redirection: stream3<br />Inside 2nd redirection: stream4<br />Inside 2nd redirection: stream6<br />Inside 2nd redirection: stream8<br />-----------------------<br />file1:<br />Inside 1st redirection: stream1<br />-----------------------<br />file2:<br />File Not Found<br />Inside 1st redirection: stream2<br />-----------------------<br />file3:<br />Inside 1st redirection: stream3<br />File Not Found<br />After 1st redirection: stream2<br />The handle could not be duplicated<br />during redirection of handle 1.<br />Inside 2nd redirection: stream9<br />-----------------------<br />file5:<br />Inside 1st redirection: stream5<br />After 1st redirection: stream1<br />After 1st redirection: stream4<br />Inside 2nd redirection: stream7<br />-----------------------<br />file6:<br />Inside 1st redirection: stream6<br />After 1st redirection: stream5<br />Inside 2nd redirection: stream5<br />=============================<br />File Not Found<br />After 2nd redirection: stream1<br />After 2nd redirection: stream2<br />After 2nd redirection: stream3<br />After 2nd redirection: stream6<br />After 2nd redirection: stream7<br />The handle could not be duplicated<br />during redirection of handle 1.<br />-----------------------<br />file1:<br />Inside 1st redirection: stream1<br />-----------------------<br />file2:<br />File Not Found<br />Inside 1st redirection: stream2<br />-----------------------<br />file3:<br />Inside 1st redirection: stream3<br />File Not Found<br />After 1st redirection: stream2<br />The handle could not be duplicated<br />during redirection of handle 1.<br />Inside 2nd redirection: stream9<br />After 2nd redirection: stream8<br />-----------------------<br />file5:<br />Inside 1st redirection: stream5<br />After 1st redirection: stream1<br />After 1st redirection: stream4<br />Inside 2nd redirection: stream7<br />After 2nd redirection: stream4<br />-----------------------<br />file6:<br />Inside 1st redirection: stream6<br />After 1st redirection: stream5<br />Inside 2nd redirection: stream5<br />After 2nd redirection: stream5<br />=============================<br /><br />&gt;del file1.txt<br /><br />&gt;del file2.txt<br /><br />&gt;del file3.txt<br />....file3.txt<br />The process cannot access the file because it is being used by another process.<br /><br />&gt;del file5.txt<br />....file5.txt<br />The process cannot access the file because it is being used by another process.<br /><br />&gt;del file6.txt<br />....file6.txt<br />The process cannot access the file because it is being used by another process.<br /><br />&gt;<br /></code></pre></div><br />The results exactly match my expectations. There are 2 cases that took a while for me to figure out.<br /><br />After the 1st redirection is over, stream 4 is undefined. Yet when I redirect 1 to &amp;4, I get the output in file5.txt. What I believe happens is this:<br /> - Before the redirection, 1 is directed to file5.txt, and 4 is undefined.<br /> - CMD gets the instruction to redirect 1 to &amp;4<br /> - - first the current definition (file5.txt) is stored in the first available undefined stream, which happens to be 4.<br /> - - then the redirection is completed and 1 is redirected to the current definition of 4, which is now file5.txt<br /><br />After the 2nd redirection is over, stream 7 is undefined. Yet when I redirect 1 to &amp;7, I get the output on stdout.<br /> - Before the redirection, 1 is going to stdout, and 7 is undefined<br /> - CMD gets the instruction to redirect 1 to &amp;7<br /> - - first the current definition (stdout) is stored in the first available undefined stream, which happens to be 7.<br /> - - then the redirection is completed and 1 is redirected to the current definition of 7, which is now stdout.<br /><br />When all is done, file1.txt and file2.txt are closed. But files 3, 5 and 6 are left open and locked until the CMD session is terminated.<br /><br /><br />Dave  Benham</div>
			</div>
			<hr />
					<div class="post">
				<h3>Re: foolproof counting of arguments</h3>
				<div class="date">Posted: <strong>04 Apr 2012 10:43</strong></div>
				<div class="author">by <strong>jeb</strong></div>
				<div class="content">It's really awkful  <img class="smilies" src="images/smilies/icon_eek.gif" alt=":shock:" title="Shocked" />  <img class="smilies" src="images/smilies/icon_exclaim.gif" alt=":!:" title="Exclamation" /> <br /><br />I like this type of analyses, it's a really new insight into batch/cmd mechanics.<br /><br />But I don't understand why someone (MS) create it this way.<br />Even when I was a poor beginner I wouldn't produce such <em class="text-italics">solutions</em>.<br /><br />But it was a great investigation of Dave to figure out how it works.  <img class="smilies" src="images/smilies/icon_biggrin.gif" alt=":D" title="Very Happy" /> <br /><br />jeb</div>
			</div>
			<hr />
					<div class="post">
				<h3>Re: foolproof counting of arguments</h3>
				<div class="date">Posted: <strong>25 Aug 2012 21:53</strong></div>
				<div class="author">by <strong>Astyan</strong></div>
				<div class="content">Hi !<br /><br />What about this code :<br /><br /><blockquote class="uncited"><div>set tmp=%1<br />set tmp=%tmp:~0,1%<br />:: Double the doublequote seems to be better with if using [ ].Characters  &quot; = [ &amp; ^ etc are handled<br />set tmp=%tmp:&quot;=&quot;&quot;%<br />if [&quot;%tmp%&quot;] == [&quot;~0,1&quot;] GOTO :ARGUMENT_NOT_DEFINED<br />if [&quot;%tmp%&quot;] == [&quot;&quot;]       GOTO :ARGUMENT_NOT_DEFINED<br /><br />:ARGUMENT_DEFINED<br />	REM your stuff<br />GOTO :EOF<br /><br />:ARGUMENT_NOT_DEFINED<br />	REM your other stuff<br />GOTO :EOF<br /></div></blockquote></div>
			</div>
			<hr />
					<div class="post">
				<h3>Re: foolproof counting of arguments</h3>
				<div class="date">Posted: <strong>25 Aug 2012 23:03</strong></div>
				<div class="author">by <strong>Liviu</strong></div>
				<div class="content"><blockquote><div><cite>Astyan wrote:</cite>What about this code</div></blockquote><br />Fails if you pass it for example either<br /><br />=<br />^&amp;<br />^&lt;<br /><br />and similar others, too.<br /><br />Liviu</div>
			</div>
			<hr />
					<div class="post">
				<h3>Re: foolproof counting of arguments</h3>
				<div class="date">Posted: <strong>26 Aug 2012 00:15</strong></div>
				<div class="author">by <strong>dbenham</strong></div>
				<div class="content">And it is much more complicated than need be for the cases that don't fail. The code could be simplified to:<br /><div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>set test=%1<br />if defined test (echo arg1 is defined) else echo arg1 is not defined<br /></code></pre></div><br />BUT, as Liviu has already pointed out, the SET statement can fail under many circumstances.<br /><br /><br />Dave Benham</div>
			</div>
			<hr />
					<div class="post">
				<h3>Re: foolproof counting of arguments</h3>
				<div class="date">Posted: <strong>02 Nov 2013 21:10</strong></div>
				<div class="author">by <strong>Aacini</strong></div>
				<div class="content">I would like to add some technical information to this thread just to complete it. I copied this info from &quot;Microsoft MS-DOS Programmer's Reference&quot; manual for DOS Version 5 (Microsoft Press, 1991). Although the manual is (old!) DOS specific, the point stated here is performed in the same way in modern Windows cmd.exe command-line window, that is: how the redirection of a standard handle to/from a disk file is achieved?<br /><br />When any command is executed in a command-line window or Batch file, it <em class="text-italics">inherits</em> from its parent process these three <em class="text-italics">standard handles</em>: 0 (STDIN) connected to keyboard, 1 (STDOUT) connected to screen, and 2 (STDERR) connected to screen (although in original DOS there are also 3=STDPRN and 4=STDAUX standard handles open). In Windows/DOS Batch files, the handles 3 to 9 are available to open additional files (in normal programs the last number is the value of FILES= in CONFIG.SYS file, usually 20). There are two DOS file handle management functions important for this topic:<br /><br /><div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>Int 21H, Function 45H: Duplicate File Handle<br /><br />&nbsp; &nbsp; mov&nbsp; &nbsp; &nbsp;bx, OldHandle&nbsp; &nbsp; &nbsp; &nbsp;;handle to duplicate, for example: 1 (STDOUT)<br />&nbsp; &nbsp; mov&nbsp; &nbsp; &nbsp;ah, 45H&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;;function: Duplicate File Handle<br />&nbsp; &nbsp; int&nbsp; &nbsp; &nbsp;21H&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;;call DOS function<br />&nbsp; &nbsp; mov&nbsp; &nbsp; &nbsp;NewHandle, ax&nbsp; &nbsp; &nbsp; &nbsp;;store new handle<br /><br />This function creates a new file handle that can be used to read from or write to the same file or device that is associated with the original handle.<br /></code></pre></div><br />The number of the new handle is the first available number (the same way than in Open File function), for example: 3.<br /><br /><div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>Int 21H, Function 46H: Force Duplicate File Handle<br /><br />&nbsp; &nbsp; mov&nbsp; &nbsp; &nbsp;bx, OpenHandle&nbsp; &nbsp; &nbsp; ;handle of file or device<br />&nbsp; &nbsp; mov&nbsp; &nbsp; &nbsp;cx, DuplicateHandle ;new handle for same file or device<br />&nbsp; &nbsp; mov&nbsp; &nbsp; &nbsp;ah, 46H&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;;function: Force Duplicate File Handle<br />&nbsp; &nbsp; int&nbsp; &nbsp; &nbsp;21H&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;;call DOS function<br /><br />This function forces the specified duplicate handle to identify the same open file or device identified by the OpenHandle parameter.<br />DuplicateHandle must not exceed the current limit of available handles.<br />After a program uses this function, both handles can be used to read from or write to the file or device specified by OpenHandle.<br />If DuplicateHandle identifies an open file, MS-DOS closes that file.<br /></code></pre></div><br />Lets pass to review the method that the programmer's manual specify to achieve a redirection of STDOUT in a similar way than this command-line: ANYCOMMAND &gt; DISKFILE.TXT<br /><br /><div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>5.4.3 Standard-Device Redirection<br /><br />A parent program can redirect a standard device for the child program by associating the standard-device handle with a new device or file before it starts the child program. To do this, the parent program should follow these steps:<br /><br />1&nbsp; Duplicate the standard-device handle by using Duplicate File Handle (Function 45H).<br /><br />&nbsp; &nbsp; mov&nbsp; &nbsp; &nbsp;bx, 1&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;;handle to duplicate: STDOUT<br />&nbsp; &nbsp; mov&nbsp; &nbsp; &nbsp;ah, 45H&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;;function: Duplicate File Handle<br />&nbsp; &nbsp; int&nbsp; &nbsp; &nbsp;21H&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;;call DOS function<br /><br />2&nbsp; Save the duplicate handle.<br /><br />&nbsp; &nbsp; mov&nbsp; &nbsp; &nbsp;NewHandle, ax&nbsp; &nbsp; &nbsp; &nbsp;;store new handle&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;;NewHandle = 3 (associated with the screen)<br /><br />3&nbsp; Open the new file or device.<br /><br />&nbsp; &nbsp; mov&nbsp; &nbsp; &nbsp;dx, offset FileName ;dx points to name of file or device (like &quot;diskfile.txt&quot;,0)<br />&nbsp; &nbsp; mov&nbsp; &nbsp; &nbsp;ah, 3DH&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;;function: Open File with Handle<br />&nbsp; &nbsp; int&nbsp; &nbsp; &nbsp;21H&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;;call DOS function<br />&nbsp; &nbsp; mov&nbsp; &nbsp; &nbsp;handle, ax&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;handle of file or device&nbsp; &nbsp; &nbsp; &nbsp;;handle = 4 (next available handle)<br /><br />4&nbsp; With the new handle retrieved in step 3, modify the standard-device handle by using Force Duplicate File Handle (Function 46H).<br /><br />&nbsp; &nbsp; mov&nbsp; &nbsp; &nbsp;bx, handle&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;handle of file or device&nbsp; &nbsp; &nbsp; &nbsp;;bx = 4 (associated with diskfile.txt)<br />&nbsp; &nbsp; mov&nbsp; &nbsp; &nbsp;cx, 1&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;;new handle for same file or device ;standard STDOUT<br />&nbsp; &nbsp; mov&nbsp; &nbsp; &nbsp;ah, 46H&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;;function: Force Duplicate File Handle<br />&nbsp; &nbsp; int&nbsp; &nbsp; &nbsp;21H&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;;call DOS function&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;now STDOUT is associated with diskfile.txt<br /><br />The standard-device handle should now identify the same file or device as the new handle.&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br /><br />5&nbsp; Load and run the child program.<br /><br />A parent program can restore the original standard-device handle by using Force Duplicate File Handle and specifying the duplicate handle saved in step 2.<br /><br />&nbsp; &nbsp; mov&nbsp; &nbsp; &nbsp;bx, NewHandle&nbsp; &nbsp; &nbsp; &nbsp;;handle of file or device&nbsp; &nbsp; &nbsp; &nbsp;;bx = 3 (associated with the screen)<br />&nbsp; &nbsp; mov&nbsp; &nbsp; &nbsp;cx, 1&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;;new handle for same file or device ;standard STDOUT<br />&nbsp; &nbsp; mov&nbsp; &nbsp; &nbsp;ah, 46H&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;;function: Force Duplicate File Handle<br />&nbsp; &nbsp; int&nbsp; &nbsp; &nbsp;21H&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;;call DOS function&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;now STDOUT is re-associated with the screen<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;at the same time, handle 1 of diskfile.txt is closed<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;but handles 4 and 3 remains open until the program ends<br /></code></pre></div><br /><br />Antonio</div>
			</div>
			<hr />
					<div class="post">
				<h3>Re: foolproof counting of arguments</h3>
				<div class="date">Posted: <strong>28 Aug 2018 08:05</strong></div>
				<div class="author">by <strong>jeb</strong></div>
				<div class="content">I have some new thoughts about this old topic.<br>
<br>
Two keypoints are relevant.<br>

<blockquote><div><cite>jeb wrote:</cite>The REM technic currently fails with embedded linefeeds in the parameters %*.
</div></blockquote>
And it can't fetch carriage returns, this seems to be impossible as CR's are removed directly after the percent expansion!<br>

<blockquote><div><cite><a href="memberlist3d77.html?mode=viewprofile&amp;u=2258">dbenham</a> wrote: <a href="viewtopic0809-2.html?p=14612#p14612" data-post-id="14612" onclick="if(document.getElementById(hash.substr(1)))href=hash">↑</a><div class="responsive-hide">29 Mar 2012 13:26</div></cite>
Now we can use jeb's idea to safely capture the arguments, and have stdout restored to almost normal when done. (remember the original topic of this thread <img class="smilies" src="images/smilies/icon_smile.gif" width="15" height="15" alt=":)" title="Smile"> <img class="smilies" src="images/smilies/icon_exclaim.gif" width="15" height="15" alt=":!:" title="Exclamation">)<br>
<br>
Code: Select all<br>
<br>
@echo on 1&gt;args.txt 3&gt;&amp;1<br>
rem # %* #<br>
@echo off 1&gt;nul 4&gt;&amp;3<br>
type args.txt<br>
echo -------------<br>
1&gt;&amp;3 echo stream1 and stream3 both point to stdout<br>
echo -------------<br>
del args.txt<br>
1&gt;&amp;4 echo stream4 is left open pointing to args.txt<br>
type args.txt<br>
exit /b
</div></blockquote>

 <img class="smilies" src="images/smilies/icon_idea.gif" width="15" height="15" alt=":idea:" title="Idea">  But I found a bullet proof solution to fetch all characters, even line feeds and  <img class="smilies" src="images/smilies/icon_exclaim.gif" width="15" height="15" alt=":!:" title="Exclamation"> carrige returns <img class="smilies" src="images/smilies/icon_exclaim.gif" width="15" height="15" alt=":!:" title="Exclamation"> 
<div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>@echo off
REM *** Thread redirector 
for /F "tokens=3 delims=:" %%F in ("%~0") do goto %%F

cls

REM *** Clear params.tmp
break &gt; params.tmp

start "" /b cmd /c "%~d0\:StayAlive:\..\%~pnx0 params.tmp"

(set LF=^
%=empty=%
)
REM *** Change prompt for better recognition
prompt #PROMPT#


REM *** Change streams permanently
REM *** stream1 redirects to params.tmp
REM *** stream2 redirects to nul
echo on &gt;nul 2&gt;nul 3&gt;params.tmp 4&gt;nul

@REM *** This is the magic part, it forces a syntax error, the error message itself shows the expanded %asterix without ANY modification
( Prepare ) PARAMS:%LF%%*%LF%

echo Works
exit /b


REM *** Second thread to fetch and show the parameters
:StayAlive

:__WaitForParams
if %~z1 EQU 0 (
    goto :__WaitForParams
)
REM *** Show the result
findstr /n "^" %1 
exit</code></pre></div>

The tricky line is <br>
( Prepare ) PARAMS:%LF%%*%LF%<br>
It creates a syntax error at ") PARAMS" while parsing, therefore the content of %* is not relevant.<br>
BUT when a syntax error  occours the complete block will be printed (ECHO ON required).<br>
And in this case even carriage returns are preserved.<br>
<br>
Okay, so far so good, but now the drawbacks:  <img class="smilies" src="images/smilies/icon_sad.gif" width="15" height="15" alt=":(" title="Sad"> <br>
- The thread stops immediately, I found no way to execute any commands in the batch for that thread after the error (tried &amp;, &amp;&amp;, ||, code blocks, call, FOR loops)<br>
- I found no way to redirect the syntax error output other than with the permanent redirection, but I can't restore the streams, as the main thread stops immediately<br>
- Because the main thread stops, the user input goes to the command line, even when the StayAlive thread is still working<br>
- The params.tmp file is still open and can't be deleted until the cmd window is closed<br>
<br>
It could be useful when someone found a solution to some of the above points, or even how to close the current cmd window  <img class="smilies" src="images/smilies/icon_question.gif" width="15" height="15" alt=":?:" title="Question"> <br>
<br>
jeb</div>
			</div>
			<hr />
			</div>

	<div id="page-footer" class="page-footer">
		<div class="page-number">All times are <span title="UTC-6">UTC-06:00</span><br />Page <strong>3</strong> of <strong>4</strong></div>
		<div class="copyright">Powered by phpBB&reg; Forum Software &copy; phpBB Limited<br />https://www.phpbb.com/</div>
	</div>
</div>

</body>

<!-- Mirrored from www.dostips.com/forum/viewtopic.php?f=3&t=2836&start=30&view=print by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 19 Oct 2018 06:21:25 GMT -->
</html>
