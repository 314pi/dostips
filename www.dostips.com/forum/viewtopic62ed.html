<!DOCTYPE html>
<html dir="ltr" lang="en-gb">

<!-- Mirrored from www.dostips.com/forum/viewtopic.php?f=3&t=2518&view=print by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 19 Oct 2018 06:43:36 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- /Added by HTTrack -->
<head>
<meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="robots" content="noindex" />

<title>DosTips.com &bull; Macros with parameters appended</title>

<link href="styles/AllanStyle-SUBSILVER/theme/print.css" rel="stylesheet">
</head>
<body id="phpbb">
<div id="wrap" class="wrap">
	<a id="top" class="top-anchor" accesskey="t"></a>

	<div id="page-header">
		<h1>DosTips.com</h1>
		<p>A Forum all about DOS Batch<br /><a href="index-2.html">https://www.dostips.com/forum/</a></p>

		<h2>Macros with parameters appended</h2>
		<p><a href="viewtopic1ca9.html?f=3&amp;t=2518">https://www.dostips.com/forum/viewtopic.php?f=3&amp;t=2518</a></p>
	</div>

	<div id="page-body" class="page-body">
		<div class="page-number">Page <strong>1</strong> of <strong>2</strong></div>
					<div class="post">
				<h3>Macros with parameters appended</h3>
				<div class="date">Posted: <strong>21 Nov 2011 05:35</strong></div>
				<div class="author">by <strong>jeb</strong></div>
				<div class="content">Hi all, (especially dbenham and tooComplex/Ed)  <img class="smilies" src="images/smilies/icon_smile.gif" alt=":)" title="Smile" /> <br /><br />sometimes someone asks for a better solution for macros with parameters.<br /><br />Currently the standard technic (from Ed) is to invoke a batch macro with parameters seems to be<br /><div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>%_forU% ( 'params' ) %@macro%</code></pre></div><br />So you need a construct with two expansions, and the parameters are in the middle.<br /><br />I would prefere something like (even I didn't use macros at all)<br /><div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>%myMacro% param1,param2<br />OR<br />%myMacro% (param1,param2)</code></pre></div><br />How to solve this might not be obviously, but it can be done.  <img class="smilies" src="images/smilies/icon_wink.gif" alt=":wink:" title="Wink" /> <br /><br />And the result isn't very complex, it's only a bit slower as it uses one extra FOR/L-Loop.<br />The main idea is this:<br /><div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>FOR/L %%n in (1,1,2) DO (<br />&nbsp; if %%n==2 ( // Now we can access the parameters<br />&nbsp; &nbsp; &nbsp;// get the parameters<br />&nbsp; &nbsp; &nbsp;// run the macro<br />&nbsp; )<br />) &amp; set parameters=<br /></code></pre></div><br /><br />And here is a working sample with <span style="color: #408000">strlen</span><br />Calling it via<br /><span style="color: #408000">%$strlen% resultVar,stringVar</span><br /><br /><div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>@echo off<br />cls<br />setlocal DisableDelayedExpansion<br />set LF=^<br /><br /><br />::Above 2 blank lines are required - do not remove<br />set ^&quot;\n=^^^%LF%%LF%^%LF%%LF%^^&quot;<br /><br />set argv=Empty<br />set $strLen=for /L %%n in (1 1 2) do ( %\n%<br />&nbsp; &nbsp;if %%n==2 (%\n%<br />&nbsp; &nbsp;&nbsp; &nbsp; setlocal enableDelayedExpansion%\n%<br />&nbsp; &nbsp;&nbsp; &nbsp;for /F &quot;tokens=1,2 delims=, &quot; %%1 in (&quot;!argv!&quot;) do (%\n%<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;echo par1=%%1 %\n%<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;echo par2=%%2 %\n%<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;set &quot;str=A!%%~2!&quot;%\n%<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; set &quot;len=0&quot;%\n%<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; for /l %%A in (12,-1,0) do (%\n%<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp; set /a &quot;len|=1&lt;&lt;%%A&quot;%\n%<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp; for %%B in (!len!) do if &quot;!str:~%%B,1!&quot;==&quot;&quot; set /a &quot;len&amp;=~1&lt;&lt;%%A&quot;%\n%<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; )%\n%<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; for %%v in (!len!) do endlocal^&amp;if &quot;%%~b&quot; neq &quot;&quot; (set &quot;%%~1=%%v&quot;) else echo %%v%\n%<br />&nbsp; &nbsp;&nbsp; &nbsp;) %\n%<br />&nbsp; &nbsp;) %\n%<br />) ^&amp; set argv=,<br /><br />set &quot;testString=this has a length of 23&quot;<br />%$strlen% result,testString<br />echo Length of testString (&quot;%testString%&quot;) is %result%</code></pre></div><br /><br />jeb</div>
			</div>
			<hr />
					<div class="post">
				<h3>Re: Macros with parameters appended</h3>
				<div class="date">Posted: <strong>21 Nov 2011 07:19</strong></div>
				<div class="author">by <strong>dbenham</strong></div>
				<div class="content"><img class="smilies" src="images/smilies/icon_eek.gif" alt=":shock:" title="Shocked" /> Awesome and Revolutionary <img class="smilies" src="images/smilies/icon_exclaim.gif" alt=":!:" title="Exclamation" /> <br /><br />Two minor inconveniences:<br /><br />1) The parameter value of argV persists after the macro completes. I don't think there is anything we can do about that.<br /><br />2) Any command added on the same line after the macro call will be executed twice<br /><br />This code with your strlen macro<br /><div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>set &quot;testString=this has a length of 23&quot;<br />%$strlen% result,testString &amp; echo Hello World %%n<br />echo Length of testString (&quot;%testString%&quot;) is %result%<br />set argv<br /></code></pre></div><br />produces:<br /><div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>Hello world 1<br />par1=!argv!<br />par2=<br />Hello world 2<br />Length of testString (&quot;this has a length of 23&quot;) is<br />argv=, result,testString<br /></code></pre></div><br />Great work jeb <img class="smilies" src="images/smilies/icon_exclaim.gif" alt=":!:" title="Exclamation" /><br />I think I will be adopting this macro style.<br /><br /><br />Dave Benham</div>
			</div>
			<hr />
					<div class="post">
				<h3>Re: Macros with parameters appended</h3>
				<div class="date">Posted: <strong>21 Nov 2011 07:42</strong></div>
				<div class="author">by <strong>Ed Dyreen</strong></div>
				<div class="content">'<br />My god, this may prove to work pretty well actually ( you definately made dave happy ).<br /><br /> <img class="smilies" src="images/smilies/icon_mad.gif" alt=":x" title="Mad" /> <br />How am I ever going to get my library stable if things keep changing at this rate ? <strong class="text-strong">impressive !</strong><br />You know jeb, you are a freaking clever guy, luckily for clever people, there is always someone more clever than you.<br /><br />And while you're at it, how about&#058;<br /><div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>set /a $var=%StrLen% ( &quot;I wish this worked&quot; ) + %random%<br /></code></pre></div> Now that would be really impressive. <img class="smilies" src="images/smilies/icon_lol.gif" alt=":lol:" title="Laughing" /><br /><br />I have a feeling this topic is going to grow...</div>
			</div>
			<hr />
					<div class="post">
				<h3>Re: Macros with parameters appended</h3>
				<div class="date">Posted: <strong>21 Nov 2011 08:13</strong></div>
				<div class="author">by <strong>jeb</strong></div>
				<div class="content"><blockquote><div><cite>dbenham wrote:</cite> <img class="smilies" src="images/smilies/icon_eek.gif" alt=":shock:" title="Shocked" /> Awesome and Revolutionary <img class="smilies" src="images/smilies/icon_exclaim.gif" alt=":!:" title="Exclamation" /> </div></blockquote><br />Thanks  <img class="smilies" src="images/smilies/icon_biggrin.gif" alt=":D" title="Very Happy" /> <br /><br /><br /><blockquote><div><cite>dbenham wrote:</cite>Two minor inconveniences:<br /><br />1) The parameter value of argV persists after the macro completes. I don't think there is anything we can do about that.<br /><br />2) Any command added on the same line after the macro call will be executed twice</div></blockquote><br /><br />The solution for these two points is obviously  <img class="smilies" src="images/smilies/icon_wink.gif" alt=":wink:" title="Wink" /> <br /><br />- Use setlocal direct before set argv<br />- Do the set argv and the rest only if %%n==1<br /><br /><div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>@echo off<br />cls<br />setlocal DisableDelayedExpansion<br />set LF=^<br /><br /><br />::Above 2 blank lines are required - do not remove<br />set ^&quot;\n=^^^%LF%%LF%^%LF%%LF%^^&quot;<br /><br />set argv=original<br />set $strLen=for /L %%n in (1 1 2) do if %%n==2 (%\n%<br />&nbsp; &nbsp;&nbsp; &nbsp;for /F &quot;tokens=1,2 delims=, &quot; %%1 in (&quot;!argv!&quot;) do (%\n%<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;echo par1=%%1 %\n%<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;echo par2=%%2 %\n%<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;set &quot;str=A!%%~2!&quot;%\n%<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; set &quot;len=0&quot;%\n%<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; for /l %%A in (12,-1,0) do (%\n%<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp; set /a &quot;len|=1&lt;&lt;%%A&quot;%\n%<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp; for %%B in (!len!) do if &quot;!str:~%%B,1!&quot;==&quot;&quot; set /a &quot;len&amp;=~1&lt;&lt;%%A&quot;%\n%<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; )%\n%<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; for %%v in (!len!) do endlocal^&amp;if &quot;%%~b&quot; neq &quot;&quot; (set &quot;%%~1=%%v&quot;) else echo %%v%\n%<br />&nbsp; &nbsp;&nbsp; &nbsp;) %\n%<br />) ELSE setlocal enableDelayedExpansion ^&amp; set argv=,<br /><br />set &quot;testString=this has a length of 23&quot;<br />%$strlen% result,testString &amp; echo hello<br />set argv</code></pre></div><br /><br />Output<br /><blockquote class="uncited"><div>hello<br />par1=result<br />par2=testString<br />Length of testString (&quot;this has a length of 23&quot;) is 23<br />argv=original</div></blockquote><br /><br />jeb</div>
			</div>
			<hr />
					<div class="post">
				<h3>Re: Macros with parameters appended</h3>
				<div class="date">Posted: <strong>21 Nov 2011 09:09</strong></div>
				<div class="author">by <strong>dbenham</strong></div>
				<div class="content"><blockquote><div><cite>jeb wrote:</cite>The solution for these two points is obviously  <img class="smilies" src="images/smilies/icon_wink.gif" alt=":wink:" title="Wink" /> <br /><br />- Use setlocal direct before set argv<br />- Do the set argv and the rest only if %%n==1<br /></div></blockquote><br />Ding Ding Ding Ding Ding Ding Ding<br />WoooHooooo - Jackpot <img class="smilies" src="images/smilies/icon_exclaim.gif" alt=":!:" title="Exclamation" /> <br /><br />I am definitely adopting jeb's new macro style now <img class="smilies" src="images/smilies/icon_biggrin.gif" alt=":D" title="Very Happy" /> <br /><br />I will probably define a few helper macros:<br /><br /><strong class="text-strong">macro_begin </strong>to encapsulate the 1st two lines<br /><br /><strong class="text-strong">macro_end</strong> to define the final ELSE construct under normal circumstances<br /><br /><strong class="text-strong">macro_endSafe</strong> to define the final ELSE construct with some additional stuff to prepare for the safe return technique<br /><br />Thanks again jeb<br /><br />Addendum - I just realized the solution is not quite perfect  <img class="smilies" src="images/smilies/icon_neutral.gif" alt=":|" title="Neutral" /> <br /><br />Any command appended to the end of the line actually executes before the macro. This might throw off some people . . .<br />. . . but the technique is still awesome  <img class="smilies" src="images/smilies/icon_biggrin.gif" alt=":D" title="Very Happy" /> <br /><br />Dave Benham</div>
			</div>
			<hr />
					<div class="post">
				<h3>Re: Macros with parameters appended</h3>
				<div class="date">Posted: <strong>21 Nov 2011 09:31</strong></div>
				<div class="author">by <strong>Ed Dyreen</strong></div>
				<div class="content">'<br /><blockquote><div><cite>dbenham wrote:</cite>Any command appended to the end of the line actually executes before the macro. This might throw off some people . . .<br /></div></blockquote>but Dave, doesn't this solves that <img class="smilies" src="images/smilies/icon_confused.gif" alt=":?" title="Confused" /> <br /><div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>set $strLen=for /L %%n in (1 1 2) do if %%n==2 (%\n%<br />&nbsp; &nbsp; &nbsp; endlocal ^&amp;cmd /c exit 0 %\n%<br />) ELSE setlocal enableDelayedExpansion ^&amp; set argv=,<br /></code></pre></div><div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>( %$strlen% result,testString ) &amp;&amp;echo.succes ||echo.failed</code></pre></div>Ok guys, I'm in <em class="text-italics">jeb rocks</em> <img class="smilies" src="images/smilies/icon_cool.gif" alt="8)" title="Cool" /></div>
			</div>
			<hr />
					<div class="post">
				<h3>Re: Macros with parameters appended</h3>
				<div class="date">Posted: <strong>21 Nov 2011 10:01</strong></div>
				<div class="author">by <strong>dbenham</strong></div>
				<div class="content"><blockquote><div><cite>Ed Dyreen wrote:</cite><blockquote><div><cite>dbenham wrote:</cite>Any command appended to the end of the line actually executes before the macro. This might throw off some people . . .<br /></div></blockquote>but Dave, doesn't this solves that <img class="smilies" src="images/smilies/icon_confused.gif" alt=":?" title="Confused" /> <br /><div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>set $strLen=for /L %%n in (1 1 2) do if %%n==2 (%\n%<br />&nbsp; &nbsp; &nbsp; endlocal ^&amp;cmd /c exit 0 %\n%<br />) ELSE setlocal enableDelayedExpansion ^&amp; set argv=,<br /></code></pre></div></div></blockquote><br />I don't understand your logic, or where you are going with this.<br /><br />Please provide a complete but small working example that demonstrates that when executing<br /><div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>%strlen% &quot;my string&quot; &amp; echo hello<br /></code></pre></div>ECHO HELLO executes after the strlen is computed. I don't see how this can be done.<br /><br />Dave Benham</div>
			</div>
			<hr />
					<div class="post">
				<h3>Re: Macros with parameters appended</h3>
				<div class="date">Posted: <strong>21 Nov 2011 10:10</strong></div>
				<div class="author">by <strong>Ed Dyreen</strong></div>
				<div class="content">'<br /><div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>@echo off<br /><br />set $strLen=for /L %%n in (1 1 2) do if %%n==2 ( echo.instrlen ^!argv^! ^&amp;endlocal ^&amp;cmd /c exit 0 ) ELSE setlocal enableDelayedExpansion ^&amp; set argv=,<br /><br />( %$strlen% result,testString ) &amp;&amp;echo.succes ||echo.failed<br /><br />pause<br />exit<br /></code></pre></div><div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>instrlen , result,testString<br />succes<br />Druk op een toets om door te gaan. . .<br /></code></pre></div>You'll have to enclose in brackets <img class="smilies" src="images/smilies/icon_neutral.gif" alt=":|" title="Neutral" /></div>
			</div>
			<hr />
					<div class="post">
				<h3>Re: Macros with parameters appended</h3>
				<div class="date">Posted: <strong>21 Nov 2011 10:23</strong></div>
				<div class="author">by <strong>dbenham</strong></div>
				<div class="content">Of course - I see how it works now. Thanks.<br /><br />But some one could still do it without brackets and be confused with the results. It's not a big deal, just something to look out for.<br /><br />Dave Benham</div>
			</div>
			<hr />
					<div class="post">
				<h3>Re: Macros with parameters appended</h3>
				<div class="date">Posted: <strong>21 Nov 2011 16:03</strong></div>
				<div class="author">by <strong>aGerman</strong></div>
				<div class="content">That's amazing!<br />I don't understand the behaviour that <em class="text-italics">^&amp; set argv=,</em> is able to catch the argument but, however, it works just fine.<br />That's indeed a trigger to commence working with macros. Thanks to each of you three.<br /><br />Regards<br />aGerman (still impressed ...)</div>
			</div>
			<hr />
					<div class="post">
				<h3>Re: Macros with parameters appended</h3>
				<div class="date">Posted: <strong>21 Nov 2011 16:25</strong></div>
				<div class="author">by <strong>dbenham</strong></div>
				<div class="content"><blockquote><div><cite>aGerman wrote:</cite>I don't understand the behaviour that <em class="text-italics">^&amp; set argv=,</em> is able to catch the argument</div></blockquote><br />At first I was confused as well. But it is really quite simple, once you see it. It helps to see everything on one line:<br /><br /><div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>set macro=for /l %%n in (1 1 2) do if %%n==2 (MACRO BUSINESS) else setlocal enableDelayedExpansion ^&amp; set argv=,<br /><br />%macro% arg1 arg2<br /><br />:: the call expands to <br />:: for /l %%n in (1 1 2) do if %%n==2 (MACRO BUSINESS) else setlocal enableDelayedExpansion &amp; set argv=, arg1 arg2<br /></code></pre></div><br />Really simple, yet clever  <img class="smilies" src="images/smilies/icon_biggrin.gif" alt=":D" title="Very Happy" /><br /><br /><br />Dave Benham</div>
			</div>
			<hr />
					<div class="post">
				<h3>Re: Macros with parameters appended</h3>
				<div class="date">Posted: <strong>21 Nov 2011 16:37</strong></div>
				<div class="author">by <strong>aGerman</strong></div>
				<div class="content">Now it dawns me <img class="smilies" src="images/smilies/icon_idea.gif" alt=":idea:" title="Idea" /> <br />Thanks Dave <img class="smilies" src="images/smilies/icon_biggrin.gif" alt=":D" title="Very Happy" /> <br /><br />Regards<br />aGerman</div>
			</div>
			<hr />
					<div class="post">
				<h3>Re: Macros with parameters appended</h3>
				<div class="date">Posted: <strong>12 Dec 2011 05:19</strong></div>
				<div class="author">by <strong>Aacini</strong></div>
				<div class="content">jeb: First of all, I want to offer you a <strong class="text-strong">VERY BIG CONGRATULATION</strong> <img class="smilies" src="images/smilies/icon_exclaim.gif" alt=":!:" title="Exclamation" />  for all of your ideas, specially this one.  <img class="smilies" src="images/smilies/icon_biggrin.gif" alt=":D" title="Very Happy" />  <img class="smilies" src="images/smilies/icon_razz.gif" alt=":P" title="Razz" /> <br /><br />That said, this is a small observation:<br /><br />WHY YOU DIDN'T EXPLAIN YOUR METHODS? I worked for over 25 years explaining computer themes to other people. I used to write larger and clearer explanations as the themes becomes harder. I hate the <strong class="text-strong">&quot;use this as it is, but don't try to understand it&quot;</strong> approach in new methods, because it prevents the new method be understood by other people and hence be modified and used for other purposes.<br /><br />Below is my own explanation on this topic and a small additional contribution.<br /><br />Suppose you have a macro-function that is usually executed this way:<br /><div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>for /F &quot;tokens=1-26&quot; %%a in (&quot;param1 param2 resultvar&quot;) do %macroFunc%</code></pre></div><br />How we may execute the macro in the following way?<br /><div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>%macroFuncWithParams% param1 param2 resultvar</code></pre></div><br />Parameters placed after the macro needs to be taken and moved inside the FOR parentheses; this may be achieved by a two-step process:<br /><br />1- Get the parameters<br />2- Execute the macro with them<br /><br />That is, the macro must be executed two times: in the first step the parameters will be stored in an (argv) variable, and in the second step the macro will be really executed:<br /><div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>for %%s in (get_params exec_macro) do (<br />&nbsp; &nbsp;if %%s == get_params (<br />&nbsp; &nbsp; &nbsp; set argv=&lt;rest of the line placed after the macro&gt;<br />&nbsp; &nbsp;) else ( rem %%s == exec_macro<br />&nbsp; &nbsp; &nbsp; for /F &quot;tokens=1-26&quot; %%a in (!argv!) do %macroFunc%<br />&nbsp; &nbsp;)<br />)<br /></code></pre></div><br />However, the &lt;rest of the line&gt; is <em class="text-italics">physically</em> placed after the macro. This means that <strong class="text-strong">set argv=</strong> command must be the <em class="text-italics">last</em> part of the macro definition:<br /><div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>for %%s in (1 2) do (<br />&nbsp; &nbsp;if %%s == 2 (<br />&nbsp; &nbsp; &nbsp; for /f &quot;tokens=1-26&quot; %%a in (!argv!) do %macroFunc%<br />&nbsp; &nbsp;) else (<br />&nbsp; &nbsp; &nbsp; set argv=&lt;rest of the line...&gt;<br />&nbsp; &nbsp;)<br />)<br /></code></pre></div><br />There are still two parentheses after <strong class="text-strong">set argv=</strong>, but we can simply eliminate they because the FOR and ELSE part parentheses are placed here just for legibility:<br /><div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>for %%n in (1 2) do if %%n == 2 (<br />&nbsp; &nbsp; &nbsp; for /f &quot;tokens=1-26&quot; %%a in (!argv!) do %macroFunc%<br />&nbsp; &nbsp;) else set argv=<br /></code></pre></div><br />This way, although the parts seems to be upside down, they execute in the right order. Note that we could place another command after ELSE separated by &amp; and it also would belong to ELSE part, although there are not parentheses here. This point makes possible to include a SETLOCAL before the <strong class="text-strong">set argv=</strong> to avoid undesired modification of a variable with same name in the caller program, and to assure that delayed expansion is enabled when !argv! is processed:<br /><div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>for %%n in (1 2) do if %%n == 2 (<br />&nbsp; &nbsp; &nbsp; for /f &quot;tokens=1-26&quot; %%a in (!argv!) do %macroFunc%<br />&nbsp; &nbsp; &nbsp; endlocal<br />&nbsp; &nbsp;) else setlocal EnableDelayedExpansion &amp; set argv=<br /></code></pre></div><br />However, because this method use textual substitution of whichever text placed after the macro, if another &amp; COMMAND is placed after macro params, then that command also belongs to ELSE part and will also be executed <em class="text-italics">before</em> the macro, that is an unexpected behavior. The only way to avoid this effect is isolating the macro and parameters from the rest of the line by enclosing they in parentheses.<br /><br /><br /><br /><strong class="text-strong">Second part:</strong> An additional contribution.<br /><br />When we define a macroFuncWithParams variable with this format, we may duplicate the original macroFunc code in the macro execution part, taking the parameters from argv variable (as in jeb example above); or we may use the original macroFunc code over argv variable in a nested macro invocation:<br /><div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>for /F &quot;tokens=1-26&quot; %%a in (&quot;!argv!&quot;) do %nestedMacroFunc%</code></pre></div><br />This last case would be useful if we want to define a <strong class="text-strong">generic</strong> macro that could call any other macro-function in a standard way. For example, suppose now that we want to execute our original macro this way:<br /><div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>%let% resultVar=macroFunc(param1,param2)</code></pre></div><br />How we can do that? Via a slightly different rearrangment of the macro parameters:<br /><div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>for %%n in (1 2) do if %%n == 2 (<br />&nbsp; &nbsp; &nbsp; for /F &quot;tokens=1-4 delims==(,) &quot; %%1 in (&quot;!argv!&quot;) do (<br />&nbsp; &nbsp; &nbsp; set macroFunc=%%1<br />&nbsp; &nbsp; &nbsp; set param1=%%2<br />&nbsp; &nbsp; &nbsp; set param2=%%3<br />&nbsp; &nbsp; &nbsp; set resultVar=%%4<br />&nbsp; &nbsp; &nbsp; for /F &quot;tokens=1-26&quot; %%a in (&quot;!param1! !param2! resultValue&quot;) do %%macroFunc%%<br />&nbsp; &nbsp; &nbsp; for %%v in (!resultValue!) do endlocal &amp; set &quot;!resultVar!=%%v&quot;<br />&nbsp; &nbsp;) else setlocal EnableDelayedExpansion &amp; set argv=<br /></code></pre></div><br />We have, however, a big problem at this point. <em class="text-italics">There is no way to directly execute a nested macro inside another one</em>. We may left this problem apart for a while and test now that the method above is correct by executing a subroutine instead of a macro:<br /><div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>@echo off<br />cls<br />setlocal DisableDelayedExpansion<br />set LF=^<br /><br /><br /><br />::Above 2 blank lines are required - do not remove<br />set ^&quot;\n=^^^%LF%%LF%^%LF%%LF%^^&quot;<br /><br /><br />set strLen=(%\n%<br />&nbsp; &nbsp;setlocal enableDelayedExpansion%\n%<br />&nbsp; &nbsp;set &quot;str=A!%%~b!&quot;%\n%<br />&nbsp; &nbsp;set &quot;len=0&quot;%\n%<br />&nbsp; &nbsp;for /l %%A in (12,-1,0) do (%\n%<br />&nbsp; &nbsp; &nbsp; set /a &quot;len|=1&lt;&lt;%%A&quot;%\n%<br />&nbsp; &nbsp; &nbsp; for %%B in (!len!) do if &quot;!str:~%%B,1!&quot;==&quot;&quot; set /a &quot;len&amp;=~1&lt;&lt;%%A&quot;%\n%<br />&nbsp; &nbsp;)%\n%<br />&nbsp; &nbsp;for %%v in (!len!) do endlocal^&amp;if &quot;%%~a&quot; neq &quot;&quot; (set &quot;%%~a=%%v&quot;) else echo %%v%\n%<br />)<br /><br /><br />set let=for %%n in (1 2) do if %%n==2 (%\n%<br />&nbsp; &nbsp; &nbsp; for /F &quot;tokens=1-4 delims==(,) &quot; %%1 in (&quot;!argv!&quot;) do (%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;echo -------------------------- %\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;set macroFunc=%%1%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;echo macroFunc=!macroFunc! %\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;set param1=%%2%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;echo param1=!param1! %\n%<br />REM&nbsp; &nbsp; &nbsp; set param2=%%3%\n%<br />REM&nbsp; &nbsp; &nbsp; echo param2=!param2! %\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;set resultVar=%%3%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;echo resultVar=!resultvar! %\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;call !macroFunc! !param1! !param2! resultValue%\n%<br />REM&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;for /F &quot;tokens=1-26&quot; %%a in (&quot;!param1! !param2! resultValue&quot;) do (%\n%<br />REM&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;nested call %%%%macroFunc%%%% %\n%<br />REM&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;)%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;for %%v in (!resultValue!) do endlocal^&amp;set &quot;%%1=%%v&quot;%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;echo -------------------------- %\n%<br />&nbsp; &nbsp; &nbsp; )%\n%<br />&nbsp; &nbsp;) else setlocal enableDelayedExpansion ^&amp; set argv=<br /><br /><br />set &quot;testString=this has a length of 23&quot;<br />echo Test string is (&quot;%testString%&quot;)<br />echo/<br /><br />echo Original (FOR /F ...) strLen macro invocation:<br />for /F &quot;tokens=1-26&quot; %%a in (&quot;testString forResult&quot;) do %strLen%<br />echo Original FOR macro invocation result is %forResult%<br />echo/<br /><br />echo Original &quot;CALL :strLen testString subResult&quot; subroutine invocation:<br />call :strLen testString subResult=<br />echo Original CALL subroutine invocation result is %subResult%<br />echo/<br /><br />echo %%Let%% letResult=:strLen(testString) invocation:<br />%let% letResult=:strLen(testString)<br />echo LET letResult=strLen(testString) result is %letResult%<br /><br />goto :EOF<br /><br /><br />:strLen string resultVar=<br />setlocal enableDelayedExpansion<br />set &quot;str=0!%~1!&quot;<br />set &quot;len=0&quot;<br />for /l %%A in (12,-1,0) do (<br />&nbsp; &nbsp;set /a &quot;len|=1&lt;&lt;%%A&quot;<br />&nbsp; &nbsp;for %%B in (!len!) do if &quot;!str:~%%B,1!&quot;==&quot;&quot; set /a &quot;len&amp;=~1&lt;&lt;%%A&quot;<br />)<br />for %%v in (!len!) do endlocal&amp;if &quot;%~2&quot; neq &quot;&quot; (set &quot;%~2=%%v&quot;) else echo %%v<br />exit /B<br /></code></pre></div><br />The result:<br /><div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>Test string is (&quot;this has a length of 23&quot;)<br /><br />Original (FOR /F ...) strLen macro invocation:<br />Original FOR macro invocation result is 23<br /><br />Original &quot;CALL :strLen testString subResult&quot; subroutine invocation:<br />Original CALL subroutine invocation result is 23<br /><br />%Let% letResult=:strLen(testString) invocation:<br />--------------------------<br />macroFunc=:strLen<br />param1=testString<br />resultVar=letResult<br />--------------------------<br />LET letResult=strLen(testString) result is 23<br /></code></pre></div><br />In previous example we achieved to get a macro that allows to execute any function in a very standard way at expense of a somewhat slower execution because the additional CALL. But we will not stop at this point, right? So we try to solve now the nested macro problem. The only way to execute a nested macro is by embeding it inside the caller one so when the original macro is expanded for execution, it already contains the code of the nested one. This may be achieved by splitting the original macro in two parts: a Head, from the beginning up to the invocation of the nested macro, and a Tail, from the return of the nested invocation up to the end. This way, we can assemble the final macro by joining the Head, the nested macro, and the Tail this way:<br /><div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>set completeLet=!letHead!!macroFunc!!letTail!</code></pre></div><br />After that, the execution of both the LET macro and the nested macro-function is immediate:<br /><div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>%completeLet%</code></pre></div><br /><br /><strong class="text-strong">EDIT: Continue at this matter.</strong><br /><br />However, there is no way to include/embed a macro into another one <em class="text-italics">at execution time</em>, so previous method imply to create a different macro for each combination of LET plus the particular macro-function, that is not the desired solution. This method may still be used to execute any subroutine-function in a clearer way and there is another instance where this solution may be useful: to get the value of an array element when the subscript vary inside a FOR loop (and it is not the FOR variable). This task may be achieved via a macro called ASET (array set) with this format: <strong class="text-strong">%aset% element=array[subscript]</strong><br /><div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>set aset=for %%n in (1 2) do if %%n==2 (%\n%<br />&nbsp; &nbsp; &nbsp; for /F &quot;tokens=1-3 delims==&#91;&#93; &quot; %%1 in (&quot;!argv!&quot;) do (%\n%<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;endlocal^&amp;set &quot;%%1=!%%2&#91;%%3&#93;!&quot;%\n%<br />&nbsp; &nbsp; &nbsp; )%\n%<br />&nbsp; &nbsp;) else setlocal enableDelayedExpansion^&amp;set argv=<br /></code></pre></div><br />For example, in <a href="http://stackoverflow.com/questions/8520313/dos-batch-script-to-parse-csv-file-and-output-a-text-file" class="postlink">this SO question</a> I posted this program segment:<br /><div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>set i=0<br />set j=1<br />for %%e in (%line%) do (<br />&nbsp; &nbsp;set /A i+=1<br />&nbsp; &nbsp;for %%j in (!j!) do set target=!target&#91;%%j&#93;!<br />&nbsp; &nbsp;if !i! == !target! (<br />&nbsp; &nbsp; &nbsp; for %%i in (!i!) do set heading=!heading&#91;%%i&#93;!<br />&nbsp; &nbsp; &nbsp; echo !heading!%%~e<br />&nbsp; &nbsp; &nbsp; set /A j+=1<br />&nbsp; &nbsp;)<br />)<br /></code></pre></div><br />Using ASET macro, the segment may be rewritten in this clearer way:<br /><div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>set i=0<br />set j=1<br />for %%e in (%line%) do (<br />&nbsp; &nbsp;set /A i+=1<br />&nbsp; &nbsp;%aset% target=target&#91;!j!&#93;<br />&nbsp; &nbsp;if !i! == !target! (<br />&nbsp; &nbsp; &nbsp; %aset% heading=heading&#91;!i!&#93;<br />&nbsp; &nbsp; &nbsp; echo !heading!%%~e<br />&nbsp; &nbsp; &nbsp; set /A j+=1<br />&nbsp; &nbsp;)<br />)<br /></code></pre></div><br />Antonio<br /><br />PS - I modified previous description to include a missing detail that jeb noted in a posterior post.<br /><br />Note: <strong class="text-strong">for %%n in (1 2)</strong> execute faster than <strong class="text-strong">for /L %%n in (1,1,2)</strong>.<br /><br />Note: In my opinion, there must be a standard in macro names that allows to know if a macro is used in the conventional <strong class="text-strong">for /F ...</strong> way instead of with parameters (to avoid confusions).<br /><br />Note: I strongly encourage all of you, people, to adopt the standard of using %%1 %%2...%%9 to take macro parameters in macro definitions (and FOR /F &quot;tokens=1-9 delims=,;= &quot; %%1 invocation) instead of using %%a %%b...%%z (and FOR /F &quot;tokens=1-26&quot; %%a invocation) for several practical reasons, some of which are explained in my second post at<br /><a href="viewtopic2df5.html?t=1827&amp;start=60" class="postlink">this topic</a>.</div>
			</div>
			<hr />
					<div class="post">
				<h3>Re: Macros with parameters appended</h3>
				<div class="date">Posted: <strong>12 Dec 2011 06:26</strong></div>
				<div class="author">by <strong>jeb</strong></div>
				<div class="content">Welcome Aacini to the expert discussions <img class="smilies" src="images/smilies/icon_smile.gif" alt=":)" title="Smile" /> <br /><br /><blockquote><div><cite>Aacini wrote:</cite>jeb: First of all, I want to offer you a VERY BIG CONGRATULATION <img class="smilies" src="images/smilies/icon_exclaim.gif" alt=":!:" title="Exclamation" /> for all of your ideas, specially this one. <img class="smilies" src="images/smilies/icon_biggrin.gif" alt=":D" title="Very Happy" /> <img class="smilies" src="images/smilies/icon_razz.gif" alt=":P" title="Razz" /> </div></blockquote>Thanks <img class="smilies" src="images/smilies/icon_biggrin.gif" alt=":D" title="Very Happy" />  <img class="smilies" src="images/smilies/icon_smile.gif" alt=":)" title="Smile" /> <br /><br /><blockquote><div><cite>Aacini wrote:</cite>WHY YOU DIDN'T EXPLAIN YOUR METHODS?</div></blockquote>They are obvious and self-explanatory <img class="smilies" src="images/smilies/icon_exclaim.gif" alt=":!:" title="Exclamation" /> <br /><br />Ok, perhaps not complete obvious <img class="smilies" src="images/smilies/icon_wink.gif" alt=":wink:" title="Wink" /> , but I wrote this especially for Dave and Ed, as only expert should/could build these types of macros.<br /><br /><blockquote><div><cite>Aacini wrote:</cite>I hate the &quot;use this as it is, but don't try to understand it&quot; approach in new methods, because it prevents the new method be understood by other people and hence be modified and used for other purposes.</div></blockquote>I love good questions, and thanks for your explanation, so I don't have to do it.<br /><br /><blockquote><div><cite>Aacini wrote:</cite>Because this trick use textual substitution of whichever text placed after the macro, if another &amp; COMMAND is placed after macro params, that command will also be carried into the for body and hence also executed 2 times:<br />[...]<br />The only way to avoid this effect is isolating the macro and parameters from the rest of the line by enclosing they in parentheses, as Ed indicated.</div></blockquote>Did I said that I love to disprove such declarations <img class="smilies" src="images/smilies/icon_question.gif" alt=":?:" title="Question" />  <img class="smilies" src="images/smilies/icon_cool.gif" alt="8)" title="Cool" /> <br /><br />I simply forgot to post the solution for this<br /><div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>set $SomeMacro=for /L %%n in (1 1 2) do if %%n==2 (%\n%<br />&nbsp; &nbsp;&nbsp; &nbsp;rem *** MACRO Content<br />&nbsp; &nbsp;&nbsp; &nbsp;for /f &quot;delims=&quot; %%r in (&quot;!result!&quot;) do endlocal^&amp; set &quot;%%~3=%%~r&quot; %\n%<br />&nbsp; &nbsp;) %\n%<br />) ELSE setlocal enableDelayedExpansion ^&amp; echo ProofOfconcept is showed only once %%n ^&amp; set argv=,<br /></code></pre></div><br />In this case it is really obvious, isn't it?<br /><br />jeb</div>
			</div>
			<hr />
					<div class="post">
				<h3>Re: Macros with parameters appended</h3>
				<div class="date">Posted: <strong>12 Dec 2011 07:37</strong></div>
				<div class="author">by <strong>Ed Dyreen</strong></div>
				<div class="content">'<br />Very obvious as usual <img class="smilies" src="images/smilies/icon_smile.gif" alt=":)" title="Smile" /> , I see , <img class="smilies" src="images/smilies/icon_smile.gif" alt=":)" title="Smile" /> . <br /><div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>@echo off<br /><br />set $lf=^<br /><br /><br />::<br /><br />set ^&quot;\n=^^^%$lf%%$lf%^%$lf%%$lf%^^&quot;<br /><br />set $SomeMacro=for /L %%n in (1 1 2) do if %%n==2 (%\n%<br />&nbsp; &nbsp; &nbsp; set argv%\n%<br />&nbsp; &nbsp; &nbsp; for /f &quot;delims=&quot; %%r in (&quot;!argv!&quot;) do endlocal^&amp; echo.set &quot;%%~3=%%~r&quot; %\n%<br />&nbsp; &nbsp;) %\n%<br />) ELSE setlocal enableDelayedExpansion ^&amp; echo ProofOfconcept is showed only once %%n ^&amp; set argv=,<br /><br /><br />%$SomeMacro% yesyes<br /><br />pause<br />exit<br /></code></pre></div><div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>Omgevingsvariabele argv is niet gedefinieerd<br />set &quot;%~3=!argv!&quot;<br />Druk op een toets om door te gaan. . .<br /></code></pre></div></div>
			</div>
			<hr />
			</div>

	<div id="page-footer" class="page-footer">
		<div class="page-number">All times are <span title="UTC-6">UTC-06:00</span><br />Page <strong>1</strong> of <strong>2</strong></div>
		<div class="copyright">Powered by phpBB&reg; Forum Software &copy; phpBB Limited<br />https://www.phpbb.com/</div>
	</div>
</div>

</body>

<!-- Mirrored from www.dostips.com/forum/viewtopic.php?f=3&t=2518&view=print by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 19 Oct 2018 06:43:36 GMT -->
</html>
